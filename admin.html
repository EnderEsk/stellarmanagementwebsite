<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Stellar Tree Management</title>
    <link rel="icon" type="image/x-icon" href="images/logo.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <script src="simple-google-oauth.js"></script>
    <!-- Load admin.js after the page content to ensure DOM elements are available -->
    <script src="assets/js/admin.js" defer></script>
    <!-- Load admin calendar functionality -->
    <script src="admin-calendar.js" defer></script>
    
    <style>
        /* Ensure quote modal is always visible when shown */
        #quoteModal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 9999 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Loading state for quote button */
        .action-btn.quote.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .action-btn.quote.loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Fix modal backdrop and ensure proper visibility */
        .modal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Ensure modal content is properly positioned and visible */
        .modal.show .modal-content {
            position: relative !important;
            z-index: 10000 !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
        }
        
        /* Remove the problematic ::before pseudo-element */
        .modal.show::before {
            display: none !important;
        }
        
        /* Clickable address styling */
        .clickable-address {
            color: #007bff;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .clickable-address:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: #0056b3;
            text-decoration: none;
        }
        
        .clickable-address:active {
            transform: translateY(1px);
        }
        
        .clickable-address i {
            color: #dc3545;
            font-size: 14px;
        }
    </style>

</head>
<body>
    <nav>
        <div class="nav-container">
            <img src="images/logo.png" alt="Stellar Tree Management Logo" class="logo">
            <ul class="nav-links">
                <li><a href="./">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/projects">Projects</a></li>
                <li><a href="/booking/">Book Quote</a></li>
                <li><a href="/admin" class="active">Admin</a></li>
            </ul>
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal show">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Access Required</h3>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label>Sign in with your email</label>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            Only authorized email addresses can access the admin panel.
                        </p>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button type="button" class="oauth-btn google-btn" onclick="window.simpleGoogleAuth.loginWithGoogle()">
                            <i class="fab fa-google"></i>
                            <span>Sign in with Google</span>
                        </button>
                    </div>
                    
                    <div id="loginError" class="error-message" style="display: none; color: #dc3545; margin-top: 1rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <p style="color: #666; font-size: 0.8rem; text-align: center; margin: 0;">
                    Secure authentication via OAuth 2.0
                </p>
            </div>
        </div>
    </div>

    <div class="admin-container" id="adminContent" style="display: none;">
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="admin-title-section">
                    <h1>Admin Dashboard</h1>
                    <p>Manage bookings and view statistics for Stellar Tree Management</p>
                </div>
                <div class="admin-user-section">
                    <div class="admin-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-role">Administrator</div>
                            <div id="userEmail" class="user-email">Loading...</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="window.simpleGoogleAuth.logout()" title="Sign Out">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="logout-text">Logout</span>
                    </button>
                </div>
            </div>
        </div>



        <!-- Main Content Area -->
        <div class="bookings-container">
            <!-- Active Bookings Section -->
            <div class="active-bookings-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-check"></i> <span id="sectionTitle">Request Quote</span></h2>
                            <button class="refresh-btn" onclick="manualRefreshBookings()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
                </div>

                <!-- Modern Filter Tabs -->
                <div class="filter-tabs">
                    <!-- Booking Status Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Booking Status</div>
                        <div class="tab-row">
                            <div class="filter-tab active" data-filter="all">
                                <i class="fas fa-list"></i>
                                All Active
                            </div>
                            <div class="filter-tab" data-filter="pending">
                                <i class="fas fa-clock"></i>
                                Pending Site Visit
                                <span class="tab-count" id="pendingCount">0</span>
                            </div>

                            <div class="filter-tab" data-filter="quote-ready">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Quote Ready
                                <span class="tab-count" id="quoteReadyCount">0</span>
                            </div>
                            <div class="filter-tab" data-filter="quote-sent">
                                <i class="fas fa-paper-plane"></i>
                                Quote Sent
                                <span class="tab-count" id="quoteSentCount">0</span>
                            </div>

                            <div class="filter-tab" data-filter="pending-booking">
                                <i class="fas fa-calendar-plus"></i>
                                Job Scheduled
                                <span class="tab-count" id="pendingBookingCount">0</span>
                            </div>
                            <div class="filter-tab" data-filter="invoice-ready">
                                <i class="fas fa-file-invoice"></i>
                                Invoice Ready
                                <span class="tab-count" id="invoiceReadyCount">0</span>
                            </div>
                            <div class="filter-tab" data-filter="invoice-sent">
                                <i class="fas fa-paper-plane"></i>
                                Invoice Sent
                                <span class="tab-count" id="invoiceSentCount">0</span>
                            </div>
                            <div class="filter-tab" data-filter="completed">
                                <i class="fas fa-check-double"></i>
                                Completed
                                <span class="tab-count" id="completedCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Management Views Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Management Views</div>
                        <div class="tab-row">
                            <div class="filter-tab" data-filter="all-bookings">
                                <i class="fas fa-calendar-alt"></i>
                                All Bookings
                            </div>
                            <div class="filter-tab" data-filter="calendar">
                                <i class="fas fa-calendar-week"></i>
                                Calendar View
                            </div>
                            <!-- Customer Management tab - REMOVED -->
                        </div>
                    </div>
                </div>

                <!-- Bookings Grid -->
                <div class="bookings-grid" id="activeBookingsGrid">
                    <div class="empty-state">Loading bookings...</div>
                </div>

                <!-- Calendar View -->
                <div class="calendar-view" id="calendarView" style="display: none;">
                    <div class="calendar-controls">
                        <button class="calendar-nav-btn" onclick="window.adminCalendar.previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonth">July 2025</h3>
                        <button class="calendar-nav-btn" onclick="window.adminCalendar.nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>
                    
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <span class="legend-indicator available"></span>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator booked"></span>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator blocked"></span>
                            <span>Blocked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator weekend"></span>
                            <span>Weekend</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Management View - REMOVED -->
                    <!-- Customer management controls and grid - REMOVED -->
                </div>
            </div>

            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Recent History</h2>
                </div>
                <div id="historyContainer">
                    <div style="text-align: center; color: var(--admin-secondary); font-style: italic;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Booking image">
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Booking Details</h3>
                <button class="modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Booking details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Date Blocking Modal -->
    <div id="dateBlockingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="blockingModalTitle">Manage Date</h3>
                <button class="modal-close" onclick="window.adminCalendar.closeBlockingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-info">
                    <p><strong>Date:</strong> <span id="selectedDateDisplay"></span></p>
                    <p><strong>Status:</strong> <span id="dateStatusDisplay"></span></p>
                </div>
                <div class="blocking-actions">
                    <button class="action-btn confirm" onclick="window.adminCalendar.toggleDateBlock()" id="toggleBlockBtn">
                        <i class="fas fa-lock"></i> Block Date
                    </button>
                    <button class="action-btn complete" onclick="window.adminCalendar.unblockDate()" id="unblockBtn" style="display: none;">
                        <i class="fas fa-unlock"></i> Unblock Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="window.adminCalendar.closeBlockingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Booking Details Popup Modal -->
    <div id="bookingDetailsPopupModal" class="modal">
        <div class="modal-content booking-details-popup">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Booking Details</h3>
                <button class="modal-close" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="bookingDetailsPopupBody">
                <!-- Detailed booking information will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Message Modal -->
    <div id="customerMessageModal" class="modal">
        <div class="modal-content customer-message-modal">
            <div class="modal-header">
                <h3><i class="fas fa-envelope"></i> Send Message to Customer</h3>
                <button class="modal-close" onclick="closeCustomerMessageModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="message-customer-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer Name</label>
                                <span id="messageCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <label>Email</label>
                                <span id="messageCustomerEmail"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="messageBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="message-compose-section">
                    <h4><i class="fas fa-edit"></i> Compose Message</h4>
                    <div class="form-group">
                        <label for="messageSubject">Subject</label>
                        <input type="text" id="messageSubject" class="form-control" placeholder="Enter message subject..." value="Message from Stellar Tree Management">
                    </div>
                    <div class="form-group">
                        <label for="messageContent">Message</label>
                        <textarea id="messageContent" class="form-control" rows="8" placeholder="Type your message here..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerMessageModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-primary" onclick="sendCustomerMessage()">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Move Booking Modal -->
    <div id="moveBookingModal" class="modal">
        <div class="modal-content move-booking-modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrows-alt"></i> Move Booking</h3>
                <button class="modal-close" onclick="window.adminCalendar.closeMoveBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Booking Info Section -->
                <div class="move-booking-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <label>Current Date</label>
                                <span id="moveCurrentDate"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer</label>
                                <span id="moveCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <label>Phone</label>
                                <span id="moveCustomerPhone"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <label>Address</label>
                                <span id="moveCustomerAddress"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tools"></i>
                            <div>
                                <label>Service</label>
                                <span id="moveService"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="moveBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Selection Section -->
                <div class="move-date-selection">
                    <h4><i class="fas fa-calendar-plus"></i> Select New Date</h4>
                    
                    <!-- Calendar Navigation -->
                    <div class="move-calendar-nav">
                        <button class="nav-btn" onclick="window.adminCalendar.changeMoveMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="moveCalendarMonth"></span>
                        <button class="nav-btn" onclick="window.adminCalendar.changeMoveMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="move-calendar-grid" id="moveCalendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>

                    <!-- Selected Date Display -->
                    <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Selected: <strong id="selectedDateText"></strong></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="move-actions">
                    <button class="action-btn confirm" id="moveConfirmBtn" onclick="window.adminCalendar.moveBooking()" disabled>
                        <i class="fas fa-arrows-alt"></i> Move to Selected Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="window.adminCalendar.closeMoveBookingModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Management Modals -->

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <input type="text" id="customerAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">Notes</label>
                        <textarea id="customerNotes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customerDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 id="customerDetailsTitle">Customer Details</h3>
                <button class="modal-close" onclick="closeCustomerDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <!-- Customer details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerDetailsModal()">Close</button>
                <button type="button" class="btn-primary" onclick="editCustomer()">Edit Customer</button>
            </div>
        </div>
    </div>

    <script>
        let allBookings = [];
        let currentFilter = 'all';
        
        // Customer Management Variables
        let allCustomers = [];
        let currentCustomerId = null;

        // Helper function to format date without timezone issues
        function formatBookingDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        // OAuth Authentication - handled by oauth-auth.js
        // The OAuth authentication system is now managed by the OAuthAuth class
        
        // Legacy logout function for compatibility
        function logout() {
            if (window.simpleGoogleAuth) {
                window.simpleGoogleAuth.logout();
            } else {
                // Fallback logout
                sessionStorage.removeItem('adminOAuthSession');
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminSession');
                location.reload();
            }
        }

        // Load admin configuration from server
        async function loadAdminConfig() {
            try {
                const response = await fetch('/api/admin-config');
                if (response.ok) {
                    const config = await response.json();
                    window.ADMIN_CONFIG = config;
                } else {
                    console.warn('Failed to load admin config, using defaults');
                }
            } catch (error) {
                console.warn('Error loading admin config:', error);
            }
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load admin configuration first
            await loadAdminConfig();
            console.log('ADMIN_CONFIG loaded:', window.ADMIN_CONFIG);
            
            // OAuth authentication is handled by simple-google-oauth.js
            // The SimpleGoogleOAuth class will automatically check for existing sessions
            // and show/hide the appropriate UI elements
            
            // Clear form fields on page load if authenticated
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                clearFormFields();
                // Load bookings immediately if authenticated
                loadBookings();
            }
            
            // Add a fallback to load bookings after a short delay
            // This ensures bookings are loaded even if there are timing issues
            setTimeout(() => {
                if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                    console.log('🔄 Fallback: Loading bookings...');
                    loadBookings();
                }
            }, 2000);
            
            // Verify critical DOM elements are available
            setTimeout(() => {
                verifyCriticalElements();
            }, 1000);
        });
        
        // Verify critical DOM elements are available
        function verifyCriticalElements() {
            console.log('🔍 Verifying critical DOM elements...');
            
            const criticalElements = [
                'quoteModal',
                'quoteClientName',
                'quoteClientPhone',
                'quoteClientAddress',
                'quoteClientEmail',
                'quoteDate',
                'taxToggle'
            ];
            
            const missingElements = [];
            criticalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (!element) {
                    missingElements.push(elementId);
                }
            });
            
            // Check for service-items-container (which is a class, not an ID)
            const serviceContainer = document.querySelector('.service-items-container');
            if (!serviceContainer) {
                missingElements.push('service-items-container (class)');
            }
            
            if (missingElements.length > 0) {
                console.error('❌ Missing critical elements:', missingElements);
                showNotification(`Missing critical elements: ${missingElements.join(', ')}`, 'error');
            } else {
                console.log('✅ All critical elements found');
            }
        }

        // Clear cached quote and invoice data
        function clearCachedData() {
            currentQuoteData = null;
            currentInvoiceData = null;
            console.log('Cleared cached quote and invoice data');
        }

        // Clear cached data for a specific booking
        function clearCachedDataForBooking(bookingId) {
            if (currentQuoteData && currentQuoteData.bookingId !== bookingId) {
                currentQuoteData = null;
            }
            if (currentInvoiceData && currentInvoiceData.bookingId !== bookingId) {
                currentInvoiceData = null;
            }
            console.log(`Cleared cached data for booking: ${bookingId}`);
        }

        // Clear form fields
        function clearFormFields() {
            // Clear quote form fields
            const quoteFields = [
                'quoteClientName',
                'quoteClientPhone', 
                'quoteClientAddress',
                'quoteClientEmail',
                'quoteDate'
            ];
            
            quoteFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear invoice form fields
            const invoiceFields = [
                'invoiceClientName',
                'invoiceClientPhone',
                'invoiceClientAddress', 
                'invoiceClientEmail',
                'invoiceDate'
            ];
            
            invoiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear service items containers
            const quoteContainer = document.querySelector('.service-items-container');
            const invoiceContainer = document.getElementById('invoiceServiceItems');
            
            if (quoteContainer) {
                quoteContainer.innerHTML = '';
            }
            
            if (invoiceContainer) {
                invoiceContainer.innerHTML = '';
            }
            
            // Reset tax toggles
            const taxToggle = document.getElementById('taxToggle');
            const invoiceTaxToggle = document.getElementById('invoiceTaxToggle');
            
            if (taxToggle) {
                taxToggle.checked = false;
            }
            
            if (invoiceTaxToggle) {
                invoiceTaxToggle.checked = false;
            }
            
            // Reset total display elements to zero
            const totalElements = [
                'subtotalAmount',
                'taxAmount', 
                'grandTotalAmount',
                'invoiceSubtotalAmount',
                'invoiceTaxAmount',
                'invoiceGrandTotalAmount'
            ];
            
            totalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = '$0.00';
                }
            });
            
            console.log('Cleared all form fields and reset totals');
        }

        // Helper function to get admin auth headers
        function getAuthHeaders() {
            console.log('🔍 getAuthHeaders called');
            console.log('🔍 window.simpleGoogleAuth exists:', !!window.simpleGoogleAuth);
            
            if (window.simpleGoogleAuth) {
                console.log('🔍 isUserAuthenticated result:', window.simpleGoogleAuth.isUserAuthenticated());
                console.log('🔍 userProfile:', window.simpleGoogleAuth.userProfile);
                
                if (window.simpleGoogleAuth.isUserAuthenticated()) {
                    const headers = window.simpleGoogleAuth.getAuthHeaders();
                    console.log('🔍 Auth headers returned:', headers);
                    return headers;
                } else {
                    console.log('⚠️ User not authenticated in OAuth system');
                }
            } else {
                console.log('⚠️ simpleGoogleAuth not available');
            }
            
            console.log('⚠️ Returning empty headers - authentication failed');
            return {};
        }

        // Manual refresh function with visual feedback
        async function manualRefreshBookings() {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                refreshBtn.disabled = true;
                
                try {
                    await loadBookings();
                    showNotification('Bookings refreshed successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to refresh bookings', 'error');
                } finally {
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 1000);
                }
            }
        }

        // Load bookings from API
        async function loadBookings() {
            try {
                console.log('🔄 Loading bookings...');
                console.log('🔍 OAuth status:', window.simpleGoogleAuth ? 'Available' : 'Not available');
                console.log('🔍 Authentication status:', window.simpleGoogleAuth ? window.simpleGoogleAuth.isUserAuthenticated() : 'N/A');
                
                // Check if user is authenticated
                if (!window.simpleGoogleAuth || !window.simpleGoogleAuth.isUserAuthenticated()) {
                    console.log('⚠️ User not authenticated, skipping booking load');
                    console.log('🔍 SimpleGoogleAuth object:', window.simpleGoogleAuth);
                    if (window.simpleGoogleAuth) {
                        console.log('🔍 Is authenticated:', window.simpleGoogleAuth.isUserAuthenticated());
                        console.log('🔍 User profile:', window.simpleGoogleAuth.userProfile);
                    }
                    return;
                }
                
                console.log('🔍 Auth headers:', getAuthHeaders());
                
                const response = await fetch('/api/bookings', {
                    headers: getAuthHeaders()
                });
                
                console.log('📊 Response status:', response.status);
                console.log('📊 Response headers:', response.headers);
                
                if (response.ok) {
                    allBookings = await response.json();
                    
                    // Debug: Check for bookings with images
                    const bookingsWithImages = allBookings.filter(booking => booking.images);
                    console.log('✅ Loaded bookings:', allBookings.length);
                    console.log('Bookings with images:', bookingsWithImages.length);
                    if (bookingsWithImages.length > 0) {
                        console.log('Sample booking with images:', bookingsWithImages[0]);
                        console.log('Sample booking images field:', bookingsWithImages[0].images);
                        try {
                            const parsedImages = JSON.parse(bookingsWithImages[0].images);
                            console.log('Parsed images:', parsedImages);
                        } catch (e) {
                            console.error('Error parsing images:', e);
                        }
                    }
                    
                    // Clear cached data when loading bookings only if no modal is open
                    try {
                        const anyModalOpen = document.querySelectorAll('.modal.show').length > 0;
                        if (!anyModalOpen) {
                            clearCachedData();
                        } else {
                            console.log('Skipping cache clear while a modal is open');
                        }
                    } catch (e) {
                        // Fallback to previous behavior on any unexpected DOM errors
                        clearCachedData();
                    }
                    
                    // Update UI components
                    updateStatistics();
                    renderActiveBookings();
                    renderHistory();
                    
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                    
                    // Customer management - REMOVED
                    
                    // Bookings loaded successfully (notification removed)
                    
                } else if (response.status === 401 || response.status === 403) {
                    // Authentication failed, logout
                    console.log('❌ Authentication failed, logging out...');
                    console.log('📊 Response text:', await response.text());
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to load bookings:', response.status, response.statusText);
                    console.error('❌ Error response:', errorText);
                    showNotification('Failed to load bookings', 'error');
                }
            } catch (error) {
                console.error('❌ Error loading bookings:', error);
                console.error('❌ Error stack:', error.stack);
                showNotification('Network error loading bookings', 'error');
            }
        }



        // Update statistics
        function updateStatistics() {
            const stats = {
                pending: allBookings.filter(b => b.status === 'pending').length,
                quoteReady: allBookings.filter(b => b.status === 'quote-ready').length,
                quoteSent: allBookings.filter(b => b.status === 'quote-sent').length,
                pendingBooking: allBookings.filter(b => b.status === 'pending-booking').length,
                invoiceReady: allBookings.filter(b => b.status === 'invoice-ready').length,
                invoiceSent: allBookings.filter(b => b.status === 'invoice-sent').length,
                completed: allBookings.filter(b => b.status === 'completed').length
            };

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('quoteReadyCount').textContent = stats.quoteReady;
            document.getElementById('quoteSentCount').textContent = stats.quoteSent;
            document.getElementById('pendingBookingCount').textContent = stats.pendingBooking;
            document.getElementById('invoiceReadyCount').textContent = stats.invoiceReady;
            document.getElementById('invoiceSentCount').textContent = stats.invoiceSent;
            document.getElementById('completedCount').textContent = stats.completed;
        }

        // Filter by stat card click
        function filterByStatCard(filter) {
            // Find the corresponding filter tab and trigger its click
            const filterTab = document.querySelector(`.filter-tab[data-filter="${filter}"]`);
            if (filterTab) {
                // Remove active class from all tabs
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                
                // Add active class to the clicked filter tab
                filterTab.classList.add('active');
                
                // Update current filter
                currentFilter = filter;
                
                // Update section title
                updateSectionTitle();
                
                // Hide calendar view if it's showing
                const calendarView = document.getElementById('calendarView');
                if (calendarView) {
                    calendarView.style.display = 'none';
                }
                
                // Customer management view - REMOVED
                
                // Show bookings grid
                const activeBookingsGrid = document.getElementById('activeBookingsGrid');
                if (activeBookingsGrid) {
                    activeBookingsGrid.style.display = 'grid';
                }
                
                // Render filtered bookings
                renderActiveBookings();
                
                // Scroll to bookings section smoothly
                const activeBookingsSection = document.querySelector('.active-bookings-section');
                if (activeBookingsSection) {
                    activeBookingsSection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }



        // Render active bookings (pending and scheduled)
        function renderActiveBookings() {
            const grid = document.getElementById('activeBookingsGrid');
            
            // Show loading state if no bookings are loaded yet
            if (!allBookings || allBookings.length === 0) {
                grid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading bookings...</div>';
                return;
            }
            
            // Apply filter
            let filteredBookings = [];
            
            if (currentFilter === 'all') {
                // Show only active bookings (pending, pending-booking, and completed)
                filteredBookings = allBookings.filter(booking => 
                    booking.status === 'pending' || 
                    booking.status === 'quote-ready' || booking.status === 'pending-booking' || 
                    booking.status === 'completed'
                );
            } else if (currentFilter === 'pending') {
                filteredBookings = allBookings.filter(b => b.status === 'pending');

            } else if (currentFilter === 'quote-ready') {
                filteredBookings = allBookings.filter(b => b.status === 'quote-ready');
            } else if (currentFilter === 'quote-sent') {
                filteredBookings = allBookings.filter(b => b.status === 'quote-sent');
            } else if (currentFilter === 'pending-booking') {
                filteredBookings = allBookings.filter(b => b.status === 'pending-booking');
            } else if (currentFilter === 'invoice-ready') {
                filteredBookings = allBookings.filter(b => b.status === 'invoice-ready');
            } else if (currentFilter === 'invoice-sent') {
                filteredBookings = allBookings.filter(b => b.status === 'invoice-sent');
            } else if (currentFilter === 'completed') {
                filteredBookings = allBookings.filter(b => b.status === 'completed');
            } else if (currentFilter === 'all-bookings') {
                // Show all bookings including completed and cancelled
                filteredBookings = allBookings;
            }

            if (filteredBookings.length === 0) {
                grid.innerHTML = '<div class="empty-state">No bookings found</div>';
                return;
            }

            grid.innerHTML = filteredBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const statusClass = `status-${booking.status}`;
                let statusText = '';
                let actionButtons = '';

                // Handle different statuses with appropriate text and buttons
                if (booking.status === 'pending') {
                    statusText = 'Pending Site Visit';
                    actionButtons = `
                        <button class="action-btn confirm" onclick="confirmSiteVisit('${booking.booking_id}')">
                            <i class="fas fa-check"></i> Confirm Visit
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;

                } else if (booking.status === 'quote-ready') {
                    statusText = 'Quote Ready';
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModalWithRetry(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn confirm" onclick="sendQuoteToCustomer('${booking.booking_id}')">
                            <i class="fas fa-paper-plane"></i> Send Quote
                        </button>
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending')" title="Revert to Initial State">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'quote-sent') {
                    statusText = 'Quote Sent - Awaiting Confirmation';
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'quote-ready')" title="Revert to Quote Ready">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'pending-booking') {
                    statusText = 'Job Scheduled - Awaiting Admin Confirmation';
                    actionButtons = `
                        <button class="action-btn confirm" onclick="confirmJob('${booking.booking_id}')">
                            <i class="fas fa-check-double"></i> Confirm Job
                        </button>
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'quote-sent')" title="Revert to Quote Sent">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'invoice-ready') {
                    statusText = 'Invoice Ready';
                    actionButtons = `
                        <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>
                        <button class="action-btn quote" onclick="sendInvoiceFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice-dollar"></i> Send Invoice
                        </button>
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending-booking')" title="Revert to Job Scheduled">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'invoice-sent') {
                    statusText = 'Invoice Sent - Awaiting Payment';
                    actionButtons = `
                        <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice"></i> View Invoice
                        </button>
                        <button class="action-btn confirm" onclick="markInvoicePaid('${booking.booking_id}')">
                            <i class="fas fa-check"></i> Mark as Paid
                        </button>
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'invoice-ready')" title="Revert to Invoice Ready">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'completed') {
                    statusText = 'Completed';
                    actionButtons = `
                        <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending-booking')" title="Revert to Job Scheduled">
                            <i class="fas fa-undo"></i> Revert
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else {
                    // Fallback for any other statuses
                    statusText = booking.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    actionButtons = `
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }

                const cardClass = booking.status === 'completed' ? 'completed' : 
                                 booking.status === 'cancelled' ? 'cancelled' : '';
                
                return `
                    <div class="booking-card ${cardClass}" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                        <div class="booking-header">
                            <div class="booking-id">${booking.booking_id}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="booking-essentials">
                            <div class="essential-row">
                                <i class="fas fa-user essential-icon"></i>
                                <span class="essential-label">Customer:</span>
                                <span class="essential-value">${booking.name}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-calendar essential-icon"></i>
                                <span class="essential-label">Date:</span>
                                <span class="essential-value">${formatBookingDate(booking.date)}${booking.time ? ` at ${booking.time}` : ''}</span>
                            </div>
                            ${booking.job_date && booking.job_time ? `
                            <div class="essential-row job-details">
                                <i class="fas fa-calendar-check essential-icon" style="color: #6f42c1;"></i>
                                <span class="essential-label">Job Date:</span>
                                <span class="essential-value" style="color: #6f42c1; font-weight: 600;">${formatBookingDate(booking.job_date)} at ${booking.job_time}</span>
                            </div>
                            ` : ''}
                            ${booking.estimated_cost ? `
                            <div class="essential-row">
                                <i class="fas fa-dollar-sign essential-icon" style="color: #28a745;"></i>
                                <span class="essential-label">Est. Cost:</span>
                                <span class="essential-value" style="color: #28a745; font-weight: 600;">$${booking.estimated_cost}</span>
                            </div>
                            ` : ''}
                            ${booking.images ? `
                            <div class="booking-images">
                                <div class="images-preview">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.slice(0, 3).map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Old</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-thumbnail" 
                                                                 onclick="event.stopPropagation(); showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Image</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>?</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('') + 
                                                (imageArray.length > 3 ? `
                                                    <div class="more-images">+${imageArray.length - 3}</div>
                                                ` : '');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="booking-actions" onclick="event.stopPropagation();">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
                    // Setup calendar drag and drop after rendering (only for calendar tab)
        if (currentFilter === 'calendar') {
            window.adminCalendar.setupCalendarDragAndDrop();
        }
        }

        // Render history (completed and cancelled)
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            const historyBookings = allBookings.filter(booking => 
                booking.status === 'completed' || booking.status === 'cancelled'
            ).slice(0, 10); // Show last 10

            if (historyBookings.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--admin-secondary); font-style: italic;">No recent activity</div>';
                return;
            }

            container.innerHTML = historyBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const historyDate = formatBookingDate(booking.date);

                return `
                    <div class="history-item ${booking.status}">
                        <h4>${booking.service} - ${booking.name}</h4>
                        <p><strong>ID:</strong> ${booking.booking_id}</p>
                        <p><strong>Date:</strong> ${dateTime}</p>
                        <p><strong>Email:</strong> ${booking.email}</p>
                        <p><strong>Phone:</strong> ${booking.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${booking.address || 'N/A'}</p>
                        <p class="history-date">${booking.status} - Booked for ${historyDate}</p>
                    </div>
                `;
            }).join('');
        }

        // Update booking status with intelligent reversion logic
        async function updateBookingStatus(bookingId, newStatus) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = newStatus;

                // Intelligent status reversion logic
                if (currentStatus === 'completed' && newStatus !== 'completed') {
                    // When reverting from completed, go back to invoice-sent (the status before completion)
                    targetStatus = 'invoice-sent';
                    console.log(`🔄 Reverting from 'completed' to '${targetStatus}' (previous workflow status)`);
                    console.log(`📋 Original requested status: ${newStatus}, but reverting to: ${targetStatus}`);
                }

                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (response.ok) {
                    const statusMessage = currentStatus === 'completed' && newStatus !== 'completed' 
                        ? `Booking reverted from completed to ${targetStatus} successfully` 
                        : `Booking ${targetStatus} successfully`;
                    showNotification(statusMessage, 'success');
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking', 'error');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showNotification('Network error updating booking', 'error');
            }
        }

        // Confirm quote and send email to customer
        async function confirmQuoteAndSendEmail(bookingId) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = 'pending-booking';

                // Intelligent status reversion logic
                if (currentStatus === 'completed') {
                    // When confirming quote from completed status, go back to invoice-sent first
                    targetStatus = 'invoice-sent';
                    console.log(`🔄 Reverting from 'completed' to '${targetStatus}' before confirming quote`);
                    console.log(`📋 Original requested status: pending-booking, but reverting to: ${targetStatus}`);
                }

                // First, update the booking status
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking status', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send email to customer with quote confirmation and booking link
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-quote-confirmation-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name,
                        estimatedCost: booking.estimated_cost || 'TBD',
                        workDescription: booking.work_description || booking.notes || 'Tree service as requested'
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    const successMessage = currentStatus === 'completed' 
                        ? 'Quote confirmed and email sent! Status reverted from completed to invoice-sent.' 
                        : 'Quote confirmed and confirmation email sent successfully!';
                    showNotification(successMessage, 'success');
                    console.log('📧 Quote confirmation email sent:', emailResult.messageId);
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else {
                    const emailError = await emailResponse.json();
                    const warningMessage = currentStatus === 'completed'
                        ? `Quote confirmed but email failed: ${emailError.error}. Status reverted from completed to invoice-sent.`
                        : `Quote confirmed but email failed: ${emailError.error}`;
                    showNotification(warningMessage, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming quote:', error);
                showNotification('Network error confirming quote', 'error');
            }
        }

        // Confirm job (admin confirms customer's job booking)
        async function confirmJob(bookingId) {
            try {
                // Update the booking status to 'invoice-ready' (Ready to create invoice)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'invoice-ready' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to confirm job', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                showNotification('Job confirmed successfully! Ready to create invoice.', 'success');
                
                // Auto-switch to the invoice-ready tab
                autoSwitchToNextTab('invoice-ready');
                
                loadBookings(); // Reload to update the display
                
                // Explicitly refresh calendar if it's currently visible
                if (currentFilter === 'calendar') {
                    window.adminCalendar.renderCalendar();
                }
            } catch (error) {
                console.error('Error confirming job:', error);
                showNotification('Network error confirming job', 'error');
            }
        }

        // Confirm booking (admin confirms customer's booking request)
        async function confirmBooking(bookingId) {
            try {
                // Update the booking status to 'completed' (Completed Booking)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to confirm booking', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send confirmation email to customer
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-confirmation-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    showNotification('Booking confirmed and confirmation email sent successfully', 'success');
                    console.log('📧 Confirmation email sent:', emailResult.emailContent);
                    
                    // Auto-switch to the completed tab
                    autoSwitchToNextTab('completed');
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else {
                    const emailError = await emailResponse.json();
                    showNotification(`Booking confirmed but email failed: ${emailError.error}`, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showNotification('Network error confirming booking', 'error');
            }
        }

        // Check for quote and complete booking
        async function checkForQuoteAndComplete(bookingId) {
            try {
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Check if there's a quote for this booking
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`, {
                    headers: getAuthHeaders()
                });
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const latestQuote = quotes[0];
                        showInvoiceModal(latestQuote, booking);
                    } else {
                        // No quote found, ask user if they want to create one
                        if (confirm('No quote found for this booking. Would you like to create a quote first?')) {
                            showQuoteModal(booking);
                        } else {
                            // Complete without quote
                            await updateBookingStatus(bookingId, 'completed');
                        }
                    }
                } else {
                    showNotification('Error checking for quotes', 'error');
                }
            } catch (error) {
                console.error('Error checking for quote:', error);
                showNotification('Network error checking for quote', 'error');
            }
        }

        // Delete booking permanently
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to permanently delete this booking? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Booking deleted successfully', 'success');
                    loadBookings(); // Reload to get updated data
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || error.message || 'Failed to delete booking', 'error');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showNotification('Network error deleting booking', 'error');
            }
        }

        // Filter functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update filter
                currentFilter = e.target.dataset.filter;
                updateSectionTitle();
                
                // Show/hide appropriate view
                if (currentFilter === 'calendar') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'block';
                    window.adminCalendar.loadBlockedDates().then(() => window.adminCalendar.renderCalendar());
                } else {
                    document.getElementById('activeBookingsGrid').style.display = 'grid';
                    document.getElementById('calendarView').style.display = 'none';
                    renderActiveBookings();
                }
            }
        });

        // Update section title based on current filter
        function updateSectionTitle() {
            const sectionTitle = document.getElementById('sectionTitle');
            switch (currentFilter) {
                case 'all':
                    sectionTitle.textContent = 'Request Quote';
                    break;
                case 'pending':
                    sectionTitle.textContent = 'Pending Site Visit';
                    break;

                case 'quote-ready':
                    sectionTitle.textContent = 'Quote Ready';
                    break;
                case 'quote-sent':
                    sectionTitle.textContent = 'Quote Sent';
                    break;

                case 'pending-booking':
                    sectionTitle.textContent = 'Job Scheduled - Awaiting Admin Confirmation';
                    break;
                case 'invoice-ready':
                    sectionTitle.textContent = 'Invoice Ready';
                    break;
                case 'invoice-sent':
                    sectionTitle.textContent = 'Invoice Sent';
                    break;
                case 'completed':
                    sectionTitle.textContent = 'Completed';
                    break;
                case 'all-bookings':
                    sectionTitle.textContent = 'All Bookings';
                    break;
                case 'calendar':
                    sectionTitle.textContent = 'Calendar';
                    break;
                default:
                    sectionTitle.textContent = 'Request Quote';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }















        function closeBookingModal() {
            document.getElementById('bookingDetailsModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }









        function showBookingDetailsPopup(bookingId) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const createdDate = new Date(booking.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const statusClass = `status-${booking.status}`;
            let statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

            let actionButtons = '';
            if (booking.status === 'pending') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'pending-booking')">
                        <i class="fas fa-check"></i> Schedule Job
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="window.adminCalendar.showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;

            } else if (booking.status === 'completed') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                                            <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending-booking')" title="Revert to Job Scheduled">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'cancelled') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn reopen" onclick="updateBookingStatus('${booking.booking_id}', 'pending')">
                        <i class="fas fa-redo"></i> Reopen
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'pending-booking')">
                        <i class="fas fa-check"></i> Schedule Job
                    </button>
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn move" onclick="window.adminCalendar.showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'invoice-ready') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice"></i> Invoice
                    </button>
                    <button class="action-btn quote" onclick="sendInvoiceFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice-dollar"></i> Send Invoice
                    </button>
                                            <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending-booking')" title="Revert to Job Scheduled">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'invoice-sent') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice"></i> View Invoice
                    </button>
                    <button class="action-btn confirm" onclick="markInvoicePaid('${booking.booking_id}')">
                        <i class="fas fa-check"></i> Mark as Paid
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'invoice-ready')" title="Revert to Invoice Ready">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else {
                // Fallback for any other statuses
                statusText = booking.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            }

            const modalBody = document.getElementById('bookingDetailsPopupBody');
            modalBody.innerHTML = `
                <div class="detail-popup-grid">
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-info-circle"></i> Booking Info</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">ID:</span>
                            <span class="detail-popup-value">${booking.booking_id}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Status:</span>
                            <span class="detail-popup-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Service:</span>
                            <span class="detail-popup-value">${booking.service}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-calendar-alt"></i> Schedule</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Date:</span>
                            <span class="detail-popup-value">${dateTime}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Booking Date:</span>
                            <span class="detail-popup-value">${(() => {
                                const [year, month, day] = booking.date.split('-').map(Number);
                                const date = new Date(year, month - 1, day);
                                return date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                            })()}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-user"></i> Customer</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Name:</span>
                            <span class="detail-popup-value">${booking.name}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Email:</span>
                            <span class="detail-popup-value">${booking.email}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Phone:</span>
                            <span class="detail-popup-value">${booking.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Address:</span>
                            <span class="detail-popup-value">
                                ${booking.address ? 
                                    `<a href="https://maps.google.com/?q=${encodeURIComponent(booking.address)}" target="_blank" class="clickable-address" title="Click to open in Google Maps">
                                        <i class="fas fa-map-marker-alt"></i> ${booking.address}
                                    </a>` 
                                    : 'Not provided'
                                }
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Notes:</span>
                            <div class="detail-popup-value">
                                <textarea id="bookingNotes" class="notes-textarea" placeholder="Add your personal notes here...">${booking.notes || ''}</textarea>
                                <button class="action-btn confirm" onclick="updateBookingNotes('${booking.booking_id}')" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Save Notes
                                </button>
                            </div>
                        </div>
                        ${booking.images ? `
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Images:</span>
                            <div class="detail-popup-value">
                                <div class="booking-images-detail">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Old Image (Not Available)</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-detail" 
                                                                 onclick="showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder-detail" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Image Unavailable</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Unknown Format</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking details:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${actionButtons ? `
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-cogs"></i> Actions</h4>
                        <div class="detail-popup-actions">
                            ${actionButtons}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            openModal('bookingDetailsPopupModal');
        }

        function closeBookingDetailsPopup() {
            document.getElementById('bookingDetailsPopupModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }



































        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.bookingId);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const bookingId = e.dataTransfer.getData('text/plain');
            const newDate = day.dataset.date;

            if (!newDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ newDate: newDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }

            day.classList.remove('drag-over');
        }

        // Update booking notes
        async function updateBookingNotes(bookingId) {
            const notesTextarea = document.getElementById('bookingNotes');
            const notes = notesTextarea.value.trim();

            try {
                const response = await fetch(`/api/bookings/${bookingId}/notes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ notes: notes })
                });

                if (response.ok) {
                    showNotification('Notes updated successfully', 'success');
                    // Update the booking in the local array
                    const booking = allBookings.find(b => b.booking_id === bookingId);
                    if (booking) {
                        booking.notes = notes;
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update notes', 'error');
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                showNotification('Network error updating notes', 'error');
            }
        }

        // Modal management functions
        function closeModal(modalId) {
            console.log('Attempting to close modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal found, removing show class');
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Don't manually set display: none - let CSS handle it
                // modal.style.display = 'none';
                
                // Additional debugging
                console.log('Modal classes after removal:', modal.className);
                console.log('Modal display style:', modal.style.display);
                console.log('Modal closed successfully');
                
                // Check if there are any other modals that might be interfering
                const allModals = document.querySelectorAll('.modal');
                console.log('Total modals found:', allModals.length);
                allModals.forEach((m, index) => {
                    console.log(`Modal ${index}:`, m.id, 'classes:', m.className, 'display:', m.style.display);
                });
            } else {
                console.log('Modal not found with ID:', modalId);
                
                // Check if there are any modals with similar names
                const allModals = document.querySelectorAll('.modal');
                console.log('All modals found:', Array.from(allModals).map(m => m.id));
            }
        }

        // Enhanced modal closing function that tries multiple methods
        function forceCloseModal(modalId) {
            console.log('Force closing modal:', modalId);
            
            // Method 1: Standard closeModal
            closeModal(modalId);
            
            // Method 2: Find all modals and close any that might be visible
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal.classList.contains('show') || modal.style.display !== 'none') {
                    console.log('Force closing visible modal:', modal.id);
                    modal.classList.remove('show');
                    // Don't set display: none manually - let CSS handle it
                    // modal.style.display = 'none';
                }
            });
            
            // Method 3: Remove modal-open class from body
            document.body.classList.remove('modal-open');
            
            // Method 4: Force remove any backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop, .modal-overlay');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Method 5: Reset any manually set display styles to allow CSS to work properly
            const targetModal = document.getElementById(modalId);
            if (targetModal && targetModal.style.display === 'none') {
                console.log('Resetting manually set display style for modal:', modalId);
                targetModal.style.removeProperty('display');
            }
        }

        function openModal(modalId) {
            console.log('🔍 openModal called with modalId:', modalId);
            
            // Add retry mechanism for modal opening
            let retryCount = 0;
            const maxRetries = 3;
            
            function attemptOpenModal() {
                const modal = document.getElementById(modalId);
                console.log(`🔍 Attempt ${retryCount + 1}: Modal element found:`, modal);
                
                if (modal) {
                    try {
                        // Ensure any manually set display styles are removed so CSS can work
                        if (modal.style.display === 'none') {
                            console.log('🔄 Removing manually set display style for modal:', modalId);
                            modal.style.removeProperty('display');
                        }
                        
                        // Ensure modal is visible and properly positioned
                        modal.style.visibility = 'visible';
                        modal.style.opacity = '1';
                        
                        modal.classList.add('show');
                        document.body.classList.add('modal-open');
                        console.log('✅ Modal opened successfully:', modalId);
                        
                        // Verify modal is actually visible
                        setTimeout(() => {
                            const isVisible = modal.classList.contains('show') && 
                                            modal.style.display !== 'none' && 
                                            modal.style.visibility !== 'hidden' && 
                                            modal.style.opacity !== '0';
                            
                            if (isVisible) {
                                console.log('✅ Modal visibility confirmed:', modalId);
                            } else {
                                console.log('ℹ️ Modal status:', {
                                    hasShowClass: modal.classList.contains('show'),
                                    display: modal.style.display,
                                    visibility: modal.style.visibility,
                                    opacity: modal.style.opacity
                                });
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('❌ Error opening modal:', modalId, error);
                        showNotification(`Error opening ${modalId}`, 'error');
                    }
                } else {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.warn(`⚠️ Modal not found, retrying in 100ms (attempt ${retryCount}/${maxRetries}):`, modalId);
                        setTimeout(attemptOpenModal, 100);
                    } else {
                        console.error(`❌ Modal not found after ${maxRetries} attempts:`, modalId);
                        showNotification(`Modal ${modalId} not found`, 'error');
                    }
                }
            }
            
            attemptOpenModal();
        }

        // Close modal when clicking outside
        function setupModalClickOutside() {
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // Close modal with Escape key
        function setupModalEscapeKey() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    if (modals.length > 0) {
                        closeModal(modals[0].id);
                    }
                }
            });
        }

        // Initialize modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            setupModalClickOutside();
            setupModalEscapeKey();
            
            // Add test function to global scope for debugging
            window.testModalClosing = function() {
                console.log('Testing modal closing...');
                const allModals = document.querySelectorAll('.modal');
                console.log('Found modals:', Array.from(allModals).map(m => m.id));
                
                allModals.forEach(modal => {
                    console.log(`Modal ${modal.id}:`, {
                        classes: modal.className,
                        display: modal.style.display,
                        hasShow: modal.classList.contains('show')
                    });
                });
                
                // Try to close any visible modals
                allModals.forEach(modal => {
                    if (modal.classList.contains('show') || modal.style.display !== 'none') {
                        console.log(`Closing visible modal: ${modal.id}`);
                        forceCloseModal(modal.id);
                    }
                });
            };
            
                    // Add function to reset all modals to proper state
        window.resetAllModals = function() {
            console.log('Resetting all modals to proper state...');
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                // Remove any manually set display styles
                if (modal.style.display === 'none') {
                    modal.style.removeProperty('display');
                    console.log('Reset display style for modal:', modal.id);
                }
                // Remove show class
                modal.classList.remove('show');
            });
            document.body.classList.remove('modal-open');
            console.log('All modals reset successfully');
        };
        
        // Add function to diagnose quote modal issues
        window.diagnoseQuoteModal = function() {
            console.log('🔍 Diagnosing quote modal...');
            
            const modal = document.getElementById('quoteModal');
            const serviceContainer = document.querySelector('.service-items-container');
            
            console.log('Quote modal element:', modal);
            console.log('Service container:', serviceContainer);
            
            if (modal) {
                console.log('Modal properties:', {
                    id: modal.id,
                    className: modal.className,
                    style: modal.style.cssText,
                    display: modal.style.display,
                    visibility: modal.style.visibility,
                    opacity: modal.style.opacity,
                    offsetParent: modal.offsetParent,
                    clientWidth: modal.clientWidth,
                    clientHeight: modal.clientHeight
                });
                
                console.log('Modal classes:', Array.from(modal.classList));
                console.log('Modal computed styles:', window.getComputedStyle(modal));
            }
            
            if (serviceContainer) {
                console.log('Service container properties:', {
                    className: serviceContainer.className,
                    children: serviceContainer.children.length,
                    innerHTML: serviceContainer.innerHTML.substring(0, 200) + '...'
                });
            }
            
            // Check for any JavaScript errors
            console.log('Current error count:', window.errorCount || 0);
            console.log('Modal open attempts:', window.modalOpenAttempts || 0);
        };
            
            // Add global error handler for unhandled errors
            window.addEventListener('error', function(event) {
                console.error('🚨 Global error caught:', event.error);
                console.error('🚨 Error details:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno
                });
                
                // Show user-friendly error message
                if (event.error && event.error.message) {
                    showNotification(`Error: ${event.error.message}`, 'error');
                }
            });
            
            // Add function to force open quote modal (fallback)
            window.forceOpenQuoteModal = function(bookingData) {
                console.log('🚨 Force opening quote modal with data:', bookingData);
                try {
                    // Ensure modal exists
                    const modal = document.getElementById('quoteModal');
                    if (!modal) {
                        console.error('❌ Quote modal still not found, creating fallback...');
                        createFallbackQuoteModal();
                        return;
                    }
                    
                    // Force show modal
                    modal.style.display = 'block';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    console.log('✅ Quote modal forced open');
                    
                    // Load data if available
                    if (bookingData) {
                        showQuoteModal(bookingData);
                    }
                    
                } catch (error) {
                    console.error('❌ Error in force open:', error);
                    showNotification('Error opening quote modal', 'error');
                }
            };
        });
        
                // Create fallback quote modal if original is missing
        function createFallbackQuoteModal() {
            console.log('🔧 Creating fallback quote modal...');
            
            const fallbackModal = document.createElement('div');
            fallbackModal.id = 'quoteModal';
            fallbackModal.className = 'modal show';
            fallbackModal.innerHTML = `
                <div class="modal-content quote-modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote (Fallback)</h3>
                        <button class="modal-close" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Quote modal loaded in fallback mode. Please refresh the page for full functionality.</p>
                        <button onclick="location.reload()" class="btn-primary">Refresh Page</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(fallbackModal);
            console.log('✅ Fallback quote modal created');
        }
        
        // Mobile Menu Functionality
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const navLinks = document.querySelector('.nav-links');
        const menuIcon = mobileMenuToggle.querySelector('i');

        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');

            // Toggle icon between bars and times with rotation
            if (navLinks.classList.contains('active')) {
                menuIcon.classList.remove('fa-bars');
                menuIcon.classList.add('fa-times');
                menuIcon.style.transform = 'rotate(180deg)';
            } else {
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking on a link
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Handle window resize for calendar layout
        window.addEventListener('resize', function() {
            if (currentFilter === 'calendar') {
                window.adminCalendar.renderCalendar();
            }
        });

        // Auto-refresh every 30 seconds with improved reliability
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                console.log('🔄 Auto-refresh: Loading bookings...');
                loadBookings();
            }
        }, 30000);
        
        // Additional fallback refresh every 60 seconds to ensure data stays fresh
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                console.log('🔄 Fallback refresh: Loading bookings...');
                loadBookings();
            }
        }, 60000);

        // Debug function for testing authentication and booking loading
        window.debugAdminPanel = function() {
            console.log('🔍 === ADMIN PANEL DEBUG ===');
            console.log('🔍 SimpleGoogleAuth available:', !!window.simpleGoogleAuth);
            if (window.simpleGoogleAuth) {
                console.log('🔍 Is authenticated:', window.simpleGoogleAuth.isUserAuthenticated());
                console.log('🔍 User profile:', window.simpleGoogleAuth.userProfile);
                console.log('🔍 Auth headers:', window.simpleGoogleAuth.getAuthHeaders());
            }
            console.log('🔍 All bookings loaded:', allBookings ? allBookings.length : 0);
            console.log('🔍 Current filter:', currentFilter);
            console.log('🔍 === END DEBUG ===');
        };

        // Test server connection
        window.testServerConnection = async function() {
            try {
                console.log('🔄 Testing server connection...');
                const response = await fetch('/api/test');
                const data = await response.json();
                console.log('✅ Server test response:', data);
                return data;
            } catch (error) {
                console.error('❌ Server test failed:', error);
                return null;
            }
        };

        // Quote Generation Variables
        let currentQuoteData = null;
        let itemCounter = 1;
        let currentSiteVisitData = null;

        // Show Site Visit Modal
        function showSiteVisitModal(bookingId) {
            currentSiteVisitData = { bookingId: bookingId };
            
            // Set default date to today
            document.getElementById('recommendedDate').value = new Date().toISOString().split('T')[0];
            
            // Clear form
            document.getElementById('siteVisitForm').reset();
            
            openModal('siteVisitModal');
        }

        // Complete Site Visit Assessment
        async function completeSiteVisit() {
            const form = document.getElementById('siteVisitForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const workDescription = formData.get('workDescription');
            const estimatedCost = parseFloat(formData.get('estimatedCost'));
            const siteVisitNotes = formData.get('siteVisitNotes');
            const recommendedDate = formData.get('recommendedDate');
            const recommendedTime = formData.get('recommendedTime');

            try {
                // Update booking status to 'quote-ready'
                const statusResponse = await fetch(`/api/bookings/${currentSiteVisitData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        status: 'quote-ready',
                        work_description: workDescription,
                        estimated_cost: estimatedCost,
                        site_visit_notes: siteVisitNotes,
                        recommended_date: recommendedDate,
                        recommended_time: recommendedTime
                    })
                });

                if (!statusResponse.ok) {
                    const error = await statusResponse.json();
                    showNotification(error.error || 'Failed to update booking status', 'error');
                    return;
                }

                // Send quote ready email to customer
                const booking = allBookings.find(b => b.booking_id === currentSiteVisitData.bookingId);
                if (booking) {
                    const emailResponse = await fetch(`/api/bookings/${currentSiteVisitData.bookingId}/send-quote-ready-email`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            bookingId: currentSiteVisitData.bookingId,
                            customerEmail: booking.email,
                            customerName: booking.name,
                            workDescription: workDescription,
                            estimatedCost: estimatedCost
                        })
                    });

                    if (emailResponse.ok) {
                        showNotification('Site visit completed and quote ready email sent successfully!', 'success');
                    } else {
                        showNotification('Site visit completed but email failed to send', 'warning');
                    }
                }

                closeModal('siteVisitModal');
                loadBookings(); // Reload to update the display
                
            } catch (error) {
                console.error('Error completing site visit:', error);
                showNotification('Network error completing site visit', 'error');
            }
        }

        // Show Quote Modal with Retry
        async function showQuoteModalWithRetry(booking) {
            // Add loading state to the quote button
            const quoteButton = event?.target?.closest('.action-btn.quote');
            if (quoteButton) {
                quoteButton.classList.add('loading');
                quoteButton.disabled = true;
            }
            
            let retryCount = 0;
            const maxRetries = 3;
            
            async function attemptShowModal() {
                try {
                    await showQuoteModal(booking);
                    
                    // Remove loading state
                    if (quoteButton) {
                        quoteButton.classList.remove('loading');
                        quoteButton.disabled = false;
                    }
                    
                } catch (error) {
                    retryCount++;
                    console.warn(`Attempt ${retryCount} failed:`, error);
                    
                    if (retryCount < maxRetries) {
                        setTimeout(attemptShowModal, 200);
                    } else {
                        console.error(`All ${maxRetries} attempts failed, using fallback`);
                        showNotification('Quote modal failed to open, using fallback', 'warning');
                        
                        // Remove loading state
                        if (quoteButton) {
                            quoteButton.classList.remove('loading');
                            quoteButton.disabled = false;
                        }
                        
                        // Use fallback method
                        if (window.forceOpenQuoteModal) {
                            window.forceOpenQuoteModal(booking);
                        } else {
                            // Last resort: reload page
                            showNotification('Reloading page to fix modal issue', 'info');
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                }
            }
            
            attemptShowModal();
        }

        // Show Quote Modal
        async function showQuoteModal(booking) {
            try {
                // If booking is passed as a string (from onclick), parse it
                if (typeof booking === 'string') {
                    try {
                        booking = JSON.parse(booking);
                    } catch (e) {
                        console.error('Error parsing booking data:', e);
                        showNotification('Error loading booking data', 'error');
                        return;
                    }
                }

                // Validate booking object
                if (!booking || !booking.booking_id) {
                    console.error('Invalid booking object:', booking);
                    showNotification('Invalid booking data', 'error');
                    return;
                }

                // Ensure modal elements are available
                const quoteModal = document.getElementById('quoteModal');
                const serviceContainer = document.querySelector('.service-items-container');
                
                if (!quoteModal) {
                    console.error('Quote modal not found in DOM');
                    showNotification('Quote modal not found', 'error');
                    return;
                }
                
                if (!serviceContainer) {
                    console.error('Service items container not found in DOM');
                    showNotification('Service items container not found', 'error');
                    return;
                }

                // Clear cached data only if switching to a different booking
                if (currentQuoteData && currentQuoteData.bookingId !== booking.booking_id) {
                    clearCachedDataForBooking(booking.booking_id);
                }

                currentQuoteData = {
                    bookingId: booking.booking_id,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes
                };

                // Check if there's an existing quote for this booking
                try {
                    const quoteResponse = await fetch(`/api/quotes/booking/${booking.booking_id}`, {
                        headers: getAuthHeaders()
                    });
                    if (quoteResponse.ok) {
                        const quotes = await quoteResponse.json();
                        if (quotes.length > 0) {
                            // Use the most recent quote
                            const existingQuote = quotes[0];
                            loadExistingQuote(existingQuote);
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking for existing quotes:', error);
                    // Continue with creating new quote even if check fails
                }

                // No existing quote found, create new one
                loadNewQuote(booking);
                
            } catch (error) {
                console.error('❌ Unexpected error in showQuoteModal:', error);
                showNotification('Unexpected error opening quote modal', 'error');
            }
        }

        // Load existing quote data
        function loadExistingQuote(quote) {
            try {
                // Reset item counter when opening quote modal
                itemCounter = 0;
                
                // Store the quote ID for updates
                currentQuoteData.quoteId = quote.quote_id;

                // Pre-fill client information from saved quote
                const nameField = document.getElementById('quoteClientName');
                const phoneField = document.getElementById('quoteClientPhone');
                const addressField = document.getElementById('quoteClientAddress');
                const emailField = document.getElementById('quoteClientEmail');
                const dateField = document.getElementById('quoteDate');
                
                if (nameField) nameField.value = quote.client_name || '';
                if (phoneField) phoneField.value = quote.client_phone || '';
                if (addressField) addressField.value = quote.client_address || '';
                if (emailField) emailField.value = quote.client_email || '';
                if (dateField) dateField.value = quote.quote_date || new Date().toISOString().split('T')[0];

                // Load service items from saved quote
                // Handle both string and object formats
                let serviceItems;
                
                if (typeof quote.service_items === 'string') {
                    try {
                        serviceItems = JSON.parse(quote.service_items);
                    } catch (e) {
                        console.error('Error parsing service items:', e);
                        serviceItems = [];
                    }
                } else {
                    serviceItems = quote.service_items || [];
                }
                
                loadServiceItems(serviceItems);

                // Set tax toggle
                const taxToggle = document.getElementById('taxToggle');
                if (taxToggle) {
                    taxToggle.checked = quote.tax_enabled || false;
                }

                // Update totals
                updateQuoteTotals();

                // Setup event listeners for all service items
                document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

                // Show modal
                openModal('quoteModal');
                
                // Load photos for service items if this is an existing quote
                if (currentQuoteData && currentQuoteData.quoteId) {
                    setTimeout(() => loadQuotePhotos(), 100);
                }
                
            } catch (error) {
                console.error('Error in loadExistingQuote:', error);
                showNotification('Error loading existing quote', 'error');
            }
        }

        // Load new quote (no existing data)
        function loadNewQuote(booking) {
            try {
                // Clear any previous form data and totals first
                clearFormFields();
                
                // Reset item counter when opening quote modal
                itemCounter = 0;
                
                // Set current quote data with booking information
                currentQuoteData = {
                    bookingId: booking.booking_id,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes
                };
                
                // Pre-fill client information from booking
                const nameField = document.getElementById('quoteClientName');
                const phoneField = document.getElementById('quoteClientPhone');
                const addressField = document.getElementById('quoteClientAddress');
                const emailField = document.getElementById('quoteClientEmail');
                const dateField = document.getElementById('quoteDate');
                
                if (nameField) nameField.value = booking.name || '';
                if (phoneField) phoneField.value = booking.phone || '';
                if (addressField) addressField.value = booking.address || '';
                if (emailField) emailField.value = booking.email || '';
                if (dateField) dateField.value = new Date().toISOString().split('T')[0];

                // Create initial service item with booking service
                const initialServiceItem = {
                    description: booking.service || 'Tree Service',
                    quantity: 1,
                    price: 0,
                    total: 0
                };

                // Load service items (this will clear container and recreate)
                loadServiceItems([initialServiceItem]);

                // Reset tax toggle
                const taxToggle = document.getElementById('taxToggle');
                if (taxToggle) {
                    taxToggle.checked = false;
                }
                
                // Update totals to reflect the new service items (should show $0.00)
                updateQuoteTotals();

                // Show modal
                openModal('quoteModal');
                
                // Load photos for service items if this is an existing quote
                if (currentQuoteData && currentQuoteData.quoteId) {
                    setTimeout(() => loadQuotePhotos(), 100);
                }
                
            } catch (error) {
                console.error('Error in loadNewQuote:', error);
                showNotification('Error loading new quote', 'error');
            }
        }

        // Load service items from saved quote
        function loadServiceItems(serviceItems) {
            const container = document.querySelector('.service-items-container');
            
            // Clear existing items
            container.innerHTML = '';

            console.log('Loading service items:', serviceItems);
            console.log('Service items count:', serviceItems.length);
            console.log('Current itemCounter before loading:', itemCounter);

            if (serviceItems.length === 0) {
                // Add one empty item if no items exist
                addServiceItem();
                return;
            }

            // Reset item counter to start fresh
            itemCounter = 0;

            // Load each service item
            serviceItems.forEach((item, index) => {
                itemCounter++;
                console.log(`Loading service item ${index + 1}:`, item);
                
                const newItem = document.createElement('div');
                newItem.className = 'service-item';
                newItem.setAttribute('data-item-id', itemCounter);

                // Calculate the item total
                const quantity = parseFloat(item.quantity) || 1;
                const price = parseFloat(item.price) || 0;
                const itemTotal = quantity * price;

                console.log(`Item ${index + 1} calculation: ${quantity} x $${price} = $${itemTotal}`);

                newItem.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description || ''}" placeholder="Service description">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${quantity}" min="1">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${price}" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${itemTotal.toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-photos-section">
                        <div class="photos-header">
                            <span class="photos-label">Photos:</span>
                            <button type="button" class="add-photo-btn" onclick="addPhotoToServiceItem(this)">
                                <i class="fas fa-camera"></i> Add Photo
                            </button>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                    </div>
                `;

                container.appendChild(newItem);
                setupItemEventListeners(newItem);
            });

            console.log('Final itemCounter after loading:', itemCounter);
            console.log('Total service items in DOM:', container.querySelectorAll('.service-item').length);

            // Force update totals after loading all items
            setTimeout(() => {
                console.log('Forcing update of quote totals...');
                updateQuoteTotals();
                
                // Verify the totals are correct
                const finalSubtotal = document.getElementById('subtotalAmount').textContent;
                const finalTotal = document.getElementById('grandTotalAmount').textContent;
                console.log('Final totals after loading:', { subtotal: finalSubtotal, total: finalTotal });
            }, 100);
        }

        // Add Service Item
        function addServiceItem() {
            console.log('addServiceItem called, current itemCounter:', itemCounter);
            itemCounter++;
            const container = document.querySelector('.service-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photos-header">
                        <span class="photos-label">Photos:</span>
                        <button type="button" class="add-photo-btn" onclick="addPhotoToServiceItem(this)">
                            <i class="fas fa-camera"></i> Add Photo
                        </button>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                </div>
            `;

            container.appendChild(newItem);
            setupItemEventListeners(newItem);
        }

        // Remove Service Item
        function removeServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('.service-item').length > 1) {
                serviceItem.remove();
                updateQuoteTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Service Items
        function setupItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateItemTotal);
            priceInput.removeEventListener('input', updateItemTotal);

            qtyInput.addEventListener('input', updateItemTotal);
            priceInput.addEventListener('input', updateItemTotal);

            function updateItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateQuoteTotals();
            }

            // Initialize the total for this item
            updateItemTotal();
        }

        // Update Quote Totals
        function updateQuoteTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('.service-item');

            items.forEach((item, index) => {
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const itemTotal = qty * price;
                
                subtotal += itemTotal;
            });

            const taxToggle = document.getElementById('taxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            // Format numbers with proper decimal places
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Tax
        function toggleTax() {
            updateQuoteTotals();
        }

        // Service Item Photo Management Functions
        
        // Add photo button click handler
        function addPhotoToServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }

        // Handle photo upload - Store files temporarily, don't upload to server yet
        function handlePhotoUpload(fileInput) {
            const serviceItem = fileInput.closest('.service-item');
            const files = fileInput.files;
            
            if (!files || files.length === 0) return;
            
            // Store files temporarily in the service item
            const tempPhotos = Array.from(files).map(file => ({
                file: file,
                preview: URL.createObjectURL(file),
                name: file.name
            }));
            
            // Store temp photos in the service item data
            if (!serviceItem.tempPhotos) {
                serviceItem.tempPhotos = [];
            }
            serviceItem.tempPhotos.push(...tempPhotos);
            
            // Display temp photos
            displayTempPhotos(serviceItem);
            
            // Clear the file input
            fileInput.value = '';
            
            showNotification(`${tempPhotos.length} photos added (will be saved with quote)`, 'info');
        }

        // Display temporary photos (not yet uploaded) - preserves existing saved photos
        function displayTempPhotos(serviceItem) {
            const photosContainer = serviceItem.querySelector('.photos-container');
            
            // Don't clear the container - preserve existing saved photos
            // Just add the new temp photos at the end
            
            if (!serviceItem.tempPhotos || serviceItem.tempPhotos.length === 0) {
                // If no temp photos, don't change anything
                return;
            }

            // Add temp photos to the existing container
            serviceItem.tempPhotos.forEach((tempPhoto, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item temp-photo';
                photoElement.innerHTML = `
                    <img src="${tempPhoto.preview}" alt="Service item photo" onclick="showPhotoModal('${tempPhoto.preview}')">
                    <button type="button" class="delete-photo-btn" onclick="removeTempPhoto(${index}, this)">
                        🗑️
                    </button>
                    <div class="temp-photo-label">Pending</div>
                `;
                photosContainer.appendChild(photoElement);
            });
        }

        // Remove temporary photo
        function removeTempPhoto(index, button) {
            const serviceItem = button.closest('.service-item');
            const photoElement = button.closest('.photo-item');
            
            // Revoke object URL to free memory
            const img = photoElement.querySelector('img');
            if (img && img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }
            
            // Remove from temp photos array
            serviceItem.tempPhotos.splice(index, 1);
            
            // Remove just this temp photo element from DOM
            photoElement.remove();
            
            // If no temp photos left and no saved photos, show "no photos" message
            const photosContainer = serviceItem.querySelector('.photos-container');
            const tempPhotos = photosContainer.querySelectorAll('.temp-photo');
            const savedPhotos = photosContainer.querySelectorAll('.photo-item:not(.temp-photo)');
            
            if (tempPhotos.length === 0 && savedPhotos.length === 0) {
                photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
            }
        }

        // Load photos for a service item
        async function loadServiceItemPhotos(serviceItem, quoteId, itemId) {
            try {
                const response = await fetch(`/api/service-item-photos/${quoteId}/${itemId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayServiceItemPhotos(serviceItem, result.photos, quoteId, itemId);
                }
            } catch (error) {
                console.error('Error loading photos:', error);
            }
        }

        // Display photos for a service item - preserves existing temp photos
        function displayServiceItemPhotos(serviceItem, photos, quoteId, itemId) {
            const photosContainer = serviceItem.querySelector('.photos-container');
            
            // Store any existing temp photos
            const existingTempPhotos = photosContainer.querySelectorAll('.temp-photo');
            const tempPhotosHTML = Array.from(existingTempPhotos).map(el => el.outerHTML);
            
            // Clear container and reload saved photos
            photosContainer.innerHTML = '';

            if (photos.length === 0 && tempPhotosHTML.length === 0) {
                photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
                return;
            }

            // Display saved photos first
            photos.forEach((photoPath, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item';
                photoElement.innerHTML = `
                    <img src="${photoPath}" alt="Service item photo" onclick="showPhotoModal('${photoPath}')">
                    <button type="button" class="delete-photo-btn" onclick="deleteServiceItemPhoto('${quoteId}', '${itemId}', '${photoPath.split('/').pop()}', this)">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                photosContainer.appendChild(photoElement);
            });
            
            // Restore temp photos after saved photos
            tempPhotosHTML.forEach(html => {
                photosContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // Delete a photo from a service item
        async function deleteServiceItemPhoto(quoteId, itemId, imageId, button) {
            try {
                console.log(`Deleting photo: quoteId=${quoteId}, itemId=${itemId}, imageId=${imageId}`);
                
                const response = await fetch(`/api/service-item-photos/${quoteId}/${itemId}/${imageId}`, {
                    method: 'DELETE'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                // Check if response is ok and has success property
                if (response.ok && result.success) {
                    showNotification('Photo deleted successfully!', 'success');
                    // Remove the photo element from DOM
                    button.closest('.photo-item').remove();
                    
                    // If no photos left (saved or temp), show "no photos" message
                    const photosContainer = button.closest('.photos-container');
                    const remainingPhotos = photosContainer.querySelectorAll('.photo-item');
                    if (remainingPhotos.length === 0) {
                        photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
                    }
                } else if (response.ok && !result.success) {
                    // Server returned success but result.success is false
                    showNotification('Failed to delete photo: ' + (result.error || 'Unknown error'), 'error');
                } else {
                    // HTTP error status
                    showNotification('Failed to delete photo: HTTP ' + response.status, 'error');
                }
            } catch (error) {
                // console.error('Error deleting photo:', error);
                // showNotification('Error deleting photo. Please try again.', 'error');
            }
        }

        // Load photos when quote modal is opened
        async function loadQuotePhotos() {
            if (!currentQuoteData || !currentQuoteData.quoteId) return;
            
            const serviceItems = document.querySelectorAll('.service-item');
            serviceItems.forEach(async (item) => {
                const itemId = item.getAttribute('data-item-id');
                await loadServiceItemPhotos(item, currentQuoteData.quoteId, itemId);
            });
        }

        // Load photos when invoice modal is opened
        async function loadInvoicePhotos(quoteId) {
            if (!quoteId) return;
            
            const serviceItems = document.querySelectorAll('#invoiceServiceItems .service-item');
            serviceItems.forEach(async (item) => {
                const itemId = item.getAttribute('data-item-id');
                await loadServiceItemPhotos(item, quoteId, itemId);
            });
        }

        // Upload temporary photos to server
        async function uploadTemporaryPhotos() {
            if (!currentQuoteData || !currentQuoteData.quoteId) {
                console.log('No quote ID, skipping photo upload');
                return;
            }

            const serviceItems = document.querySelectorAll('.service-item');
            let hasPhotos = false;

            for (const serviceItem of serviceItems) {
                if (serviceItem.tempPhotos && serviceItem.tempPhotos.length > 0) {
                    hasPhotos = true;
                    const itemId = serviceItem.getAttribute('data-item-id');
                    const itemIndex = Array.from(serviceItem.parentNode.children).indexOf(serviceItem);
                    
                    // Create FormData for upload
                    const formData = new FormData();
                    serviceItem.tempPhotos.forEach(tempPhoto => {
                        formData.append('photos', tempPhoto.file);
                    });
                    formData.append('itemIndex', itemIndex);

                    try {
                        console.log(`Uploading ${serviceItem.tempPhotos.length} photos for item ${itemId}`);
                        
                        const response = await fetch(`/api/service-item-photos/${currentQuoteData.quoteId}/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            console.log(`✅ Photos uploaded successfully for item ${itemId}`);
                            // Clear temp photos after successful upload
                            serviceItem.tempPhotos = [];
                            // Load the actual photos from server
                            await loadServiceItemPhotos(serviceItem, currentQuoteData.quoteId, itemId);
                        } else {
                            throw new Error(result.error || 'Failed to upload photos');
                        }
                    } catch (error) {
                        console.error(`❌ Error uploading photos for item ${itemId}:`, error);
                        throw error;
                    }
                }
            }

            if (hasPhotos) {
                showNotification('Photos uploaded successfully!', 'success');
            }
        }

        // Upload temporary photos for invoice
        async function uploadInvoiceTemporaryPhotos() {
            if (!currentInvoiceData || !currentInvoiceData.quoteId) {
                console.log('No quote ID for invoice, skipping photo upload');
                return;
            }

            const serviceItems = document.querySelectorAll('#invoiceServiceItems .service-item');
            let hasPhotos = false;

            for (const serviceItem of serviceItems) {
                if (serviceItem.tempPhotos && serviceItem.tempPhotos.length > 0) {
                    hasPhotos = true;
                    const itemId = serviceItem.getAttribute('data-item-id');
                    const itemIndex = Array.from(serviceItem.parentNode.children).indexOf(serviceItem);
                    
                    // Create FormData for upload
                    const formData = new FormData();
                    serviceItem.tempPhotos.forEach(tempPhoto => {
                        formData.append('photos', tempPhoto.file);
                    });
                    formData.append('itemIndex', itemIndex);

                    try {
                        console.log(`Uploading ${serviceItem.tempPhotos.length} photos for invoice item ${itemId}`);
                        
                        const response = await fetch(`/api/service-item-photos/${currentInvoiceData.quoteId}/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            console.log(`✅ Photos uploaded successfully for invoice item ${itemId}`);
                            // Clear temp photos after successful upload
                            serviceItem.tempPhotos = [];
                            // Load the actual photos from server
                            await loadServiceItemPhotos(serviceItem, currentInvoiceData.quoteId, itemId);
                        } else {
                            throw new Error(result.error || 'Failed to upload photos');
                        }
                    } catch (error) {
                        console.error(`❌ Error uploading photos for invoice item ${itemId}:`, error);
                        throw error;
                    }
                }
            }

            if (hasPhotos) {
                showNotification('Invoice photos uploaded successfully!', 'success');
            }
        }

        // Show photo in modal
        function showPhotoModal(photoPath) {
            const modalPhoto = document.getElementById('modalPhoto');
            if (modalPhoto) {
                modalPhoto.src = photoPath;
                openModal('photoModal');
            }
        }

        // Setup initial event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners for existing service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Setup event listeners for form inputs
            document.querySelectorAll('.item-qty-input, .item-price-input').forEach(input => {
                input.addEventListener('input', updateQuoteTotals);
            });
        });

        // Save Quote to Database
        async function generateQuote() {
            // Validate form
            const requiredFields = ['quoteClientName', 'quoteClientPhone', 'quoteClientAddress', 'quoteClientEmail', 'quoteDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Ensure we have current booking context
            if (!currentQuoteData || !currentQuoteData.bookingId) {
                showNotification('No booking selected. Please open the quote from a booking.', 'error');
                console.error('generateQuote called without currentQuoteData or bookingId', currentQuoteData);
                return;
            }

            // Photos will be uploaded after the quote is saved and we have a quote ID

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('.service-item');
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Save all items with a description, even if price is 0
                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Save quote to database
            saveQuote(serviceItems);
        }

        // Save Quote to Database
        async function saveQuote(serviceItems) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            // Guard against missing booking context
            if (!currentQuoteData || !currentQuoteData.bookingId) {
                showNotification('Cannot save quote: missing booking context. Please reopen the quote from the booking.', 'error');
                console.error('saveQuote called without currentQuoteData or bookingId', currentQuoteData);
                return;
            }

            const quoteData = {
                booking_id: currentQuoteData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                quote_date: quoteDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            try {
                // If we have an existing quote ID, update it; otherwise create new
                const method = currentQuoteData && currentQuoteData.quoteId ? 'PUT' : 'POST';
                const url = currentQuoteData && currentQuoteData.quoteId ? `/api/quotes/${currentQuoteData.quoteId}` : '/api/quotes';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Quote saved successfully!', 'success');
                    
                    // Store the quote ID for later use (guard against race conditions)
                    if (!currentQuoteData) {
                        currentQuoteData = { bookingId: quoteData.booking_id };
                    }
                    currentQuoteData.quoteId = result.quote_id || currentQuoteData.quoteId;
                    
                    // Now upload any temporary photos since we have a quote ID
                    try {
                        await uploadTemporaryPhotos();
                    } catch (error) {
                        console.error('Error uploading photos after quote save:', error);
                        showNotification('Quote saved but photos failed to upload. Please try uploading photos again.', 'warning');
                    }
                    
                    // Generate quote preview
                    generateQuotePreview(serviceItems, result.quote_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save quote', 'error');
                }
            } catch (error) {
                console.error('Error saving quote:', error);
                showNotification('Network error saving quote', 'error');
            }
        }

        // Generate Quote Preview
        function generateQuotePreview(serviceItems, quoteId = null) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteNumber = quoteId || generateQuoteNumber();
            const formattedDate = new Date(quoteDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const quoteHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>1932 9a Ave NE, Calgary, Alberta</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(250) 551-1021</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>
stellartmanagement@outlook.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">QUOTE</div>
                            <div class="document-number">#${quoteNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Terms & Conditions</h3>
                        <div class="terms-content">
                            <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept cash, check, and major credit cards.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('quotePreviewContent').innerHTML = quoteHTML;
            
            // Update the Send Quote button with the correct booking ID
            const sendQuoteBtn = document.querySelector('#quotePreviewModal .action-btn.confirm');
            if (sendQuoteBtn && currentQuoteData && currentQuoteData.bookingId) {
                sendQuoteBtn.onclick = () => {
                    sendQuoteToCustomer(currentQuoteData.bookingId);
                    closeModal('quotePreviewModal');
                };
            }
            
            closeModal('quoteModal');
            openModal('quotePreviewModal');
        }

        // Generate Quote Number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `QT-${year}${month}${day}-${random}`;
        }

        // Print Quote
        function printQuote() {
            const printWindow = window.open('', '_blank');
            const quoteContent = document.getElementById('quotePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${quoteContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Quote as PDF
        function downloadQuotePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printQuote();
        }

        // Send Quote
        async function sendQuoteEmail(event) {
            if (!currentQuoteData || !currentQuoteData.quoteId) {
                showNotification('No quote data available to send', 'error');
                return;
            }

            try {
                // Show loading state - use more reliable button selection
                let sendButton = event.target;
                if (!sendButton || !sendButton.tagName || sendButton.tagName !== 'BUTTON') {
                    // Fallback: find the button by its onclick attribute
                    sendButton = document.querySelector('button[onclick*="sendQuoteEmail"]');
                }
                
                if (!sendButton) {
                    console.error('Could not find send button');
                    showNotification('Error: Could not find send button', 'error');
                    return;
                }
                
                const originalText = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                // Send the quote email via the server
                const response = await fetch(`/api/quotes/${currentQuoteData.quoteId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    showNotification('Quote sent successfully! Status updated to Quote Sent.', 'success');
                    
                    // Update the booking status to 'quote-sent' if we have a booking ID
                    if (currentQuoteData.bookingId) {
                        try {
                            await updateBookingStatus(currentQuoteData.bookingId, 'quote-sent');
                        } catch (statusError) {
                            console.warn('Could not update booking status:', statusError);
                            // Don't fail the whole operation if status update fails
                        }
                    }
                    
                    // Close the quote modal after a short delay to ensure notification is visible
                    setTimeout(() => {
                        forceCloseModal('quoteModal');
                    }, 500);
                    
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send quote', 'error');
                }
            } catch (error) {
                console.error('Error sending quote:', error);
                showNotification('Network error sending quote', 'error');
            } finally {
                // Restore button state
                if (sendButton) {
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                }
            }
        }

        // Generate Quote Email Content
        function generateQuoteEmailContent(quoteData) {
            const serviceItems = quoteData.serviceItems || [];
            const serviceItemsList = serviceItems.map(item => 
                `<li>${item.description}: ${item.quantity} x $${item.price.toFixed(2)} = $${item.total.toFixed(2)}</li>`
            ).join('');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Quote - ${quoteData.quoteId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background-color: #2c5530; color: white; padding: 20px; text-align: center; }
                        .content { padding: 20px; background-color: #f9f9f9; }
                        .service-items { background-color: white; padding: 20px; margin: 20px 0; border-radius: 5px; }
                        .total { background-color: #2c5530; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: bold; }
                        .footer { text-align: center; padding: 20px; color: #666; }
                        ul { list-style: none; padding: 0; }
                        li { padding: 8px 0; border-bottom: 1px solid #eee; }
                        li:last-child { border-bottom: none; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Stellar Tree Management</h1>
                            <h2>Quote</h2>
                        </div>
                        
                        <div class="content">
                            <p>Dear ${quoteData.customerName || 'Valued Customer'},</p>
                            
                            <p>Thank you for your interest in Stellar Tree Management services!</p>
                            
                            <p>Please find your quote details below:</p>
                            
                            <div class="service-items">
                                <h3>Quote Details</h3>
                                <p><strong>Quote ID:</strong> ${quoteData.quoteId}</p>
                                <p><strong>Date:</strong> ${quoteData.quoteDate || new Date().toLocaleDateString()}</p>
                                
                                <h4>Service Items:</h4>
                                <ul>
                                    ${serviceItemsList}
                                </ul>
                            </div>
                            
                            <div class="total">
                                Total Amount: $${quoteData.totalAmount ? quoteData.totalAmount.toFixed(2) : '0.00'}
                            </div>
                            
                            <p>Please review this quote and contact us if you have any questions.</p>
                            
                            <p>Best regards,<br>
                            Stellar Tree Management Team</p>
                        </div>
                        
                        <div class="footer">
                            <p>Email: stellartmanagement@outlook.com<br>
                            Website: www.stellartreemanagement.ca</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const textContent = `
                Dear ${quoteData.customerName || 'Valued Customer'},
                
                Thank you for your interest in Stellar Tree Management services!
                
                Please find your quote details below:
                
                Quote ID: ${quoteData.quoteId}
                Date: ${quoteData.quoteDate || new Date().toLocaleDateString()}
                
                Service Items:
                ${serviceItems.map(item => 
                    `- ${item.description}: ${item.quantity} x $${item.price.toFixed(2)} = $${item.total.toFixed(2)}`
                ).join('\n')}
                
                Total Amount: $${quoteData.totalAmount ? quoteData.totalAmount.toFixed(2) : '0.00'}
                
                Please review this quote and contact us if you have any questions.
                
                Best regards,
                Stellar Tree Management Team
                Email: stellartmanagement@outlook.com
            `;
            
            return { html: htmlContent, text: textContent };
        }

        // Invoice Functions
        let currentInvoiceData = null;

        // Show Invoice Modal from Booking ID
        async function showInvoiceModalFromBooking(bookingId) {
            try {
                console.log('showInvoiceModalFromBooking called with bookingId:', bookingId);
                
                // First, check if there's an existing invoice for this booking
                const invoiceResponse = await fetch(`/api/invoices/booking/${bookingId}`);
                console.log('Invoice response status:', invoiceResponse.status);
                
                let existingInvoice = null;
                if (invoiceResponse.ok) {
                    const invoices = await invoiceResponse.json();
                    console.log('Invoices received:', invoices);
                    
                    if (invoices && invoices.length > 0) {
                        // Use the most recent invoice
                        existingInvoice = invoices[0];
                        console.log('Found existing invoice:', existingInvoice);
                    }
                }
                
                if (existingInvoice) {
                    // Load existing invoice data
                    console.log('Loading existing invoice data');
                    await loadExistingInvoiceData(existingInvoice, bookingId);
                } else {
                    // No existing invoice, create from quote
                    console.log('No existing invoice, creating from quote');
                    await createInvoiceFromQuote(bookingId);
                }
                
            } catch (error) {
                console.error('Error fetching data for invoice modal:', error);
                showNotification('Failed to load invoice data. Please try again.', 'error');
            }
        }

        // Load existing invoice data into the modal
        async function loadExistingInvoiceData(invoice, bookingId) {
            try {
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Booking received:', booking);
                
                // Set current invoice data
                currentInvoiceData = {
                    invoiceId: invoice.invoice_id,
                    quoteId: invoice.quote_id,
                    bookingId: bookingId,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes
                };
                
                console.log('currentInvoiceData set to:', currentInvoiceData);
                
                // Pre-fill client information from existing invoice
                document.getElementById('invoiceClientName').value = invoice.client_name || booking.name || '';
                document.getElementById('invoiceClientPhone').value = invoice.client_phone || booking.phone || '';
                document.getElementById('invoiceClientAddress').value = invoice.client_address || booking.address || '';
                document.getElementById('invoiceClientEmail').value = invoice.client_email || booking.email || '';
                document.getElementById('invoiceDate').value = invoice.invoice_date || new Date().toISOString().split('T')[0];
                
                // Populate service items from existing invoice
                populateInvoiceServiceItems(invoice.service_items);
                
                // Set tax toggle to match the existing invoice
                document.getElementById('invoiceTaxToggle').checked = invoice.tax_enabled || false;
                
                // Update totals based on current service items
                updateInvoiceTotals();
                
                // Show modal
                console.log('About to call openModal with invoiceModal');
                openModal('invoiceModal');
                console.log('openModal called');
                
                // Load photos for service items if this is an existing invoice
                if (invoice && invoice.invoice_id) {
                    setTimeout(() => loadInvoicePhotos(invoice.quote_id), 100);
                }
                
            } catch (error) {
                console.error('Error loading existing invoice data:', error);
                showNotification('Failed to load existing invoice data. Please try again.', 'error');
            }
        }

        // Create invoice from quote data
        async function createInvoiceFromQuote(bookingId) {
            try {
                // Fetch the latest quote for this booking
                const response = await fetch(`/api/quotes/booking/${bookingId}`);
                console.log('Quote response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch quote data');
                }
                
                const quotes = await response.json();
                console.log('Quotes received:', quotes);
                
                if (!quotes || quotes.length === 0) {
                    throw new Error('No quotes found for this booking');
                }
                
                // Get the latest quote (first in the array since it's sorted by creation date desc)
                const quote = quotes[0];
                console.log('Using quote:', quote);
                
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                console.log('Booking response status:', bookingResponse.status);
                
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Booking received:', booking);
                
                // Now call the existing showInvoiceModal function
                console.log('Calling showInvoiceModal with:', { quote, booking });
                showInvoiceModal(quote, booking);
                
            } catch (error) {
                console.error('Error creating invoice from quote:', error);
                showNotification('Failed to create invoice from quote. Please try again.', 'error');
            }
        }

        // Send Invoice from Booking (directly generates and sends invoice without showing modal)
        async function sendInvoiceFromBooking(bookingId) {
            try {
                console.log('sendInvoiceFromBooking called with bookingId:', bookingId);
                
                // Show loading notification
                showNotification('Preparing and sending invoice...', 'info');
                
                // Fetch the latest quote for this booking (without showing modal)
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`);
                if (!quoteResponse.ok) {
                    throw new Error('Failed to fetch quote data');
                }
                
                const quotes = await quoteResponse.json();
                if (!quotes || quotes.length === 0) {
                    throw new Error('No quotes found for this booking');
                }
                
                const quote = quotes[0];
                console.log('Using quote:', quote);
                
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Using booking:', booking);
                
                // Prepare invoice data directly from quote
                const invoiceData = {
                    quote_id: quote.quote_id,
                    booking_id: bookingId,
                    client_name: quote.client_name || booking.name || '',
                    client_phone: quote.client_phone || booking.phone || '',
                    client_address: quote.client_address || booking.address || '',
                    client_email: quote.client_email || booking.email || '',
                    invoice_date: new Date().toISOString().split('T')[0],
                    service_items: quote.service_items || [],
                    subtotal: quote.subtotal || 0,
                    tax_amount: quote.tax_amount || 0,
                    total_amount: quote.total_amount || 0,
                    tax_enabled: quote.tax_enabled || false
                };
                
                console.log('Creating invoice with data:', invoiceData);
                
                // Create the invoice directly
                const createResponse = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(invoiceData)
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Failed to create invoice');
                }
                
                const createResult = await createResponse.json();
                const invoiceId = createResult.invoice_id;
                console.log('Invoice created successfully with ID:', invoiceId);
                
                // Send the invoice email immediately
                console.log('Sending invoice email...');
                const emailResponse = await fetch(`/api/invoices/${invoiceId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                
                if (!emailResponse.ok) {
                    const error = await emailResponse.json();
                    throw new Error(error.error || 'Failed to send invoice email');
                }
                
                const emailResult = await emailResponse.json();
                console.log('Invoice email sent successfully:', emailResult);
                
                // Update booking status to 'invoice-sent'
                const statusResponse = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'invoice-sent' })
                });
                
                if (statusResponse.ok) {
                    showNotification('Invoice sent successfully and booking status updated!', 'success');
                    
                    // Auto-switch to the invoice-sent tab
                    autoSwitchToNextTab('invoice-sent');
                    
                    // Reload bookings to reflect the status change
                    loadBookings();
                } else {
                    console.warn('Invoice sent but failed to update booking status');
                    showNotification('Invoice sent but failed to update booking status', 'warning');
                }
                
            } catch (error) {
                console.error('Error in sendInvoiceFromBooking:', error);
                showNotification(`Failed to send invoice: ${error.message}`, 'error');
            }
        }

        // Show Invoice Modal
        function showInvoiceModal(quote, booking) {
            console.log('showInvoiceModal called with:', { quote, booking });
            console.log('Quote service items:', quote.service_items);
            console.log('Quote total amount:', quote.total_amount);
            console.log('Quote subtotal:', quote.subtotal);
            console.log('Quote tax amount:', quote.tax_amount);
            
            currentInvoiceData = {
                quoteId: quote.quote_id,
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes,
                // Store the original quote totals to ensure consistency
                originalQuoteTotals: {
                    subtotal: quote.subtotal,
                    tax_amount: quote.tax_amount,
                    total_amount: quote.total_amount,
                    tax_enabled: quote.tax_enabled
                }
            };
            
            console.log('currentInvoiceData set to:', currentInvoiceData);

            // Pre-fill client information from quote
            document.getElementById('invoiceClientName').value = quote.client_name || booking.name || '';
            document.getElementById('invoiceClientPhone').value = quote.client_phone || booking.phone || '';
            document.getElementById('invoiceClientAddress').value = quote.client_address || booking.address || '';
            document.getElementById('invoiceClientEmail').value = quote.client_email || booking.email || '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Populate service items from quote
            populateInvoiceServiceItems(quote.service_items);

            // Set tax toggle to match the original quote
            document.getElementById('invoiceTaxToggle').checked = quote.tax_enabled || false;

            // Update totals based on current service items
            updateInvoiceTotals();

            // Show modal
            console.log('About to call openModal with invoiceModal');
            openModal('invoiceModal');
            console.log('openModal called');
            
            // Load photos for service items if this is an existing quote
            if (quote && quote.quote_id) {
                setTimeout(() => loadInvoicePhotos(quote.quote_id), 100);
            }
        }



        // Populate Invoice Service Items
        function populateInvoiceServiceItems(serviceItems) {
            const container = document.getElementById('invoiceServiceItems');
            container.innerHTML = '';

            // Parse service items if it's a JSON string
            let items = serviceItems;
            if (typeof serviceItems === 'string') {
                try {
                    items = JSON.parse(serviceItems);
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    items = [];
                }
            }

            console.log('Populating invoice service items:', items);
            console.log('Service items type:', typeof serviceItems);
            console.log('Parsed items:', items);

            items.forEach((item, index) => {
                console.log(`Processing service item ${index + 1}:`, item);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'service-item';
                itemDiv.setAttribute('data-item-id', index + 1);

                itemDiv.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description}" placeholder="Service or item description">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${item.quantity}" min="1" placeholder="Qty">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${item.price}" min="0" step="0.01" placeholder="Price">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${item.total.toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeInvoiceServiceItem(this)" aria-label="Remove item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-photos-section">
                        <div class="photos-header">
                            <span class="photos-label">Photos:</span>
                            <button type="button" class="add-photo-btn" onclick="addPhotoToServiceItem(this)">
                                <i class="fas fa-camera"></i> Add Photo
                            </button>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                    </div>
                `;

                container.appendChild(itemDiv);
                setupInvoiceItemEventListeners(itemDiv);
            });

            // Log the final populated items for verification
            console.log('Final populated invoice service items count:', container.children.length);
        }

        // Add Invoice Service Item
        function addInvoiceServiceItem() {
            console.log('addInvoiceServiceItem called');
            const container = document.getElementById('invoiceServiceItems');
            const itemCounter = container.children.length + 1;
            
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeInvoiceServiceItem(this)" aria-label="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photos-header">
                        <span class="photos-label">Photos:</span>
                        <button type="button" class="add-photo-btn" onclick="addPhotoToServiceItem(this)">
                            <i class="fas fa-camera"></i> Add Photo
                        </button>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                </div>
            `;

            container.appendChild(newItem);
            setupInvoiceItemEventListeners(newItem);
        }

        // Remove Invoice Service Item
        function removeInvoiceServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('#invoiceServiceItems .service-item').length > 1) {
                serviceItem.remove();
                updateInvoiceTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Invoice Service Items
        function setupInvoiceItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateInvoiceItemTotal);
            priceInput.removeEventListener('input', updateInvoiceItemTotal);

            qtyInput.addEventListener('input', updateInvoiceItemTotal);
            priceInput.addEventListener('input', updateInvoiceItemTotal);

            function updateInvoiceItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateInvoiceTotals();
            }

            // Initialize the total for this item
            updateInvoiceItemTotal();
        }

        // Update Invoice Totals
        function updateInvoiceTotals() {
            const items = document.querySelectorAll('#invoiceServiceItems .service-item');
            let subtotal = 0;

            items.forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('invoiceTaxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            document.getElementById('invoiceSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('invoiceGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('invoiceTaxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';

            console.log('Invoice totals updated:', { subtotal, tax, total });
        }

        // Toggle Invoice Tax
        function toggleInvoiceTax() {
            updateInvoiceTotals();
        }

        // Create Invoice from Saved Quote
        async function generateInvoice() {
            // Ensure we have current invoice context
            if (!currentInvoiceData || !currentInvoiceData.bookingId) {
                showNotification('No booking selected. Please open the invoice from a saved quote.', 'error');
                console.error('generateInvoice called without currentInvoiceData or bookingId', currentInvoiceData);
                return;
            }

            // Validate form
            const requiredFields = ['invoiceClientName', 'invoiceClientPhone', 'invoiceClientAddress', 'invoiceClientEmail', 'invoiceDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Upload any temporary photos before saving the invoice
            try {
                await uploadInvoiceTemporaryPhotos();
            } catch (error) {
                console.error('Error uploading photos:', error);
                showNotification('Error uploading photos. Please try again.', 'error');
                return;
            }

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('#invoiceServiceItems .service-item');
            console.log('Found service item elements:', serviceItemElements.length);
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value;
                const quantity = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                const total = quantity * price;

                console.log(`Service item ${index + 1}:`, { description, quantity, price, total });

                if (description && quantity > 0 && price > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('No service items found', 'error');
                return;
            }

            // Save invoice to database with current totals
            saveInvoice(serviceItems);
        }

        // Save Invoice to Database
        async function saveInvoice(serviceItems) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            // Calculate current totals from service items (allowing for modifications)
            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;
            
            console.log('Using current calculated totals:', { subtotal, tax, total });

            // Guard against missing booking context
            if (!currentInvoiceData || !currentInvoiceData.bookingId) {
                showNotification('Cannot save invoice: missing booking context. Please reopen from a saved quote.', 'error');
                console.error('saveInvoice called without currentInvoiceData or bookingId', currentInvoiceData);
                return;
            }

            const invoiceData = {
                quote_id: currentInvoiceData.quoteId,
                booking_id: currentInvoiceData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                invoice_date: invoiceDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            console.log('Saving invoice with data:', invoiceData);

            try {
                let response;
                let result;
                
                if (currentInvoiceData.invoiceId) {
                    // Update existing invoice
                    console.log('Updating existing invoice:', currentInvoiceData.invoiceId);
                    response = await fetch(`/api/invoices/${currentInvoiceData.invoiceId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        showNotification('Invoice updated successfully!', 'success');
                    }
                } else {
                    // Create new invoice
                    console.log('Creating new invoice');
                    response = await fetch('/api/invoices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        showNotification('Invoice saved successfully!', 'success');
                        
                        // Store the invoice ID for later use
                        currentInvoiceData.invoiceId = result.invoice_id;
                    }
                }

                if (response.ok) {
                    // Generate invoice preview
                    generateInvoicePreview(serviceItems, currentInvoiceData.invoiceId || result.invoice_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save invoice', 'error');
                }
            } catch (error) {
                console.error('Error saving invoice:', error);
                showNotification('Network error saving invoice', 'error');
            }
        }

        // Complete Booking with Invoice
        async function completeBookingWithInvoice() {
            try {
                const response = await fetch(`/api/bookings/${currentInvoiceData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showNotification('Booking completed successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to complete booking', 'error');
                }
            } catch (error) {
                console.error('Error completing booking:', error);
                showNotification('Network error completing booking', 'error');
            }
        }

        // Generate Invoice Preview
        function generateInvoicePreview(serviceItems, invoiceId = null) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            // Use current calculated totals (allowing for modifications)
            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;
            
            console.log('Invoice preview using current calculated totals:', { subtotal, tax, total });

            const invoiceNumber = invoiceId || generateInvoiceNumber();
            const formattedDate = new Date(invoiceDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const invoiceHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>123 Business Street, Toronto, ON M5V 3A8</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(555) 123-4567</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>info@stellartreemanagement.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">INVOICE</div>
                            <div class="document-number">#${invoiceNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Payment Terms</h3>
                        <div class="terms-content">
                            <p>Payment is due upon receipt of this invoice. We accept cash, check, and major credit cards. Please include the invoice number with your payment.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('invoicePreviewContent').innerHTML = invoiceHTML;
            closeModal('invoiceModal');
            openModal('invoicePreviewModal');
        }

        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `INV-${year}${month}${day}-${random}`;
        }

        // Print Invoice
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            const invoiceContent = document.getElementById('invoicePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Invoice as PDF
        function downloadInvoicePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printInvoice();
        }

        // Send Invoice Email
        async function sendInvoiceEmail(event) {
            if (!currentInvoiceData || !currentInvoiceData.invoiceId) {
                showNotification('No invoice data available to send email', 'error');
                return;
            }

            try {
                // Show loading state - use more reliable button selection
                let sendButton = event.target;
                if (!sendButton || !sendButton.tagName || sendButton.tagName !== 'BUTTON') {
                    // Fallback: find the button by its onclick attribute
                    sendButton = document.querySelector('button[onclick*="sendInvoiceEmail"]');
                    console.log('Fallback button selection:', sendButton);
                }
                
                if (!sendButton) {
                    console.error('Could not find send button');
                    showNotification('Error: Could not find send button', 'error');
                    return;
                }
                
                const originalText = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                const response = await fetch(`/api/invoices/${currentInvoiceData.invoiceId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Invoice email sent successfully, result:', result);
                    showNotification('Invoice email sent successfully!', 'success');
                    
                    // Close the invoice modal after a short delay to ensure notification is visible
                    console.log('Attempting to close invoice modal after successful email send');
                    setTimeout(() => {
                        forceCloseModal('invoiceModal');
                    }, 500);
                    
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send invoice email', 'error');
                }
            } catch (error) {
                console.error('Error sending invoice email:', error);
                showNotification('Network error sending invoice email', 'error');
            } finally {
                // Restore button state
                console.log('Restoring button state, sendButton:', sendButton);
                if (sendButton) {
                    console.log('Restoring button to:', originalText);
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                    console.log('Button state restored');
                } else {
                    console.error('No sendButton found in finally block');
                }
            }
        }

        // Customer Management Functions - REMOVED

        // Render customer details
        function renderCustomerDetails(data) {
            const { customer, bookings, quotes, invoices, totalBreakdown } = data;
            
            document.getElementById('customerDetailsTitle').textContent = `Customer Details - ${customer.name}`;
            
            const content = `
                <div class="customer-details-grid">
                    <div class="customer-info-section">
                        <h4><i class="fas fa-user"></i> Customer Information</h4>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${customer.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${customer.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${customer.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${customer.address || 'Not provided'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Customer ID:</span>
                            <span class="info-value">${customer.customer_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${new Date(customer.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Bookings:</span>
                            <span class="info-value">${customer.total_bookings || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Spent:</span>
                            <span class="info-value">$${(customer.total_spent || 0).toFixed(2)}</span>
                            <button class="action-btn info" onclick="recalculateCustomerTotal('${customer.customer_id}')" style="margin-left: 10px; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                <i class="fas fa-calculator"></i> Recalculate
                            </button>
                        </div>

                        ${customer.notes ? `
                            <div class="info-row">
                                <span class="info-label">Notes:</span>
                                <span class="info-value">${customer.notes}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="customer-history-section">
                        <div class="history-tabs">
                            <div class="history-tab active" onclick="switchHistoryTab('bookings', {bookings, quotes, invoices})">Bookings (${bookings.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('quotes', {bookings, quotes, invoices})">Quotes (${quotes.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('invoices', {bookings, quotes, invoices})">Invoices (${invoices.length})</div>
                        </div>
                        <div class="history-content" id="historyContent">
                            ${renderEnhancedHistoryTab('bookings', bookings, quotes, invoices)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = content;
        }

        // Switch history tab
        function switchHistoryTab(tab, data) {
            // Update active tab
            document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get data based on tab
            let items = [];
            if (tab === 'bookings') items = data.bookings || [];
            else if (tab === 'quotes') items = data.quotes || [];
            else if (tab === 'invoices') items = data.invoices || [];
            
            if (tab === 'bookings') {
                document.getElementById('historyContent').innerHTML = renderEnhancedHistoryTab(tab, data.bookings || [], data.quotes || [], data.invoices || []);
            } else {
                document.getElementById('historyContent').innerHTML = renderHistoryTab(tab, items);
            }
        }

        // Render enhanced history tab content for bookings with related invoices and quotes
        function renderEnhancedHistoryTab(tab, bookings, quotes, invoices) {
            if (bookings.length === 0) {
                return '<div class="empty-state">No bookings found</div>';
            }

            return bookings.map(booking => {
                // Find related quotes and invoices for this booking
                const relatedQuotes = quotes.filter(q => q.booking_id === booking.booking_id);
                const relatedInvoices = invoices.filter(i => i.booking_id === booking.booking_id);
                
                return `
                    <div class="enhanced-history-item">
                        <div class="booking-header">
                            <h5><i class="fas fa-calendar-check"></i> ${booking.service} - ${booking.status}</h5>
                            <div class="booking-meta">
                                <span class="booking-date"><i class="fas fa-calendar"></i> ${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()} at ${booking.time}</span>
                                <span class="booking-id"><i class="fas fa-hashtag"></i> ${booking.booking_id}</span>
                            </div>
                        </div>
                        
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="detail-label">Customer:</span>
                                <span class="detail-value">${booking.name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${booking.notes || 'No notes'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Booking Date:</span>
                                <span class="detail-value">${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()}</span>
                            </div>
                        </div>
                        
                        ${relatedQuotes.length > 0 || relatedInvoices.length > 0 ? `
                            <div class="related-documents">
                                ${relatedQuotes.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-file-invoice-dollar"></i> Related Quotes (${relatedQuotes.length})</h6>
                                        <div class="document-list">
                                            ${relatedQuotes.map(quote => {
                                                const serviceItems = JSON.parse(quote.service_items);
                                                return `
                                                    <div class="document-item quote-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Quote ${quote.quote_id}</span>
                                                            <span class="document-status ${quote.status}">${quote.status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${quote.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(quote.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${relatedInvoices.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-receipt"></i> Related Invoices (${relatedInvoices.length})</h6>
                                        <div class="document-list">
                                            ${relatedInvoices.map(invoice => {
                                                const serviceItems = JSON.parse(invoice.service_items);
                                                return `
                                                    <div class="document-item invoice-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Invoice ${invoice.invoice_id}</span>
                                                            <span class="document-status ${invoice.payment_status}">${invoice.payment_status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${invoice.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(invoice.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="no-documents">
                                <i class="fas fa-info-circle"></i> No related quotes or invoices found for this booking.
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Render history tab content
        function renderHistoryTab(tab, items) {
            if (items.length === 0) {
                return '<div class="empty-state">No items found</div>';
            }

            return items.map(item => {
                if (tab === 'bookings') {
                    return `
                        <div class="history-item">
                            <h5>${item.service} - ${item.status}</h5>
                            <p><strong>Date:</strong> ${new Date(item.date).toLocaleDateString()} at ${item.time}</p>
                            <p><strong>Booking ID:</strong> ${item.booking_id}</p>
                            <p class="date">Booked for: ${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'quotes') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Quote ${item.quote_id} - ${item.status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'invoices') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Invoice ${item.invoice_id} - ${item.payment_status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }
            }).join('');
        }

        // Edit customer
        function editCustomer(customerId) {
            currentCustomerId = customerId;
            const customer = allCustomers.find(c => c.customer_id === customerId);
            
            if (customer) {
                document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                openModal('customerModal');
            }
        }

        // Save customer
        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name || !email || !phone) {
                showNotification('Name, email, and phone are required', 'error');
                return;
            }

            try {
                const url = currentCustomerId ? `/api/customers/${currentCustomerId}` : '/api/customers';
                const method = currentCustomerId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone, address, notes })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save customer', 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showNotification('Network error saving customer', 'error');
            }
        }

        // Delete customer
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    
                    // Check if customer has associated data and offer force delete
                    if (error.hasData) {
                        const forceDelete = confirm(
                            `This customer has associated data:\n` +
                            `- ${error.counts.booking_count} bookings\n` +
                            `- ${error.counts.quote_count} quotes\n` +
                            `- ${error.counts.invoice_count} invoices\n\n` +
                            `Do you want to force delete this customer and ALL associated data? This action cannot be undone.`
                        );
                        
                        if (forceDelete) {
                            try {
                                const forceResponse = await fetch(`/api/customers/${customerId}?force=true`, {
                                    method: 'DELETE',
                                    headers: getAuthHeaders()
                                });
                                
                                if (forceResponse.ok) {
                                    const forceResult = await forceResponse.json();
                                    showNotification(forceResult.message, 'success');
                                    loadCustomers();
                                } else {
                                    const forceError = await forceResponse.json();
                                    showNotification(forceError.error || 'Failed to force delete customer', 'error');
                                }
                            } catch (forceError) {
                                console.error('Error force deleting customer:', forceError);
                                showNotification('Network error force deleting customer', 'error');
                            }
                        }
                    } else {
                        showNotification(error.error || 'Failed to delete customer', 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showNotification('Network error deleting customer', 'error');
            }
        }

        // Migrate existing customers
        async function migrateCustomers() {
            if (!confirm('This will migrate existing bookings to create customer profiles. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/customers/migrate', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Migration completed: ${result.processed} customers processed, ${result.errors} errors`, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to migrate customers', 'error');
                }
            } catch (error) {
                console.error('Error migrating customers:', error);
                showNotification('Network error migrating customers', 'error');
            }
        }

        // Close customer modal
        function closeCustomerModal() {
            closeModal('customerModal');
            currentCustomerId = null;
        }

        // Close customer details modal
        function closeCustomerDetailsModal() {
            closeModal('customerDetailsModal');
        }

        // Image Modal Functions
        function showImageModal(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imagePath;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        // Customer Message Modal Functions
        function showCustomerMessageModal(bookingId, customerName, customerEmail) {
            // Populate the modal with customer information
            document.getElementById('messageCustomerName').textContent = customerName;
            document.getElementById('messageCustomerEmail').textContent = customerEmail;
            document.getElementById('messageBookingId').textContent = bookingId;
            
            // Clear previous message content
            document.getElementById('messageContent').value = '';
            
            // Open the modal
            openModal('customerMessageModal');
        }

        function closeCustomerMessageModal() {
            closeModal('customerMessageModal');
        }

        async function sendCustomerMessage() {
            const customerName = document.getElementById('messageCustomerName').textContent;
            const customerEmail = document.getElementById('messageCustomerEmail').textContent;
            const bookingId = document.getElementById('messageBookingId').textContent;
            const subject = document.getElementById('messageSubject').value;
            const messageContent = document.getElementById('messageContent').value;

            if (!messageContent.trim()) {
                showNotification('Please enter a message', 'error');
                return;
            }

            // Get the send button and store original text before any operations
            const sendButton = document.querySelector('#customerMessageModal .btn-primary');
            if (!sendButton) {
                showNotification('Error: Send button not found', 'error');
                return;
            }
            const originalText = sendButton.innerHTML;

            try {
                // Show loading state
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                const response = await fetch('/api/bookings/send-customer-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerName: customerName,
                        customerEmail: customerEmail,
                        subject: subject,
                        message: messageContent
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Message sent successfully!', 'success');
                    closeCustomerMessageModal();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send message: ${error.message}`, 'error');
                }
            } catch (error) {
                console.error('Error sending customer message:', error);
                let errorMessage = 'Failed to send message. Please try again.';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Reset button state
                if (sendButton) {
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                }
            }
        }

        // Smooth filter tab click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                const filter = e.target.getAttribute('data-filter');
                
                // Prevent multiple rapid clicks
                if (e.target.classList.contains('loading')) return;
                
                // Add loading state to clicked tab
                e.target.classList.add('loading');
                
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.classList.remove('loading');
                });
                e.target.classList.add('active');
                
                // Update current filter
                currentFilter = filter;
                
                // Update section title smoothly
                const sectionTitle = document.getElementById('sectionTitle');
                let newTitle = '';
                if (filter === 'all') newTitle = 'Active Bookings';
                else if (filter === 'pending') newTitle = 'Pending Bookings';

                else if (filter === 'all-bookings') newTitle = 'All Bookings';
                else if (filter === 'calendar') newTitle = 'Calendar View';
                else if (filter === 'customers') newTitle = 'Customer Management';
                
                // Smooth title transition
                sectionTitle.style.opacity = '0';
                sectionTitle.style.transform = 'translateY(-5px)';
                
                // Hide all views smoothly first
                const views = ['activeBookingsGrid', 'calendarView'];
                views.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    view.classList.add('view-hidden');
                });
                
                // Wait for fade out, then show new view
                setTimeout(() => {
                    // Update title
                    sectionTitle.textContent = newTitle;
                    sectionTitle.style.opacity = '1';
                    sectionTitle.style.transform = 'translateY(0)';
                    
                    // Hide all views
                    views.forEach(viewId => {
                        const view = document.getElementById(viewId);
                        view.style.display = 'none';
                        view.classList.remove('view-hidden');
                    });
                    
                    // Show appropriate view
                    let targetView;
                    if (filter === 'calendar') {
                        targetView = document.getElementById('calendarView');
                        targetView.style.display = 'block';
                        if (!window.adminCalendar.blockedDates.length) window.adminCalendar.loadBlockedDates();
                        window.adminCalendar.renderCalendar();
                    } else {
                        targetView = document.getElementById('activeBookingsGrid');
                        targetView.style.display = 'grid';
                        currentFilter = filter;
                        renderActiveBookings();
                    }
                    
                    // Trigger smooth entrance animation
                    requestAnimationFrame(() => {
                        targetView.style.opacity = '0';
                        targetView.style.transform = 'translateY(10px)';
                        requestAnimationFrame(() => {
                            targetView.style.opacity = '1';
                            targetView.style.transform = 'translateY(0)';
                        });
                    });
                    
                    // Remove loading state
                    e.target.classList.remove('loading');
                }, 250);
            }
        });

        // Show Email Options Modal
        function showEmailOptions(title, emailContent, customerEmail) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="email-options">
                            <div class="option-section">
                                <h3>📧 Send via Email Client</h3>
                                <p>This will open your default email client with the quote content pre-filled.</p>
                                <button class="btn-primary" onclick="sendViaEmailClient('${customerEmail}', 'Quote - ${currentQuoteData.quoteId}', '${emailContent.html.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Open Email Client
                                </button>
                            </div>
                            
                            <div class="option-section">
                                <h3>📋 Copy to Clipboard</h3>
                                <p>Copy the email content to paste into your email client manually.</p>
                                <button class="btn-secondary" onclick="copyEmailContent('${emailContent.html.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Copy HTML Content
                                </button>
                                <button class="btn-secondary" onclick="copyEmailContent('${emailContent.text.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Copy Text Content
                                </button>
                            </div>
                            
                            <div class="option-section">
                                <h3>👀 Preview Email</h3>
                                <p>See how the email will look to your customers.</p>
                                <button class="btn-info" onclick="previewEmail('${emailContent.html.replace(/'/g, "\\'")}')">
                                    👀 Preview Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Send via Email Client
        function sendViaEmailClient(to, subject, htmlBody, textBody) {
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textBody)}`;
            window.open(mailtoLink);
            
            // Close the modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            showNotification('Email client opened! The quote content is pre-filled.', 'success');
        }

        // Copy Email Content
        function copyEmailContent(content, type) {
            navigator.clipboard.writeText(content).then(() => {
                showNotification(`${type} content copied to clipboard!`, 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification(`${type} content copied to clipboard!`, 'success');
            });
        }

        // Preview Email
        function previewEmail(htmlContent) {
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(htmlContent);
            previewWindow.document.close();
        }

        // Image verification functions removed - now using improved storage system
        
        // Confirm site visit and change status to quote-ready
        async function confirmSiteVisit(bookingId) {
            try {
                console.log('🔄 Attempting to confirm site visit for booking:', bookingId);
                console.log('🔍 Auth headers:', getAuthHeaders());
                
                // Update booking from pending status directly to quote-ready
                const newStatus = 'quote-ready';
                
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                console.log('📊 Response status:', response.status);
                console.log('📊 Response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Site visit confirmed successfully:', result);
                    showNotification('Site visit confirmed. Status changed to Quote Ready.', 'success');
                    
                    // Auto-switch to the quote-ready tab
                    autoSwitchToNextTab('quote-ready');
                    
                    loadBookings();
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to confirm site visit. Status:', response.status);
                    console.error('❌ Error response:', errorText);
                    
                    let errorMessage = 'Failed to confirm site visit';
                    if (response.status === 401) {
                        errorMessage = 'Authentication failed. Please log in again.';
                    } else if (response.status === 403) {
                        errorMessage = 'Access denied. You may not have permission to perform this action.';
                    } else if (response.status === 404) {
                        errorMessage = 'Booking not found. Please refresh and try again.';
                    } else if (response.status === 500) {
                        errorMessage = 'Server error. Please try again later.';
                    }
                    
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('❌ Network error confirming site visit:', error);
                showNotification(`Network error: ${error.message}`, 'error');
            }
        }

        // Revert booking status to a previous state with intelligent reversion logic
        async function revertBookingStatus(bookingId, newStatus) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = newStatus;

                // Intelligent status reversion logic
                if (currentStatus === 'completed' && newStatus !== 'completed') {
                    // When reverting from completed, go back to invoice-sent (the status before completion)
                    targetStatus = 'invoice-sent';
                    console.log(`🔄 Reverting from 'completed' to '${targetStatus}' (previous workflow status)`);
                    console.log(`📋 Original requested status: ${newStatus}, but reverting to: ${targetStatus}`);
                }

                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (response.ok) {
                    const statusMessage = currentStatus === 'completed' && newStatus !== 'completed' 
                        ? `Booking reverted from completed to ${targetStatus} successfully` 
                        : `Booking status reverted to ${targetStatus} successfully`;
                    showNotification(statusMessage, 'success');
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar();
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to revert booking status', 'error');
                }
            } catch (error) {
                console.error('Error reverting booking status:', error);
                showNotification('Network error reverting booking status', 'error');
            }
        }

        // Send Quote to Customer
        async function sendQuoteToCustomer(bookingId) {
            try {
                // First check if there's an existing quote for this booking
                let quoteData = null;
                try {
                    const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`, {
                        headers: getAuthHeaders()
                    });
                    if (quoteResponse.ok) {
                        const quotes = await quoteResponse.json();
                        if (quotes.length > 0) {
                            quoteData = quotes[0]; // Use the most recent quote
                            console.log('📋 Found existing quote:', quoteData);
                        }
                    }
                } catch (error) {
                    console.error('Error checking for existing quotes:', error);
                }

                // If we have quote data, update the booking with the quote information
                if (quoteData) {
                    try {
                        // Calculate total from quote service items
                        let totalAmount = 0;
                        if (quoteData.service_items) {
                            const serviceItems = typeof quoteData.service_items === 'string' 
                                ? JSON.parse(quoteData.service_items) 
                                : quoteData.service_items;
                            
                            serviceItems.forEach(item => {
                                totalAmount += (item.quantity || 0) * (item.price || 0);
                            });
                        }

                        // Update booking with quote information
                        const updateResponse = await fetch(`/api/bookings/${bookingId}/status`, {
                            method: 'PATCH',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({
                                estimated_cost: totalAmount.toFixed(2),
                                work_description: quoteData.work_description || 'Tree service as requested'
                            })
                        });

                        if (!updateResponse.ok) {
                            console.error('Failed to update booking with quote data');
                        }
                    } catch (error) {
                        console.error('Error updating booking with quote data:', error);
                    }
                }

                // Now send the quote email
                const response = await fetch(`/api/bookings/${bookingId}/send-quote`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Quote sent to customer successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send quote to customer', 'error');
                }
            } catch (error) {
                console.error('Error sending quote to customer:', error);
                showNotification('Network error sending quote to customer', 'error');
            }
        }

        // Mark Invoice as Paid
        async function markInvoicePaid(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/mark-paid`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Invoice marked as paid successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to mark invoice as paid', 'error');
                }
            } catch (error) {
                console.error('Error marking invoice as paid:', error);
                showNotification('Network error marking invoice as paid', 'error');
            }
        }

        // Test Invoice Modal
        function testInvoiceModal() {
            console.log('Testing invoice modal...');
            console.log('Modal element:', document.getElementById('invoiceModal'));
            console.log('Modal classes:', document.getElementById('invoiceModal').className);
            console.log('Modal display style:', document.getElementById('invoiceModal').style.display);
            
            // Try to open the modal directly
            openModal('invoiceModal');
        }

        // Debug function to compare quote and invoice totals
        function debugQuoteInvoiceDiscrepancy() {
            if (!currentInvoiceData || !currentInvoiceData.originalQuoteTotals) {
                console.error('No invoice data available for debugging');
                return;
            }

            const quoteTotals = currentInvoiceData.originalQuoteTotals;
            const serviceItems = document.querySelectorAll('#invoiceServiceItems .service-item');
            let calculatedSubtotal = 0;
            let calculatedTax = 0;
            let calculatedTotal = 0;

            console.log('🔍 === QUOTE vs INVOICE DEBUG ===');
            console.log('📋 QUOTE TOTALS:', quoteTotals);

            // Calculate from service items
            serviceItems.forEach((item, index) => {
                const qty = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                const itemTotal = qty * price;
                calculatedSubtotal += itemTotal;

                console.log(`📦 Service Item ${index + 1}:`, {
                    description: item.querySelector('.item-desc-input').value,
                    quantity: qty,
                    price: price,
                    itemTotal: itemTotal
                });
            });

            calculatedTax = quoteTotals.tax_enabled ? calculatedSubtotal * 0.05 : 0;
            calculatedTotal = calculatedSubtotal + calculatedTax;

            console.log('🧮 CALCULATED TOTALS:', {
                subtotal: calculatedSubtotal,
                tax: calculatedTax,
                total: calculatedTotal,
                taxEnabled: quoteTotals.tax_enabled
            });

            console.log('📊 COMPARISON:', {
                subtotal: {
                    quote: quoteTotals.subtotal,
                    calculated: calculatedSubtotal,
                    difference: Math.abs(quoteTotals.subtotal - calculatedSubtotal)
                },
                tax: {
                    quote: quoteTotals.tax_amount,
                    calculated: calculatedTax,
                    difference: Math.abs(quoteTotals.tax_amount - calculatedTax)
                },
                total: {
                    quote: quoteTotals.total_amount,
                    calculated: calculatedTotal,
                    difference: Math.abs(quoteTotals.total_amount - calculatedTotal)
                }
            });

            // Check for potential issues
            if (Math.abs(calculatedSubtotal - quoteTotals.subtotal) > 0.01) {
                console.error('❌ SUBTOTAL MISMATCH DETECTED!');
                console.error('This could be caused by:');
                console.error('1. Service items not being copied correctly from quote to invoice');
                console.error('2. Data corruption during database operations');
                console.error('3. Rounding errors in calculations');
                console.error('4. Service items being modified after quote creation');
            }

            if (Math.abs(calculatedTotal - quoteTotals.total_amount) > 0.01) {
                console.error('❌ TOTAL AMOUNT MISMATCH DETECTED!');
                console.error('This could be caused by:');
                console.error('1. Tax calculation differences');
                console.error('2. Subtotal mismatch');
                console.error('3. Data corruption');
            }

            console.log('🔍 === END DEBUG ===');

            // Show results in a user-friendly way
            const message = `
Quote vs Invoice Debug Results:

Quote Totals:
- Subtotal: $${quoteTotals.subtotal?.toFixed(2) || '0.00'}
- Tax: $${quoteTotals.tax_amount?.toFixed(2) || '0.00'}
- Total: $${quoteTotals.total_amount?.toFixed(2) || '0.00'}

Calculated from Service Items:
- Subtotal: $${calculatedSubtotal.toFixed(2)}
- Tax: $${calculatedTax.toFixed(2)}
- Total: $${calculatedTotal.toFixed(2)}

Difference: $${Math.abs(calculatedTotal - quoteTotals.total_amount).toFixed(2)}

Check console for detailed analysis.
            `;

            alert(message);
        }

        // Auto-switch to next logical tab based on status update
        function autoSwitchToNextTab(newStatus) {
            let targetFilter = null;
            
            // Map status to the next logical tab
            switch (newStatus) {
                case 'quote-ready':
                    targetFilter = 'quote-ready';
                    break;
                case 'quote-sent':
                    targetFilter = 'quote-sent';
                    break;
                case 'pending-booking':
                    targetFilter = 'pending-booking';
                    break;
                case 'invoice-ready':
                    targetFilter = 'invoice-ready';
                    break;
                case 'invoice-sent':
                    targetFilter = 'invoice-sent';
                    break;
                case 'completed':
                    targetFilter = 'completed';
                    break;
                default:
                    console.log(`🔄 No auto-switch for status: ${newStatus}`);
                    return; // Don't switch for other statuses
            }
            
            console.log(`🔄 Auto-switching from status: ${newStatus} to tab: ${targetFilter}`);
            
            // Find the corresponding filter tab and trigger its click
            const filterTab = document.querySelector(`.filter-tab[data-filter="${targetFilter}"]`);
            if (filterTab) {
                console.log(`✅ Found filter tab: ${targetFilter}`);
                
                // Remove active class from all tabs
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                
                // Add active class to the target filter tab
                filterTab.classList.add('active');
                
                // Update current filter
                currentFilter = targetFilter;
                console.log(`🔄 Updated currentFilter to: ${currentFilter}`);
                
                // Update section title
                updateSectionTitle();
                
                // Show bookings grid (not calendar)
                document.getElementById('activeBookingsGrid').style.display = 'grid';
                document.getElementById('calendarView').style.display = 'none';
                
                // Render filtered bookings
                renderActiveBookings();
                
                // Scroll to bookings section smoothly
                const activeBookingsSection = document.querySelector('.active-bookings-section');
                if (activeBookingsSection) {
                    activeBookingsSection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
                
                console.log(`✅ Successfully auto-switched to tab: ${targetFilter} after status update to: ${newStatus}`);
            } else {
                console.warn(`⚠️ Could not find filter tab for: ${targetFilter}`);
            }
        }

        // ... existing code ...
    </script>

    <!-- Site Visit Modal -->
    <div id="siteVisitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-check"></i> Complete Site Visit Assessment</h3>
                <button class="modal-close" onclick="closeModal('siteVisitModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="siteVisitForm">
                    <div class="form-group">
                        <label for="workDescription">Work Description</label>
                        <textarea id="workDescription" name="workDescription" rows="4" placeholder="Describe the work to be performed based on your site assessment..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="estimatedCost">Estimated Cost ($)</label>
                        <input type="number" id="estimatedCost" name="estimatedCost" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="siteVisitNotes">Site Visit Notes</label>
                        <textarea id="siteVisitNotes" name="siteVisitNotes" rows="3" placeholder="Additional notes from your site visit..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="recommendedDate">Recommended Date</label>
                        <input type="date" id="recommendedDate" name="recommendedDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recommendedTime">Recommended Time</label>
                        <select id="recommendedTime" name="recommendedTime" required>
                            <option value="">Select time</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:30">6:30 PM</option>
                            <option value="19:30">7:30 PM</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('siteVisitModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="completeSiteVisit()">Complete Assessment</button>
            </div>
        </div>
    </div>

    <!-- Quote Generation Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote</h3>
                <button class="modal-close" onclick="closeModal('quoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <input type="text" id="quoteClientName" placeholder="Full Name" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="quoteClientPhone" placeholder="Phone Number" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="quoteClientAddress" placeholder="Address" required>
                            </div>
                            <div class="form-group">
                                <input type="email" id="quoteClientEmail" placeholder="Email" required>
                            </div>
                            <div class="form-group">
                                <input type="date" id="quoteDate" placeholder="Quote Date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                                    </div>
                                    <div class="item-controls">
                                        <div class="item-quantity">
                                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                                        </div>
                                        <div class="item-price">
                                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                                        </div>
                                        <div class="item-total">
                                            <span class="item-total-amount">$0.00</span>
                                        </div>
                                        <div class="item-actions">
                                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="item-photos-section">
                                    <div class="photos-header">
                                        <span class="photos-label">Photos:</span>
                                        <button type="button" class="add-photo-btn" onclick="addPhotoToServiceItem(this)">
                                            <i class="fas fa-camera"></i> Add Photo
                                        </button>
                                    </div>
                                    <div class="photos-container">
                                        <!-- Photos will be displayed here -->
                                    </div>
                                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="taxToggle" onchange="toggleTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="taxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="grandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuote()">
                            <i class="fas fa-save"></i> Save Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Modal -->
    <div id="quotePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Quote Saved Successfully</h3>
                <button class="modal-close" onclick="closeModal('quotePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="quotePreviewContent" class="quote-preview">
                    <!-- Quote content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('quotePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printQuote()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadQuotePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                        <button class="action-btn confirm">
                            <i class="fas fa-paper-plane"></i> Send Quote
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Generation Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="invoiceClientName">Full Name</label>
                                <input type="text" id="invoiceClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientPhone">Phone Number</label>
                                <input type="tel" id="invoiceClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientAddress">Address</label>
                                <input type="text" id="invoiceClientAddress" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientEmail">Email</label>
                                <input type="email" id="invoiceClientEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="invoiceServiceItems" class="service-items-container">
                            <!-- Service items will be populated from quote -->
                        </div>
                        <div class="add-item-container">
                            <button type="button" class="add-item-btn" onclick="addInvoiceServiceItem()">
                                <i class="fas fa-plus"></i> Add Service Item
                            </button>
                        </div>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="invoiceTaxToggle" onchange="toggleInvoiceTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="invoiceTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="invoiceTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="invoiceGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateInvoice()">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Quick Actions -->
        <div class="mobile-quick-actions">
            <button class="quick-action-btn refresh-action" onclick="manualRefreshBookings()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn test-action" onclick="testInvoiceModal()" title="Test Invoice Modal">
                <i class="fas fa-test"></i>
            </button>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Invoice Created Successfully</h3>
                <button class="modal-close" onclick="closeModal('invoicePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent" class="quote-preview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('invoicePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadInvoicePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                                            <button type="button" class="btn-info" onclick="sendInvoiceEmail(event)">
                            <i class="fas fa-envelope"></i> Send Email
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content photo-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-image"></i> Photo View</h3>
                <button class="modal-close" onclick="closeModal('photoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="photo-display">
                    <img id="modalPhoto" src="" alt="Service item photo" style="max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Image verification functions removed - now using improved storage system
    </script>

    <style>
        /* Image verification styles removed - using improved storage system */
        
        /* Service Item Photo Styles */
        .item-photos-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .photos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .photos-label {
            font-weight: 600;
            color: #2a2a2a;
            font-size: 14px;
        }
        
        .add-photo-btn {
            background: #fd7e14;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-photo-btn:hover {
            background: #ff8c42;
            transform: translateY(-1px);
        }
        
        .photos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            min-height: 40px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .photo-item img:hover {
            transform: scale(1.05);
        }
        
        .delete-photo-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .delete-photo-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        
        .no-photos {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
            text-align: center;
            grid-column: 1 / -1;
            padding: 10px;
        }

        /* Temporary photo styling */
        .temp-photo {
            position: relative;
        }
        
        .temp-photo-label {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(255, 193, 7, 0.9);
            color: #856404;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .temp-photo img {
            opacity: 0.8;
            border: 2px dashed #ffc107;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .photos-container {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .photo-item img {
                height: 60px;
            }
            
            .add-photo-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
        }

        /* Photo Modal Styles */
        .photo-modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .photo-display {
            text-align: center;
            padding: 20px;
        }
        
        .photo-display img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</body>
</html> 