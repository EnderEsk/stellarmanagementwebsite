<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Stellar Tree Management</title>
    <link rel="icon" type="image/x-icon" href="images/logo.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <script src="simple-google-oauth.js"></script>
    <style>
        /* Admin Panel Theme - Matching Stellar Tree Management */
        
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <img src="images/logo.png" alt="Stellar Tree Management Logo" class="logo">
            <ul class="nav-links">
                <li><a href="./">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/projects">Projects</a></li>
                <li><a href="/booking/">Book Quote</a></li>
                <li><a href="/admin" class="active">Admin</a></li>
            </ul>
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal show">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Access Required</h3>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label>Sign in with your email</label>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            Only authorized email addresses can access the admin panel.
                        </p>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button type="button" class="oauth-btn google-btn" onclick="window.simpleGoogleAuth.loginWithGoogle()">
                            <i class="fab fa-google"></i>
                            <span>Sign in with Google</span>
                        </button>
                    </div>
                    
                    <div id="loginError" class="error-message" style="display: none; color: #dc3545; margin-top: 1rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <p style="color: #666; font-size: 0.8rem; text-align: center; margin: 0;">
                    Secure authentication via OAuth 2.0
                </p>
            </div>
        </div>
    </div>

    <div class="admin-container" id="adminContent" style="display: none;">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <p>Manage bookings and view statistics for Stellar Tree Management</p>
            <div class="admin-actions">
                <div id="userInfo"></div>
                <button class="logout-btn" onclick="window.simpleGoogleAuth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <h3 id="pendingCount">0</h3>
                <p>Request Quote</p>
            </div>
            <div class="stat-card confirmed">
                <h3 id="confirmedCount">0</h3>
                <p>Request Booking</p>
            </div>
            <div class="stat-card pending-booking">
                <h3 id="pendingBookingCount">0</h3>
                <p>Booking Pending</p>
            </div>
            <div class="stat-card completed">
                <h3 id="completedCount">0</h3>
                <p>Confirmed Booking</p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="bookings-container">
            <!-- Active Bookings Section -->
            <div class="active-bookings-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-check"></i> <span id="sectionTitle">Request Quote</span></h2>
                            <button class="refresh-btn" onclick="manualRefreshBookings()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
                </div>

                <!-- Modern Filter Tabs -->
                <div class="filter-tabs">
                    <!-- Booking Status Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Booking Status</div>
                        <div class="tab-row">
                            <div class="filter-tab active" data-filter="all">
                                <i class="fas fa-list"></i>
                                All Active
                            </div>
                            <div class="filter-tab" data-filter="pending">
                                <i class="fas fa-clock"></i>
                                Request Quote
                            </div>
                            <div class="filter-tab" data-filter="confirmed">
                                <i class="fas fa-check-circle"></i>
                                Request Booking
                            </div>
                            <div class="filter-tab" data-filter="pending-booking">
                                <i class="fas fa-calendar-plus"></i>
                                Booking Pending
                            </div>
                            <div class="filter-tab" data-filter="completed">
                                <i class="fas fa-check-double"></i>
                                Confirmed Booking
                            </div>
                        </div>
                    </div>

                    <!-- Management Views Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Management Views</div>
                        <div class="tab-row">
                            <div class="filter-tab" data-filter="all-bookings">
                                <i class="fas fa-calendar-alt"></i>
                                All Bookings
                            </div>
                            <div class="filter-tab" data-filter="calendar">
                                <i class="fas fa-calendar-week"></i>
                                Calendar View
                            </div>
                            <div class="filter-tab" data-filter="customers">
                                <i class="fas fa-users"></i>
                                Customer Management
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bookings Grid -->
                <div class="bookings-grid" id="activeBookingsGrid">
                    <div class="empty-state">Loading bookings...</div>
                </div>

                <!-- Calendar View -->
                <div class="calendar-view" id="calendarView" style="display: none;">
                    <div class="calendar-controls">
                        <button class="calendar-nav-btn" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonth">July 2025</h3>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>
                    
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <span class="legend-indicator available"></span>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator booked"></span>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator blocked"></span>
                            <span>Blocked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator weekend"></span>
                            <span>Weekend</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Management View -->
                <div class="customer-view" id="customerView" style="display: none;">
                    <div class="customer-controls">
                        <div class="customer-search">
                            <input type="text" id="customerSearchInput" placeholder="Search customers by name, email, phone, or address..." class="search-input">
                            <button class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="customer-actions">
                            <button class="action-btn confirm" onclick="showAddCustomerModal()">
                                <i class="fas fa-plus"></i> Add Customer
                            </button>
                            <button class="action-btn complete" onclick="migrateCustomers()">
                                <i class="fas fa-sync"></i> Migrate Existing
                            </button>
                            <button class="action-btn warning" onclick="recalculateCustomerTotals()">
                                <i class="fas fa-calculator"></i> Recalculate Totals
                            </button>
                            <button class="action-btn info" onclick="refreshCustomerData()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="customers-grid" id="customersGrid">
                        <div class="empty-state">Loading customers...</div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Recent History</h2>
                </div>
                <div id="historyContainer">
                    <div style="text-align: center; color: var(--admin-secondary); font-style: italic;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Booking image">
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Booking Details</h3>
                <button class="modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Booking details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Date Blocking Modal -->
    <div id="dateBlockingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="blockingModalTitle">Manage Date</h3>
                <button class="modal-close" onclick="closeBlockingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-info">
                    <p><strong>Date:</strong> <span id="selectedDateDisplay"></span></p>
                    <p><strong>Status:</strong> <span id="dateStatusDisplay"></span></p>
                </div>
                <div class="blocking-actions">
                    <button class="action-btn confirm" onclick="toggleDateBlock()" id="toggleBlockBtn">
                        <i class="fas fa-lock"></i> Block Date
                    </button>
                    <button class="action-btn complete" onclick="unblockDate()" id="unblockBtn" style="display: none;">
                        <i class="fas fa-unlock"></i> Unblock Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBlockingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Booking Details Popup Modal -->
    <div id="bookingDetailsPopupModal" class="modal">
        <div class="modal-content booking-details-popup">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Booking Details</h3>
                <button class="modal-close" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="bookingDetailsPopupBody">
                <!-- Detailed booking information will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Move Booking Modal -->
    <div id="moveBookingModal" class="modal">
        <div class="modal-content move-booking-modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrows-alt"></i> Move Booking</h3>
                <button class="modal-close" onclick="closeMoveBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Booking Info Section -->
                <div class="move-booking-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <label>Current Date</label>
                                <span id="moveCurrentDate"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer</label>
                                <span id="moveCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <label>Phone</label>
                                <span id="moveCustomerPhone"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <label>Address</label>
                                <span id="moveCustomerAddress"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tools"></i>
                            <div>
                                <label>Service</label>
                                <span id="moveService"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="moveBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Selection Section -->
                <div class="move-date-selection">
                    <h4><i class="fas fa-calendar-plus"></i> Select New Date</h4>
                    
                    <!-- Calendar Navigation -->
                    <div class="move-calendar-nav">
                        <button class="nav-btn" onclick="changeMoveMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="moveCalendarMonth"></span>
                        <button class="nav-btn" onclick="changeMoveMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="move-calendar-grid" id="moveCalendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>

                    <!-- Selected Date Display -->
                    <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Selected: <strong id="selectedDateText"></strong></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="move-actions">
                    <button class="action-btn confirm" id="moveConfirmBtn" onclick="moveBooking()" disabled>
                        <i class="fas fa-arrows-alt"></i> Move to Selected Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeMoveBookingModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Management Modals -->

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <input type="text" id="customerAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">Notes</label>
                        <textarea id="customerNotes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customerDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 id="customerDetailsTitle">Customer Details</h3>
                <button class="modal-close" onclick="closeCustomerDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <!-- Customer details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerDetailsModal()">Close</button>
                <button type="button" class="btn-primary" onclick="editCustomer()">Edit Customer</button>
            </div>
        </div>
    </div>

    <script>
        let allBookings = [];
        let currentFilter = 'all';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let blockedDates = [];
        let selectedDate = null;
        
        // Customer Management Variables
        let allCustomers = [];
        let currentCustomerId = null;

        // Helper function to format date without timezone issues
        function formatBookingDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        // OAuth Authentication - handled by oauth-auth.js
        // The OAuth authentication system is now managed by the OAuthAuth class
        
        // Legacy logout function for compatibility
        function logout() {
            if (window.simpleGoogleAuth) {
                window.simpleGoogleAuth.logout();
            } else {
                // Fallback logout
                sessionStorage.removeItem('adminOAuthSession');
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminSession');
                location.reload();
            }
        }

        // Load admin configuration from server
        async function loadAdminConfig() {
            try {
                const response = await fetch('/api/admin-config');
                if (response.ok) {
                    const config = await response.json();
                    window.ADMIN_CONFIG = config;
                } else {
                    console.warn('Failed to load admin config, using defaults');
                }
            } catch (error) {
                console.warn('Error loading admin config:', error);
            }
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load admin configuration first
            await loadAdminConfig();
            
            // OAuth authentication is handled by simple-google-oauth.js
            // The SimpleGoogleOAuth class will automatically check for existing sessions
            // and show/hide the appropriate UI elements
            
            // Clear form fields on page load if authenticated
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                clearFormFields();
                // Load bookings immediately if authenticated
                loadBookings();
            }
            
            // Add a fallback to load bookings after a short delay
            // This ensures bookings are loaded even if there are timing issues
            setTimeout(() => {
                if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                    console.log('🔄 Fallback: Loading bookings...');
                    loadBookings();
                }
            }, 2000);
        });

        // Clear cached quote and invoice data
        function clearCachedData() {
            currentQuoteData = null;
            currentInvoiceData = null;
            console.log('Cleared cached quote and invoice data');
        }

        // Clear cached data for a specific booking
        function clearCachedDataForBooking(bookingId) {
            if (currentQuoteData && currentQuoteData.bookingId !== bookingId) {
                currentQuoteData = null;
            }
            if (currentInvoiceData && currentInvoiceData.bookingId !== bookingId) {
                currentInvoiceData = null;
            }
            console.log(`Cleared cached data for booking: ${bookingId}`);
        }

        // Clear form fields
        function clearFormFields() {
            // Clear quote form fields
            const quoteFields = [
                'quoteClientName',
                'quoteClientPhone', 
                'quoteClientAddress',
                'quoteClientEmail',
                'quoteDate'
            ];
            
            quoteFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear invoice form fields
            const invoiceFields = [
                'invoiceClientName',
                'invoiceClientPhone',
                'invoiceClientAddress', 
                'invoiceClientEmail',
                'invoiceDate'
            ];
            
            invoiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear service items containers
            const quoteContainer = document.querySelector('.service-items-container');
            const invoiceContainer = document.getElementById('invoiceServiceItems');
            
            if (quoteContainer) {
                quoteContainer.innerHTML = '';
            }
            
            if (invoiceContainer) {
                invoiceContainer.innerHTML = '';
            }
            
            // Reset tax toggles
            const taxToggle = document.getElementById('taxToggle');
            const invoiceTaxToggle = document.getElementById('invoiceTaxToggle');
            
            if (taxToggle) {
                taxToggle.checked = false;
            }
            
            if (invoiceTaxToggle) {
                invoiceTaxToggle.checked = false;
            }
            
            // Reset total display elements to zero
            const totalElements = [
                'subtotalAmount',
                'taxAmount', 
                'grandTotalAmount',
                'invoiceSubtotalAmount',
                'invoiceTaxAmount',
                'invoiceGrandTotalAmount'
            ];
            
            totalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = '$0.00';
                }
            });
            
            console.log('Cleared all form fields and reset totals');
        }

        // Helper function to get admin auth headers
        function getAuthHeaders() {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                return window.simpleGoogleAuth.getAuthHeaders();
            }
            return {};
        }

        // Manual refresh function with visual feedback
        async function manualRefreshBookings() {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                refreshBtn.disabled = true;
                
                try {
                    await loadBookings();
                    showNotification('Bookings refreshed successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to refresh bookings', 'error');
                } finally {
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 1000);
                }
            }
        }

        // Load bookings from API
        async function loadBookings() {
            try {
                console.log('🔄 Loading bookings...');
                console.log('🔍 OAuth status:', window.simpleGoogleAuth ? 'Available' : 'Not available');
                console.log('🔍 Authentication status:', window.simpleGoogleAuth ? window.simpleGoogleAuth.isUserAuthenticated() : 'N/A');
                
                // Check if user is authenticated
                if (!window.simpleGoogleAuth || !window.simpleGoogleAuth.isUserAuthenticated()) {
                    console.log('⚠️ User not authenticated, skipping booking load');
                    console.log('🔍 SimpleGoogleAuth object:', window.simpleGoogleAuth);
                    if (window.simpleGoogleAuth) {
                        console.log('🔍 Is authenticated:', window.simpleGoogleAuth.isUserAuthenticated());
                        console.log('🔍 User profile:', window.simpleGoogleAuth.userProfile);
                    }
                    return;
                }
                
                console.log('🔍 Auth headers:', getAuthHeaders());
                
                const response = await fetch('/api/bookings', {
                    headers: getAuthHeaders()
                });
                
                console.log('📊 Response status:', response.status);
                console.log('📊 Response headers:', response.headers);
                
                if (response.ok) {
                    allBookings = await response.json();
                    
                    // Debug: Check for bookings with images
                    const bookingsWithImages = allBookings.filter(booking => booking.images);
                    console.log('✅ Loaded bookings:', allBookings.length);
                    console.log('Bookings with images:', bookingsWithImages.length);
                    if (bookingsWithImages.length > 0) {
                        console.log('Sample booking with images:', bookingsWithImages[0]);
                        console.log('Sample booking images field:', bookingsWithImages[0].images);
                        try {
                            const parsedImages = JSON.parse(bookingsWithImages[0].images);
                            console.log('Parsed images:', parsedImages);
                        } catch (e) {
                            console.error('Error parsing images:', e);
                        }
                    }
                    
                    // Clear cached data when loading bookings
                    clearCachedData();
                    
                    // Update UI components
                    updateStatistics();
                    renderActiveBookings();
                    renderHistory();
                    
                    if (currentFilter === 'calendar') {
                        renderCalendar();
                    }
                    
                    // Initialize customer management if needed
                    if (currentFilter === 'customers') {
                        loadCustomers();
                    }
                    
                    // Bookings loaded successfully (notification removed)
                    
                } else if (response.status === 401 || response.status === 403) {
                    // Authentication failed, logout
                    console.log('❌ Authentication failed, logging out...');
                    console.log('📊 Response text:', await response.text());
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to load bookings:', response.status, response.statusText);
                    console.error('❌ Error response:', errorText);
                    showNotification('Failed to load bookings', 'error');
                }
            } catch (error) {
                console.error('❌ Error loading bookings:', error);
                console.error('❌ Error stack:', error.stack);
                showNotification('Network error loading bookings', 'error');
            }
        }

        // Load blocked dates
        async function loadBlockedDates() {
            try {
                const response = await fetch('/api/blocked-dates');
                if (response.ok) {
                    blockedDates = await response.json();
                } else {
                    blockedDates = [];
                }
            } catch (error) {
                console.error('Error loading blocked dates:', error);
                blockedDates = [];
            }
        }

        // Update statistics
        function updateStatistics() {
            const stats = {
                pending: allBookings.filter(b => b.status === 'pending').length,
                confirmed: allBookings.filter(b => b.status === 'confirmed').length,
                pendingBooking: allBookings.filter(b => b.status === 'pending-booking').length,
                completed: allBookings.filter(b => b.status === 'completed').length
            };

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('confirmedCount').textContent = stats.confirmed;
            document.getElementById('pendingBookingCount').textContent = stats.pendingBooking;
            document.getElementById('completedCount').textContent = stats.completed;
        }

        // Render active bookings (pending and confirmed)
        function renderActiveBookings() {
            const grid = document.getElementById('activeBookingsGrid');
            
            // Show loading state if no bookings are loaded yet
            if (!allBookings || allBookings.length === 0) {
                grid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading bookings...</div>';
                return;
            }
            
            // Apply filter
            let filteredBookings = [];
            
            if (currentFilter === 'all') {
                // Show only active bookings (pending, confirmed, pending-booking, and completed)
                filteredBookings = allBookings.filter(booking => 
                    booking.status === 'pending' || booking.status === 'confirmed' || 
                    booking.status === 'pending-booking' || booking.status === 'completed'
                );
            } else if (currentFilter === 'pending') {
                filteredBookings = allBookings.filter(b => b.status === 'pending');
            } else if (currentFilter === 'confirmed') {
                filteredBookings = allBookings.filter(b => b.status === 'confirmed');
            } else if (currentFilter === 'pending-booking') {
                filteredBookings = allBookings.filter(b => b.status === 'pending-booking');
            } else if (currentFilter === 'completed') {
                filteredBookings = allBookings.filter(b => b.status === 'completed');
            } else if (currentFilter === 'all-bookings') {
                // Show all bookings including completed and cancelled
                filteredBookings = allBookings;
            }

            if (filteredBookings.length === 0) {
                grid.innerHTML = '<div class="empty-state">No bookings found</div>';
                return;
            }

            grid.innerHTML = filteredBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const statusClass = `status-${booking.status}`;
                const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

                let actionButtons = '';
                if (booking.status === 'pending') {
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn confirm" onclick="confirmQuoteAndSendEmail('${booking.booking_id}')">
                            <i class="fas fa-check"></i> Confirm Quote
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'confirmed') {
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'pending-booking') {
                    actionButtons = `
                        <button class="action-btn confirm" onclick="confirmBooking('${booking.booking_id}')">
                            <i class="fas fa-check-double"></i> Confirm Booking
                        </button>
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'completed') {
                    actionButtons = `
                        <span class="status-badge status-completed">
                            <i class="fas fa-check-double"></i> Completed
                        </span>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'cancelled') {
                    actionButtons = `
                        <span class="status-badge status-cancelled">
                            <i class="fas fa-times"></i> Cancelled
                        </span>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }

                const cardClass = booking.status === 'completed' ? 'completed' : 
                                 booking.status === 'cancelled' ? 'cancelled' : '';
                
                return `
                    <div class="booking-card ${cardClass}" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                        <div class="booking-header">
                            <div class="booking-id">${booking.booking_id}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="booking-essentials">
                            <div class="essential-row">
                                <i class="fas fa-tools essential-icon"></i>
                                <span class="essential-label">Service:</span>
                                <span class="essential-value">${booking.service}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-calendar essential-icon"></i>
                                <span class="essential-label">Date:</span>
                                <span class="essential-value">${formatBookingDate(booking.date)}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-clock essential-icon"></i>
                                <span class="essential-label">Time:</span>
                                <span class="essential-value">${booking.time}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-user essential-icon"></i>
                                <span class="essential-label">Customer:</span>
                                <span class="essential-value">${booking.name}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-phone essential-icon"></i>
                                <span class="essential-label">Phone:</span>
                                <span class="essential-value">${booking.phone || 'N/A'}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-map-marker-alt essential-icon"></i>
                                <span class="essential-label">Address:</span>
                                <span class="essential-value">${booking.address ? (booking.address.length > 30 ? booking.address.substring(0, 30) + '...' : booking.address) : 'N/A'}</span>
                            </div>
                            ${booking.images ? `
                            <div class="booking-images">
                                <div class="images-preview">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.slice(0, 3).map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Old</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-thumbnail" 
                                                                 onclick="event.stopPropagation(); showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Image</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>?</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('') + 
                                                (imageArray.length > 3 ? `
                                                    <div class="more-images">+${imageArray.length - 3}</div>
                                                ` : '');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="booking-actions" onclick="event.stopPropagation();">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
                    // Setup calendar drag and drop after rendering (only for calendar tab)
        if (currentFilter === 'calendar') {
            setupCalendarDragAndDrop();
        }
        }

        // Render history (completed and cancelled)
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            const historyBookings = allBookings.filter(booking => 
                booking.status === 'completed' || booking.status === 'cancelled'
            ).slice(0, 10); // Show last 10

            if (historyBookings.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--admin-secondary); font-style: italic;">No recent activity</div>';
                return;
            }

            container.innerHTML = historyBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const historyDate = formatBookingDate(booking.date);

                return `
                    <div class="history-item ${booking.status}">
                        <h4>${booking.service} - ${booking.name}</h4>
                        <p><strong>ID:</strong> ${booking.booking_id}</p>
                        <p><strong>Date:</strong> ${dateTime}</p>
                        <p><strong>Email:</strong> ${booking.email}</p>
                        <p><strong>Phone:</strong> ${booking.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${booking.address || 'N/A'}</p>
                        <p class="history-date">${booking.status} - Booked for ${historyDate}</p>
                    </div>
                `;
            }).join('');
        }

        // Update booking status
        async function updateBookingStatus(bookingId, newStatus) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showNotification(`Booking ${newStatus} successfully`, 'success');
                    loadBookings(); // Reload to update the display
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking', 'error');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showNotification('Network error updating booking', 'error');
            }
        }

        // Confirm quote and send email to customer
        async function confirmQuoteAndSendEmail(bookingId) {
            try {
                // First, update the booking status to 'confirmed' (Request Booking)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'confirmed' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking status', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send email to customer with booking link
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-booking-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    showNotification('Quote confirmed and email content generated successfully', 'success');
                    console.log('📧 Email content generated:', emailResult.emailContent);
                    loadBookings(); // Reload to update the display
                } else {
                    const emailError = await emailResponse.json();
                    showNotification(`Booking updated but email failed: ${emailError.error}`, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming quote:', error);
                showNotification('Network error confirming quote', 'error');
            }
        }

        // Confirm booking (admin confirms customer's booking request)
        async function confirmBooking(bookingId) {
            try {
                // Update the booking status to 'completed' (Confirmed Booking)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to confirm booking', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send confirmation email to customer
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-confirmation-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    showNotification('Booking confirmed and confirmation email content generated successfully', 'success');
                    console.log('📧 Final confirmation email content generated:', emailResult.emailContent);
                    loadBookings(); // Reload to update the display
                } else {
                    const emailError = await emailResponse.json();
                    showNotification(`Booking confirmed but email failed: ${emailError.error}`, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showNotification('Network error confirming booking', 'error');
            }
        }

        // Check for quote and complete booking
        async function checkForQuoteAndComplete(bookingId) {
            try {
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Check if there's a quote for this booking
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`);
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const latestQuote = quotes[0];
                        showInvoiceModal(latestQuote, booking);
                    } else {
                        // No quote found, ask user if they want to create one
                        if (confirm('No quote found for this booking. Would you like to create a quote first?')) {
                            showQuoteModal(booking);
                        } else {
                            // Complete without quote
                            await updateBookingStatus(bookingId, 'completed');
                        }
                    }
                } else {
                    showNotification('Error checking for quotes', 'error');
                }
            } catch (error) {
                console.error('Error checking for quote:', error);
                showNotification('Network error checking for quote', 'error');
            }
        }

        // Delete booking permanently
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to permanently delete this booking? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Booking deleted successfully', 'success');
                    loadBookings(); // Reload to get updated data
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || error.message || 'Failed to delete booking', 'error');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showNotification('Network error deleting booking', 'error');
            }
        }

        // Filter functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update filter
                currentFilter = e.target.dataset.filter;
                updateSectionTitle();
                
                // Show/hide appropriate view
                if (currentFilter === 'calendar') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'block';
                    loadBlockedDates().then(() => renderCalendar());
                } else {
                    document.getElementById('activeBookingsGrid').style.display = 'grid';
                    document.getElementById('calendarView').style.display = 'none';
                    renderActiveBookings();
                }
            }
        });

        // Update section title based on current filter
        function updateSectionTitle() {
            const sectionTitle = document.getElementById('sectionTitle');
            switch (currentFilter) {
                case 'all':
                    sectionTitle.textContent = 'Request Quote';
                    break;
                case 'pending':
                    sectionTitle.textContent = 'Request Quote';
                    break;
                case 'confirmed':
                    sectionTitle.textContent = 'Request Booking';
                    break;
                case 'pending-booking':
                    sectionTitle.textContent = 'Booking Pending';
                    break;
                case 'completed':
                    sectionTitle.textContent = 'Confirmed Booking';
                    break;
                case 'all-bookings':
                    sectionTitle.textContent = 'All Bookings';
                    break;
                case 'calendar':
                    sectionTitle.textContent = 'Calendar';
                    break;
                default:
                    sectionTitle.textContent = 'Request Quote';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Calendar functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear grid
            grid.innerHTML = '';
            
            // Check if we're on mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile-friendly calendar with weeks
                renderMobileCalendar(grid);
            } else {
                // Desktop calendar (original grid layout)
                renderDesktopCalendar(grid);
            }
        }

        function renderMobileCalendar(grid) {
            // Create vertical timeline container
            const timelineContainer = document.createElement('div');
            timelineContainer.className = 'timeline-container';
            
            // Create vertical line
            const timelineLine = document.createElement('div');
            timelineLine.className = 'timeline-line';
            timelineContainer.appendChild(timelineLine);
            
            // Get all days in the current month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const today = new Date();
            
            // Generate timeline for each day in the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(currentYear, currentMonth, day);
                const dateString = currentDate.toISOString().split('T')[0];
                
                // Create timeline item
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                timelineItem.dataset.date = dateString;
                
                // Create timeline dot
                const timelineDot = document.createElement('div');
                timelineDot.className = 'timeline-dot';
                
                // Check if it's today
                if (currentDate.toDateString() === today.toDateString()) {
                    timelineDot.classList.add('today');
                }
                
                // Check if it's weekend
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                // Check if it's blocked
                const isBlocked = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                );
                const isUnblockedWeekend = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                );
                
                // Set dot color based on status
                if (isBlocked) {
                    timelineDot.classList.add('blocked');
                } else if (isWeekend && !isUnblockedWeekend) {
                    timelineDot.classList.add('weekend');
                } else if (isUnblockedWeekend) {
                    timelineDot.classList.add('available');
                }
                
                // Create date column
                const dateColumn = document.createElement('div');
                dateColumn.className = 'date-column';
                
                const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = currentDate.getDate();
                
                dateColumn.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-number">${dayNumber}</div>
                `;
                
                // Create events column
                const eventsColumn = document.createElement('div');
                eventsColumn.className = 'events-column';
                
                // Check for bookings
                const dayBookings = allBookings.filter(booking => 
                    booking.date === dateString && 
                    (booking.status === 'confirmed' || booking.status === 'pending')
                );
                
                if (dayBookings.length > 0) {
                    timelineDot.classList.add('booked');
                    
                    // Create booking events
                    dayBookings.forEach(booking => {
                        const eventBlock = document.createElement('div');
                        eventBlock.className = `event-block ${booking.status}`;
                        eventBlock.dataset.bookingId = booking.id;
                        
                        const timeSlot = booking.time || 'TBD';
                        const customerName = booking.name || 'Unknown';
                        
                        eventBlock.innerHTML = `
                            <div class="event-time">${timeSlot}</div>
                            <div class="event-customer">${customerName}</div>
                            <div class="event-status">${booking.status}</div>
                        `;
                        
                        // Add click handler for booking details
                        eventBlock.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showBookingDetails(booking);
                        });
                        
                        eventsColumn.appendChild(eventBlock);
                    });
                } else {
                    // Show availability status
                    let statusText = 'Available';
                    let statusClass = 'available';
                    
                    if (isBlocked) {
                        statusText = 'Blocked';
                        statusClass = 'blocked';
                    } else if (isWeekend && !isUnblockedWeekend) {
                        statusText = 'Weekend';
                        statusClass = 'weekend';
                    }
                    
                    const statusBlock = document.createElement('div');
                    statusBlock.className = `status-block ${statusClass}`;
                    statusBlock.textContent = statusText;
                    eventsColumn.appendChild(statusBlock);
                }
                
                // Add click handler for day management
                timelineItem.addEventListener('click', () => handleDayClick(currentDate, dayBookings));
                
                // Add drag and drop handlers
                timelineItem.addEventListener('dragover', handleCalendarDragOver);
                timelineItem.addEventListener('drop', handleCalendarDrop);
                timelineItem.addEventListener('dragenter', handleCalendarDragEnter);
                timelineItem.addEventListener('dragleave', handleCalendarDragLeave);
                
                // Assemble timeline item
                timelineItem.appendChild(timelineDot);
                timelineItem.appendChild(dateColumn);
                timelineItem.appendChild(eventsColumn);
                
                timelineContainer.appendChild(timelineItem);
            }
            
            grid.appendChild(timelineContainer);
        }

        function renderDesktopCalendar(grid) {
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                header.style.fontWeight = 'bold';
                header.style.color = 'var(--admin-primary)';
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateString = currentDate.toISOString().split('T')[0];
                
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = currentDate.getDate();
                dayElement.dataset.date = dateString;
                
                // Check if it's current month
                if (currentDate.getMonth() !== currentMonth) {
                    dayElement.style.opacity = '0.3';
                }
                
                // Check if it's today
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if it's weekend (automatically blocked)
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                // Check if it's blocked
                const isBlocked = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                );
                const isUnblockedWeekend = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                );
                
                if (isBlocked) {
                    dayElement.classList.add('blocked');
                } else if (isWeekend && !isUnblockedWeekend) {
                    // Weekends are blocked by default unless explicitly unblocked
                    dayElement.classList.add('weekend');
                } else if (isUnblockedWeekend) {
                    // Unblocked weekends show as available
                    dayElement.classList.add('available');
                }
                
                // Check if it's booked
                const dayBookings = allBookings.filter(booking => 
                    booking.date === dateString && 
                    (booking.status === 'confirmed' || booking.status === 'pending')
                );
                if (dayBookings.length > 0) {
                    dayElement.classList.add('booked');
                    // Add booking info to the day
                    const bookingInfo = document.createElement('div');
                    bookingInfo.className = 'booking-info';
                    
                    // Group bookings by time slot
                    const timeSlots = ['8:00 AM', '1:00 PM', '4:00 PM'];
                    const bookedTimeSlots = timeSlots.filter(time => 
                        dayBookings.some(booking => booking.time === time)
                    );
                    
                    bookingInfo.innerHTML = `
                        <div class="booking-count">${dayBookings.length}</div>
                        <div class="booking-preview">${bookedTimeSlots.join(', ')}</div>
                    `;
                    dayElement.appendChild(bookingInfo);
                }
                
                // Add click handler
                dayElement.addEventListener('click', () => handleDayClick(currentDate, dayBookings));
                
                // Add drag and drop handlers for calendar days
                dayElement.addEventListener('dragover', handleCalendarDragOver);
                dayElement.addEventListener('drop', handleCalendarDrop);
                dayElement.addEventListener('dragenter', handleCalendarDragEnter);
                dayElement.addEventListener('dragleave', handleCalendarDragLeave);
                
                grid.appendChild(dayElement);
            }
        }

        function handleDayClick(date, bookings) {
            const dateString = date.toISOString().split('T')[0];
            const isBlocked = blockedDates.some(blockedDate => 
                blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
            );
            const isUnblockedWeekend = blockedDates.some(blockedDate => 
                blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
            );
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            if (bookings.length > 0) {
                // Show booking details
                showBookingDetails(date, bookings);
            } else if (isBlocked) {
                // Show unblock option for manually blocked dates
                showBlockingModal(date, true);
            } else if (isWeekend && isUnblockedWeekend) {
                // Show re-block option for unblocked weekends
                showBlockingModal(date, 'unblocked_weekend');
            } else if (isWeekend) {
                // Show make available option for blocked weekends
                showBlockingModal(date, 'weekend');
            } else {
                // Show blocking management for available dates
                showBlockingModal(date, false);
            }
        }

        function showCalendarPopup(date, bookings) {
            const modal = document.getElementById('bookingDetailsModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const dateString = date.toISOString().split('T')[0];
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const isBlocked = blockedDates.some(d => d.date === dateString);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            // Clear existing modal structure and create clean content
            modalContent.innerHTML = '';
            
            let popupContent = `
                <div class="calendar-popup-compact">
                    <div class="calendar-popup-header">
                        <div class="calendar-popup-date">${formattedDate}</div>
                        <button class="calendar-popup-close" onclick="closeModal('bookingDetailsModal')">&times;</button>
                    </div>
                    <div class="calendar-popup-content">
            `;
            
            if (bookings.length > 0) {
                bookings.forEach(booking => {
                    popupContent += `
                        <div class="calendar-booking-preview" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                            <h4>${booking.service}</h4>
                            <p>${booking.time} • ${booking.name}</p>
                        </div>
                    `;
                });
            } else {
                popupContent += `
                    <div class="calendar-booking-preview" style="border-left-color: #6c757d;">
                        <h4>No Bookings</h4>
                        <p>This date is available</p>
                    </div>
                `;
            }
            
            popupContent += `
                    </div>
                    <div class="calendar-popup-actions">
            `;
            
            if (isWeekend) {
                if (isBlocked) {
                    popupContent += `<button class="calendar-popup-btn primary" onclick="unblockWeekend('${dateString}')">Make Available</button>`;
                } else {
                    popupContent += `<button class="calendar-popup-btn secondary" onclick="reblockWeekend('${dateString}')">Block Weekend</button>`;
                }
            } else {
                if (isBlocked) {
                    popupContent += `<button class="calendar-popup-btn primary" onclick="unblockDate('${dateString}')">Unblock Date</button>`;
                } else {
                    popupContent += `<button class="calendar-popup-btn secondary" onclick="toggleDateBlock('${dateString}')">Block Date</button>`;
                }
            }
            
            popupContent += `
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = popupContent;
            openModal('bookingDetailsModal');
        }

        function showBookingDetails(date, bookings) {
            showCalendarPopup(date, bookings);
        }

        function showBlockingModal(date, isBlocked) {
            const modal = document.getElementById('dateBlockingModal');
            const dateDisplay = document.getElementById('selectedDateDisplay');
            const statusDisplay = document.getElementById('dateStatusDisplay');
            const toggleBtn = document.getElementById('toggleBlockBtn');
            const unblockBtn = document.getElementById('unblockBtn');
            
            selectedDate = date;
            const dateString = date.toISOString().split('T')[0];
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            dateDisplay.textContent = formattedDate;
            
            if (isBlocked === 'weekend') {
                // Weekend - show make available option
                statusDisplay.textContent = 'Weekend';
                statusDisplay.style.color = 'var(--admin-primary)';
                toggleBtn.innerHTML = '<i class="fas fa-unlock"></i> Make Available';
                toggleBtn.className = 'action-btn confirm';
                toggleBtn.onclick = () => unblockWeekend(dateString);
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            } else if (isBlocked === 'unblocked_weekend') {
                // Unblocked weekend - show re-block option
                statusDisplay.textContent = 'Weekend (Available)';
                statusDisplay.style.color = 'var(--admin-success)';
                toggleBtn.innerHTML = '<i class="fas fa-lock"></i> Block Weekend';
                toggleBtn.className = 'action-btn cancel';
                toggleBtn.onclick = () => reblockWeekend(dateString);
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            } else if (isBlocked) {
                // Manually blocked date - show unblock option
                statusDisplay.textContent = 'Blocked';
                statusDisplay.style.color = 'var(--admin-danger)';
                toggleBtn.style.display = 'none';
                unblockBtn.style.display = 'inline-flex';
            } else {
                // Available date - show block option
                statusDisplay.textContent = 'Available';
                statusDisplay.style.color = 'var(--admin-success)';
                toggleBtn.innerHTML = '<i class="fas fa-lock"></i> Block Date';
                toggleBtn.className = 'action-btn confirm';
                toggleBtn.onclick = () => toggleDateBlock();
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            }
            
            openModal('dateBlockingModal');
        }

        function closeBookingModal() {
            document.getElementById('bookingDetailsModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function closeBlockingModal() {
            document.getElementById('dateBlockingModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        let moveBookingData = null;
        let moveCalendarMonth = new Date();
        let selectedMoveDate = null;

        function showMoveBookingModal(bookingId, currentDate) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            moveBookingData = booking;
            moveCalendarMonth = new Date();
            selectedMoveDate = null;

            // Populate booking info
            document.getElementById('moveBookingId').textContent = booking.booking_id;
            document.getElementById('moveCurrentDate').textContent = (() => {
                const [year, month, day] = booking.date.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            })();
            document.getElementById('moveCustomerName').textContent = booking.name;
            document.getElementById('moveCustomerPhone').textContent = booking.phone || 'Not provided';
            document.getElementById('moveCustomerAddress').textContent = booking.address || 'Not provided';
            document.getElementById('moveService').textContent = booking.service;

            // Reset UI
            document.getElementById('selectedDateDisplay').style.display = 'none';
            document.getElementById('moveConfirmBtn').disabled = true;

            // Render move calendar
            renderMoveCalendar();

            openModal('moveBookingModal');
        }

        function closeMoveBookingModal() {
            document.getElementById('moveBookingModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            moveBookingData = null;
            selectedMoveDate = null;
        }

        function showBookingDetailsPopup(bookingId) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const createdDate = new Date(booking.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const statusClass = `status-${booking.status}`;
            const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

            let actionButtons = '';
            if (booking.status === 'pending') {
                actionButtons = `
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'confirmed') {
                actionButtons = `
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'completed') {
                actionButtons = `
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-undo"></i> Reopen
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'cancelled') {
                actionButtons = `
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            }

            const modalBody = document.getElementById('bookingDetailsPopupBody');
            modalBody.innerHTML = `
                <div class="detail-popup-grid">
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-info-circle"></i> Booking Info</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">ID:</span>
                            <span class="detail-popup-value">${booking.booking_id}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Status:</span>
                            <span class="detail-popup-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Service:</span>
                            <span class="detail-popup-value">${booking.service}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-calendar-alt"></i> Schedule</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Date:</span>
                            <span class="detail-popup-value">${dateTime}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Booking Date:</span>
                            <span class="detail-popup-value">${(() => {
                                const [year, month, day] = booking.date.split('-').map(Number);
                                const date = new Date(year, month - 1, day);
                                return date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                            })()}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-user"></i> Customer</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Name:</span>
                            <span class="detail-popup-value">${booking.name}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Email:</span>
                            <span class="detail-popup-value">${booking.email}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Phone:</span>
                            <span class="detail-popup-value">${booking.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Address:</span>
                            <span class="detail-popup-value">${booking.address || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Notes:</span>
                            <div class="detail-popup-value">
                                <textarea id="bookingNotes" class="notes-textarea" placeholder="Add your personal notes here...">${booking.notes || ''}</textarea>
                                <button class="action-btn confirm" onclick="updateBookingNotes('${booking.booking_id}')" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Save Notes
                                </button>
                            </div>
                        </div>
                        ${booking.images ? `
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Images:</span>
                            <div class="detail-popup-value">
                                <div class="booking-images-detail">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Old Image (Not Available)</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-detail" 
                                                                 onclick="showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder-detail" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Image Unavailable</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Unknown Format</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking details:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${actionButtons ? `
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-cogs"></i> Actions</h4>
                        <div class="detail-popup-actions">
                            ${actionButtons}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            openModal('bookingDetailsPopupModal');
        }

        function closeBookingDetailsPopup() {
            document.getElementById('bookingDetailsPopupModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function renderMoveCalendar() {
            const year = moveCalendarMonth.getFullYear();
            const month = moveCalendarMonth.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('moveCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const grid = document.getElementById('moveCalendarGrid');
            grid.innerHTML = '';
            
            // Add day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = currentDate.getDate();
                
                // Check if it's current month
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Check if it's today
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if it's in the past
                if (currentDate < today) {
                    dayElement.classList.add('disabled');
                } else {
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    // Check if it's the current booking date
                    if (moveBookingData && dateString === moveBookingData.date) {
                        dayElement.classList.add('disabled');
                        dayElement.title = 'Current booking date';
                    } else {
                        // Check if it's booked
                        const dayBookings = allBookings.filter(booking => 
                            booking.date === dateString && 
                            (booking.status === 'confirmed' || booking.status === 'pending')
                        );
                        
                        if (dayBookings.length > 0) {
                            dayElement.classList.add('booked');
                            dayElement.title = 'Already booked';
                        } else {
                            // Check if it's blocked
                            const isBlocked = blockedDates.some(blockedDate => 
                                blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                            );
                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                            const isUnblockedWeekend = blockedDates.some(blockedDate => 
                                blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                            );
                            
                            if (isBlocked || (isWeekend && !isUnblockedWeekend)) {
                                dayElement.classList.add('blocked');
                                dayElement.title = 'Date blocked';
                            } else {
                                dayElement.classList.add('available');
                                dayElement.addEventListener('click', () => selectMoveDate(currentDate, dateString));
                            }
                        }
                    }
                }
                
                grid.appendChild(dayElement);
            }
        }

        function changeMoveMonth(direction) {
            moveCalendarMonth.setMonth(moveCalendarMonth.getMonth() + direction);
            renderMoveCalendar();
        }

        function selectMoveDate(date, dateString) {
            // Remove previous selection
            document.querySelectorAll('.move-calendar-grid .day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection to clicked day
            const dayElements = document.querySelectorAll('.move-calendar-grid .day');
            const dayIndex = Array.from(dayElements).findIndex(day => 
                day.textContent == date.getDate() && 
                !day.classList.contains('other-month')
            );
            
            if (dayIndex !== -1) {
                dayElements[dayIndex].classList.add('selected');
            }
            
            selectedMoveDate = dateString;
            
            // Update selected date display
            const selectedDateText = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('selectedDateText').textContent = selectedDateText;
            document.getElementById('selectedDateDisplay').style.display = 'flex';
            document.getElementById('moveConfirmBtn').disabled = false;
        }

        async function moveBooking() {
            if (!selectedMoveDate || !moveBookingData) {
                showNotification('Please select a new date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${moveBookingData.booking_id}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newDate: selectedMoveDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    closeMoveBookingModal();
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }
        }

        async function toggleDateBlock() {
            if (!selectedDate) return;
            
            const dateString = selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date: dateString })
                });
                
                if (response.ok) {
                    showNotification('Date blocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    showNotification('Failed to block date', 'error');
                }
            } catch (error) {
                console.error('Error blocking date:', error);
                showNotification('Network error blocking date', 'error');
            }
        }

        async function unblockWeekend(dateString) {
            try {
                // Add the weekend to blocked dates with a special flag to indicate it's unblocked
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        date: dateString,
                        unblockWeekend: true 
                    })
                });

                if (response.ok) {
                    showNotification('Weekend made available for booking', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to make weekend available', 'error');
                }
            } catch (error) {
                console.error('Error making weekend available:', error);
                showNotification('Network error making weekend available', 'error');
            }
        }

        async function reblockWeekend(dateString) {
            try {
                // Remove the weekend from blocked dates to re-block it
                const response = await fetch(`/api/blocked-dates/${dateString}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Weekend blocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to block weekend', 'error');
                }
            } catch (error) {
                console.error('Error blocking weekend:', error);
                showNotification('Network error blocking weekend', 'error');
            }
        }

        async function unblockDate() {
            if (!selectedDate) return;
            
            const dateString = selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/blocked-dates/${dateString}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Date unblocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    showNotification('Failed to unblock date', 'error');
                }
            } catch (error) {
                console.error('Error unblocking date:', error);
                showNotification('Network error unblocking date', 'error');
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Calendar Drag and Drop functionality
        function setupCalendarDragAndDrop() {
            const bookedDays = document.querySelectorAll('.calendar-grid .day.booked');
            
            bookedDays.forEach(day => {
                day.draggable = true;
                day.addEventListener('dragstart', handleCalendarDragStart);
                day.addEventListener('dragend', handleCalendarDragEnd);
            });
        }

        function handleCalendarDragStart(e) {
            e.target.classList.add('dragging');
            const dateString = e.target.dataset.date;
            e.dataTransfer.setData('text/plain', dateString);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleCalendarDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleCalendarDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleCalendarDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleCalendarDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleCalendarDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const sourceDate = e.dataTransfer.getData('text/plain');
            const targetDate = day.dataset.date;

            if (!sourceDate || !targetDate || sourceDate === targetDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            // Get bookings for the source date
            const sourceBookings = allBookings.filter(booking => 
                booking.date === sourceDate && 
                (booking.status === 'confirmed' || booking.status === 'pending')
            );

            if (sourceBookings.length === 0) {
                showNotification('No bookings found for source date', 'error');
                return;
            }

            // Move all bookings from source to target date
            try {
                for (const booking of sourceBookings) {
                    const response = await fetch(`/api/bookings/${booking.booking_id}/move`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ newDate: targetDate })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        showNotification(error.message || 'Failed to move booking', 'error');
                        return;
                    }
                }

                showNotification(`Moved ${sourceBookings.length} booking(s) successfully`, 'success');
                loadBookings(); // Reload to update the display
            } catch (error) {
                console.error('Error moving bookings:', error);
                showNotification('Network error moving bookings', 'error');
            }

            day.classList.remove('drag-over');
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.bookingId);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const bookingId = e.dataTransfer.getData('text/plain');
            const newDate = day.dataset.date;

            if (!newDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newDate: newDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }

            day.classList.remove('drag-over');
        }

        // Update booking notes
        async function updateBookingNotes(bookingId) {
            const notesTextarea = document.getElementById('bookingNotes');
            const notes = notesTextarea.value.trim();

            try {
                const response = await fetch(`/api/bookings/${bookingId}/notes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes })
                });

                if (response.ok) {
                    showNotification('Notes updated successfully', 'success');
                    // Update the booking in the local array
                    const booking = allBookings.find(b => b.booking_id === bookingId);
                    if (booking) {
                        booking.notes = notes;
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update notes', 'error');
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                showNotification('Network error updating notes', 'error');
            }
        }

        // Modal management functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Don't clear cached data when closing modals - keep it for the current booking
                // The data will be cleared when switching to a different booking
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        // Close modal when clicking outside
        function setupModalClickOutside() {
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // Close modal with Escape key
        function setupModalEscapeKey() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    if (modals.length > 0) {
                        closeModal(modals[0].id);
                    }
                }
            });
        }

        // Initialize modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            setupModalClickOutside();
            setupModalEscapeKey();
        });

        // Mobile Menu Functionality
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const navLinks = document.querySelector('.nav-links');
        const menuIcon = mobileMenuToggle.querySelector('i');

        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');

            // Toggle icon between bars and times with rotation
            if (navLinks.classList.contains('active')) {
                menuIcon.classList.remove('fa-bars');
                menuIcon.classList.add('fa-times');
                menuIcon.style.transform = 'rotate(180deg)';
            } else {
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking on a link
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Handle window resize for calendar layout
        window.addEventListener('resize', function() {
            if (currentFilter === 'calendar') {
                renderCalendar();
            }
        });

        // Auto-refresh every 30 seconds with improved reliability
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                console.log('🔄 Auto-refresh: Loading bookings...');
                loadBookings();
            }
        }, 30000);
        
        // Additional fallback refresh every 60 seconds to ensure data stays fresh
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                console.log('🔄 Fallback refresh: Loading bookings...');
                loadBookings();
            }
        }, 60000);

        // Debug function for testing authentication and booking loading
        window.debugAdminPanel = function() {
            console.log('🔍 === ADMIN PANEL DEBUG ===');
            console.log('🔍 SimpleGoogleAuth available:', !!window.simpleGoogleAuth);
            if (window.simpleGoogleAuth) {
                console.log('🔍 Is authenticated:', window.simpleGoogleAuth.isUserAuthenticated());
                console.log('🔍 User profile:', window.simpleGoogleAuth.userProfile);
                console.log('🔍 Auth headers:', window.simpleGoogleAuth.getAuthHeaders());
            }
            console.log('🔍 All bookings loaded:', allBookings ? allBookings.length : 0);
            console.log('🔍 Current filter:', currentFilter);
            console.log('🔍 === END DEBUG ===');
        };

        // Test server connection
        window.testServerConnection = async function() {
            try {
                console.log('🔄 Testing server connection...');
                const response = await fetch('/api/test');
                const data = await response.json();
                console.log('✅ Server test response:', data);
                return data;
            } catch (error) {
                console.error('❌ Server test failed:', error);
                return null;
            }
        };

        // Quote Generation Variables
        let currentQuoteData = null;
        let itemCounter = 1;

        // Show Quote Modal
        async function showQuoteModal(booking) {
            // If booking is passed as a string (from onclick), parse it
            if (typeof booking === 'string') {
                try {
                    booking = JSON.parse(booking);
                } catch (e) {
                    console.error('Error parsing booking data:', e);
                    return;
                }
            }

            // Clear cached data only if switching to a different booking
            if (currentQuoteData && currentQuoteData.bookingId !== booking.booking_id) {
                clearCachedDataForBooking(booking.booking_id);
            }

            currentQuoteData = {
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes
            };

            // Check if there's an existing quote for this booking
            try {
                const quoteResponse = await fetch(`/api/quotes/booking/${booking.booking_id}`);
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const existingQuote = quotes[0];
                        loadExistingQuote(existingQuote);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking for existing quotes:', error);
            }

            // No existing quote found, create new one
            loadNewQuote(booking);
        }

        // Load existing quote data
        function loadExistingQuote(quote) {
            // Reset item counter when opening quote modal
            itemCounter = 0;
            
            // Store the quote ID for updates
            currentQuoteData.quoteId = quote.quote_id;

            // Pre-fill client information from saved quote
            document.getElementById('quoteClientName').value = quote.client_name || '';
            document.getElementById('quoteClientPhone').value = quote.client_phone || '';
            document.getElementById('quoteClientAddress').value = quote.client_address || '';
            document.getElementById('quoteClientEmail').value = quote.client_email || '';
            document.getElementById('quoteDate').value = quote.quote_date || new Date().toISOString().split('T')[0];

            // Load service items from saved quote
            // Handle both string and object formats
            let serviceItems;
            console.log('Quote service_items type:', typeof quote.service_items);
            console.log('Quote service_items value:', quote.service_items);
            
            if (typeof quote.service_items === 'string') {
                try {
                    serviceItems = JSON.parse(quote.service_items);
                    console.log('Parsed service items:', serviceItems);
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    serviceItems = [];
                }
            } else {
                serviceItems = quote.service_items || [];
                console.log('Service items (not string):', serviceItems);
            }
            loadServiceItems(serviceItems);

            // Set tax toggle
            document.getElementById('taxToggle').checked = quote.tax_enabled || false;

            // Update totals
            updateQuoteTotals();

            // Setup event listeners for all service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Show modal
            console.log('Opening quote modal (existing quote), itemCounter:', itemCounter);
            openModal('quoteModal');
        }

        // Load new quote (no existing data)
        function loadNewQuote(booking) {
            // Clear any previous form data and totals first
            clearFormFields();
            
            // Reset item counter when opening quote modal
            itemCounter = 0;
            
            // Set current quote data with booking information
            currentQuoteData = {
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes
            };
            
            // Pre-fill client information from booking
            document.getElementById('quoteClientName').value = booking.name || '';
            document.getElementById('quoteClientPhone').value = booking.phone || '';
            document.getElementById('quoteClientAddress').value = booking.address || '';
            document.getElementById('quoteClientEmail').value = booking.email || '';
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];

            // Create initial service item with booking service
            const initialServiceItem = {
                description: booking.service || 'Tree Service',
                quantity: 1,
                price: 0,
                total: 0
            };

            // Load service items (this will clear container and recreate)
            loadServiceItems([initialServiceItem]);

            // Reset tax toggle
            document.getElementById('taxToggle').checked = false;
            
            // Update totals to reflect the new service items (should show $0.00)
            updateQuoteTotals();

            // Show modal
            console.log('Opening quote modal (new quote), itemCounter:', itemCounter);
            openModal('quoteModal');
        }

        // Load service items from saved quote
        function loadServiceItems(serviceItems) {
            const container = document.querySelector('.service-items-container');
            
            // Clear existing items
            container.innerHTML = '';

            console.log('Loading service items:', serviceItems);

            if (serviceItems.length === 0) {
                // Add one empty item if no items exist
                addServiceItem();
                return;
            }

            // Load each service item
            serviceItems.forEach((item, index) => {
                itemCounter++;
                const newItem = document.createElement('div');
                newItem.className = 'service-item';
                newItem.setAttribute('data-item-id', itemCounter);

                newItem.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description || ''}" placeholder="Service description">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${item.quantity || 1}" min="1">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${item.price || ''}" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${((item.quantity || 1) * (item.price || 0)).toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(newItem);
                setupItemEventListeners(newItem);
            });

            // Force update totals after loading all items
            setTimeout(() => {
                updateQuoteTotals();
            }, 100);
        }

        // Add Service Item
        function addServiceItem() {
            console.log('addServiceItem called, current itemCounter:', itemCounter);
            itemCounter++;
            const container = document.querySelector('.service-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(newItem);
            setupItemEventListeners(newItem);
        }

        // Remove Service Item
        function removeServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('.service-item').length > 1) {
                serviceItem.remove();
                updateQuoteTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Service Items
        function setupItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateItemTotal);
            priceInput.removeEventListener('input', updateItemTotal);

            qtyInput.addEventListener('input', updateItemTotal);
            priceInput.addEventListener('input', updateItemTotal);

            function updateItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateQuoteTotals();
            }

            // Initialize the total for this item
            updateItemTotal();
        }

        // Update Quote Totals
        function updateQuoteTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('.service-item');

            items.forEach(item => {
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('taxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            // Format numbers with proper decimal places
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Tax
        function toggleTax() {
            updateQuoteTotals();
        }

        // Setup initial event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners for existing service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Setup event listeners for form inputs
            document.querySelectorAll('.item-qty-input, .item-price-input').forEach(input => {
                input.addEventListener('input', updateQuoteTotals);
            });
        });

        // Save Quote to Database
        function generateQuote() {
            // Validate form
            const requiredFields = ['quoteClientName', 'quoteClientPhone', 'quoteClientAddress', 'quoteClientEmail', 'quoteDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('.service-item');
            console.log('Found service item elements:', serviceItemElements.length);
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                console.log(`Service item ${index + 1}:`, { description, quantity, price, total });

                // Save all items with a description, even if price is 0
                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Save quote to database
            saveQuote(serviceItems);
        }

        // Save Quote to Database
        async function saveQuote(serviceItems) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteData = {
                booking_id: currentQuoteData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                quote_date: quoteDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            try {
                // If we have an existing quote ID, update it; otherwise create new
                const method = currentQuoteData.quoteId ? 'PUT' : 'POST';
                const url = currentQuoteData.quoteId ? `/api/quotes/${currentQuoteData.quoteId}` : '/api/quotes';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Quote saved successfully!', 'success');
                    
                    // Store the quote ID for later use
                    currentQuoteData.quoteId = result.quote_id;
                    
                    // Generate quote preview
                    generateQuotePreview(serviceItems, result.quote_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save quote', 'error');
                }
            } catch (error) {
                console.error('Error saving quote:', error);
                showNotification('Network error saving quote', 'error');
            }
        }

        // Generate Quote Preview
        function generateQuotePreview(serviceItems, quoteId = null) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteNumber = quoteId || generateQuoteNumber();
            const formattedDate = new Date(quoteDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const quoteHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>123 Business Street, Toronto, ON M5V 3A8</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(555) 123-4567</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>info@stellartreemanagement.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">QUOTE</div>
                            <div class="document-number">#${quoteNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Terms & Conditions</h3>
                        <div class="terms-content">
                            <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept cash, check, and major credit cards.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('quotePreviewContent').innerHTML = quoteHTML;
            closeModal('quoteModal');
            openModal('quotePreviewModal');
        }

        // Generate Quote Number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `QT-${year}${month}${day}-${random}`;
        }

        // Print Quote
        function printQuote() {
            const printWindow = window.open('', '_blank');
            const quoteContent = document.getElementById('quotePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${quoteContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Quote as PDF
        function downloadQuotePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printQuote();
        }

        // Send Quote Email
        async function sendQuoteEmail() {
            if (!currentQuoteData || !currentQuoteData.quoteId) {
                showNotification('No quote data available to send email', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/quotes/${currentQuoteData.quoteId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Quote email sent successfully!', 'success');
                    console.log('Email content:', result.emailContent);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send quote email', 'error');
                }
            } catch (error) {
                console.error('Error sending quote email:', error);
                showNotification('Network error sending quote email', 'error');
            }
        }

        // Invoice Functions
        let currentInvoiceData = null;

        // Show Invoice Modal
        function showInvoiceModal(quote, booking) {
            currentInvoiceData = {
                quoteId: quote.quote_id,
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes
            };

            // Pre-fill client information from quote
            document.getElementById('invoiceClientName').value = quote.client_name || booking.name || '';
            document.getElementById('invoiceClientPhone').value = quote.client_phone || booking.phone || '';
            document.getElementById('invoiceClientAddress').value = quote.client_address || booking.address || '';
            document.getElementById('invoiceClientEmail').value = quote.client_email || booking.email || '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Populate service items from quote
            populateInvoiceServiceItems(quote.service_items);

            // Set tax toggle
            document.getElementById('invoiceTaxToggle').checked = quote.tax_enabled || false;

            // Update totals
            updateInvoiceTotals();

            // Show modal
            openModal('invoiceModal');
        }

        // Populate Invoice Service Items
        function populateInvoiceServiceItems(serviceItems) {
            const container = document.getElementById('invoiceServiceItems');
            container.innerHTML = '';

            // Parse service items if it's a JSON string
            let items = serviceItems;
            if (typeof serviceItems === 'string') {
                try {
                    items = JSON.parse(serviceItems);
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    items = [];
                }
            }

            console.log('Populating invoice service items:', items);

            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'service-item';
                itemDiv.setAttribute('data-item-id', index + 1);

                itemDiv.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description}" readonly>
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${item.quantity}" min="1" readonly>
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${item.price}" min="0" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${item.total.toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <!-- No remove button for invoices -->
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(itemDiv);
            });
        }

        // Update Invoice Totals
        function updateInvoiceTotals() {
            const items = document.querySelectorAll('#invoiceServiceItems .service-item');
            let subtotal = 0;

            items.forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('invoiceTaxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            document.getElementById('invoiceSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('invoiceGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('invoiceTaxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Invoice Tax
        function toggleInvoiceTax() {
            updateInvoiceTotals();
        }

        // Create Invoice from Saved Quote
        function generateInvoice() {
            // Validate form
            const requiredFields = ['invoiceClientName', 'invoiceClientPhone', 'invoiceClientAddress', 'invoiceClientEmail', 'invoiceDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('#invoiceServiceItems .service-item');
            console.log('Found service item elements:', serviceItemElements.length);
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value;
                const quantity = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                const total = quantity * price;

                console.log(`Service item ${index + 1}:`, { description, quantity, price, total });

                if (description && quantity > 0 && price > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('No service items found', 'error');
                return;
            }

            // Save invoice to database
            saveInvoice(serviceItems);
        }

        // Save Invoice to Database
        async function saveInvoice(serviceItems) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const invoiceData = {
                quote_id: currentInvoiceData.quoteId,
                booking_id: currentInvoiceData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                invoice_date: invoiceDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Invoice created successfully!', 'success');
                    
                    // Store the invoice ID for later use
                    currentInvoiceData.invoiceId = result.invoice_id;
                    
                    // Generate invoice preview
                    generateInvoicePreview(serviceItems, result.invoice_id);
                    
                    // Complete the booking
                    await completeBookingWithInvoice();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to create invoice', 'error');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
                showNotification('Network error creating invoice', 'error');
            }
        }

        // Complete Booking with Invoice
        async function completeBookingWithInvoice() {
            try {
                const response = await fetch(`/api/bookings/${currentInvoiceData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showNotification('Booking completed successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to complete booking', 'error');
                }
            } catch (error) {
                console.error('Error completing booking:', error);
                showNotification('Network error completing booking', 'error');
            }
        }

        // Generate Invoice Preview
        function generateInvoicePreview(serviceItems, invoiceId = null) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const invoiceNumber = invoiceId || generateInvoiceNumber();
            const formattedDate = new Date(invoiceDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const invoiceHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>123 Business Street, Toronto, ON M5V 3A8</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(555) 123-4567</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>info@stellartreemanagement.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">INVOICE</div>
                            <div class="document-number">#${invoiceNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Payment Terms</h3>
                        <div class="terms-content">
                            <p>Payment is due upon receipt of this invoice. We accept cash, check, and major credit cards. Please include the invoice number with your payment.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('invoicePreviewContent').innerHTML = invoiceHTML;
            closeModal('invoiceModal');
            openModal('invoicePreviewModal');
        }

        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `INV-${year}${month}${day}-${random}`;
        }

        // Print Invoice
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            const invoiceContent = document.getElementById('invoicePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Invoice as PDF
        function downloadInvoicePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printInvoice();
        }

        // Send Invoice Email
        async function sendInvoiceEmail() {
            if (!currentInvoiceData || !currentInvoiceData.invoiceId) {
                showNotification('No invoice data available to send email', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/invoices/${currentInvoiceData.invoiceId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Invoice email sent successfully!', 'success');
                    console.log('Email content:', result.emailContent);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send invoice email', 'error');
                }
            } catch (error) {
                console.error('Error sending invoice email:', error);
                showNotification('Network error sending invoice email', 'error');
            }
        }

        // Customer Management Functions

        // Recalculate all customer totals
        async function recalculateCustomerTotals() {
            if (!confirm('This will recalculate the total spent for all customers. This may take a moment. Continue?')) {
                return;
            }
            
            try {
                showNotification('Recalculating customer totals...', 'info');
                
                const response = await fetch('/api/customers/recalculate-totals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    
                    // Reload customers to show updated totals
                    await loadCustomers();
                } else {
                    showNotification('Failed to recalculate totals', 'error');
                }
            } catch (error) {
                console.error('Error recalculating totals:', error);
                showNotification('Network error during recalculation', 'error');
            }
        }

        // Refresh customer data
        async function refreshCustomerData() {
            try {
                showNotification('Refreshing customer data...', 'info');
                await loadCustomers();
                showNotification('Customer data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing customer data:', error);
                showNotification('Network error refreshing customer data', 'error');
            }
        }

        // Recalculate specific customer total
        async function recalculateCustomerTotal(customerId) {
            try {
                showNotification('Recalculating customer total...', 'info');
                
                const response = await fetch(`/api/customers/${customerId}/recalculate-total`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    
                    // Refresh the customer details view
                    await showCustomerDetails(customerId);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to recalculate customer total', 'error');
                }
            } catch (error) {
                console.error('Error recalculating customer total:', error);
                showNotification('Network error recalculating customer total', 'error');
            }
        }

        // Load customers from API
        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers', {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    allCustomers = await response.json();
                    renderCustomers();
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    showNotification('Failed to load customers', 'error');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showNotification('Network error loading customers', 'error');
            }
        }

        // Render customers grid
        function renderCustomers() {
            const grid = document.getElementById('customersGrid');
            
            if (allCustomers.length === 0) {
                grid.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }

            grid.innerHTML = allCustomers.map(customer => {
                return `
                    <div class="customer-card" onclick="showCustomerDetails('${customer.customer_id}')">
                        <div class="customer-header">
                            <div>
                                <div class="customer-name">${customer.name}</div>
                                <div class="customer-id">${customer.customer_id}</div>
                            </div>
                        </div>
                        <div class="customer-contact">
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span class="contact-label">Email:</span>
                                <span class="contact-value">${customer.email}</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span class="contact-label">Phone:</span>
                                <span class="contact-value">${customer.phone}</span>
                            </div>
                            ${customer.address ? `
                                <div class="contact-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="contact-label">Address:</span>
                                    <span class="contact-value">${customer.address}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="customer-stats">
                            <div class="stat-item">
                                <div class="stat-number">${customer.total_bookings || 0}</div>
                                <div class="stat-label">Bookings</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">$${(customer.total_spent || 0).toFixed(2)}</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                        </div>
                        <div class="customer-actions-card" onclick="event.stopPropagation();">
                            <button class="customer-action-btn view" onclick="showCustomerDetails('${customer.customer_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="customer-action-btn edit" onclick="editCustomer('${customer.customer_id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="customer-action-btn delete" onclick="deleteCustomer('${customer.customer_id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search customers
        async function searchCustomers() {
            const query = document.getElementById('customerSearchInput').value.trim();
            
            if (!query) {
                loadCustomers();
                return;
            }

            try {
                const response = await fetch(`/api/customers/search/${encodeURIComponent(query)}`);
                if (response.ok) {
                    allCustomers = await response.json();
                    renderCustomers();
                } else {
                    showNotification('Failed to search customers', 'error');
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                showNotification('Network error searching customers', 'error');
            }
        }

        // Show add customer modal
        function showAddCustomerModal() {
            currentCustomerId = null;
            document.getElementById('customerModalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            openModal('customerModal');
        }

        // Show customer details
        async function showCustomerDetails(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}`);
                if (response.ok) {
                    const data = await response.json();
                    renderCustomerDetails(data);
                    openModal('customerDetailsModal');
                } else {
                    showNotification('Failed to load customer details', 'error');
                }
            } catch (error) {
                console.error('Error loading customer details:', error);
                showNotification('Network error loading customer details', 'error');
            }
        }

        // Render customer details
        function renderCustomerDetails(data) {
            const { customer, bookings, quotes, invoices, totalBreakdown } = data;
            
            document.getElementById('customerDetailsTitle').textContent = `Customer Details - ${customer.name}`;
            
            const content = `
                <div class="customer-details-grid">
                    <div class="customer-info-section">
                        <h4><i class="fas fa-user"></i> Customer Information</h4>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${customer.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${customer.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${customer.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${customer.address || 'Not provided'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Customer ID:</span>
                            <span class="info-value">${customer.customer_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${new Date(customer.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Bookings:</span>
                            <span class="info-value">${customer.total_bookings || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Spent:</span>
                            <span class="info-value">$${(customer.total_spent || 0).toFixed(2)}</span>
                            <button class="action-btn info" onclick="recalculateCustomerTotal('${customer.customer_id}')" style="margin-left: 10px; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                <i class="fas fa-calculator"></i> Recalculate
                            </button>
                        </div>

                        ${customer.notes ? `
                            <div class="info-row">
                                <span class="info-label">Notes:</span>
                                <span class="info-value">${customer.notes}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="customer-history-section">
                        <div class="history-tabs">
                            <div class="history-tab active" onclick="switchHistoryTab('bookings', {bookings, quotes, invoices})">Bookings (${bookings.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('quotes', {bookings, quotes, invoices})">Quotes (${quotes.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('invoices', {bookings, quotes, invoices})">Invoices (${invoices.length})</div>
                        </div>
                        <div class="history-content" id="historyContent">
                            ${renderEnhancedHistoryTab('bookings', bookings, quotes, invoices)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = content;
        }

        // Switch history tab
        function switchHistoryTab(tab, data) {
            // Update active tab
            document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get data based on tab
            let items = [];
            if (tab === 'bookings') items = data.bookings || [];
            else if (tab === 'quotes') items = data.quotes || [];
            else if (tab === 'invoices') items = data.invoices || [];
            
            if (tab === 'bookings') {
                document.getElementById('historyContent').innerHTML = renderEnhancedHistoryTab(tab, data.bookings || [], data.quotes || [], data.invoices || []);
            } else {
                document.getElementById('historyContent').innerHTML = renderHistoryTab(tab, items);
            }
        }

        // Render enhanced history tab content for bookings with related invoices and quotes
        function renderEnhancedHistoryTab(tab, bookings, quotes, invoices) {
            if (bookings.length === 0) {
                return '<div class="empty-state">No bookings found</div>';
            }

            return bookings.map(booking => {
                // Find related quotes and invoices for this booking
                const relatedQuotes = quotes.filter(q => q.booking_id === booking.booking_id);
                const relatedInvoices = invoices.filter(i => i.booking_id === booking.booking_id);
                
                return `
                    <div class="enhanced-history-item">
                        <div class="booking-header">
                            <h5><i class="fas fa-calendar-check"></i> ${booking.service} - ${booking.status}</h5>
                            <div class="booking-meta">
                                <span class="booking-date"><i class="fas fa-calendar"></i> ${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()} at ${booking.time}</span>
                                <span class="booking-id"><i class="fas fa-hashtag"></i> ${booking.booking_id}</span>
                            </div>
                        </div>
                        
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="detail-label">Customer:</span>
                                <span class="detail-value">${booking.name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${booking.notes || 'No notes'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Booking Date:</span>
                                <span class="detail-value">${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()}</span>
                            </div>
                        </div>
                        
                        ${relatedQuotes.length > 0 || relatedInvoices.length > 0 ? `
                            <div class="related-documents">
                                ${relatedQuotes.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-file-invoice-dollar"></i> Related Quotes (${relatedQuotes.length})</h6>
                                        <div class="document-list">
                                            ${relatedQuotes.map(quote => {
                                                const serviceItems = JSON.parse(quote.service_items);
                                                return `
                                                    <div class="document-item quote-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Quote ${quote.quote_id}</span>
                                                            <span class="document-status ${quote.status}">${quote.status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${quote.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(quote.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${relatedInvoices.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-receipt"></i> Related Invoices (${relatedInvoices.length})</h6>
                                        <div class="document-list">
                                            ${relatedInvoices.map(invoice => {
                                                const serviceItems = JSON.parse(invoice.service_items);
                                                return `
                                                    <div class="document-item invoice-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Invoice ${invoice.invoice_id}</span>
                                                            <span class="document-status ${invoice.payment_status}">${invoice.payment_status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${invoice.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(invoice.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="no-documents">
                                <i class="fas fa-info-circle"></i> No related quotes or invoices found for this booking.
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Render history tab content
        function renderHistoryTab(tab, items) {
            if (items.length === 0) {
                return '<div class="empty-state">No items found</div>';
            }

            return items.map(item => {
                if (tab === 'bookings') {
                    return `
                        <div class="history-item">
                            <h5>${item.service} - ${item.status}</h5>
                            <p><strong>Date:</strong> ${new Date(item.date).toLocaleDateString()} at ${item.time}</p>
                            <p><strong>Booking ID:</strong> ${item.booking_id}</p>
                            <p class="date">Booked for: ${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'quotes') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Quote ${item.quote_id} - ${item.status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'invoices') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Invoice ${item.invoice_id} - ${item.payment_status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }
            }).join('');
        }

        // Edit customer
        function editCustomer(customerId) {
            currentCustomerId = customerId;
            const customer = allCustomers.find(c => c.customer_id === customerId);
            
            if (customer) {
                document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                openModal('customerModal');
            }
        }

        // Save customer
        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name || !email || !phone) {
                showNotification('Name, email, and phone are required', 'error');
                return;
            }

            try {
                const url = currentCustomerId ? `/api/customers/${currentCustomerId}` : '/api/customers';
                const method = currentCustomerId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone, address, notes })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save customer', 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showNotification('Network error saving customer', 'error');
            }
        }

        // Delete customer
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    
                    // Check if customer has associated data and offer force delete
                    if (error.hasData) {
                        const forceDelete = confirm(
                            `This customer has associated data:\n` +
                            `- ${error.counts.booking_count} bookings\n` +
                            `- ${error.counts.quote_count} quotes\n` +
                            `- ${error.counts.invoice_count} invoices\n\n` +
                            `Do you want to force delete this customer and ALL associated data? This action cannot be undone.`
                        );
                        
                        if (forceDelete) {
                            try {
                                const forceResponse = await fetch(`/api/customers/${customerId}?force=true`, {
                                    method: 'DELETE'
                                });
                                
                                if (forceResponse.ok) {
                                    const forceResult = await forceResponse.json();
                                    showNotification(forceResult.message, 'success');
                                    loadCustomers();
                                } else {
                                    const forceError = await forceResponse.json();
                                    showNotification(forceError.error || 'Failed to force delete customer', 'error');
                                }
                            } catch (forceError) {
                                console.error('Error force deleting customer:', forceError);
                                showNotification('Network error force deleting customer', 'error');
                            }
                        }
                    } else {
                        showNotification(error.error || 'Failed to delete customer', 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showNotification('Network error deleting customer', 'error');
            }
        }

        // Migrate existing customers
        async function migrateCustomers() {
            if (!confirm('This will migrate existing bookings to create customer profiles. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/customers/migrate', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Migration completed: ${result.processed} customers processed, ${result.errors} errors`, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to migrate customers', 'error');
                }
            } catch (error) {
                console.error('Error migrating customers:', error);
                showNotification('Network error migrating customers', 'error');
            }
        }

        // Close customer modal
        function closeCustomerModal() {
            closeModal('customerModal');
            currentCustomerId = null;
        }

        // Close customer details modal
        function closeCustomerDetailsModal() {
            closeModal('customerDetailsModal');
        }

        // Image Modal Functions
        function showImageModal(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imagePath;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        // Smooth filter tab click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                const filter = e.target.getAttribute('data-filter');
                
                // Prevent multiple rapid clicks
                if (e.target.classList.contains('loading')) return;
                
                // Add loading state to clicked tab
                e.target.classList.add('loading');
                
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.classList.remove('loading');
                });
                e.target.classList.add('active');
                
                // Update section title smoothly
                const sectionTitle = document.getElementById('sectionTitle');
                let newTitle = '';
                if (filter === 'all') newTitle = 'Active Bookings';
                else if (filter === 'pending') newTitle = 'Pending Bookings';
                else if (filter === 'confirmed') newTitle = 'Confirmed Bookings';
                else if (filter === 'all-bookings') newTitle = 'All Bookings';
                else if (filter === 'calendar') newTitle = 'Calendar View';
                else if (filter === 'customers') newTitle = 'Customer Management';
                
                // Smooth title transition
                sectionTitle.style.opacity = '0';
                sectionTitle.style.transform = 'translateY(-5px)';
                
                // Hide all views smoothly first
                const views = ['activeBookingsGrid', 'calendarView', 'customerView'];
                views.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    view.classList.add('view-hidden');
                });
                
                // Wait for fade out, then show new view
                setTimeout(() => {
                    // Update title
                    sectionTitle.textContent = newTitle;
                    sectionTitle.style.opacity = '1';
                    sectionTitle.style.transform = 'translateY(0)';
                    
                    // Hide all views
                    views.forEach(viewId => {
                        const view = document.getElementById(viewId);
                        view.style.display = 'none';
                        view.classList.remove('view-hidden');
                    });
                    
                    // Show appropriate view
                    let targetView;
                    if (filter === 'calendar') {
                        targetView = document.getElementById('calendarView');
                        targetView.style.display = 'block';
                        if (!blockedDates.length) loadBlockedDates();
                        renderCalendar();
                    } else if (filter === 'customers') {
                        targetView = document.getElementById('customerView');
                        targetView.style.display = 'block';
                        loadCustomers();
                    } else {
                        targetView = document.getElementById('activeBookingsGrid');
                        targetView.style.display = 'grid';
                        currentFilter = filter;
                        renderActiveBookings();
                    }
                    
                    // Trigger smooth entrance animation
                    requestAnimationFrame(() => {
                        targetView.style.opacity = '0';
                        targetView.style.transform = 'translateY(10px)';
                        requestAnimationFrame(() => {
                            targetView.style.opacity = '1';
                            targetView.style.transform = 'translateY(0)';
                        });
                    });
                    
                    // Remove loading state
                    e.target.classList.remove('loading');
                }, 250);
            }
        });
    </script>

    <!-- Quote Generation Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote</h3>
                <button class="modal-close" onclick="closeModal('quoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <input type="text" id="quoteClientName" placeholder="Full Name" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="quoteClientPhone" placeholder="Phone Number" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="quoteClientAddress" placeholder="Address" required>
                            </div>
                            <div class="form-group">
                                <input type="email" id="quoteClientEmail" placeholder="Email" required>
                            </div>
                            <div class="form-group">
                                <input type="date" id="quoteDate" placeholder="Quote Date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                                    </div>
                                    <div class="item-controls">
                                        <div class="item-quantity">
                                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                                        </div>
                                        <div class="item-price">
                                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                                        </div>
                                        <div class="item-total">
                                            <span class="item-total-amount">$0.00</span>
                                        </div>
                                        <div class="item-actions">
                                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="taxToggle" onchange="toggleTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="taxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="grandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuote()">
                            <i class="fas fa-save"></i> Save Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Modal -->
    <div id="quotePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Quote Saved Successfully</h3>
                <button class="modal-close" onclick="closeModal('quotePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="quotePreviewContent" class="quote-preview">
                    <!-- Quote content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('quotePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printQuote()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadQuotePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button type="button" class="btn-info" onclick="sendQuoteEmail()">
                        <i class="fas fa-envelope"></i> Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Generation Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Create Invoice from Quote</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="invoiceClientName">Full Name</label>
                                <input type="text" id="invoiceClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientPhone">Phone Number</label>
                                <input type="tel" id="invoiceClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientAddress">Address</label>
                                <input type="text" id="invoiceClientAddress" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientEmail">Email</label>
                                <input type="email" id="invoiceClientEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="invoiceServiceItems" class="service-items-container">
                            <!-- Service items will be populated from quote -->
                        </div>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="invoiceTaxToggle" onchange="toggleInvoiceTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="invoiceTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="invoiceTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="invoiceGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateInvoice()">
                            <i class="fas fa-file-invoice"></i> Create Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Invoice Created Successfully</h3>
                <button class="modal-close" onclick="closeModal('invoicePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent" class="quote-preview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('invoicePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadInvoicePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button type="button" class="btn-info" onclick="sendInvoiceEmail()">
                        <i class="fas fa-envelope"></i> Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Image verification functions removed - now using improved storage system
    </script>

    <style>
        /* Image verification styles removed - using improved storage system */
    </style>
</body>
</html> 