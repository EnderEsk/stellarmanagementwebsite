<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Stellar Tree Management</title>
    <link rel="icon" type="image/x-icon" href="images/logo.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="admin-archive.css">
    <link rel="stylesheet" href="admin-trash.css">
    <link rel="stylesheet" href="admin-booking-creation/admin-booking-creation.css">
    <script src="simple-google-oauth.js"></script>
    <!-- Load admin.js after the page content to ensure DOM elements are available -->
    <script src="assets/js/admin.js" defer></script>
    <!-- Load admin calendar functionality -->
    <script src="admin-calendar.js" defer></script>
    <!-- Load admin booking creation functionality -->
    <script src="admin-booking-creation/admin-booking-creation.js" defer></script>
    <!-- Load admin calendar events functionality -->
    <script src="admin-calendar-events.js" defer></script>
    <!-- Load admin archive functionality -->
    <script src="admin-archive.js" defer></script>
    <!-- Load admin trash functionality -->
    <script src="admin-trash.js" defer></script>
    
    <style>
        
        /* Fix notification text color - ensure black text on white background */
        .notification,
        .notification.info,
        .notification.success,
        .notification.error,
        .notification.warning {
            background: white !important;
            color: #000000 !important;
            border: 1px solid #dee2e6 !important;
        }
        
        .notification i {
            color: inherit !important;
        }
        
        .notification.success {
            border-left: 4px solid #28a745 !important;
        }
        
        .notification.error {
            border-left: 4px solid #dc3545 !important;
        }
        
        .notification.warning {
            border-left: 4px solid #ffc107 !important;
        }
        
        .notification.info {
            border-left: 4px solid #17a2b8 !important;
        }

        
        /* Ensure quote modal is always visible when shown */
        #quoteModal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 9999 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Loading state for quote button */
        .action-btn.quote.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .action-btn.quote.loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Base modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* Fix modal backdrop and ensure proper visibility */
        .modal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Base modal content styles */
        .modal-content {
            position: relative;
            z-index: 10000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            max-width: 800px;
            min-width: 400px;
        }
        
        /* Ensure modal content is properly positioned and visible */
        .modal.show .modal-content {
            position: relative !important;
            z-index: 10000 !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            width: 90% !important;
            max-width: 800px !important;
            min-width: 400px !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin: auto !important;
            padding: 0 !important;
            border: none !important;
        }
        
        /* Specific styles for quote modal content */
        .modal.show .modal-content.quote-modal-content {
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 10000 !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            width: 90% !important;
            max-width: 800px !important;
            min-width: 400px !important;
            margin: auto !important;
            padding: 0 !important;
            border: none !important;
        }
        
        
        /* Remove the problematic ::before pseudo-element */
        .modal.show::before {
            display: none !important;
        }
        
        /* Clickable address styling */
        .clickable-address {
            color: #007bff;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .clickable-address:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: #0056b3;
            text-decoration: none;
        }
        
        .clickable-address:active {
            transform: translateY(1px);
        }
        
        .clickable-address i {
            color: #dc3545;
            font-size: 14px;
        }

        /* Clickable booking ID styling */
        .clickable-booking-id {
            color: #007bff;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .clickable-booking-id:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: #0056b3;
            text-decoration: none;
        }
        
        .clickable-booking-id:active {
            transform: translateY(1px);
        }
        
        .clickable-booking-id i {
            color: #007bff;
            font-size: 12px;
        }

        /* Prevent click event bubbling for booking ID links */
        .clickable-booking-id {
            pointer-events: auto;
        }
        
        .booking-card .clickable-booking-id {
            pointer-events: auto;
        }

        /* Quick Quote View Styles */
        .quick-quote-view {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .quick-quote-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quick-quote-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .quick-quote-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--admin-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .quick-quote-header p {
            color: var(--admin-secondary);
            font-size: 1.1rem;
            margin: 0;
        }

        .quick-quote-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .quick-quote-btn {
            background: var(--admin-accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
            justify-content: center;
        }

        .quick-quote-btn:hover {
            background: #7ab33a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(140, 198, 63, 0.3);
        }

        .quick-quote-btn:active {
            transform: translateY(0);
        }

        .quick-quote-info {
            margin-top: 2rem;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid var(--admin-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .info-card i {
            font-size: 2rem;
            color: var(--admin-accent);
            margin-bottom: 1rem;
        }

        .info-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--admin-primary);
            margin-bottom: 0.5rem;
        }

        .info-card p {
            color: var(--admin-secondary);
            line-height: 1.5;
            margin: 0;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .quick-quote-actions {
                flex-direction: column;
                align-items: center;
            }

            .quick-quote-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <img src="images/logo.png" alt="Stellar Tree Management Logo" class="logo">
            <ul class="nav-links">
                <li><a href="./">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/projects">Projects</a></li>
                <li><a href="/booking/">Book Quote</a></li>
                <li><a href="/admin" class="active">Admin</a></li>
            </ul>
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal show">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Access Required</h3>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label>Sign in with your email</label>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            Only authorized email addresses can access the admin panel.
                        </p>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button type="button" class="oauth-btn google-btn" onclick="window.simpleGoogleAuth.loginWithGoogle()">
                            <i class="fab fa-google"></i>
                            <span>Sign in with Google</span>
                        </button>
                    </div>
                    
                    <div id="loginError" class="error-message" style="display: none; color: #dc3545; margin-top: 1rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <p style="color: #666; font-size: 0.8rem; text-align: center; margin: 0;">
                    Secure authentication via OAuth 2.0
                </p>
            </div>
        </div>
    </div>

    <div class="admin-container" id="adminContent" style="display: none;">
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="admin-title-section">
                    <h1>Admin Dashboard</h1>
                    <p>Manage bookings and view statistics for Stellar Tree Management</p>
                </div>
                <div class="admin-user-section">
                    <div class="admin-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-role">Administrator</div>
                            <div id="userEmail" class="user-email">Loading...</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="window.simpleGoogleAuth.logout()" title="Sign Out">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="logout-text">Logout</span>
                    </button>
                </div>
            </div>
        </div>



        <!-- Admin Sidebar - Mobile positioned between header and booking section -->
        <div class="admin-sidebar mobile-sidebar">
            <div class="sidebar-header">
            </div>
            
            <!-- Booking Status Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('booking-status')">
                    <span class="section-title">Booking Status</span>
                    <i class="fas fa-chevron-down section-chevron" id="booking-status-chevron"></i>
                </div>
                <div class="sidebar-section-content expanded" id="booking-status-content">
                    <div class="sidebar-item active" data-filter="all">
                        <i class="fas fa-list"></i>
                        <span class="item-text">All Active</span>
                    </div>
                    <div class="sidebar-item" data-filter="pending">
                        <i class="fas fa-clock"></i>
                        <span class="item-text">Pending Site Visit</span>
                        <span class="item-count" id="pendingCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="quote-ready">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span class="item-text">Quote Ready</span>
                        <span class="item-count" id="quoteReadyCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="quote-sent">
                        <i class="fas fa-paper-plane"></i>
                        <span class="item-text">Quote Sent</span>
                        <span class="item-count" id="quoteSentCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="quote-accepted">
                        <i class="fas fa-check-circle"></i>
                        <span class="item-text">Quote Accepted</span>
                        <span class="item-count" id="quoteAcceptedCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="pending-booking">
                        <i class="fas fa-calendar-plus"></i>
                        <span class="item-text">Job Scheduled</span>
                        <span class="item-count" id="pendingBookingCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="invoice-ready">
                        <i class="fas fa-file-invoice"></i>
                        <span class="item-text">Invoice Ready</span>
                        <span class="item-count" id="invoiceReadyCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="invoice-sent">
                        <i class="fas fa-paper-plane"></i>
                        <span class="item-text">Invoice Sent</span>
                        <span class="item-count" id="invoiceSentCount">0</span>
                    </div>
                    <div class="sidebar-item" data-filter="completed">
                        <i class="fas fa-check-double"></i>
                        <span class="item-text">Completed</span>
                        <span class="item-count" id="completedCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Management Views Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('management-views')">
                    <span class="section-title">Management Views</span>
                    <i class="fas fa-chevron-down section-chevron" id="management-views-chevron"></i>
                </div>
                <div class="sidebar-section-content" id="management-views-content">
                    <div class="sidebar-item" data-filter="all-bookings">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="item-text">All Bookings</span>
                    </div>
                    <div class="sidebar-item" data-filter="calendar">
                        <i class="fas fa-calendar-week"></i>
                        <span class="item-text">Calendar View</span>
                    </div>
                    <div class="sidebar-item" data-filter="archive">
                        <i class="fas fa-archive"></i>
                        <span class="item-text">Archive</span>
                    </div>
                    <div class="sidebar-item" data-filter="trash">
                        <i class="fas fa-trash-alt"></i>
                        <span class="item-text">Trash</span>
                    </div>
                    <div class="sidebar-item" data-filter="quick-quote">
                        <i class="fas fa-bolt"></i>
                        <span class="item-text">Quick Billing</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="bookings-container">
            <!-- Main Layout with Sidebar -->
            <div class="main-layout-with-sidebar">
            <!-- Active Bookings Section -->
            <div class="active-bookings-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-check"></i> <span id="sectionTitle">Request Quote</span></h2>
                    <div class="section-header-actions">
                        <button class="create-booking-btn" onclick="window.adminBookingCreation.showModal()">
                            <i class="fas fa-calendar-plus"></i> Create Booking
                        </button>
                        <button class="refresh-btn" onclick="manualRefreshBookings()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                    <!-- Main Content Area -->
                    <div class="main-content-area">
                <!-- Bookings Grid -->
                <div class="bookings-grid" id="activeBookingsGrid">
                    <div class="empty-state">Loading bookings...</div>
                </div>

                <!-- Calendar View -->
                <div class="calendar-view" id="calendarView" style="display: none;">
                    <div class="calendar-controls">
                        <button class="calendar-nav-btn" onclick="window.adminCalendar.previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonth">July 2025</h3>
                        <button class="calendar-nav-btn" onclick="window.adminCalendar.nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>

                    </div>
                    

                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>
                </div>

                <!-- Quick Quote View -->
                <div class="quick-quote-view" id="quickQuoteView" style="display: none;">
                    <div class="quick-quote-container">
                        <div class="quick-quote-header">
                            <h2><i class="fas fa-bolt"></i> Quick Billing Generator</h2>
                            <p>Generate quotes and invoices quickly without creating a full booking</p>
                        </div>
                        
                        <div class="quick-quote-actions">
                            <button class="quick-quote-btn" onclick="showQuickQuoteModal()">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Generate Quote
                            </button>
                            <button class="quick-quote-btn" onclick="showQuickInvoiceModal()">
                                <i class="fas fa-file-invoice"></i>
                                Generate Invoice
                            </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Archive View (dynamically created) -->
                        <div id="archiveView" style="display: none;"></div>
                        <!-- Trash View (dynamically created) -->
                        <div id="trashView" style="display: none;"></div>
                    </div>
                    </div>
                </div>

            <!-- Desktop Sidebar (Right Side) - Only visible on desktop -->
            <div class="admin-sidebar desktop-sidebar">
                <div class="sidebar-header">
                </div>
                
                <!-- Booking Status Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('desktop-booking-status')">
                        <span class="section-title">Booking Status</span>
                        <i class="fas fa-chevron-down section-chevron" id="desktop-booking-status-chevron"></i>
                    </div>
                    <div class="sidebar-section-content expanded" id="desktop-booking-status-content">
                        <div class="sidebar-item active" data-filter="all">
                            <i class="fas fa-list"></i>
                            <span class="item-text">All Active</span>
                        </div>
                        <div class="sidebar-item" data-filter="pending">
                            <i class="fas fa-clock"></i>
                            <span class="item-text">Pending Site Visit</span>
                            <span class="item-count" id="desktop-pendingCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="quote-ready">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span class="item-text">Quote Ready</span>
                            <span class="item-count" id="desktop-quoteReadyCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="quote-sent">
                            <i class="fas fa-paper-plane"></i>
                            <span class="item-text">Quote Sent</span>
                            <span class="item-count" id="desktop-quoteSentCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="quote-accepted">
                            <i class="fas fa-check-circle"></i>
                            <span class="item-text">Quote Accepted</span>
                            <span class="item-count" id="desktop-quoteAcceptedCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="pending-booking">
                            <i class="fas fa-calendar-plus"></i>
                            <span class="item-text">Job Scheduled</span>
                            <span class="item-count" id="desktop-pendingBookingCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="invoice-ready">
                            <i class="fas fa-file-invoice"></i>
                            <span class="item-text">Invoice Ready</span>
                            <span class="item-count" id="desktop-invoiceReadyCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="invoice-sent">
                            <i class="fas fa-paper-plane"></i>
                            <span class="item-text">Invoice Sent</span>
                            <span class="item-count" id="desktop-invoiceSentCount">0</span>
                        </div>
                        <div class="sidebar-item" data-filter="completed">
                            <i class="fas fa-check-double"></i>
                            <span class="item-text">Completed</span>
                            <span class="item-count" id="desktop-completedCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Management Views Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('desktop-management-views')">
                        <span class="section-title">Management Views</span>
                        <i class="fas fa-chevron-down section-chevron" id="desktop-management-views-chevron"></i>
                    </div>
                    <div class="sidebar-section-content" id="desktop-management-views-content">
                        <div class="sidebar-item" data-filter="all-bookings">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="item-text">All Bookings</span>
                        </div>
                        <div class="sidebar-item" data-filter="calendar">
                            <i class="fas fa-calendar-week"></i>
                            <span class="item-text">Calendar View</span>
                        </div>
                        <div class="sidebar-item" data-filter="archive">
                            <i class="fas fa-archive"></i>
                            <span class="item-text">Archive</span>
                        </div>
                        <div class="sidebar-item" data-filter="trash">
                            <i class="fas fa-trash-alt"></i>
                            <span class="item-text">Trash</span>
                        </div>
                        <div class="sidebar-item" data-filter="quick-quote">
                            <i class="fas fa-bolt"></i>
                            <span class="item-text">Quick Billing</span>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Recent History</h2>
                </div>
                <div id="historyContainer">
                    <div style="text-align: center; color: var(--admin-secondary); font-style: italic;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Booking image">
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Booking Details</h3>
                <button class="modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Booking details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Date Blocking Modal -->
    <div id="dateBlockingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="blockingModalTitle">Manage Date</h3>
                <button class="modal-close" onclick="window.adminCalendar.closeBlockingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-info">
                    <p><strong>Date:</strong> <span id="selectedDateDisplay"></span></p>
                    <p><strong>Status:</strong> <span id="dateStatusDisplay"></span></p>
                </div>
                <div class="blocking-actions">
                    <button class="action-btn confirm" onclick="window.adminCalendar.toggleDateBlock()" id="toggleBlockBtn">
                        <i class="fas fa-lock"></i> Block Date
                    </button>
                    <button class="action-btn complete" onclick="window.adminCalendar.unblockDate()" id="unblockBtn" style="display: none;">
                        <i class="fas fa-unlock"></i> Unblock Date
                    </button>
                </div>
            </div>
            <!-- Footer removed - only header close button remains -->
        </div>
    </div>

    <!-- Booking Details Popup Modal -->
    <div id="bookingDetailsPopupModal" class="modal">
        <div class="modal-content booking-details-popup">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Booking Details</h3>
                <button class="modal-close" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="bookingDetailsPopupBody">
                <!-- Detailed booking information will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Message Modal -->
    <div id="customerMessageModal" class="modal">
        <div class="modal-content customer-message-modal">
            <div class="modal-header">
                <h3><i class="fas fa-envelope"></i> Send Message to Customer</h3>
                <button class="modal-close" onclick="closeCustomerMessageModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="message-customer-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer Name</label>
                                <span id="messageCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <label>Email</label>
                                <span id="messageCustomerEmail"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="messageBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="message-compose-section">
                    <h4><i class="fas fa-edit"></i> Compose Message</h4>
                    <div class="form-group">
                        <label for="messageSubject">Subject</label>
                        <input type="text" id="messageSubject" class="form-control" placeholder="Enter message subject..." value="Message from Stellar Tree Management">
                    </div>
                    <div class="form-group">
                        <label for="messageContent">Message</label>
                        <textarea id="messageContent" class="form-control" rows="8" placeholder="Type your message here..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerMessageModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-primary" onclick="sendCustomerMessage()">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Move Booking Modal -->
    <div id="moveBookingModal" class="modal">
        <div class="modal-content move-booking-modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrows-alt"></i> Move Booking</h3>
                <button class="modal-close" onclick="window.adminCalendar.closeMoveBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Booking Info Section -->
                <div class="move-booking-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <label>Current Date</label>
                                <span id="moveCurrentDate"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer</label>
                                <span id="moveCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <label>Phone</label>
                                <span id="moveCustomerPhone"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <label>Address</label>
                                <span id="moveCustomerAddress"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tools"></i>
                            <div>
                                <label>Service</label>
                                <span id="moveService"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="moveBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Selection Section -->
                <div class="move-date-selection">
                    <h4><i class="fas fa-calendar-plus"></i> Select New Date</h4>
                    
                    <!-- Calendar Navigation -->
                    <div class="move-calendar-nav">
                        <button class="nav-btn" onclick="window.adminCalendar.changeMoveMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="moveCalendarMonth"></span>
                        <button class="nav-btn" onclick="window.adminCalendar.changeMoveMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="move-calendar-grid" id="moveCalendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>

                    <!-- Selected Date Display -->
                    <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Selected: <strong id="selectedDateText"></strong></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="move-actions">
                    <button class="action-btn confirm" id="moveConfirmBtn" onclick="window.adminCalendar.moveBooking()" disabled>
                        <i class="fas fa-arrows-alt"></i> Move to Selected Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="window.adminCalendar.closeMoveBookingModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Management Modals -->

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <input type="text" id="customerAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">Notes</label>
                        <textarea id="customerNotes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customerDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 id="customerDetailsTitle">Customer Details</h3>
                <button class="modal-close" onclick="closeCustomerDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <!-- Customer details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerDetailsModal()">Close</button>
                <button type="button" class="btn-primary" onclick="editCustomer()">Edit Customer</button>
            </div>
        </div>
    </div>
    <script>
        // Variables are now declared in admin.js to avoid duplication
        // Global state variables
        let allBookings = [];
        let currentFilter = 'all';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let blockedDates = [];
        let selectedDate = null;
        
        // Customer Management Variables
        let allCustomers = [];
        let currentCustomerId = null;

        // Helper function to format date without timezone issues
        function formatBookingDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        // OAuth Authentication - handled by oauth-auth.js
        // The OAuth authentication system is now managed by the OAuthAuth class
        
        // Legacy logout function for compatibility
        function logout() {
            if (window.simpleGoogleAuth) {
                window.simpleGoogleAuth.logout();
            } else {
                // Fallback logout
                sessionStorage.removeItem('adminOAuthSession');
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminSession');
                location.reload();
            }
        }

        // Cleanup duplicate full-day job blocks






        // Load admin configuration from server
        async function loadAdminConfig() {
            try {
                const response = await fetch('/api/admin-config');
                if (response.ok) {
                    const config = await response.json();
                    window.ADMIN_CONFIG = config;
                } else {
                    console.warn('Failed to load admin config, using defaults');
                }
            } catch (error) {
                console.warn('Error loading admin config:', error);
            }
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load admin configuration first
            await loadAdminConfig();
            console.log('ADMIN_CONFIG loaded:', window.ADMIN_CONFIG);
            
            // OAuth authentication is handled by simple-google-oauth.js
            // The SimpleGoogleOAuth class will automatically check for existing sessions
            // and show/hide the appropriate UI elements
            
            // Clear form fields on page load if authenticated
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                clearFormFields();
                // Load bookings immediately if authenticated
                loadBookings();
            }
            
            // Add a fallback to load bookings after a short delay
            // This ensures bookings are loaded even if there are timing issues
            setTimeout(() => {
                if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                    loadBookings();
                }
            }, 2000);
            
            // Verify critical DOM elements are available
            setTimeout(() => {
                verifyCriticalElements();
            }, 1000);
        });
        
        // Verify critical DOM elements are available
        function verifyCriticalElements() {
            const criticalElements = [
                'quoteModal',
                'quoteClientName',
                'quoteClientPhone',
                'quoteClientAddress',
                'quoteClientEmail',
                'quoteDate',
                'taxToggle'
            ];
            
            const missingElements = [];
            criticalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (!element) {
                    missingElements.push(elementId);
                }
            });
            
            // Check for service-items-container (which is a class, not an ID)
            const serviceContainer = document.querySelector('.service-items-container');
            if (!serviceContainer) {
                missingElements.push('service-items-container (class)');
            }
            
            if (missingElements.length > 0) {
                console.error('âŒ Missing critical elements:', missingElements);
                showNotification(`Missing critical elements: ${missingElements.join(', ')}`, 'error');
            }
        }

        // Clear any potential cross-contamination from quick quotes/invoices
        function clearQuickQuoteInvoiceData() {
            // Clear quick quote service items container
            const quickQuoteContainer = document.getElementById('quickQuoteServiceItems');
            if (quickQuoteContainer) {
                quickQuoteContainer.innerHTML = '';
            }
            
            // Clear quick invoice service items container
            const quickInvoiceContainer = document.getElementById('quickInvoiceServiceItems');
            if (quickInvoiceContainer) {
                quickInvoiceContainer.innerHTML = '';
            }
            
            // Clear quick quote form fields
            const quickQuoteFields = ['quickQuoteClientName', 'quickQuoteClientPhone', 'quickQuoteClientAddress', 'quickQuoteClientEmail', 'quickQuoteDate'];
            quickQuoteFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            // Clear quick invoice form fields
            const quickInvoiceFields = ['quickInvoiceClientName', 'quickInvoiceClientPhone', 'quickInvoiceClientAddress', 'quickInvoiceClientEmail', 'quickInvoiceDate'];
            quickInvoiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            // Reset quick quote tax toggle
            const quickQuoteTaxToggle = document.getElementById('quickQuoteTaxToggle');
            if (quickQuoteTaxToggle) quickQuoteTaxToggle.checked = false;
            
            // Reset quick invoice tax toggle
            const quickInvoiceTaxToggle = document.getElementById('quickInvoiceTaxToggle');
            if (quickInvoiceTaxToggle) quickInvoiceTaxToggle.checked = false;
            
            console.log('Cleared quick quote/invoice data to prevent cross-contamination');
        }

        // Clear cached quote and invoice data
        function clearCachedData() {
            currentQuoteData = null;
            window.currentInvoiceData = null;
            itemCounter = 0;
            
            // Clear any temporary photo data
            if (window.tempPhotos) {
                window.tempPhotos = {};
            }
            
            console.log('Cleared cached quote and invoice data');
        }

        // Clear cached data for a specific booking
        function clearCachedDataForBooking(bookingId) {
            if (currentQuoteData && currentQuoteData.bookingId !== bookingId) {
                currentQuoteData = null;
            }
            if (window.currentInvoiceData && window.currentInvoiceData.bookingId !== bookingId) {
                window.currentInvoiceData = null;
            }
            
            // Reset item counter when switching bookings
            itemCounter = 0;
            
            // Clear any temporary photo data for this booking
            if (window.tempPhotos) {
                window.tempPhotos = {};
            }
            
            console.log(`Cleared cached data for booking: ${bookingId}`);
        }

        // Clear form fields
        function clearFormFields() {
            // Clear quote form fields
            const quoteFields = [
                'quoteClientName',
                'quoteClientPhone', 
                'quoteClientAddress',
                'quoteClientEmail',
                'quoteDate'
            ];
            
            quoteFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear invoice form fields
            const invoiceFields = [
                'invoiceClientName',
                'invoiceClientPhone',
                'invoiceClientAddress', 
                'invoiceClientEmail',
                'invoiceDate'
            ];
            
            invoiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Clear service items containers
            const quoteContainer = document.querySelector('.service-items-container');
            const invoiceContainer = document.getElementById('invoiceServiceItems');
            
            if (quoteContainer) {
                quoteContainer.innerHTML = '';
            }
            
            if (invoiceContainer) {
                invoiceContainer.innerHTML = '';
            }
            
            // Reset tax toggles
            const taxToggle = document.getElementById('taxToggle');
            const invoiceTaxToggle = document.getElementById('invoiceTaxToggle');
            
            if (taxToggle) {
                taxToggle.checked = false;
            }
            
            if (invoiceTaxToggle) {
                invoiceTaxToggle.checked = false;
            }
            
            // Reset total display elements to zero
            const totalElements = [
                'subtotalAmount',
                'taxAmount', 
                'grandTotalAmount',
                'invoiceSubtotalAmount',
                'invoiceTaxAmount',
                'invoiceGrandTotalAmount'
            ];
            
            totalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = '$0.00';
                }
            });
            
            console.log('Cleared all form fields and reset totals');
        }

        // Helper function to get admin auth headers
        function getAuthHeaders() {
            if (window.simpleGoogleAuth) {
                if (window.simpleGoogleAuth.isUserAuthenticated()) {
                    const headers = window.simpleGoogleAuth.getAuthHeaders();
                    return headers;
                }
            }
            
            return {};
        }

        // Manual refresh function with visual feedback
        async function manualRefreshBookings() {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                refreshBtn.disabled = true;
                
                try {
                    await loadBookings();
                    showNotification('Bookings refreshed successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to refresh bookings', 'error');
                } finally {
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 1000);
                }
            }
        }

        // Load bookings from API
        async function loadBookings() {
            try {
                // Check if user is authenticated
                if (!window.simpleGoogleAuth || !window.simpleGoogleAuth.isUserAuthenticated()) {
                    return;
                }
                
                const response = await fetch('/api/bookings', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    allBookings = await response.json();
                    
                    // Make allBookings globally accessible for admin calendar
                    window.allBookings = allBookings;
                    
                    // Clear cached data when loading bookings only if no modal is open
                    try {
                        const anyModalOpen = document.querySelectorAll('.modal.show').length > 0;
                        if (!anyModalOpen) {
                            clearCachedData();
                        }
                    } catch (e) {
                        // Fallback to previous behavior on any unexpected DOM errors
                        clearCachedData();
                    }
                    
                    // Update UI components
                    updateStatistics();
                    renderActiveBookings();
                    renderHistory();
                    
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                    
                } else if (response.status === 401 || response.status === 403) {
                    // Authentication failed, logout
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Failed to load bookings:', response.status, response.statusText);
                    console.error('âŒ Error response:', errorText);
                    showNotification('Failed to load bookings', 'error');
                }
            } catch (error) {
                console.error('âŒ Error loading bookings:', error);
                console.error('âŒ Error stack:', error.stack);
                showNotification('Network error loading bookings', 'error');
            }
        }



        // Update statistics
        function updateStatistics() {
            const stats = {
                pending: allBookings.filter(b => b.status === 'pending').length,
                quoteReady: allBookings.filter(b => b.status === 'quote-ready').length,
                quoteSent: allBookings.filter(b => b.status === 'quote-sent').length,
                quoteAccepted: allBookings.filter(b => b.status === 'quote-accepted').length,
                pendingBooking: allBookings.filter(b => b.status === 'pending-booking').length,
                invoiceReady: allBookings.filter(b => b.status === 'invoice-ready').length,
                invoiceSent: allBookings.filter(b => b.status === 'invoice-sent').length,
                completed: allBookings.filter(b => b.status === 'completed').length
            };

            // Update mobile sidebar counts
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('quoteReadyCount').textContent = stats.quoteReady;
            document.getElementById('quoteSentCount').textContent = stats.quoteSent;
            document.getElementById('quoteAcceptedCount').textContent = stats.quoteAccepted;
            document.getElementById('pendingBookingCount').textContent = stats.pendingBooking;
            document.getElementById('invoiceReadyCount').textContent = stats.invoiceReady;
            document.getElementById('invoiceSentCount').textContent = stats.invoiceSent;
            document.getElementById('completedCount').textContent = stats.completed;

            // Update desktop sidebar counts
            const desktopPendingCount = document.getElementById('desktop-pendingCount');
            const desktopQuoteReadyCount = document.getElementById('desktop-quoteReadyCount');
            const desktopQuoteSentCount = document.getElementById('desktop-quoteSentCount');
            const desktopQuoteAcceptedCount = document.getElementById('desktop-quoteAcceptedCount');
            const desktopPendingBookingCount = document.getElementById('desktop-pendingBookingCount');
            const desktopInvoiceReadyCount = document.getElementById('desktop-invoiceReadyCount');
            const desktopInvoiceSentCount = document.getElementById('desktop-invoiceSentCount');
            const desktopCompletedCount = document.getElementById('desktop-completedCount');

            if (desktopPendingCount) desktopPendingCount.textContent = stats.pending;
            if (desktopQuoteReadyCount) desktopQuoteReadyCount.textContent = stats.quoteReady;
            if (desktopQuoteSentCount) desktopQuoteSentCount.textContent = stats.quoteSent;
            if (desktopQuoteAcceptedCount) desktopQuoteAcceptedCount.textContent = stats.quoteAccepted;
            if (desktopPendingBookingCount) desktopPendingBookingCount.textContent = stats.pendingBooking;
            if (desktopInvoiceReadyCount) desktopInvoiceReadyCount.textContent = stats.invoiceReady;
            if (desktopInvoiceSentCount) desktopInvoiceSentCount.textContent = stats.invoiceSent;
            if (desktopCompletedCount) desktopCompletedCount.textContent = stats.completed;
        }

        // Toggle expandable menu sections
        function toggleSection(sectionId) {
            console.log('toggleSection called with:', sectionId);
            const content = document.getElementById(`${sectionId}-content`);
            const chevron = document.getElementById(`${sectionId}-chevron`);
            
            console.log('Content element:', content);
            console.log('Chevron element:', chevron);
            
            if (content && chevron) {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    chevron.style.transform = 'rotate(-90deg)';
                } else {
                    content.classList.add('expanded');
                    chevron.style.transform = 'rotate(0deg)';
                }
            } else {
                console.error('Could not find elements for section:', sectionId);
            }
        }

        // Filter by stat card click
        function filterByStatCard(filter) {
            // Find the corresponding sidebar item and trigger its click
            const sidebarItem = document.querySelector(`.sidebar-item[data-filter="${filter}"]`);
            if (sidebarItem) {
                // Remove active class from all sidebar items
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                
                // Add active class to the clicked sidebar item
                sidebarItem.classList.add('active');
                
                // Update current filter
                currentFilter = filter;
                
                // Update section title
                updateSectionTitle();
                
                // Handle archive filter
                if (filter === 'archive') {
                    // Hide other views
                    const calendarView = document.getElementById('calendarView');
                    if (calendarView) {
                        calendarView.style.display = 'none';
                    }
                    
                    const activeBookingsGrid = document.getElementById('activeBookingsGrid');
                    if (activeBookingsGrid) {
                        activeBookingsGrid.style.display = 'none';
                    }
                    
                    // Show archive view
                    const archiveView = document.getElementById('archiveView');
                    if (archiveView) {
                        archiveView.style.display = 'block';
                    }
                    
                    // Load archived bookings if not already loaded
                    if (window.adminArchive && !window.adminArchive.isLoaded) {
                        window.adminArchive.loadArchivedBookings();
                    }
                    
                    return;
                }
                
                // Hide calendar view if it's showing
                const calendarView = document.getElementById('calendarView');
                if (calendarView) {
                    calendarView.style.display = 'none';
                }
                
                // Hide archive view
                const archiveView = document.getElementById('archiveView');
                if (archiveView) {
                    archiveView.style.display = 'none';
                }
                
                // Customer management view - REMOVED
                
                // Show bookings grid
                const activeBookingsGrid = document.getElementById('activeBookingsGrid');
                if (activeBookingsGrid) {
                    activeBookingsGrid.style.display = 'grid';
                }
                
                // Render filtered bookings
                renderActiveBookings();
                
                // Scroll to bookings section smoothly
                const activeBookingsSection = document.querySelector('.active-bookings-section');
                if (activeBookingsSection) {
                    activeBookingsSection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }



        // Render active bookings (pending and scheduled)
        function renderActiveBookings() {
            // Don't render if archive or trash filter is active
            if (currentFilter === 'archive' || currentFilter === 'trash') {
                return;
            }
            
            const grid = document.getElementById('activeBookingsGrid');
            
            // Show loading state if no bookings are loaded yet
            if (!allBookings || allBookings.length === 0) {
                grid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading bookings...</div>';
                return;
            }
            
            // Apply filter
            let filteredBookings = [];
            
            if (currentFilter === 'all') {
                // Show only active bookings (pending, quote-ready, quote-sent, quote-accepted, pending-booking, invoice-ready, invoice-sent)
                filteredBookings = allBookings.filter(booking => 
                    booking.status === 'pending' || 
                    booking.status === 'quote-ready' || 
                    booking.status === 'quote-sent' || 
                    booking.status === 'quote-accepted' || 
                    booking.status === 'pending-booking' || 
                    booking.status === 'invoice-ready' || 
                    booking.status === 'invoice-sent'
                );
            } else if (currentFilter === 'pending') {
                filteredBookings = allBookings.filter(b => b.status === 'pending');

            } else if (currentFilter === 'quote-ready') {
                filteredBookings = allBookings.filter(b => b.status === 'quote-ready');
            } else if (currentFilter === 'quote-sent') {
                filteredBookings = allBookings.filter(b => b.status === 'quote-sent');
            } else if (currentFilter === 'quote-accepted') {
                filteredBookings = allBookings.filter(b => b.status === 'quote-accepted');
            } else if (currentFilter === 'pending-booking') {
                filteredBookings = allBookings.filter(b => b.status === 'pending-booking');
            } else if (currentFilter === 'invoice-ready') {
                filteredBookings = allBookings.filter(b => b.status === 'invoice-ready');
            } else if (currentFilter === 'invoice-sent') {
                filteredBookings = allBookings.filter(b => b.status === 'invoice-sent');
            } else if (currentFilter === 'completed') {
                filteredBookings = allBookings.filter(b => b.status === 'completed');
            } else if (currentFilter === 'all-bookings') {
                // Show all bookings including completed and cancelled
                filteredBookings = allBookings;
            }

            if (filteredBookings.length === 0) {
                // Don't show "No bookings found" if archive or trash filter is active
                if (currentFilter === 'archive' || currentFilter === 'trash') {
                    return;
                }
                grid.innerHTML = '<div class="empty-state">No bookings found</div>';
                return;
            }

            grid.innerHTML = filteredBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const statusClass = `status-${booking.status}`;
                let statusText = '';
                let actionButtons = '';

                // Handle different statuses with appropriate text and buttons
                if (booking.status === 'pending') {
                    statusText = 'Pending Site Visit';
                    actionButtons = `
                        <button class="action-btn confirm" onclick="confirmSiteVisit('${booking.booking_id}')">
                            <i class="fas fa-check"></i> Confirm Visit
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;

                } else if (booking.status === 'quote-ready') {
                    statusText = 'Quote Ready';
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModalWithRetry(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn send-quote" onclick="sendQuoteToCustomer('${booking.booking_id}')">
                            <i class="fas fa-paper-plane"></i> Send Quote
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'quote-sent') {
                    statusText = 'Quote Sent - Awaiting Confirmation';
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'quote-accepted') {
                    statusText = 'Quote Accepted - Ready to Schedule';
                    actionButtons = `
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'pending-booking') {
                    statusText = 'Job Scheduled - Awaiting Admin';
                    actionButtons = `
                        <button class="action-btn confirm" onclick="confirmJob('${booking.booking_id}')">
                            <i class="fas fa-check-double"></i> Confirm Job
                        </button>
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'invoice-ready') {
                    statusText = 'Invoice Ready';
                    actionButtons = `
                        <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>
                        <button class="action-btn quote" onclick="sendInvoiceFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice-dollar"></i> Send Invoice
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'invoice-sent') {
                    statusText = 'Invoice Sent - Awaiting Payment';
                    actionButtons = `
                        <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                            <i class="fas fa-file-invoice"></i> View Invoice
                        </button>
                        <button class="action-btn confirm" onclick="markInvoicePaid('${booking.booking_id}')">
                            <i class="fas fa-check"></i> Mark as Paid
                        </button>
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else if (booking.status === 'completed') {
                    statusText = 'Completed';
                    actionButtons = `
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                } else {
                    // Fallback for any other statuses
                    statusText = booking.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    actionButtons = `
                        <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    `;
                }

                const cardClass = booking.status === 'completed' ? 'completed' : 
                                 booking.status === 'cancelled' ? 'cancelled' : '';
                
                return `
                    <div class="booking-card ${cardClass}" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                        <div class="booking-header">
                            <div class="booking-id">
                                <a href="booking-status.html?booking=${booking.booking_id}" target="_blank" class="clickable-booking-id" title="Click to view booking status page" onclick="event.stopPropagation();">
                                    <i class="fas fa-external-link-alt"></i> ${booking.booking_id}
                                </a>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="booking-essentials">
                            <div class="essential-row">
                                <i class="fas fa-user essential-icon"></i>
                                <span class="essential-label">Customer:</span>
                                <span class="essential-value">${booking.name}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-calendar essential-icon"></i>
                                <span class="essential-label">Date:</span>
                                <span class="essential-value">${formatBookingDate(booking.date)}${booking.time ? ` at ${booking.time}` : ''}</span>
                            </div>
                            ${booking.job_date && booking.job_time ? `
                            <div class="essential-row job-details">
                                <i class="fas fa-calendar-check essential-icon" style="color: #6f42c1;"></i>
                                <span class="essential-label">Job Date:</span>
                                <span class="essential-value" style="color: #6f42c1; font-weight: 600;">${formatBookingDate(booking.job_date)} at ${booking.job_time}</span>
                            </div>
                            ` : ''}

                            ${booking.images ? `
                            <div class="booking-images">
                                <div class="images-preview">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.slice(0, 3).map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Old</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-thumbnail" 
                                                                 onclick="event.stopPropagation(); showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>Image</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666; width: 60px; height: 60px;">
                                                                <i class="fas fa-image" style="font-size: 16px; margin-bottom: 4px;"></i>
                                                                <span>?</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('') + 
                                                (imageArray.length > 3 ? `
                                                    <div class="more-images">+${imageArray.length - 3}</div>
                                                ` : '');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="booking-actions" onclick="event.stopPropagation();">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
                    // Setup calendar drag and drop after rendering (only for calendar tab)
        if (currentFilter === 'calendar') {
            window.adminCalendar.setupCalendarDragAndDrop();
        }
        }

        // Render history (completed and cancelled)
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            const historyBookings = allBookings.filter(booking => 
                booking.status === 'completed' || booking.status === 'cancelled'
            ).slice(0, 10); // Show last 10

            if (historyBookings.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--admin-secondary); font-style: italic;">No recent activity</div>';
                return;
            }

            container.innerHTML = historyBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const historyDate = formatBookingDate(booking.date);

                return `
                    <div class="history-item ${booking.status}">
                        <h4>${booking.service} - ${booking.name}</h4>
                        <p><strong>ID:</strong> ${booking.booking_id}</p>
                        <p><strong>Date:</strong> ${dateTime}</p>
                        <p><strong>Email:</strong> ${booking.email}</p>
                        <p><strong>Phone:</strong> ${booking.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${booking.address || 'N/A'}</p>
                        <p class="history-date">${booking.status} - Booked for ${historyDate}</p>
                    </div>
                `;
            }).join('');
        }
        // Update booking status with intelligent reversion logic
        async function updateBookingStatus(bookingId, newStatus) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = newStatus;

                // Intelligent status reversion logic
                if (currentStatus === 'completed' && newStatus !== 'completed') {
                    // When reverting from completed, go back to invoice-sent (the status before completion)
                    targetStatus = 'invoice-sent';
                }

                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (response.ok) {
                    const statusMessage = currentStatus === 'completed' && newStatus !== 'completed' 
                        ? `Booking reverted from completed to ${targetStatus} successfully` 
                        : `Booking ${targetStatus} successfully`;
                    showNotification(statusMessage, 'success');
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking', 'error');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showNotification('Network error updating booking', 'error');
            }
        }

        // Move booking to next stage without sending emails (dev/admin use only)
        async function moveToNextStage(bookingId, newStatus) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                
                // Validate the status transition
                const validTransitions = {
                    'pending': ['quote-ready'],
                    'quote-ready': ['quote-sent'],
                    'quote-sent': ['quote-accepted'],
                    'quote-accepted': ['pending-booking'],
                    'pending-booking': ['invoice-ready'],
                    'invoice-ready': ['invoice-sent'],
                    'invoice-sent': ['completed']
                };

                if (!validTransitions[currentStatus] || !validTransitions[currentStatus].includes(newStatus)) {
                    showNotification(`Invalid status transition from ${currentStatus} to ${newStatus}`, 'error');
                    return;
                }

                // Update the booking status
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showNotification(`Booking moved from ${currentStatus} to ${newStatus} successfully`, 'success');
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(newStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                    
                    // Close the popup modal
                    closeBookingDetailsPopup();
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to move booking to next stage', 'error');
                }
            } catch (error) {
                console.error('Error moving booking to next stage:', error);
                showNotification('Network error moving booking to next stage', 'error');
            }
        }

        // Confirm quote and send email to customer
        async function confirmQuoteAndSendEmail(bookingId) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = 'pending-booking';

                // Intelligent status reversion logic
                if (currentStatus === 'completed') {
                    // When confirming quote from completed status, go back to invoice-sent first
                    targetStatus = 'invoice-sent';
                }

                // First, update the booking status
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking status', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send email to customer with quote confirmation and booking link
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-quote-confirmation-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name,
                        estimatedCost: booking.estimated_cost || 'TBD',
                        workDescription: booking.work_description || booking.notes || 'Tree service as requested'
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    const successMessage = currentStatus === 'completed' 
                        ? 'Quote confirmed and email sent! Status reverted from completed to invoice-sent.' 
                        : 'Quote confirmed and confirmation email sent successfully!';
                    showNotification(successMessage, 'success');
                    console.log('ðŸ“§ Quote confirmation email sent:', emailResult.messageId);
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else {
                    const emailError = await emailResponse.json();
                    const warningMessage = currentStatus === 'completed'
                        ? `Quote confirmed but email failed: ${emailError.error}. Status reverted from completed to invoice-sent.`
                        : `Quote confirmed but email failed: ${emailError.error}`;
                    showNotification(warningMessage, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming quote:', error);
                showNotification('Network error confirming quote', 'error');
            }
        }

        // Confirm job (admin confirms customer's job booking)
        async function confirmJob(bookingId) {
            try {
                // Update the booking status to 'invoice-ready' (Ready to create invoice)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'invoice-ready' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to confirm job', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                showNotification('Job confirmed successfully! Ready to create invoice.', 'success');
                
                // Auto-switch to the invoice-ready tab
                autoSwitchToNextTab('invoice-ready');
                
                loadBookings(); // Reload to update the display
                
                // Explicitly refresh calendar if it's currently visible
                if (currentFilter === 'calendar') {
                    window.adminCalendar.renderCalendar(allBookings);
                }
            } catch (error) {
                console.error('Error confirming job:', error);
                showNotification('Network error confirming job', 'error');
            }
        }

        // Confirm booking (admin confirms customer's booking request)
        async function confirmBooking(bookingId) {
            try {
                // Update the booking status to 'completed' (Completed Booking)
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to confirm booking', 'error');
                    return;
                }

                // Get booking details
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Send confirmation email to customer
                const emailResponse = await fetch(`/api/bookings/${bookingId}/send-confirmation-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerEmail: booking.email,
                        customerName: booking.name
                    })
                });

                if (emailResponse.ok) {
                    const emailResult = await emailResponse.json();
                    showNotification('Booking confirmed and confirmation email sent successfully', 'success');
                    console.log('ðŸ“§ Confirmation email sent:', emailResult.emailContent);
                    
                    // Auto-switch to the completed tab
                    autoSwitchToNextTab('completed');
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else {
                    const emailError = await emailResponse.json();
                    showNotification(`Booking confirmed but email failed: ${emailError.error}`, 'warning');
                    loadBookings(); // Still reload to show updated status
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showNotification('Network error confirming booking', 'error');
            }
        }

        // Check for quote and complete booking
        async function checkForQuoteAndComplete(bookingId) {
            try {
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Check if there's a quote for this booking
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`, {
                    headers: getAuthHeaders()
                });
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const latestQuote = quotes[0];
                        showInvoiceModal(latestQuote, booking);
                    } else {
                        // No quote found, ask user if they want to create one
                        if (confirm('No quote found for this booking. Would you like to create a quote first?')) {
                            showQuoteModal(booking);
                        } else {
                            // Complete without quote
                            await updateBookingStatus(bookingId, 'completed');
                        }
                    }
                } else {
                    showNotification('Error checking for quotes', 'error');
                }
            } catch (error) {
                console.error('Error checking for quote:', error);
                showNotification('Network error checking for quote', 'error');
            }
        }

        // Move booking to trash
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to move this booking to trash? It can be restored within 30 days.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/trash`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const trashedBooking = await response.json();
                    showNotification('Booking moved to trash', 'success');
                    
                    // Close any open modals
                    const modals = document.querySelectorAll('.modal.show, .modal[style*="display: block"], .modal[style*="display:block"]');
                    modals.forEach(modal => {
                        modal.classList.remove('show');
                        modal.style.display = 'none';
                    });
                    
                    // Remove modal-open class from body
                    document.body.classList.remove('modal-open');
                    
                    // Restore body scrolling
                    document.body.style.overflow = '';
                    
                    // Remove the booking from the allBookings array immediately
                    if (window.allBookings) {
                        window.allBookings = window.allBookings.filter(b => b.booking_id !== bookingId);
                    }
                    
                    // Add to trash immediately (always)
                    if (window.adminTrash) {
                        window.adminTrash.trashedBookings.unshift(trashedBooking);
                        window.adminTrash.isLoaded = true; // Mark as loaded to prevent double-loading
                        // If trash view is currently open, update it immediately
                        if (currentFilter === 'trash') {
                            window.adminTrash.renderTrashedBookings();
                        }
                    }
                    
                    // Update the UI immediately
                    if (typeof renderActiveBookings === 'function') {
                        renderActiveBookings();
                    }
                    
                    // Update statistics
                    if (typeof updateStatistics === 'function') {
                        updateStatistics();
                    }
                    
                    // Reload bookings to ensure sync with server
                    loadBookings();
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    const error = await response.json();
                    showNotification(error.error || error.message || 'Failed to move booking to trash', 'error');
                }
            } catch (error) {
                console.error('Error moving booking to trash:', error);
                showNotification('Network error moving booking to trash', 'error');
            }
        }

        // Filter functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('sidebar-item') || e.target.closest('.sidebar-item')) {
                const sidebarItem = e.target.classList.contains('sidebar-item') ? e.target : e.target.closest('.sidebar-item');
                
                // Update active sidebar item
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                sidebarItem.classList.add('active');
                
                // Update filter
                currentFilter = sidebarItem.dataset.filter;
                updateSectionTitle();
                
                // Show/hide appropriate view
                if (currentFilter === 'calendar') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('archiveView').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'block';
                    
                    // Load calendar events first, then render calendar
                    if (window.adminCalendarEvents) {
                        window.adminCalendarEvents.loadEventsWhenAuthenticated().then(() => {
                            // After events are loaded, load blocked dates and render calendar
                            window.adminCalendar.loadBlockedDates().then(() => window.adminCalendar.renderCalendar(allBookings));
                        });
                    } else {
                        // Fallback if calendar events not available
                        window.adminCalendar.loadBlockedDates().then(() => window.adminCalendar.renderCalendar(allBookings));
                    }
                } else if (currentFilter === 'archive') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('archiveView').style.display = 'block';
                    
                    // Load archived bookings if not already loaded
                    if (window.adminArchive && !window.adminArchive.isLoaded) {
                        window.adminArchive.loadArchivedBookings();
                    }
                    
                    // Clear the active bookings grid to prevent "No bookings found" message
                    const activeBookingsGrid = document.getElementById('activeBookingsGrid');
                    if (activeBookingsGrid) {
                        activeBookingsGrid.innerHTML = '';
                    }
                } else if (currentFilter === 'trash') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('archiveView').style.display = 'none';
                    document.getElementById('trashView').style.display = 'block';
                    
                    // Load trashed bookings if not already loaded
                    if (window.adminTrash && !window.adminTrash.isLoaded) {
                        window.adminTrash.loadTrashedBookings();
                    }
                    
                    // Clear the active bookings grid to prevent "No bookings found" message
                    const activeBookingsGrid = document.getElementById('activeBookingsGrid');
                    if (activeBookingsGrid) {
                        activeBookingsGrid.innerHTML = '';
                    }
                } else {
                    document.getElementById('activeBookingsGrid').style.display = 'grid';
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('archiveView').style.display = 'none';
                    document.getElementById('trashView').style.display = 'none';
                    renderActiveBookings();
                }
            }
        });

        // Update section title based on current filter
        function updateSectionTitle() {
            const sectionTitle = document.getElementById('sectionTitle');
            switch (currentFilter) {
                case 'all':
                    sectionTitle.textContent = 'Request Quote';
                    break;
                case 'pending':
                    sectionTitle.textContent = 'Pending Site Visit';
                    break;

                case 'quote-ready':
                    sectionTitle.textContent = 'Quote Ready';
                    break;
                case 'quote-sent':
                    sectionTitle.textContent = 'Quote Sent';
                    break;
                case 'quote-accepted':
                    sectionTitle.textContent = 'Quote Accepted';
                    break;

                case 'pending-booking':
                    sectionTitle.textContent = 'Job Scheduled - Awaiting Admin Confirmation';
                    break;
                case 'invoice-ready':
                    sectionTitle.textContent = 'Invoice Ready';
                    break;
                case 'invoice-sent':
                    sectionTitle.textContent = 'Invoice Sent';
                    break;
                case 'completed':
                    sectionTitle.textContent = 'Completed';
                    break;
                case 'all-bookings':
                    sectionTitle.textContent = 'All Bookings';
                    break;
                case 'calendar':
                    sectionTitle.textContent = 'Calendar';
                    break;
                case 'archive':
                    sectionTitle.textContent = 'Archive';
                    break;
                default:
                    sectionTitle.textContent = 'Request Quote';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }















        function closeBookingModal() {
            document.getElementById('bookingDetailsModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }
        function showDetailedBookingDetailsPopup(bookingId) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const createdDate = new Date(booking.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const statusClass = `status-${booking.status}`;
            let statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

            let actionButtons = '';
            if (booking.status === 'pending') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'pending-booking')">
                        <i class="fas fa-check"></i> Schedule Job
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="window.adminCalendar.showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;

            } else if (booking.status === 'completed') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'invoice-sent')" title="Revert to Invoice Sent">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'cancelled') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn reopen" onclick="updateBookingStatus('${booking.booking_id}', 'pending')">
                        <i class="fas fa-redo"></i> Reopen
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'pending-booking')">
                        <i class="fas fa-check"></i> Schedule Job
                    </button>
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn move" onclick="window.adminCalendar.showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'quote-ready') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'quote-sent')" title="Move to Quote Sent">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending')" title="Revert to Pending">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'quote-sent') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'quote-accepted')" title="Move to Quote Accepted">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'quote-ready')" title="Revert to Quote Ready">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'quote-accepted') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'pending-booking')" title="Move to Job Scheduled">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'quote-sent')" title="Revert to Quote Sent">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'pending-booking') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-invoice-dollar"></i> Quote
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'invoice-ready')" title="Move to Invoice Ready">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'quote-accepted')" title="Revert to Quote Accepted">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'invoice-ready') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice"></i> Invoice
                    </button>
                    <button class="action-btn quote" onclick="sendInvoiceFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice-dollar"></i> Send Invoice
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'invoice-sent')" title="Move to Invoice Sent">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'pending-booking')" title="Revert to Job Scheduled">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'invoice-sent') {
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn invoice" onclick="showInvoiceModalFromBooking('${booking.booking_id}')">
                        <i class="fas fa-file-invoice"></i> View Invoice
                    </button>
                    <button class="action-btn forward" onclick="moveToNextStage('${booking.booking_id}', 'completed')" title="Move to Completed">
                        <i class="fas fa-arrow-right"></i> Forward
                    </button>
                    <button class="action-btn warning" onclick="revertBookingStatus('${booking.booking_id}', 'invoice-ready')" title="Revert to Invoice Ready">
                        <i class="fas fa-undo"></i> Revert
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else {
                // Fallback for any other statuses
                statusText = booking.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                actionButtons = `
                    <button class="action-btn message" onclick="showCustomerMessageModal('${booking.booking_id}', '${booking.name}', '${booking.email}')">
                        <i class="fas fa-envelope"></i> Message
                    </button>
                    <button class="action-btn archive" onclick="adminArchive.archiveBooking('${booking.booking_id}')">
                        <i class="fas fa-archive"></i> Archive
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            }

            const modalBody = document.getElementById('bookingDetailsPopupBody');
            modalBody.innerHTML = `
                <div class="detail-popup-grid">
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-info-circle"></i> Booking Info</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">ID:</span>
                            <span class="detail-popup-value">
                                <a href="booking-status.html?booking=${booking.booking_id}" target="_blank" class="clickable-booking-id" title="Click to view booking status page">
                                    <i class="fas fa-external-link-alt"></i> ${booking.booking_id}
                                </a>
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Status:</span>
                            <span class="detail-popup-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Service:</span>
                            <span class="detail-popup-value">${booking.service}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-calendar-alt"></i> Schedule</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Date:</span>
                            <span class="detail-popup-value">${dateTime}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Booking Date:</span>
                            <span class="detail-popup-value">${(() => {
                                const [year, month, day] = booking.date.split('-').map(Number);
                                const date = new Date(year, month - 1, day);
                                return date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                            })()}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-user"></i> Customer</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Name:</span>
                            <span class="detail-popup-value">${booking.name}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Email:</span>
                            <span class="detail-popup-value">${booking.email}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Phone:</span>
                            <span class="detail-popup-value">${booking.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Address:</span>
                            <span class="detail-popup-value">
                                ${booking.address ? 
                                    `<a href="https://maps.google.com/?q=${encodeURIComponent(booking.address)}" target="_blank" class="clickable-address" title="Click to open in Google Maps">
                                        <i class="fas fa-map-marker-alt"></i> ${booking.address}
                                    </a>` 
                                    : 'Not provided'
                                }
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Notes:</span>
                            <div class="detail-popup-value">
                                <textarea id="bookingNotes" class="notes-textarea" placeholder="Add your personal notes here...">${booking.notes || ''}</textarea>
                                <button class="action-btn confirm" onclick="updateBookingNotes('${booking.booking_id}')" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Save Notes
                                </button>
                            </div>
                        </div>
                        ${booking.images ? `
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Images:</span>
                            <div class="detail-popup-value">
                                <div class="booking-images-detail">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.map(imagePath => {
                                                    // Check if this is an old filesystem path or new MongoDB path
                                                    const isOldPath = imagePath.includes('booking-') && imagePath.includes('.');
                                                    const isNewPath = imagePath.includes('/uploads/') && imagePath.split('/').pop().length === 24;
                                                    
                                                    if (isOldPath) {
                                                        // Old filesystem path - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Old Image (Not Available)</span>
                                                            </div>
                                                        `;
                                                    } else if (isNewPath) {
                                                        // New MongoDB path - try to load
                                                        return `
                                                            <img src="${imagePath}" alt="Booking image" class="booking-image-detail" 
                                                                 onclick="showImageModal('${imagePath}')"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                                 onload="this.nextElementSibling.style.display='none';">
                                                            <div class="image-placeholder-detail" style="display: none; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Image Unavailable</span>
                                                            </div>
                                                        `;
                                                    } else {
                                                        // Unknown format - show placeholder
                                                        return `
                                                            <div class="image-placeholder-detail" style="display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f5f5f5; border-radius: 4px; padding: 12px; font-size: 14px; color: #666; min-height: 100px;">
                                                                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px;"></i>
                                                                <span>Unknown Format</span>
                                                            </div>
                                                        `;
                                                    }
                                                }).join('');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking details:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${actionButtons ? `
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-cogs"></i> Actions</h4>
                        <div class="detail-popup-actions">
                            ${actionButtons}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            openModal('bookingDetailsPopupModal');
        }

        function closeBookingDetailsPopup() {
            document.getElementById('bookingDetailsPopupModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }



































        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.bookingId);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const bookingId = e.dataTransfer.getData('text/plain');
            const newDate = day.dataset.date;

            if (!newDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ newDate: newDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }

            day.classList.remove('drag-over');
        }

        // Update booking notes
        async function updateBookingNotes(bookingId) {
            const notesTextarea = document.getElementById('bookingNotes');
            const notes = notesTextarea.value.trim();

            try {
                const response = await fetch(`/api/bookings/${bookingId}/notes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ notes: notes })
                });

                if (response.ok) {
                    showNotification('Notes updated successfully', 'success');
                    // Update the booking in the local array
                    const booking = allBookings.find(b => b.booking_id === bookingId);
                    if (booking) {
                        booking.notes = notes;
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update notes', 'error');
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                showNotification('Network error updating notes', 'error');
            }
        }

        // Modal management functions
        function closeModal(modalId) {
            console.log('Attempting to close modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal found, removing show class and forcing display none');
                
                // Remove the show class
                modal.classList.remove('show');
                
                // Force the modal to be hidden with inline styles to override any !important rules
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.zIndex = '-1';
                
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                
                // Clear any cached data when closing quote/invoice modals
                if (modalId === 'quoteModal' || modalId === 'invoiceModal' || modalId === 'quickQuoteModal' || modalId === 'quickInvoiceModal') {
                    clearModalData(modalId);
                }
                
                console.log('Modal closed successfully:', modalId);
            } else {
                console.error('Modal not found:', modalId);
            }
        }
        
        // Clear modal data when closing
        function clearModalData(modalId) {
            if (modalId === 'quoteModal') {
                // Clear quote form data
                const quoteFields = ['quoteClientName', 'quoteClientPhone', 'quoteClientAddress', 'quoteClientEmail', 'quoteDate'];
                quoteFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear service items
                const serviceContainer = document.querySelector('.service-items-container');
                if (serviceContainer) {
                    serviceContainer.innerHTML = '';
                }
                
                // Reset totals
                const totalElements = ['subtotalAmount', 'taxAmount', 'grandTotalAmount'];
                totalElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) element.textContent = '$0.00';
                });
                
                // Reset tax toggle
                const taxToggle = document.getElementById('taxToggle');
                if (taxToggle) taxToggle.checked = false;
                
                // Clear global state
                currentQuoteData = null;
                itemCounter = 0;
                
            } else if (modalId === 'invoiceModal') {
                // Clear invoice form data
                const invoiceFields = ['invoiceClientName', 'invoiceClientPhone', 'invoiceClientAddress', 'invoiceClientEmail', 'invoiceDate'];
                invoiceFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear service items
                const serviceContainer = document.getElementById('invoiceServiceItems');
                if (serviceContainer) {
                    serviceContainer.innerHTML = '';
                }
                
                // Reset totals
                const totalElements = ['invoiceSubtotalAmount', 'invoiceTaxAmount', 'invoiceGrandTotalAmount'];
                totalElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) element.textContent = '$0.00';
                });
                
                // Reset tax toggle
                const taxToggle = document.getElementById('invoiceTaxToggle');
                if (taxToggle) taxToggle.checked = false;
                
                // Clear global state
                window.currentInvoiceData = null;
                
            } else if (modalId === 'quickQuoteModal') {
                // Clear quick quote form data
                const quickQuoteFields = ['quickQuoteClientName', 'quickQuoteClientPhone', 'quickQuoteClientAddress', 'quickQuoteClientEmail', 'quickQuoteDate'];
                quickQuoteFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear service items container
                const serviceContainer = document.getElementById('quickQuoteServiceItems');
                if (serviceContainer) {
                    serviceContainer.innerHTML = '';
                }
                
                // Reset totals
                const totalElements = ['quickQuoteSubtotalAmount', 'quickQuoteTaxAmount', 'quickQuoteGrandTotalAmount'];
                totalElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) element.textContent = '$0.00';
                });
                
                // Reset tax toggle
                const taxToggle = document.getElementById('quickQuoteTaxToggle');
                if (taxToggle) taxToggle.checked = false;
                
            } else if (modalId === 'quickInvoiceModal') {
                // Clear quick invoice form data
                const quickInvoiceFields = ['quickInvoiceClientName', 'quickInvoiceClientPhone', 'quickInvoiceClientAddress', 'quickInvoiceClientEmail', 'quickInvoiceDate'];
                quickInvoiceFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear service items container
                const serviceContainer = document.getElementById('quickInvoiceServiceItems');
                if (serviceContainer) {
                    serviceContainer.innerHTML = '';
                }
                
                // Reset totals
                const totalElements = ['quickInvoiceSubtotalAmount', 'quickInvoiceTaxAmount', 'quickInvoiceGrandTotalAmount'];
                totalElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) element.textContent = '$0.00';
                });
                
                // Reset tax toggle
                const taxToggle = document.getElementById('quickInvoiceTaxToggle');
                if (taxToggle) taxToggle.checked = false;
            }
        }

        // Enhanced modal closing function that tries multiple methods
        function forceCloseModal(modalId) {
            // Method 1: Standard closeModal
            closeModal(modalId);
            
            // Method 2: Find all modals and close any that might be visible
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal.classList.contains('show') || modal.style.display !== 'none') {
                    modal.classList.remove('show');
                    // Don't set display: none manually - let CSS handle it
                    // modal.style.display = 'none';
                }
            });
            
            // Method 3: Remove modal-open class from body
            document.body.classList.remove('modal-open');
            
            // Method 4: Force remove any backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop, .modal-overlay');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Method 5: Reset any manually set display styles to allow CSS to work properly
            const targetModal = document.getElementById(modalId);
            if (targetModal && targetModal.style.display === 'none') {
                targetModal.style.removeProperty('display');
            }
        }
        // Special function for opening invoice modal
        function openInvoiceModal() {
            console.log('ðŸ”§ Opening invoice modal with special handling...');
            
            // Remove any existing invoice modal completely
            const existingModal = document.getElementById('invoiceModal');
            if (existingModal) {
                console.log('ðŸ”§ Removing existing invoice modal completely...');
                existingModal.remove();
            }
            
            // Create a completely new modal element from scratch
            const newModal = document.createElement('div');
            newModal.id = 'invoiceModal';
            newModal.className = 'modal show';
            
            // Create the modal content with inline styles
            newModal.innerHTML = `
                <div class="modal-content quote-modal-content" style="
                    display: flex !important;
                    flex-direction: column !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 10000 !important;
                    background: white !important;
                    border-radius: 8px !important;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
                    max-height: 90vh !important;
                    overflow-y: auto !important;
                    width: 90% !important;
                    max-width: 800px !important;
                    min-width: 400px !important;
                    margin: auto !important;
                    padding: 20px !important;
                    border: none !important;
                ">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-invoice"></i> Invoice</h3>
                        <button class="modal-close" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="quote-form">
                            <!-- Client Information Section -->
                            <div class="quote-section">
                                <h4><i class="fas fa-user"></i> Client Information</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="invoiceClientName">Full Name</label>
                                        <input type="text" id="invoiceClientName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="invoiceClientPhone">Phone Number</label>
                                        <input type="tel" id="invoiceClientPhone" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="invoiceClientAddress">Address</label>
                                        <input type="text" id="invoiceClientAddress" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="invoiceClientEmail">Email</label>
                                        <input type="email" id="invoiceClientEmail" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="invoiceDate">Invoice Date</label>
                                        <input type="date" id="invoiceDate" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Service Items Section -->
                            <div class="quote-section">
                                <h4><i class="fas fa-tools"></i> Service Items</h4>
                                <div id="invoiceServiceItems" class="service-items-container">
                                    <!-- Service items will be populated from quote -->
                                </div>
                                <div class="add-item-container">
                                    <button type="button" class="add-item-btn" onclick="addInvoiceServiceItem()">
                                        <i class="fas fa-plus"></i> Add Service Item
                                    </button>
                                </div>
                            </div>

                            <!-- Tax and Total Section -->
                            <div class="quote-section">
                                <div class="tax-toggle-container">
                                    <label class="tax-toggle-label">
                                        <input type="checkbox" id="invoiceTaxToggle" onchange="toggleInvoiceTax()">
                                        <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                                    </label>
                                </div>
                                <div class="quote-totals">
                                    <div class="total-row">
                                        <span>Subtotal:</span>
                                        <span id="invoiceSubtotalAmount">$0.00</span>
                                    </div>
                                    <div class="total-row tax-row" id="invoiceTaxRow" style="display: none;">
                                        <span>Tax (5%):</span>
                                        <span id="invoiceTaxAmount">$0.00</span>
                                    </div>
                                    <div class="total-row grand-total">
                                        <span>Total:</span>
                                        <span id="invoiceGrandTotalAmount">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoice Actions -->
                            <div class="quote-actions">
                                <button type="button" class="btn-secondary" onclick="closeModal('invoiceModal')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn-primary" onclick="generateInvoice()">
                                    <i class="fas fa-save"></i> Save Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Apply styles to the modal container
            newModal.style.cssText = `
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 9999 !important;
                align-items: center !important;
                justify-content: center !important;
                background-color: rgba(0, 0, 0, 0.4) !important;
            `;
            
            // Add the new modal to the body
            document.body.appendChild(newModal);
            document.body.classList.add('modal-open');
            
            // Data will be populated by showInvoiceModal after modal creation
            console.log('ðŸ”§ Modal created, waiting for data population...');
            
            // Verify the modal is working
            setTimeout(() => {
                const modalContent = newModal.querySelector('.modal-content');
                const contentVisible = modalContent && 
                                     modalContent.offsetWidth > 0 && 
                                     modalContent.offsetHeight > 0;
                console.log('ðŸ”§ Completely new invoice modal content visible:', contentVisible);
                console.log('ðŸ”§ New modal content dimensions:', {
                    offsetWidth: modalContent ? modalContent.offsetWidth : 'N/A',
                    offsetHeight: modalContent ? modalContent.offsetHeight : 'N/A',
                    clientWidth: modalContent ? modalContent.clientWidth : 'N/A',
                    clientHeight: modalContent ? modalContent.clientHeight : 'N/A'
                });
                
                if (contentVisible) {
                    console.log('âœ… SUCCESS: Invoice modal is now visible!');
                } else {
                    console.log('âŒ Still having issues with modal visibility');
                }
            }, 100);
            
            console.log('âœ… Invoice modal created completely from scratch');
            return true;
        }
        
        // Function to populate the new invoice modal with data
        function populateNewInvoiceModal() {
            if (!window.currentInvoiceData) {
                console.log('âŒ No currentInvoiceData available for population');
                return;
            }
            
            console.log('ðŸ”§ Populating new invoice modal with data:', window.currentInvoiceData);
            console.log('ðŸ”§ Available form elements:', {
                clientName: document.getElementById('invoiceClientName'),
                clientPhone: document.getElementById('invoiceClientPhone'),
                clientAddress: document.getElementById('invoiceClientAddress'),
                clientEmail: document.getElementById('invoiceClientEmail'),
                invoiceDate: document.getElementById('invoiceDate')
            });
            
            // Get the original quote data from the totals
            const originalTotals = window.currentInvoiceData.originalQuoteTotals;
            if (!originalTotals) {
                console.log('No original quote totals available');
                return;
            }
            
            // Pre-fill client information
            const clientNameEl = document.getElementById('invoiceClientName');
            const clientPhoneEl = document.getElementById('invoiceClientPhone');
            const clientAddressEl = document.getElementById('invoiceClientAddress');
            const clientEmailEl = document.getElementById('invoiceClientEmail');
            const invoiceDateEl = document.getElementById('invoiceDate');
            
            console.log('ðŸ”§ Setting form values:', {
                name: window.currentInvoiceData.name,
                phone: window.currentInvoiceData.phone,
                address: window.currentInvoiceData.address,
                email: window.currentInvoiceData.email
            });
            
            if (clientNameEl) {
                clientNameEl.value = window.currentInvoiceData.name || '';
                console.log('ðŸ”§ Set client name to:', clientNameEl.value);
            }
            if (clientPhoneEl) {
                clientPhoneEl.value = window.currentInvoiceData.phone || '';
                console.log('ðŸ”§ Set client phone to:', clientPhoneEl.value);
            }
            if (clientAddressEl) {
                clientAddressEl.value = window.currentInvoiceData.address || '';
                console.log('ðŸ”§ Set client address to:', clientAddressEl.value);
            }
            if (clientEmailEl) {
                clientEmailEl.value = window.currentInvoiceData.email || '';
                console.log('ðŸ”§ Set client email to:', clientEmailEl.value);
            }
            if (invoiceDateEl) {
                invoiceDateEl.value = new Date().toISOString().split('T')[0];
                console.log('ðŸ”§ Set invoice date to:', invoiceDateEl.value);
            }
            
            // Set tax toggle
            const taxToggleEl = document.getElementById('invoiceTaxToggle');
            if (taxToggleEl) taxToggleEl.checked = originalTotals.tax_enabled || false;
            
            // Update totals display
            const subtotalEl = document.getElementById('invoiceSubtotalAmount');
            const taxEl = document.getElementById('invoiceTaxAmount');
            const totalEl = document.getElementById('invoiceGrandTotalAmount');
            const taxRowEl = document.getElementById('invoiceTaxRow');
            
            if (subtotalEl) subtotalEl.textContent = `$${originalTotals.subtotal || 0}.00`;
            if (taxEl) taxEl.textContent = `$${originalTotals.tax_amount || 0}.00`;
            if (totalEl) totalEl.textContent = `$${originalTotals.total_amount || 0}.00`;
            if (taxRowEl) taxRowEl.style.display = originalTotals.tax_enabled ? 'block' : 'none';
            
            // Populate service items if available
            if (window.currentInvoiceData.serviceItems) {
                console.log('ðŸ”§ Populating service items...');
                populateInvoiceServiceItems(window.currentInvoiceData.serviceItems);
            }
            
            console.log('âœ… Invoice modal data populated successfully');
        }

        function openModal(modalId) {
            console.log('ðŸ” openModal called with modalId:', modalId);
            
            // Special handling for invoice modal
            if (modalId === 'invoiceModal') {
                console.log('ðŸ”§ Using special invoice modal handling...');
                return openInvoiceModal();
            }
            
            // Add retry mechanism for modal opening
            let retryCount = 0;
            const maxRetries = 3;
            
            function attemptOpenModal() {
                const modal = document.getElementById(modalId);
                console.log(`ðŸ” Attempt ${retryCount + 1}: Modal element found:`, modal);
                
                if (modal) {
                    try {
                        console.log('ðŸ” Modal found, attempting to show...');
                        
                        // Ensure any manually set display styles are removed so CSS can work
                        if (modal.style.display === 'none') {
                            console.log('ðŸ” Removing display: none style');
                            modal.style.removeProperty('display');
                        }
                        
                        // Force modal to be visible with inline styles
                        modal.style.display = 'flex';
                        modal.style.visibility = 'visible';
                        modal.style.opacity = '1';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100%';
                        modal.style.height = '100%';
                        modal.style.zIndex = '9999';
                        modal.style.alignItems = 'center';
                        modal.style.justifyContent = 'center';
                        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.4)';
                        
                        // Force modal content to be visible
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            // Use flex display for quote-modal-content and quote-preview-content to match CSS
                            const isQuoteModal = modalContent.classList.contains('quote-modal-content');
                            const isPreviewModal = modalContent.classList.contains('quote-preview-content');
                            const shouldUseFlex = isQuoteModal || isPreviewModal;
                            
                            // Clear any existing inline styles that might conflict
                            modalContent.style.cssText = '';
                            
                            // Apply comprehensive styles using cssText for maximum priority
                            modalContent.style.cssText = `
                                display: ${shouldUseFlex ? 'flex' : 'block'} !important;
                                flex-direction: ${shouldUseFlex ? 'column' : 'initial'} !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                position: relative !important;
                                z-index: 10000 !important;
                                background: white !important;
                                border-radius: 8px !important;
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
                                max-height: 90vh !important;
                                overflow-y: auto !important;
                                width: 90% !important;
                                max-width: 800px !important;
                                min-width: 400px !important;
                                margin: auto !important;
                                padding: 0 !important;
                                border: none !important;
                            `;
                            
                            console.log('ðŸ” Forced modal content visibility with cssText approach');
                            console.log('ðŸ” Modal content styles applied:', {
                                display: modalContent.style.display,
                                visibility: modalContent.style.visibility,
                                opacity: modalContent.style.opacity,
                                isQuoteModal: isQuoteModal,
                                isPreviewModal: isPreviewModal,
                                shouldUseFlex: shouldUseFlex,
                                computedDisplay: window.getComputedStyle(modalContent).display
                            });
                        }
                        
                        console.log('ðŸ” Adding show class to modal and resetting inline styles');
                        
                        // Reset any inline styles that might be hiding the modal
                        modal.style.display = '';
                        modal.style.visibility = '';
                        modal.style.opacity = '';
                        modal.style.zIndex = '';
                        
                        modal.classList.add('show');
                        document.body.classList.add('modal-open');
                        
                        // Verify modal is actually visible
                        setTimeout(() => {
                            const isVisible = modal.classList.contains('show') && 
                                            modal.style.display !== 'none' && 
                                            modal.style.visibility !== 'hidden' && 
                                            modal.style.opacity !== '0';
                            
                            // Check if modal content is visible
                            const modalContent = modal.querySelector('.modal-content');
                            const contentVisible = modalContent && 
                                                 modalContent.offsetWidth > 0 && 
                                                 modalContent.offsetHeight > 0;
                            
                            console.log('ðŸ” Modal visibility check:', {
                                hasShowClass: modal.classList.contains('show'),
                                display: modal.style.display,
                                visibility: modal.style.visibility,
                                opacity: modal.style.opacity,
                                isVisible: isVisible,
                                modalContent: modalContent,
                                contentVisible: contentVisible,
                                contentWidth: modalContent ? modalContent.offsetWidth : 'N/A',
                                contentHeight: modalContent ? modalContent.offsetHeight : 'N/A'
                            });
                            
                            if (!isVisible) {
                                console.warn('âš ï¸ Modal may not be visible despite show class');
                            } else if (!contentVisible) {
                                console.warn('âš ï¸ Modal is visible but content is not');
                                
                                // Force content visibility as fallback
                                const modalContent = modal.querySelector('.modal-content');
                                if (modalContent) {
                                    console.log('ðŸ”§ Applying fallback content visibility fixes...');
                                    
                                    // Remove any conflicting styles first
                                    modalContent.style.removeProperty('display');
                                    modalContent.style.removeProperty('visibility');
                                    modalContent.style.removeProperty('opacity');
                                    modalContent.style.removeProperty('position');
                                    modalContent.style.removeProperty('z-index');
                                    modalContent.style.removeProperty('background');
                                    modalContent.style.removeProperty('border-radius');
                                    modalContent.style.removeProperty('box-shadow');
                                    modalContent.style.removeProperty('max-height');
                                    modalContent.style.removeProperty('overflow-y');
                                    modalContent.style.removeProperty('width');
                                    modalContent.style.removeProperty('max-width');
                                    modalContent.style.removeProperty('min-width');
                                    modalContent.style.removeProperty('margin');
                                    modalContent.style.removeProperty('flex-direction');
                                    
                                    // Apply fresh styles
                                    modalContent.style.cssText = `
                                        display: flex !important;
                                        flex-direction: column !important;
                                        visibility: visible !important;
                                        opacity: 1 !important;
                                        position: relative !important;
                                        z-index: 10000 !important;
                                        background: white !important;
                                        border-radius: 8px !important;
                                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
                                        max-height: 90vh !important;
                                        overflow-y: auto !important;
                                        width: 90% !important;
                                        max-width: 800px !important;
                                        min-width: 400px !important;
                                        margin: auto !important;
                                        padding: 0 !important;
                                        border: none !important;
                                    `;
                                    
                                    // Force a reflow and check dimensions
                                    modalContent.offsetHeight;
                                    
                                    console.log('ðŸ”§ Fallback styles applied with cssText, checking again...');
                                    console.log('ðŸ”§ Modal content dimensions:', {
                                        offsetWidth: modalContent.offsetWidth,
                                        offsetHeight: modalContent.offsetHeight,
                                        clientWidth: modalContent.clientWidth,
                                        clientHeight: modalContent.clientHeight,
                                        scrollWidth: modalContent.scrollWidth,
                                        scrollHeight: modalContent.scrollHeight,
                                        computedStyle: window.getComputedStyle(modalContent).display
                                    });
                                    
                                    setTimeout(() => {
                                        const newContentVisible = modalContent && 
                                                               modalContent.offsetWidth > 0 && 
                                                               modalContent.offsetHeight > 0;
                                        console.log('ðŸ”§ After fallback - content visible:', newContentVisible);
                                        
                                        if (!newContentVisible) {
                                            console.log('ðŸ”§ Content still not visible, trying alternative approach...');
                                            
                                            // Try removing and re-adding the modal content
                                            const parent = modalContent.parentNode;
                                            const nextSibling = modalContent.nextSibling;
                                            const clonedContent = modalContent.cloneNode(true);
                                            
                                            parent.removeChild(modalContent);
                                            if (nextSibling) {
                                                parent.insertBefore(clonedContent, nextSibling);
                                            } else {
                                                parent.appendChild(clonedContent);
                                            }
                                            
                                            // Reapply styles to the new element
                                            clonedContent.style.cssText = `
                                                display: flex !important;
                                                flex-direction: column !important;
                                                visibility: visible !important;
                                                opacity: 1 !important;
                                                position: relative !important;
                                                z-index: 10000 !important;
                                                background: white !important;
                                                border-radius: 8px !important;
                                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
                                                max-height: 90vh !important;
                                                overflow-y: auto !important;
                                                width: 90% !important;
                                                max-width: 800px !important;
                                                min-width: 400px !important;
                                                margin: auto !important;
                                                padding: 0 !important;
                                                border: none !important;
                                            `;
                                            
                                            console.log('ðŸ”§ Modal content recreated, final check...');
                                            setTimeout(() => {
                                                const finalVisible = clonedContent && 
                                                                   clonedContent.offsetWidth > 0 && 
                                                                   clonedContent.offsetHeight > 0;
                                                console.log('ðŸ”§ After recreation - content visible:', finalVisible);
                                            }, 100);
                                        }
                                    }, 100);
                                }
                            } else {
                                console.log('âœ… Modal should be visible now');
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('âŒ Error opening modal:', error);
                        showNotification(`Error opening ${modalId}`, 'error');
                    }
                } else {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log(`ðŸ” Modal not found, retrying in 100ms (attempt ${retryCount}/${maxRetries})`);
                        setTimeout(attemptOpenModal, 100);
                    } else {
                        console.error(`âŒ Modal ${modalId} not found after ${maxRetries} attempts`);
                        showNotification(`Modal ${modalId} not found`, 'error');
                    }
                }
            }
            
            attemptOpenModal();
        }

        // Close modal when clicking outside
        function setupModalClickOutside() {
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    // Check if click is on the modal backdrop (not on modal content)
                    if (event.target === modal) {
                        console.log('Clicking outside modal, closing:', modal.id);
                        closeModal(modal.id);
                    }
                });
            });
        }

        // Close modal with Escape key
        function setupModalEscapeKey() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    if (modals.length > 0) {
                        // Close the most recently opened modal (last in the list)
                        const lastModal = modals[modals.length - 1];
                        console.log('Escape key pressed, closing modal:', lastModal.id);
                        closeModal(lastModal.id);
                    }
                }
            });
        }

        // Initialize modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            setupModalClickOutside();
            setupModalEscapeKey();
            

            
            
            
            // Add global error handler for unhandled errors
            window.addEventListener('error', function(event) {
                console.error('ðŸš¨ Global error caught:', event.error);
                console.error('ðŸš¨ Error details:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno
                });
                
                // Show user-friendly error message
                if (event.error && event.error.message) {
                    showNotification(`Error: ${event.error.message}`, 'error');
                }
            });
            
            // Add function to force open quote modal (fallback)
            window.forceOpenQuoteModal = function(bookingData) {
                console.log('ðŸš¨ Force opening quote modal with data:', bookingData);
                try {
                    // Ensure modal exists
                    const modal = document.getElementById('quoteModal');
                    if (!modal) {
                        console.error('âŒ Quote modal still not found, creating fallback...');
                        createFallbackQuoteModal();
                        return;
                    }
                    
                    // Force show modal
                    modal.style.display = 'block';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    

                    
                    // Load data if available
                    if (bookingData) {
                        showQuoteModal(bookingData);
                    }
                    
                } catch (error) {
                    console.error('âŒ Error in force open:', error);
                    showNotification('Error opening quote modal', 'error');
                }
            };
        });
        
                // Create fallback quote modal if original is missing
        function createFallbackQuoteModal() {
            console.log('ðŸ”§ Creating fallback quote modal...');
            
            const fallbackModal = document.createElement('div');
            fallbackModal.id = 'quoteModal';
            fallbackModal.className = 'modal show';
            fallbackModal.innerHTML = `
                <div class="modal-content quote-modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote (Fallback)</h3>
                        <button class="modal-close" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Quote modal loaded in fallback mode. Please refresh the page for full functionality.</p>
                        <button onclick="location.reload()" class="btn-primary">Refresh Page</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(fallbackModal);
            
        }
        
        // Mobile Menu Functionality
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const navLinks = document.querySelector('.nav-links');
        const menuIcon = mobileMenuToggle.querySelector('i');

        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');

            // Toggle icon between bars and times with rotation
            if (navLinks.classList.contains('active')) {
                menuIcon.classList.remove('fa-bars');
                menuIcon.classList.add('fa-times');
                menuIcon.style.transform = 'rotate(180deg)';
            } else {
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking on a link
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Handle window resize for calendar layout
        window.addEventListener('resize', function() {
            if (currentFilter === 'calendar') {
                window.adminCalendar.renderCalendar(allBookings);
            }
        });

        // Auto-refresh every 30 seconds with improved reliability
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated()) {
                loadBookings();
            }
        }, 30000);
        
        // Additional fallback refresh every 60 seconds to ensure data stays fresh
        setInterval(() => {
            if (window.simpleGoogleAuth && window.simpleGoogleAuth.isUserAuthenticated() && (!allBookings || allBookings.length === 0)) {
                loadBookings();
            }
        }, 60000);



        // Quote Generation Variables
        let currentQuoteData = null;
        let itemCounter = 1;
        let currentSiteVisitData = null;

        // Show Site Visit Modal
        function showSiteVisitModal(bookingId) {
            currentSiteVisitData = { bookingId: bookingId };
            
            // Set default date to today
            document.getElementById('recommendedDate').value = new Date().toISOString().split('T')[0];
            
            // Clear form
            document.getElementById('siteVisitForm').reset();
            
            openModal('siteVisitModal');
        }

        // Complete Site Visit Assessment
        async function completeSiteVisit() {
            const form = document.getElementById('siteVisitForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const workDescription = formData.get('workDescription');
            const estimatedCost = parseFloat(formData.get('estimatedCost'));
            const siteVisitNotes = formData.get('siteVisitNotes');
            const recommendedDate = formData.get('recommendedDate');
            const recommendedTime = formData.get('recommendedTime');

            try {
                // Update booking status to 'quote-ready'
                const statusResponse = await fetch(`/api/bookings/${currentSiteVisitData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        status: 'quote-ready',
                        work_description: workDescription,
                        estimated_cost: estimatedCost,
                        site_visit_notes: siteVisitNotes,
                        recommended_date: recommendedDate,
                        recommended_time: recommendedTime
                    })
                });

                if (!statusResponse.ok) {
                    const error = await statusResponse.json();
                    showNotification(error.error || 'Failed to update booking status', 'error');
                    return;
                }

                // Send quote ready email to customer
                const booking = allBookings.find(b => b.booking_id === currentSiteVisitData.bookingId);
                if (booking) {
                    const emailResponse = await fetch(`/api/bookings/${currentSiteVisitData.bookingId}/send-quote-ready-email`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            bookingId: currentSiteVisitData.bookingId,
                            customerEmail: booking.email,
                            customerName: booking.name,
                            workDescription: workDescription,
                            estimatedCost: estimatedCost
                        })
                    });

                    if (emailResponse.ok) {
                        showNotification('Site visit completed and quote ready email sent successfully!', 'success');
                    } else {
                        showNotification('Site visit completed but email failed to send', 'warning');
                    }
                }

                closeModal('siteVisitModal');
                loadBookings(); // Reload to update the display
                
            } catch (error) {
                console.error('Error completing site visit:', error);
                showNotification('Network error completing site visit', 'error');
            }
        }
        // Show Quote Modal with Retry
        async function showQuoteModalWithRetry(booking) {
            // Add loading state to the quote button
            const quoteButton = event?.target?.closest('.action-btn.quote');
            if (quoteButton) {
                quoteButton.classList.add('loading');
                quoteButton.disabled = true;
            }
            
            let retryCount = 0;
            const maxRetries = 3;
            
            async function attemptShowModal() {
                try {
                    await showQuoteModal(booking);
                    
                    // Remove loading state
                    if (quoteButton) {
                        quoteButton.classList.remove('loading');
                        quoteButton.disabled = false;
                    }
                    
                } catch (error) {
                    retryCount++;
                    console.warn(`Attempt ${retryCount} failed:`, error);
                    
                    if (retryCount < maxRetries) {
                        setTimeout(attemptShowModal, 200);
                    } else {
                        console.error(`All ${maxRetries} attempts failed, using fallback`);
                        showNotification('Quote modal failed to open, using fallback', 'warning');
                        
                        // Remove loading state
                        if (quoteButton) {
                            quoteButton.classList.remove('loading');
                            quoteButton.disabled = false;
                        }
                        
                        // Use fallback method
                        if (window.forceOpenQuoteModal) {
                            window.forceOpenQuoteModal(booking);
                        } else {
                            // Last resort: reload page
                            showNotification('Reloading page to fix modal issue', 'info');
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                }
            }
            
            attemptShowModal();
        }

        // Show Quote Modal
        async function showQuoteModal(booking) {
            try {
                // If booking is passed as a string (from onclick), parse it
                if (typeof booking === 'string') {
                    try {
                        booking = JSON.parse(booking);
                    } catch (e) {
                        console.error('Error parsing booking data:', e);
                        showNotification('Error loading booking data', 'error');
                        return;
                    }
                }

                // Validate booking object
                if (!booking || !booking.booking_id) {
                    console.error('Invalid booking object:', booking);
                    showNotification('Invalid booking data', 'error');
                    return;
                }

                // Ensure modal elements are available
                const quoteModal = document.getElementById('quoteModal');
                const modalServiceContainer = document.querySelector('.service-items-container');
                
                if (!quoteModal) {
                    console.error('Quote modal not found in DOM');
                    showNotification('Quote modal not found', 'error');
                    return;
                }
                
                if (!modalServiceContainer) {
                    console.error('Service items container not found in DOM');
                    showNotification('Service items container not found', 'error');
                    return;
                }

                // Clear cached data only if switching to a different booking
                if (currentQuoteData && currentQuoteData.bookingId !== booking.booking_id) {
                    clearCachedDataForBooking(booking.booking_id);
                }

                // Ensure complete isolation by clearing service items container first
                const quoteServiceContainer = document.querySelector('.service-items-container');
                if (quoteServiceContainer) {
                    quoteServiceContainer.innerHTML = '';
                }
                
                // Reset item counter to ensure clean state
                itemCounter = 0;
                
                // Clear any potential cross-contamination from quick quotes/invoices
                clearQuickQuoteInvoiceData();

                currentQuoteData = {
                    bookingId: booking.booking_id,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes
                };

                // Check if there's an existing quote for this booking
                try {
                    const quoteResponse = await fetch(`/api/quotes/booking/${booking.booking_id}`, {
                        headers: getAuthHeaders()
                    });
                    if (quoteResponse.ok) {
                        const quotes = await quoteResponse.json();
                        if (quotes.length > 0) {
                            // Use the most recent quote
                            const existingQuote = quotes[0];
                            loadExistingQuote(existingQuote);
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking for existing quotes:', error);
                    // Continue with creating new quote even if check fails
                }

                // No existing quote found, create new one
                loadNewQuote(booking);
                
            } catch (error) {
                console.error('âŒ Unexpected error in showQuoteModal:', error);
                showNotification('Unexpected error opening quote modal', 'error');
            }
        }

        // Load existing quote data
        function loadExistingQuote(quote) {
            try {
                // Reset item counter when opening quote modal
                itemCounter = 0;
                
                // Clear any potential cross-contamination from quick quotes/invoices
                clearQuickQuoteInvoiceData();
                
                // Store the quote ID for updates
                currentQuoteData.quoteId = quote.quote_id;

                // Pre-fill client information from saved quote
                const nameField = document.getElementById('quoteClientName');
                const phoneField = document.getElementById('quoteClientPhone');
                const addressField = document.getElementById('quoteClientAddress');
                const emailField = document.getElementById('quoteClientEmail');
                const dateField = document.getElementById('quoteDate');
                
                if (nameField) nameField.value = quote.client_name || '';
                if (phoneField) phoneField.value = quote.client_phone || '';
                if (addressField) addressField.value = quote.client_address || '';
                if (emailField) emailField.value = quote.client_email || '';
                if (dateField) dateField.value = quote.quote_date || new Date().toISOString().split('T')[0];

                // Load service items from saved quote
                // Handle both string and object formats
                let serviceItems;
                
                if (typeof quote.service_items === 'string') {
                    try {
                        serviceItems = JSON.parse(quote.service_items);
                    } catch (e) {
                        console.error('Error parsing service items:', e);
                        serviceItems = [];
                    }
                } else {
                    serviceItems = quote.service_items || [];
                }
                
                loadServiceItems(serviceItems);

                // Set tax toggle
                const taxToggle = document.getElementById('taxToggle');
                if (taxToggle) {
                    taxToggle.checked = quote.tax_enabled || false;
                }

                // Update totals
                updateQuoteTotals();

                // Setup event listeners for all service items
                document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

                // Load booking restrictions if they exist
                if (quote.booking_restrictions) {
                    loadBookingRestrictions(quote.booking_restrictions);
                }

                // Show modal
                openModal('quoteModal');
                
                // Load photos for service items if this is an existing quote
                if (currentQuoteData && currentQuoteData.quoteId) {
                    setTimeout(() => loadQuotePhotos(), 100);
                }
                
            } catch (error) {
                console.error('Error in loadExistingQuote:', error);
                showNotification('Error loading existing quote', 'error');
            }
        }

        // Load new quote (no existing data)
        function loadNewQuote(booking) {
            try {
                // Clear any previous form data and totals first
                clearFormFields();
                
                // Reset item counter when opening quote modal
                itemCounter = 0;
                
                // Clear any potential cross-contamination from quick quotes/invoices
                clearQuickQuoteInvoiceData();
                
                // Set current quote data with booking information
                currentQuoteData = {
                    bookingId: booking.booking_id,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes
                };
                
                // Pre-fill client information from booking
                const nameField = document.getElementById('quoteClientName');
                const phoneField = document.getElementById('quoteClientPhone');
                const addressField = document.getElementById('quoteClientAddress');
                const emailField = document.getElementById('quoteClientEmail');
                const dateField = document.getElementById('quoteDate');
                
                if (nameField) nameField.value = booking.name || '';
                if (phoneField) phoneField.value = booking.phone || '';
                if (addressField) addressField.value = booking.address || '';
                if (emailField) emailField.value = booking.email || '';
                if (dateField) dateField.value = new Date().toISOString().split('T')[0];

                // Create initial service item with booking service
                const initialServiceItem = {
                    description: booking.service || 'Tree Service',
                    quantity: 1,
                    price: 0,
                    total: 0
                };

                // Load service items (this will clear container and recreate)
                loadServiceItems([initialServiceItem]);

                // Reset tax toggle
                const taxToggle = document.getElementById('taxToggle');
                if (taxToggle) {
                    taxToggle.checked = false;
                }
                
                // Initialize booking restrictions with defaults
                loadBookingRestrictions({
                    allowed_days: 'weekends',
                    custom_dates: [],
                    job_duration_days: 1
                });
                
                // Update totals to reflect the new service items (should show $0.00)
                updateQuoteTotals();

                // Show modal
                openModal('quoteModal');
                
                // Load photos for service items if this is an existing quote
                if (currentQuoteData && currentQuoteData.quoteId) {
                    setTimeout(() => loadQuotePhotos(), 100);
                }
                
            } catch (error) {
                console.error('Error in loadNewQuote:', error);
                showNotification('Error loading new quote', 'error');
            }
        }

        // Load service items from saved quote
        function loadServiceItems(serviceItems) {
            const container = document.querySelector('.service-items-container');
            
            // Validate that we're operating on the correct container
            if (!container) {
                console.error('Service items container not found - this should be the regular quote container');
                return;
            }
            
            // Clear existing items completely
            container.innerHTML = '';

            console.log('Loading service items:', serviceItems);
            console.log('Service items count:', serviceItems.length);
            console.log('Current itemCounter before loading:', itemCounter);

            if (serviceItems.length === 0) {
                // Add one empty item if no items exist
                addServiceItem();
                return;
            }

            // Reset item counter to start fresh
            itemCounter = 0;

            // Load each service item
            serviceItems.forEach((item, index) => {
                itemCounter++;
                console.log(`Loading service item ${index + 1}:`, item);
                
                const newItem = document.createElement('div');
                newItem.className = 'service-item';
                newItem.setAttribute('data-item-id', itemCounter);

                // Calculate the item total
                const quantity = parseFloat(item.quantity) || 1;
                const price = parseFloat(item.price) || 0;
                const itemTotal = quantity * price;

                console.log(`Item ${index + 1} calculation: ${quantity} x $${price} = $${itemTotal}`);

                newItem.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description || ''}" placeholder="Service description">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${quantity}" min="1">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${price}" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${itemTotal.toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                                        <div class="item-photos-section">
                        <div class="photo-upload-area" onclick="triggerPhotoUpload(this)">
                            <div class="photo-upload-content">
                                <i class="fas fa-file-image"></i>
                                <span class="photo-upload-text">Photos: Add Photo</span>
                            </div>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                    </div>
                `;

                container.appendChild(newItem);
                setupItemEventListeners(newItem);
            });

            console.log('Final itemCounter after loading:', itemCounter);
            console.log('Total service items in DOM:', container.querySelectorAll('.service-item').length);

            // Force update totals after loading all items
            setTimeout(() => {
                console.log('Forcing update of quote totals...');
                updateQuoteTotals();
                
                // Verify the totals are correct
                const finalSubtotal = document.getElementById('subtotalAmount').textContent;
                const finalTotal = document.getElementById('grandTotalAmount').textContent;
                console.log('Final totals after loading:', { subtotal: finalSubtotal, total: finalTotal });
            }, 100);
        }

        // Add Service Item
        function addServiceItem() {
            console.log('addServiceItem called, current itemCounter:', itemCounter);
            itemCounter++;
            const container = document.querySelector('.service-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)" aria-label="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photo-upload-area" onclick="triggerPhotoUpload(this)">
                        <div class="photo-upload-content">
                            <i class="fas fa-file-image"></i>
                            <span class="photo-upload-text">Photos: Add Photo</span>
                        </div>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                </div>
            `;

            container.appendChild(newItem);
            setupItemEventListeners(newItem);
        }

        // Remove Service Item
        function removeServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('.service-item').length > 1) {
                serviceItem.remove();
                updateQuoteTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Service Items
        function setupItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateItemTotal);
            priceInput.removeEventListener('input', updateItemTotal);

            qtyInput.addEventListener('input', updateItemTotal);
            priceInput.addEventListener('input', updateItemTotal);

            function updateItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateQuoteTotals();
            }

            // Initialize the total for this item
            updateItemTotal();
        }

        // Update Quote Totals
        function updateQuoteTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('.service-item');

            items.forEach((item, index) => {
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const itemTotal = qty * price;
                
                subtotal += itemTotal;
            });

            const taxToggle = document.getElementById('taxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            // Format numbers with proper decimal places
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Tax
        function toggleTax() {
            updateQuoteTotals();
        }

        // Service Item Photo Management Functions
        
        // Trigger photo upload when clicking the upload area
        function triggerPhotoUpload(uploadArea) {
            const serviceItem = uploadArea.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }
        
        // Trigger photo upload for quick quotes
        function triggerQuickQuotePhotoUpload(uploadArea) {
            const serviceItem = uploadArea.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }
        
        // Trigger photo upload for quick invoices
        function triggerQuickInvoicePhotoUpload(uploadArea) {
            const serviceItem = uploadArea.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }
        
        // Add photo button click handler for regular quotes/invoices
        function addPhotoToServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }

        // Add photo button click handler for quick quotes
        function addPhotoToQuickQuoteServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }

        // Add photo button click handler for quick invoices
        function addPhotoToQuickInvoiceServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            const fileInput = serviceItem.querySelector('.photo-upload-input');
            fileInput.click();
        }

        // Handle photo upload - Store files temporarily, don't upload to server yet
        function handlePhotoUpload(fileInput) {
            const serviceItem = fileInput.closest('.service-item');
            const files = fileInput.files;
            
            if (!files || files.length === 0) return;
            
            // Store files temporarily in the service item
            const tempPhotos = Array.from(files).map(file => ({
                file: file,
                preview: URL.createObjectURL(file),
                name: file.name
            }));
            
            // Store temp photos in the service item data
            if (!serviceItem.tempPhotos) {
                serviceItem.tempPhotos = [];
            }
            serviceItem.tempPhotos.push(...tempPhotos);
            
            // Display temp photos
            displayTempPhotos(serviceItem);
            
            // Clear the file input
            fileInput.value = '';
            
            showNotification(`${tempPhotos.length} photos added (will be saved with quote)`, 'info');
        }

        // Handle photo upload for quick quotes
        function handleQuickQuotePhotoUpload(fileInput) {
            const serviceItem = fileInput.closest('.service-item');
            const files = fileInput.files;
            
            if (!files || files.length === 0) return;
            
            // Store files temporarily in the service item
            const tempPhotos = Array.from(files).map(file => ({
                file: file,
                preview: URL.createObjectURL(file),
                name: file.name
            }));
            
            // Store temp photos in the service item data
            if (!serviceItem.tempPhotos) {
                serviceItem.tempPhotos = [];
            }
            serviceItem.tempPhotos.push(...tempPhotos);
            
            // Display temp photos
            displayTempPhotos(serviceItem);
            
            // Clear the file input
            fileInput.value = '';
            
            showNotification(`${tempPhotos.length} photos added to quick quote`, 'info');
        }

        // Handle photo upload for quick invoices
        function handleQuickInvoicePhotoUpload(fileInput) {
            const serviceItem = fileInput.closest('.service-item');
            const files = fileInput.files;
            
            if (!files || files.length === 0) return;
            
            // Store files temporarily in the service item
            const tempPhotos = Array.from(files).map(file => ({
                file: file,
                preview: URL.createObjectURL(file),
                name: file.name
            }));
            
            // Store temp photos in the service item data
            if (!serviceItem.tempPhotos) {
                serviceItem.tempPhotos = [];
            }
            serviceItem.tempPhotos.push(...tempPhotos);
            
            // Display temp photos
            displayTempPhotos(serviceItem);
            
            // Clear the file input
            fileInput.value = '';
            
            showNotification(`${tempPhotos.length} photos added to quick invoice`, 'info');
        }

        // Display temporary photos (not yet uploaded) - preserves existing saved photos
        function displayTempPhotos(serviceItem) {
            const photosContainer = serviceItem.querySelector('.photos-container');
            
            // Don't clear the container - preserve existing saved photos
            // Just add the new temp photos at the end
            
            if (!serviceItem.tempPhotos || serviceItem.tempPhotos.length === 0) {
                // If no temp photos, don't change anything
                return;
            }

            // Add temp photos to the existing container
            serviceItem.tempPhotos.forEach((tempPhoto, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item temp-photo';
                photoElement.innerHTML = `
                    <img src="${tempPhoto.preview}" alt="Service item photo" onclick="showPhotoModal('${tempPhoto.preview}')">
                    <button type="button" class="delete-photo-btn" onclick="removeTempPhoto(${index}, this)">
                        ðŸ—‘ï¸
                    </button>
                    <div class="temp-photo-label">Pending</div>
                `;
                photosContainer.appendChild(photoElement);
            });
        }

        // Remove temporary photo
        function removeTempPhoto(index, button) {
            const serviceItem = button.closest('.service-item');
            const photoElement = button.closest('.photo-item');
            
            // Revoke object URL to free memory
            const img = photoElement.querySelector('img');
            if (img && img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }
            
            // Remove from temp photos array
            serviceItem.tempPhotos.splice(index, 1);
            
            // Remove just this temp photo element from DOM
            photoElement.remove();
            
            // If no temp photos left and no saved photos, show "no photos" message
            const photosContainer = serviceItem.querySelector('.photos-container');
            const tempPhotos = photosContainer.querySelectorAll('.temp-photo');
            const savedPhotos = photosContainer.querySelectorAll('.photo-item:not(.temp-photo)');
            
            if (tempPhotos.length === 0 && savedPhotos.length === 0) {
                photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
            }
        }

        // Load photos for a service item
        async function loadServiceItemPhotos(serviceItem, quoteId, itemId) {
            try {
                const response = await fetch(`/api/service-item-photos/${quoteId}/${itemId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayServiceItemPhotos(serviceItem, result.photos, quoteId, itemId);
                }
            } catch (error) {
                console.error('Error loading photos:', error);
            }
        }

        // Display photos for a service item - preserves existing temp photos
        function displayServiceItemPhotos(serviceItem, photos, quoteId, itemId) {
            const photosContainer = serviceItem.querySelector('.photos-container');
            
            // Store any existing temp photos
            const existingTempPhotos = photosContainer.querySelectorAll('.temp-photo');
            const tempPhotosHTML = Array.from(existingTempPhotos).map(el => el.outerHTML);
            
            // Clear container and reload saved photos
            photosContainer.innerHTML = '';

            if (photos.length === 0 && tempPhotosHTML.length === 0) {
                photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
                return;
            }

            // Display saved photos first
            photos.forEach((photoPath, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item';
                photoElement.innerHTML = `
                    <img src="${photoPath}" alt="Service item photo" onclick="showPhotoModal('${photoPath}')">
                    <button type="button" class="delete-photo-btn" onclick="deleteServiceItemPhoto('${quoteId}', '${itemId}', '${photoPath.split('/').pop()}', this)">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                photosContainer.appendChild(photoElement);
            });
            
            // Restore temp photos after saved photos
            tempPhotosHTML.forEach(html => {
                photosContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // Delete a photo from a service item
        async function deleteServiceItemPhoto(quoteId, itemId, imageId, button) {
            try {
                console.log(`Deleting photo: quoteId=${quoteId}, itemId=${itemId}, imageId=${imageId}`);
                
                const response = await fetch(`/api/service-item-photos/${quoteId}/${itemId}/${imageId}`, {
                    method: 'DELETE'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                // Check if response is ok and has success property
                if (response.ok && result.success) {
                    showNotification('Photo deleted successfully!', 'success');
                    // Remove the photo element from DOM
                    button.closest('.photo-item').remove();
                    
                    // If no photos left (saved or temp), show "no photos" message
                    const photosContainer = button.closest('.photos-container');
                    const remainingPhotos = photosContainer.querySelectorAll('.photo-item');
                    if (remainingPhotos.length === 0) {
                        photosContainer.innerHTML = '<span class="no-photos">No photos added yet</span>';
                    }
                } else if (response.ok && !result.success) {
                    // Server returned success but result.success is false
                    showNotification('Failed to delete photo: ' + (result.error || 'Unknown error'), 'error');
                } else {
                    // HTTP error status
                    showNotification('Failed to delete photo: HTTP ' + response.status, 'error');
                }
            } catch (error) {
                // console.error('Error deleting photo:', error);
                // showNotification('Error deleting photo. Please try again.', 'error');
            }
        }

        // Load photos when quote modal is opened
        async function loadQuotePhotos() {
            if (!currentQuoteData || !currentQuoteData.quoteId) return;
            
            const serviceItems = document.querySelectorAll('.service-item');
            serviceItems.forEach(async (item) => {
                const itemId = item.getAttribute('data-item-id');
                await loadServiceItemPhotos(item, currentQuoteData.quoteId, itemId);
            });
        }

        // Load photos when invoice modal is opened
        async function loadInvoicePhotos(quoteId) {
            if (!quoteId) return;
            
            const serviceItems = document.querySelectorAll('#invoiceServiceItems .service-item');
            serviceItems.forEach(async (item) => {
                const itemId = item.getAttribute('data-item-id');
                await loadServiceItemPhotos(item, quoteId, itemId);
            });
        }
        // Upload temporary photos to server
        async function uploadTemporaryPhotos() {
            if (!currentQuoteData || !currentQuoteData.quoteId) {
                console.log('No quote ID, skipping photo upload');
                return;
            }

            const serviceItems = document.querySelectorAll('.service-item');
            let hasPhotos = false;

            for (const serviceItem of serviceItems) {
                if (serviceItem.tempPhotos && serviceItem.tempPhotos.length > 0) {
                    hasPhotos = true;
                    const itemId = serviceItem.getAttribute('data-item-id');
                    const itemIndex = Array.from(serviceItem.parentNode.children).indexOf(serviceItem);
                    
                    // Create FormData for upload
                    const formData = new FormData();
                    serviceItem.tempPhotos.forEach(tempPhoto => {
                        formData.append('photos', tempPhoto.file);
                    });
                    formData.append('itemIndex', itemIndex);

                    try {
                        console.log(`Uploading ${serviceItem.tempPhotos.length} photos for item ${itemId}`);
                        
                        const response = await fetch(`/api/service-item-photos/${currentQuoteData.quoteId}/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
            
                            // Clear temp photos after successful upload
                            serviceItem.tempPhotos = [];
                            // Load the actual photos from server
                            await loadServiceItemPhotos(serviceItem, currentQuoteData.quoteId, itemId);
                        } else {
                            throw new Error(result.error || 'Failed to upload photos');
                        }
                    } catch (error) {
                        console.error(`âŒ Error uploading photos for item ${itemId}:`, error);
                        throw error;
                    }
                }
            }

            if (hasPhotos) {
                showNotification('Photos uploaded successfully!', 'success');
            }
        }

        // Upload temporary photos for invoice
        async function uploadInvoiceTemporaryPhotos() {
            if (!currentInvoiceData || !currentInvoiceData.quoteId) {
                console.log('No quote ID for invoice, skipping photo upload');
                return;
            }

            const serviceItems = document.querySelectorAll('#invoiceServiceItems .service-item');
            let hasPhotos = false;

            for (const serviceItem of serviceItems) {
                if (serviceItem.tempPhotos && serviceItem.tempPhotos.length > 0) {
                    hasPhotos = true;
                    const itemId = serviceItem.getAttribute('data-item-id');
                    const itemIndex = Array.from(serviceItem.parentNode.children).indexOf(serviceItem);
                    
                    // Create FormData for upload
                    const formData = new FormData();
                    serviceItem.tempPhotos.forEach(tempPhoto => {
                        formData.append('photos', tempPhoto.file);
                    });
                    formData.append('itemIndex', itemIndex);

                    try {
                        console.log(`Uploading ${serviceItem.tempPhotos.length} photos for invoice item ${itemId}`);
                        
                        const response = await fetch(`/api/service-item-photos/${currentInvoiceData.quoteId}/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
            
                            // Clear temp photos after successful upload
                            serviceItem.tempPhotos = [];
                            // Load the actual photos from server
                            await loadServiceItemPhotos(serviceItem, currentInvoiceData.quoteId, itemId);
                        } else {
                            throw new Error(result.error || 'Failed to upload photos');
                        }
                    } catch (error) {
                        console.error(`âŒ Error uploading photos for invoice item ${itemId}:`, error);
                        throw error;
                    }
                }
            }

            if (hasPhotos) {
                showNotification('Invoice photos uploaded successfully!', 'success');
            }
        }

        // Show photo in modal
        function showPhotoModal(photoPath) {
            const modalPhoto = document.getElementById('modalPhoto');
            if (modalPhoto) {
                modalPhoto.src = photoPath;
                openModal('photoModal');
            }
        }

        // Setup initial event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners for existing service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Setup event listeners for form inputs
            document.querySelectorAll('.item-qty-input, .item-price-input').forEach(input => {
                input.addEventListener('input', updateQuoteTotals);
            });
        });

        // Save Quote to Database
        async function generateQuote() {
            // Validate form
            const requiredFields = ['quoteClientName', 'quoteClientPhone', 'quoteClientAddress', 'quoteClientEmail', 'quoteDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Ensure we have current booking context
            if (!currentQuoteData || !currentQuoteData.bookingId) {
                showNotification('No booking selected. Please open the quote from a booking.', 'error');
                console.error('generateQuote called without currentQuoteData or bookingId', currentQuoteData);
                return;
            }

            // Photos will be uploaded after the quote is saved and we have a quote ID

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('.service-item');
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Save all items with a description, even if price is 0
                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Save quote to database
            saveQuote(serviceItems);
        }

        // Save Quote to Database
        async function saveQuote(serviceItems) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            // Guard against missing booking context
            if (!currentQuoteData || !currentQuoteData.bookingId) {
                showNotification('Cannot save quote: missing booking context. Please reopen the quote from the booking.', 'error');
                console.error('saveQuote called without currentQuoteData or bookingId', currentQuoteData);
                return;
            }

            // Get booking restrictions data
            const allowedDays = document.getElementById('allowedDays').value;
            const jobDurationDays = parseInt(document.getElementById('jobDurationDays').value) || 1;
            const customDates = selectedCustomDates.map(dateObj => dateObj.date);

            const quoteData = {
                booking_id: currentQuoteData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                quote_date: quoteDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled,
                booking_restrictions: {
                    allowed_days: allowedDays,
                    custom_dates: customDates,
                    job_duration_days: jobDurationDays
                }
            };

            try {
                // If we have an existing quote ID, update it; otherwise create new
                const method = currentQuoteData && currentQuoteData.quoteId ? 'PUT' : 'POST';
                const url = currentQuoteData && currentQuoteData.quoteId ? `/api/quotes/${currentQuoteData.quoteId}` : '/api/quotes';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Quote saved successfully!', 'success');
                    
                    // Store the quote ID for later use (guard against race conditions)
                    if (!currentQuoteData) {
                        currentQuoteData = { bookingId: quoteData.booking_id };
                    }
                    currentQuoteData.quoteId = result.quote_id || currentQuoteData.quoteId;
                    
                    // Now upload any temporary photos since we have a quote ID
                    try {
                        await uploadTemporaryPhotos();
                    } catch (error) {
                        console.error('Error uploading photos after quote save:', error);
                        showNotification('Quote saved but photos failed to upload. Please try uploading photos again.', 'warning');
                    }
                    
                    // Generate quote preview
                    generateQuotePreview(serviceItems, result.quote_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save quote', 'error');
                }
            } catch (error) {
                console.error('Error saving quote:', error);
                showNotification('Network error saving quote', 'error');
            }
        }

        // Quick Quote Functions
        function showQuickQuoteModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quickQuoteDate').value = today;
            
            // Clear form fields
            document.getElementById('quickQuoteClientName').value = '';
            document.getElementById('quickQuoteClientPhone').value = '';
            document.getElementById('quickQuoteClientAddress').value = '';
            document.getElementById('quickQuoteClientEmail').value = '';
            
            // Reset service items
            resetQuickQuoteServiceItems();
            
            // Reset tax toggle
            document.getElementById('quickQuoteTaxToggle').checked = false;
            
            // Update totals
            updateQuickQuoteTotals();
            
            // Show modal
            openModal('quickQuoteModal');
        }

        function showQuickInvoiceModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quickInvoiceDate').value = today;
            
            // Clear form fields
            document.getElementById('quickInvoiceClientName').value = '';
            document.getElementById('quickInvoiceClientPhone').value = '';
            document.getElementById('quickInvoiceClientAddress').value = '';
            document.getElementById('quickInvoiceClientEmail').value = '';
            
            // Reset service items
            resetQuickInvoiceServiceItems();
            
            // Reset tax toggle
            document.getElementById('quickInvoiceTaxToggle').checked = false;
            
            // Update totals
            updateQuickInvoiceTotals();
            
            // Show modal
            openModal('quickInvoiceModal');
        }

        function resetQuickQuoteServiceItems() {
            const container = document.getElementById('quickQuoteServiceItems');
            container.innerHTML = `
                <div class="service-item" data-item-id="1">
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$0.00</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeQuickQuoteServiceItem(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-photos-section">
                        <div class="photo-upload-area" onclick="triggerQuickQuotePhotoUpload(this)">
                            <div class="photo-upload-content">
                                <i class="fas fa-file-image"></i>
                                <span class="photo-upload-text">Photos: Add Photo</span>
                            </div>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickQuotePhotoUpload(this)">
                    </div>
                </div>
            `;
            
            // Setup event listeners for the new service item
            setupQuickQuoteServiceItemListeners();
        }

        function resetQuickInvoiceServiceItems() {
            const container = document.getElementById('quickInvoiceServiceItems');
            container.innerHTML = `
                <div class="service-item" data-item-id="1">
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$0.00</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeQuickInvoiceServiceItem(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-photos-section">
                        <div class="photo-upload-area" onclick="triggerQuickInvoicePhotoUpload(this)">
                            <div class="photo-upload-content">
                                <i class="fas fa-file-image"></i>
                                <span class="photo-upload-text">Photos: Add Photo</span>
                            </div>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickInvoicePhotoUpload(this)">
                    </div>
                </div>
            `;
            
            // Setup event listeners for the new service item
            setupQuickInvoiceServiceItemListeners();
        }

        function addQuickQuoteServiceItem() {
            const container = document.getElementById('quickQuoteServiceItems');
            const itemCount = container.children.length + 1;
            
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.dataset.itemId = itemCount;
            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeQuickQuoteServiceItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photo-upload-area" onclick="triggerQuickQuotePhotoUpload(this)">
                        <div class="photo-upload-content">
                            <i class="fas fa-file-image"></i>
                            <span class="photo-upload-text">Photos: Add Photo</span>
                        </div>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickQuotePhotoUpload(this)">
                </div>
            `;
            
            container.appendChild(newItem);
            setupQuickQuoteServiceItemListeners();
        }

        function addQuickInvoiceServiceItem() {
            const container = document.getElementById('quickInvoiceServiceItems');
            const itemCount = container.children.length + 1;
            
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.dataset.itemId = itemCount;
            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeQuickInvoiceServiceItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photo-upload-area" onclick="triggerQuickInvoicePhotoUpload(this)">
                        <div class="photo-upload-content">
                            <i class="fas fa-file-image"></i>
                            <span class="photo-upload-text">Photos: Add Photo</span>
                        </div>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickInvoicePhotoUpload(this)">
                </div>
            `;
            
            container.appendChild(newItem);
            setupQuickInvoiceServiceItemListeners();
        }

        function removeQuickQuoteServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (serviceItem) {
                serviceItem.remove();
                updateQuickQuoteTotals();
            }
        }

        function removeQuickInvoiceServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (serviceItem) {
                serviceItem.remove();
                updateQuickInvoiceTotals();
            }
        }

        function setupQuickQuoteServiceItemListeners() {
            const container = document.getElementById('quickQuoteServiceItems');
            const inputs = container.querySelectorAll('.item-desc-input, .item-qty-input, .item-price-input');
            
            inputs.forEach(input => {
                input.addEventListener('input', updateQuickQuoteTotals);
            });
        }

        function setupQuickInvoiceServiceItemListeners() {
            const container = document.getElementById('quickInvoiceServiceItems');
            const inputs = container.querySelectorAll('.item-desc-input, .item-qty-input, .item-price-input');
            
            inputs.forEach(input => {
                input.addEventListener('input', updateQuickInvoiceTotals);
            });
        }

        function toggleQuickQuoteTax() {
            updateQuickQuoteTotals();
        }

        function toggleQuickInvoiceTax() {
            updateQuickInvoiceTotals();
        }

        function updateQuickQuoteTotals() {
            const container = document.getElementById('quickQuoteServiceItems');
            const serviceItems = [];
            
            container.querySelectorAll('.service-item').forEach(item => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Update the individual item total display
                const totalSpan = item.querySelector('.item-total-amount');
                if (totalSpan) {
                    totalSpan.textContent = `$${total.toFixed(2)}`;
                }

                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const taxEnabled = document.getElementById('quickQuoteTaxToggle').checked;
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            document.getElementById('quickQuoteSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('quickQuoteTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('quickQuoteGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('quickQuoteTaxRow');
            taxRow.style.display = taxEnabled ? 'flex' : 'none';
        }

        function updateQuickInvoiceTotals() {
            const container = document.getElementById('quickInvoiceServiceItems');
            const serviceItems = [];
            
            container.querySelectorAll('.service-item').forEach(item => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Update the individual item total display
                const totalSpan = item.querySelector('.item-total-amount');
                if (totalSpan) {
                    totalSpan.textContent = `$${total.toFixed(2)}`;
                }

                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const taxEnabled = document.getElementById('quickInvoiceTaxToggle').checked;
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            document.getElementById('quickInvoiceSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('quickInvoiceTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('quickInvoiceGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('quickInvoiceTaxRow');
            taxRow.style.display = taxEnabled ? 'flex' : 'none';
        }

        function generateQuickQuote() {
            // Validate required fields
            const clientName = document.getElementById('quickQuoteClientName').value.trim();
            if (!clientName) {
                showNotification('Client name is required', 'error');
                document.getElementById('quickQuoteClientName').focus();
                return;
            }

            // Collect service items
            const container = document.getElementById('quickQuoteServiceItems');
            const serviceItems = [];
            
            container.querySelectorAll('.service-item').forEach(item => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Update the individual item total display
                const totalSpan = item.querySelector('.item-total-amount');
                if (totalSpan) {
                    totalSpan.textContent = `$${total.toFixed(2)}`;
                }

                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Generate quote preview
            generateQuickQuotePreview(serviceItems);
        }

        function generateQuickInvoice() {
            // Validate required fields
            const clientName = document.getElementById('quickInvoiceClientName').value.trim();
            if (!clientName) {
                showNotification('Client name is required', 'error');
                document.getElementById('quickInvoiceClientName').focus();
                return;
            }

            // Collect service items
            const container = document.getElementById('quickInvoiceServiceItems');
            const serviceItems = [];
            
            container.querySelectorAll('.service-item').forEach(item => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Update the individual item total display
                const totalSpan = item.querySelector('.item-total-amount');
                if (totalSpan) {
                    totalSpan.textContent = `$${total.toFixed(2)}`;
                }

                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Generate invoice preview
            generateQuickInvoicePreview(serviceItems);
        }
        function generateQuickQuotePreview(serviceItems) {
            console.log('ðŸŽ¯ generateQuickQuotePreview called with:', { serviceItems });
            const clientName = document.getElementById('quickQuoteClientName').value;
            const clientPhone = document.getElementById('quickQuoteClientPhone').value || 'N/A';
            const clientAddress = document.getElementById('quickQuoteClientAddress').value || 'N/A';
            const clientEmail = document.getElementById('quickQuoteClientEmail').value || 'N/A';
            const quoteDate = document.getElementById('quickQuoteDate').value;
            const taxEnabled = document.getElementById('quickQuoteTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteNumber = generateQuoteNumber();
            const formattedDate = new Date(quoteDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const quoteHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>1932 9a Ave NE, Calgary, Alberta</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(250) 551-1021</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>stellartmanagement@outlook.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">QUOTE</div>
                            <div class="document-number">#${quoteNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Terms & Conditions</h3>
                        <div class="terms-content">
                            <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept check, and e-transfer.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('quotePreviewContent').innerHTML = quoteHTML;
            closeModal('quickQuoteModal');
            // Add a small delay to ensure the close operation completes
            setTimeout(() => {
                console.log('ðŸŽ¯ Attempting to open quick quote preview modal...');
                createNewPreviewModal('quote', quoteHTML);
            }, 200);
        }

        function generateQuickInvoicePreview(serviceItems) {
            console.log('ðŸŽ¯ generateQuickInvoicePreview called with:', { serviceItems });
            const clientName = document.getElementById('quickInvoiceClientName').value;
            const clientPhone = document.getElementById('quickInvoiceClientPhone').value || 'N/A';
            const clientAddress = document.getElementById('quickInvoiceClientAddress').value || 'N/A';
            const clientEmail = document.getElementById('quickInvoiceClientEmail').value || 'N/A';
            const invoiceDate = document.getElementById('quickInvoiceDate').value;
            const taxEnabled = document.getElementById('quickInvoiceTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const invoiceNumber = generateInvoiceNumber();
            const formattedDate = new Date(invoiceDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const invoiceHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>1932 9a Ave NE, Calgary, Alberta</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(250) 551-1021</span>
                                    </div>
                                    <div class="contact-item">
                                        <span>stellartmanagement@outlook.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">INVOICE</div>
                            <div class="document-number">#${invoiceNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Payment Terms</h3>
                        <div class="terms-content">
                            <p>Payment is due upon receipt of this invoice. We accept check, and e-transfer. Please include the invoice number with your payment.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('invoicePreviewContent').innerHTML = invoiceHTML;
            closeModal('quickInvoiceModal');
            // Add a small delay to ensure the close operation completes
            setTimeout(() => {
                console.log('ðŸŽ¯ Attempting to open quick invoice preview modal...');
                createNewPreviewModal('invoice', invoiceHTML);
            }, 200);
        }

        // Generate Quote Preview
        function generateQuotePreview(serviceItems, quoteId = null) {
            console.log('ðŸŽ¯ generateQuotePreview called with:', { serviceItems, quoteId });
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteNumber = quoteId || generateQuoteNumber();
            const formattedDate = new Date(quoteDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const quoteHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <p><i class="fas fa-map-marker-alt"></i> 1932 9a Ave NE, Calgary, Alberta</p>
                                    <p><i class="fas fa-phone"></i> (250) 551-1021</p>
                                    <p><i class="fas fa-envelope"></i> stellartmanagement@outlook.com</p>
                                </div>
                            </div>
                        </div>
                        <div class="quote-details">
                            <h2 class="quote-title">QUOTE</h2>
                            <p class="quote-number">#${quoteNumber}</p>
                            <p class="quote-date">${formattedDate}</p>
                        </div>
                    </div>

                    <!-- Client Information Section -->
                    <div class="client-info-section">
                        <div class="client-info-column">
                            <h3>Client Information</h3>
                            <div class="info-line"></div>
                            <div class="info-content">
                                <p><strong>Name:</strong> ${clientName}</p>
                                <p><strong>Phone:</strong> ${clientPhone || 'N/A'}</p>
                                <p><strong>Email:</strong> ${clientEmail || 'N/A'}</p>
                                <p><strong>Address:</strong> ${clientAddress || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="bill-to-column">
                            <h3>Bill To</h3>
                            <div class="info-line"></div>
                            <div class="info-content">
                                <p><strong>Name:</strong> ${clientName}</p>
                                <p><strong>Phone:</strong> ${clientPhone || 'N/A'}</p>
                                <p><strong>Email:</strong> ${clientEmail || 'N/A'}</p>
                                <p><strong>Address:</strong> ${clientAddress || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <div class="services-section">
                        <h3>Services</h3>
                        <div class="info-line"></div>
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviceItems.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>$${item.price.toFixed(2)}</td>
                                        <td>$${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                        ${taxEnabled ? `
                            <div class="total-row">
                                <span>Tax (5%):</span>
                                <span>$${tax.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="total-line"></div>
                        <div class="total-row grand-total">
                            <span>Total:</span>
                            <span>$${total.toFixed(2)}</span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3>Terms & Conditions</h3>
                        <div class="info-line"></div>
                        <div class="terms-content">
                            <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept check, and e-transfer.</p>
                        </div>
                    </div>
                </div>
            `;

            console.log('ðŸŽ¯ Setting quote preview content...');
            const previewContent = document.getElementById('quotePreviewContent');
            console.log('ðŸŽ¯ Preview content element found:', !!previewContent);
            if (previewContent) {
                previewContent.innerHTML = quoteHTML;
                // Ensure the preview content is visible
                previewContent.style.display = 'block';
                previewContent.style.visibility = 'visible';
                previewContent.style.opacity = '1';
                console.log('ðŸŽ¯ Quote preview content set successfully');
            } else {
                console.error('ðŸŽ¯ quotePreviewContent element not found!');
            }
            
            // Update the Send Quote button with the correct booking ID
            const sendQuoteBtn = document.querySelector('#quotePreviewModal .action-btn.confirm');
            if (sendQuoteBtn && currentQuoteData && currentQuoteData.bookingId) {
                sendQuoteBtn.onclick = () => {
                    sendQuoteToCustomer(currentQuoteData.bookingId);
                    closeModal('quotePreviewModal');
                };
            }
            
            closeModal('quoteModal');
            // Add a small delay to ensure the close operation completes and content is rendered
            setTimeout(() => {
                console.log('ðŸŽ¯ Attempting to open quotePreviewModal...');
                createNewPreviewModal('quote', quoteHTML);
            }, 200);
        }

        // Generate Quote Number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `QT-${year}${month}${day}-${random}`;
        }

        // Universal styling function for consistent appearance
        function getUniversalDocumentStyles() {
            return `
                    <style>
                
                #quotePreviewContent,
                #invoicePreviewContent {
                    font-family: 'Arial', sans-serif;
                    line-height: 1.6;
                            color: #333;
                        }

                /* Quote Document Styles - Matching the Design */
                        .quote-document { 
                    font-family: 'Arial', sans-serif;
                    line-height: 1.6;
                    color: #333;
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            border-radius: 8px;
                            overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        }
                        
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                    border-bottom: 2px solid #8cc63f;
                }

                .company-brand {
                    display: flex;
                    align-items: flex-start;
                    gap: 16px;
                }

                .company-logo {
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    object-fit: cover;
                }

                        .company-name { 
                    font-size: 1.8rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                .company-contact {
                    margin: 0;
                }

                .company-contact p {
                    margin: 4px 0;
                    font-size: 0.9rem;
                    color: #666;
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                        }

                .company-contact i {
                            color: #8cc63f;
                    width: 16px;
                        }

                .quote-details {
                            text-align: right;
                }

                .quote-title {
                    font-size: 2.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                .quote-number {
                    font-size: 1.1rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 4px 0;
                }

                .quote-date {
                    font-size: 1rem;
                            color: #666;
                    margin: 0;
                }

                .client-info-section {
                            background: #f8f9fa;
                    padding: 20px;
                    margin: 0;
                    display: flex;
                    gap: 40px;
                }

                .client-info-column,
                .bill-to-column {
                    flex: 1;
                }

                .client-info-column h3,
                .bill-to-column h3 {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                .info-line {
                    height: 2px;
                    background: #8cc63f;
                    width: 60%;
                    margin-bottom: 12px;
                }

                .info-content p {
                    margin: 6px 0;
                    font-size: 0.95rem;
                            color: #333;
                }

                .services-section {
                    background: #f8f9fa;
                    padding: 20px;
                    margin: 0;
                }

                .services-section h3 {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                        .services-table { 
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 16px;
                    background: white;
                }

                .services-table thead {
                    background: #333;
                            color: white;
                        }

                .services-table th {
                    padding: 12px 8px;
                            text-align: left;
                    font-weight: bold;
                    font-size: 0.9rem;
                }

                .services-table td {
                    padding: 12px 8px;
                    border-bottom: 1px solid #ddd;
                    font-size: 0.9rem;
                }

                .services-table tbody tr:nth-child(even) {
                    background: #f9f9f9;
                }

                        .totals-section { 
                            background: #f8f9fa;
                    padding: 20px;
                    margin: 0;
                    text-align: right;
                    max-width: 300px;
                    margin-left: auto;
                }

                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                    padding: 6px 0;
                    font-size: 1rem;
                }

                .total-line {
                    height: 1px;
                    background: #8cc63f;
                    margin: 8px 0;
                }

                .grand-total {
                    font-weight: bold;
                    font-size: 1.1rem;
                }

                        .terms-section { 
                            background: #f8f9fa;
                    padding: 20px;
                    margin: 0;
                }

                .terms-section h3 {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                        .terms-content p { 
                            margin: 0;
                    font-size: 0.95rem;
                            color: #666;
                    line-height: 1.5;
                        }

                /* Print/Export specific tweaks (do not affect on-screen preview) */
                .print-export .terms-section { 
                    padding-top: 12px;
                }
                .print-export .terms-section h3 {
                    font-size: 1rem;
                    font-weight: 600;
                }
                .print-export .terms-content p {
                    font-size: 0.85rem;
                    font-weight: 400;
                    color: #777;
                }

                /* Additional styles for Quick Billing structure */
                .contact-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin: 4px 0;
                    font-size: 0.9rem;
                    color: #666;
                }

                .contact-item i {
                    color: #8cc63f;
                    width: 16px;
                }

                .document-info {
                    text-align: right;
                }

                .document-type {
                    font-size: 2.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                .document-number {
                    font-size: 1.1rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 4px 0;
                }

                .document-date {
                    font-size: 1rem;
                    color: #666;
                    margin: 0;
                }

                .client-billing-section {
                    background: #f8f9fa;
                    padding: 20px;
                    margin: 0;
                    display: flex;
                    gap: 40px;
                }

                .client-billing-section > div {
                    flex: 1;
                }

                .section-heading {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                    margin: 0 0 8px 0;
                }

                .data-row {
                    display: flex;
                    margin: 6px 0;
                    font-size: 0.95rem;
                }

                .data-row .label {
                    font-weight: bold;
                    color: #333;
                    min-width: 80px;
                    margin-right: 8px;
                }

                .data-row .value {
                    color: #333;
                    flex: 1;
                }

                .table-header {
                    display: flex;
                    background: #333;
                    color: white;
                    font-weight: bold;
                    font-size: 0.9rem;
                }

                .table-body {
                    background: white;
                }

                .table-row {
                    display: flex;
                    border-bottom: 1px solid #ddd;
                }

                .table-row:nth-child(even) {
                    background: #f9f9f9;
                }

                .header-item,
                .table-cell {
                    padding: 12px 8px;
                    font-size: 0.9rem;
                }

                .header-item:first-child,
                .table-cell:first-child {
                    width: 40px;
                    text-align: center;
                }

                .header-item.description,
                .table-cell.description {
                    flex: 2;
                }

                .header-item.quantity,
                .table-cell.quantity {
                    width: 60px;
                    text-align: center;
                }

                .header-item.price,
                .table-cell.price {
                    width: 100px;
                    text-align: right;
                }

                .header-item.total,
                .table-cell.total {
                    width: 100px;
                    text-align: right;
                    font-weight: bold;
                }

                .totals-container {
                    max-width: 300px;
                    margin-left: auto;
                }

                .total-label {
                    font-weight: bold;
                }

                .total-value {
                    font-weight: bold;
                }

                .grand-total .total-label,
                .grand-total .total-value {
                    font-size: 1.1rem;
                }
                        
                /* Print Styles */
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    
                    </style>
            `;
        }

        // Print Quote
        function printQuote() {
            const printWindow = window.open('', '_blank');
            const quoteContent = document.getElementById('quotePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body>
                    ${quoteContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Quote as PDF
        function downloadQuotePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printQuote();
        }

        // Download Quote (for quick billing compatibility)
        function downloadQuote() {
            const quoteContent = document.getElementById('quotePreviewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body>
                    ${quoteContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Trigger download
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Send Quote
        async function sendQuoteEmail(event) {
            if (!currentQuoteData || !currentQuoteData.quoteId) {
                showNotification('No quote data available to send', 'error');
                return;
            }

            try {
                // Show loading state - use more reliable button selection
                let sendButton = event.target;
                if (!sendButton || !sendButton.tagName || sendButton.tagName !== 'BUTTON') {
                    // Fallback: find the button by its onclick attribute
                    sendButton = document.querySelector('button[onclick*="sendQuoteEmail"]');
                }
                
                if (!sendButton) {
                    console.error('Could not find send button');
                    showNotification('Error: Could not find send button', 'error');
                    return;
                }
                
                const originalText = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                // Send the quote email via the server
                const response = await fetch(`/api/quotes/${currentQuoteData.quoteId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    showNotification('Quote sent successfully! Status updated to Quote Sent.', 'success');
                    
                    // Update the booking status to 'quote-sent' if we have a booking ID
                    if (currentQuoteData.bookingId) {
                        try {
                            await updateBookingStatus(currentQuoteData.bookingId, 'quote-sent');
                        } catch (statusError) {
                            console.warn('Could not update booking status:', statusError);
                            // Don't fail the whole operation if status update fails
                        }
                    }
                    
                    // Close the quote modal after a short delay to ensure notification is visible
                    setTimeout(() => {
                        forceCloseModal('quoteModal');
                    }, 500);
                    
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send quote', 'error');
                }
            } catch (error) {
                console.error('Error sending quote:', error);
                showNotification('Network error sending quote', 'error');
            } finally {
                // Restore button state
                if (sendButton) {
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                }
            }
        }

        // Generate Quote Email Content
        function generateQuoteEmailContent(quoteData) {
            const serviceItems = quoteData.serviceItems || [];
            const serviceItemsList = serviceItems.map(item => 
                `<li>${item.description}: ${item.quantity} x $${item.price.toFixed(2)} = $${item.total.toFixed(2)}</li>`
            ).join('');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Quote - ${quoteData.quoteId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background-color: #2c5530; color: white; padding: 20px; text-align: center; }
                        .content { padding: 20px; background-color: #f9f9f9; }
                        .service-items { background-color: white; padding: 20px; margin: 20px 0; border-radius: 5px; }
                        .total { background-color: #2c5530; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: bold; }
                        .footer { text-align: center; padding: 20px; color: #666; }
                        ul { list-style: none; padding: 0; }
                        li { padding: 8px 0; border-bottom: 1px solid #eee; }
                        li:last-child { border-bottom: none; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Stellar Tree Management</h1>
                            <h2>Quote</h2>
                        </div>
                        
                        <div class="content">
                            <p>Dear ${quoteData.customerName || 'Valued Customer'},</p>
                            
                            <p>Thank you for your interest in Stellar Tree Management services!</p>
                            
                            <p>Please find your quote details below:</p>
                            
                            <div class="service-items">
                                <h3>Quote Details</h3>
                                <p><strong>Quote ID:</strong> ${quoteData.quoteId}</p>
                                <p><strong>Date:</strong> ${quoteData.quoteDate || new Date().toLocaleDateString()}</p>
                                
                                <h4>Service Items:</h4>
                                <ul>
                                    ${serviceItemsList}
                                </ul>
                            </div>
                            
                            <div class="total">
                                Total Amount: $${quoteData.totalAmount ? quoteData.totalAmount.toFixed(2) : '0.00'}
                            </div>
                            
                            <p>Please review this quote and contact us if you have any questions.</p>
                            
                            <p>Best regards,<br>
                            Stellar Tree Management Team</p>
                        </div>
                        
                        <div class="footer">
                            <p>Email: stellartmanagement@outlook.com<br>
                            Website: www.stellartreemanagement.ca</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const textContent = `
                Dear ${quoteData.customerName || 'Valued Customer'},
                
                Thank you for your interest in Stellar Tree Management services!
                
                Please find your quote details below:
                
                Quote ID: ${quoteData.quoteId}
                Date: ${quoteData.quoteDate || new Date().toLocaleDateString()}
                
                Service Items:
                ${serviceItems.map(item => 
                    `- ${item.description}: ${item.quantity} x $${item.price.toFixed(2)} = $${item.total.toFixed(2)}`
                ).join('\n')}
                
                Total Amount: $${quoteData.totalAmount ? quoteData.totalAmount.toFixed(2) : '0.00'}
                
                Please review this quote and contact us if you have any questions.
                
                Best regards,
                Stellar Tree Management Team
                Email: stellartmanagement@outlook.com
            `;
            
            return { html: htmlContent, text: textContent };
        }

        // Invoice Functions
        window.currentInvoiceData = null;

        // Show Invoice Modal from Booking ID
        async function showInvoiceModalFromBooking(bookingId) {
            try {
                console.log('showInvoiceModalFromBooking called with bookingId:', bookingId);
                
                // First, check if there's an existing invoice for this booking
                const invoiceResponse = await fetch(`/api/invoices/booking/${bookingId}`);
                console.log('Invoice response status:', invoiceResponse.status);
                
                let existingInvoice = null;
                if (invoiceResponse.ok) {
                    const invoices = await invoiceResponse.json();
                    console.log('Invoices received:', invoices);
                    
                    if (invoices && invoices.length > 0) {
                        // Use the most recent invoice
                        existingInvoice = invoices[0];
                        console.log('Found existing invoice:', existingInvoice);
                    }
                }
                
                if (existingInvoice) {
                    // Load existing invoice data
                    console.log('Loading existing invoice data');
                    await loadExistingInvoiceData(existingInvoice, bookingId);
                } else {
                    // No existing invoice, create from quote
                    console.log('No existing invoice, creating from quote');
                    await createInvoiceFromQuote(bookingId);
                }
                
            } catch (error) {
                console.error('Error fetching data for invoice modal:', error);
                showNotification('Failed to load invoice data. Please try again.', 'error');
                
                // Fallback: Show empty invoice modal
                console.log('Showing fallback empty invoice modal');
                showEmptyInvoiceModal(bookingId);
            }
        }
        
        // Fallback function to show empty invoice modal
        function showEmptyInvoiceModal(bookingId) {
            console.log('showEmptyInvoiceModal called with bookingId:', bookingId);
            
            // Find the booking data
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (booking) {
                // Populate basic client information
                document.getElementById('invoiceClientName').value = booking.name || '';
                document.getElementById('invoiceClientPhone').value = booking.phone || '';
                document.getElementById('invoiceClientAddress').value = booking.address || '';
                document.getElementById('invoiceClientEmail').value = booking.email || '';
                document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
                
                // Clear service items
                const container = document.getElementById('invoiceServiceItems');
                if (container) {
                    container.innerHTML = '';
                }
                
                // Reset totals
                document.getElementById('invoiceSubtotalAmount').textContent = '$0.00';
                document.getElementById('invoiceTaxAmount').textContent = '$0.00';
                document.getElementById('invoiceGrandTotalAmount').textContent = '$0.00';
                
                // Uncheck tax toggle
                const taxToggle = document.getElementById('invoiceTaxToggle');
                if (taxToggle) {
                    taxToggle.checked = false;
                }
            }
            
            // Show the modal
            console.log('About to call openModal with invoiceModal (fallback)');
            openModal('invoiceModal');
            console.log('openModal called (fallback)');
        }

        // Load existing invoice data into the modal
        async function loadExistingInvoiceData(invoice, bookingId) {
            try {
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Booking received:', booking);
                
                // Set current invoice data
                window.currentInvoiceData = {
                    invoiceId: invoice.invoice_id,
                    quoteId: invoice.quote_id,
                    bookingId: bookingId,
                    service: booking.service,
                    date: booking.date,
                    time: booking.time,
                    name: booking.name,
                    email: booking.email,
                    phone: booking.phone,
                    address: booking.address,
                    notes: booking.notes,
                    // Store the service items for the new modal
                    serviceItems: invoice.service_items,
                    // Store the original invoice totals
                    originalQuoteTotals: {
                        subtotal: invoice.subtotal,
                        tax_amount: invoice.tax_amount,
                        total_amount: invoice.total_amount,
                        tax_enabled: invoice.tax_enabled
                    }
                };
                
                console.log('currentInvoiceData set to:', window.currentInvoiceData);
                
                // Pre-fill client information from existing invoice
                document.getElementById('invoiceClientName').value = invoice.client_name || booking.name || '';
                document.getElementById('invoiceClientPhone').value = invoice.client_phone || booking.phone || '';
                document.getElementById('invoiceClientAddress').value = invoice.client_address || booking.address || '';
                document.getElementById('invoiceClientEmail').value = invoice.client_email || booking.email || '';
                document.getElementById('invoiceDate').value = invoice.invoice_date || new Date().toISOString().split('T')[0];
                
                // Populate service items from existing invoice
                populateInvoiceServiceItems(invoice.service_items);
                
                // Set tax toggle to match the existing invoice
                document.getElementById('invoiceTaxToggle').checked = invoice.tax_enabled || false;
                
                // Update totals based on current service items
                updateInvoiceTotals();
                
                // Show modal
                console.log('About to call openModal with invoiceModal');
                openModal('invoiceModal');
                console.log('openModal called');
                
                // For the new modal system, populate data after modal is created
                setTimeout(() => {
                    console.log('ðŸ”§ Populating data after modal creation (existing invoice)...');
                    populateNewInvoiceModal();
                }, 200);
                
                // Load photos for service items if this is an existing invoice
                if (invoice && invoice.invoice_id) {
                    setTimeout(() => loadInvoicePhotos(invoice.quote_id), 100);
                }
                
            } catch (error) {
                console.error('Error loading existing invoice data:', error);
                showNotification('Failed to load existing invoice data. Please try again.', 'error');
            }
        }

        // Create invoice from quote data
        async function createInvoiceFromQuote(bookingId) {
            try {
                // Fetch the latest quote for this booking
                const response = await fetch(`/api/quotes/booking/${bookingId}`);
                console.log('Quote response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch quote data');
                }
                
                const quotes = await response.json();
                console.log('Quotes received:', quotes);
                
                if (!quotes || quotes.length === 0) {
                    throw new Error('No quotes found for this booking');
                }
                
                // Get the latest quote (first in the array since it's sorted by creation date desc)
                const quote = quotes[0];
                console.log('Using quote:', quote);
                
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                console.log('Booking response status:', bookingResponse.status);
                
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Booking received:', booking);
                
                // Now call the existing showInvoiceModal function
                console.log('Calling showInvoiceModal with:', { quote, booking });
                showInvoiceModal(quote, booking);
                
            } catch (error) {
                console.error('Error creating invoice from quote:', error);
                showNotification('Failed to create invoice from quote. Please try again.', 'error');
            }
        }
        // Send Invoice from Booking (directly generates and sends invoice without showing modal)
        async function sendInvoiceFromBooking(bookingId) {
            try {
                console.log('sendInvoiceFromBooking called with bookingId:', bookingId);
                
                // Show loading notification
                showNotification('Preparing and sending invoice...', 'info');
                
                // Fetch the latest quote for this booking (without showing modal)
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`);
                if (!quoteResponse.ok) {
                    throw new Error('Failed to fetch quote data');
                }
                
                const quotes = await quoteResponse.json();
                if (!quotes || quotes.length === 0) {
                    throw new Error('No quotes found for this booking');
                }
                
                const quote = quotes[0];
                console.log('Using quote:', quote);
                
                // Fetch the booking data
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                if (!bookingResponse.ok) {
                    throw new Error('Failed to fetch booking data');
                }
                
                const booking = await bookingResponse.json();
                console.log('Using booking:', booking);
                
                // Prepare invoice data directly from quote
                const invoiceData = {
                    quote_id: quote.quote_id,
                    booking_id: bookingId,
                    client_name: quote.client_name || booking.name || '',
                    client_phone: quote.client_phone || booking.phone || '',
                    client_address: quote.client_address || booking.address || '',
                    client_email: quote.client_email || booking.email || '',
                    invoice_date: new Date().toISOString().split('T')[0],
                    service_items: quote.service_items || [],
                    subtotal: quote.subtotal || 0,
                    tax_amount: quote.tax_amount || 0,
                    total_amount: quote.total_amount || 0,
                    tax_enabled: quote.tax_enabled || false
                };
                
                console.log('Creating invoice with data:', invoiceData);
                
                // Create the invoice directly
                const createResponse = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(invoiceData)
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Failed to create invoice');
                }
                
                const createResult = await createResponse.json();
                const invoiceId = createResult.invoice_id;
                console.log('Invoice created successfully with ID:', invoiceId);
                
                // Send the invoice email immediately
                console.log('Sending invoice email...');
                const emailResponse = await fetch(`/api/invoices/${invoiceId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                
                if (!emailResponse.ok) {
                    const error = await emailResponse.json();
                    throw new Error(error.error || 'Failed to send invoice email');
                }
                
                const emailResult = await emailResponse.json();
                console.log('Invoice email sent successfully:', emailResult);
                
                // Update booking status to 'invoice-sent'
                const statusResponse = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'invoice-sent' })
                });
                
                if (statusResponse.ok) {
                    showNotification('Invoice sent successfully and booking status updated!', 'success');
                    
                    // Auto-switch to the invoice-sent tab
                    autoSwitchToNextTab('invoice-sent');
                    
                    // Reload bookings to reflect the status change
                    loadBookings();
                } else {
                    console.warn('Invoice sent but failed to update booking status');
                    showNotification('Invoice sent but failed to update booking status', 'warning');
                }
                
            } catch (error) {
                console.error('Error in sendInvoiceFromBooking:', error);
                showNotification(`Failed to send invoice: ${error.message}`, 'error');
            }
        }

        // Show Invoice Modal
        function showInvoiceModal(quote, booking) {
            console.log('showInvoiceModal called with:', { quote, booking });
            console.log('Quote service items:', quote.service_items);
            console.log('Quote total amount:', quote.total_amount);
            console.log('Quote subtotal:', quote.subtotal);
            console.log('Quote tax amount:', quote.tax_amount);
            
            window.currentInvoiceData = {
                quoteId: quote.quote_id,
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes,
                // Store the service items for the new modal
                serviceItems: quote.service_items,
                // Store the original quote totals to ensure consistency
                originalQuoteTotals: {
                    subtotal: quote.subtotal,
                    tax_amount: quote.tax_amount,
                    total_amount: quote.total_amount,
                    tax_enabled: quote.tax_enabled
                }
            };
            
            console.log('currentInvoiceData set to:', currentInvoiceData);

            // Pre-fill client information from quote
            document.getElementById('invoiceClientName').value = quote.client_name || booking.name || '';
            document.getElementById('invoiceClientPhone').value = quote.client_phone || booking.phone || '';
            document.getElementById('invoiceClientAddress').value = quote.client_address || booking.address || '';
            document.getElementById('invoiceClientEmail').value = quote.client_email || booking.email || '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Populate service items from quote
            populateInvoiceServiceItems(quote.service_items);

            // Set tax toggle to match the original quote
            document.getElementById('invoiceTaxToggle').checked = quote.tax_enabled || false;

            // Update totals based on current service items
            updateInvoiceTotals();

            // Show modal
            console.log('About to call openModal with invoiceModal');
            openModal('invoiceModal');
            console.log('openModal called');
            
            // For the new modal system, populate data after modal is created
            setTimeout(() => {
                console.log('ðŸ”§ Populating data after modal creation...');
                populateNewInvoiceModal();
            }, 200);
            
            // Load photos for service items if this is an existing quote
            if (quote && quote.quote_id) {
                setTimeout(() => loadInvoicePhotos(quote.quote_id), 100);
            }
        }



        // Populate Invoice Service Items
        function populateInvoiceServiceItems(serviceItems) {
            const container = document.getElementById('invoiceServiceItems');
            container.innerHTML = '';

            // Parse service items if it's a JSON string
            let items = serviceItems;
            if (typeof serviceItems === 'string') {
                try {
                    items = JSON.parse(serviceItems);
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    items = [];
                }
            }

            console.log('Populating invoice service items:', items);
            console.log('Service items type:', typeof serviceItems);
            console.log('Parsed items:', items);

            items.forEach((item, index) => {
                console.log(`Processing service item ${index + 1}:`, item);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'service-item';
                itemDiv.setAttribute('data-item-id', index + 1);

                itemDiv.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description}" placeholder="Service or item description">
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <input type="number" class="item-qty-input" value="${item.quantity}" min="1" placeholder="Qty">
                            </div>
                            <div class="item-price">
                                <input type="number" class="item-price-input" value="${item.price}" min="0" step="0.01" placeholder="Price">
                            </div>
                        </div>
                        <div class="item-footer">
                            <div class="item-total">
                                <span class="item-total-amount">$${item.total.toFixed(2)}</span>
                            </div>
                            <div class="item-actions">
                                <button type="button" class="remove-item-btn" onclick="removeInvoiceServiceItem(this)" aria-label="Remove item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-photos-section">
                        <div class="photo-upload-area" onclick="triggerPhotoUpload(this)">
                            <div class="photo-upload-content">
                                <i class="fas fa-file-image"></i>
                                <span class="photo-upload-text">Photos: Add Photo</span>
                            </div>
                        </div>
                        <div class="photos-container">
                            <!-- Photos will be displayed here -->
                        </div>
                        <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                    </div>
                `;

                container.appendChild(itemDiv);
                setupInvoiceItemEventListeners(itemDiv);
            });

            // Log the final populated items for verification
            console.log('Final populated invoice service items count:', container.children.length);
        }

        // Add Invoice Service Item
        function addInvoiceServiceItem() {
            console.log('addInvoiceServiceItem called');
            const container = document.getElementById('invoiceServiceItems');
            const itemCounter = container.children.length + 1;
            
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service or item description">
                    </div>
                    <div class="item-controls">
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                        </div>
                    </div>
                    <div class="item-footer">
                        <div class="item-total">
                            <span class="item-total-amount">$0.00</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeInvoiceServiceItem(this)" aria-label="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item-photos-section">
                    <div class="photo-upload-area" onclick="triggerPhotoUpload(this)">
                        <div class="photo-upload-content">
                            <i class="fas fa-file-image"></i>
                            <span class="photo-upload-text">Photos: Add Photo</span>
                        </div>
                    </div>
                    <div class="photos-container">
                        <!-- Photos will be displayed here -->
                    </div>
                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                </div>
            `;

            container.appendChild(newItem);
            setupInvoiceItemEventListeners(newItem);
        }

        // Remove Invoice Service Item
        function removeInvoiceServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('#invoiceServiceItems .service-item').length > 1) {
                serviceItem.remove();
                updateInvoiceTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Invoice Service Items
        function setupInvoiceItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateInvoiceItemTotal);
            priceInput.removeEventListener('input', updateInvoiceItemTotal);

            qtyInput.addEventListener('input', updateInvoiceItemTotal);
            priceInput.addEventListener('input', updateInvoiceItemTotal);

            function updateInvoiceItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateInvoiceTotals();
            }

            // Initialize the total for this item
            updateInvoiceItemTotal();
        }

        // Update Invoice Totals
        function updateInvoiceTotals() {
            const items = document.querySelectorAll('#invoiceServiceItems .service-item');
            let subtotal = 0;

            items.forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('invoiceTaxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            document.getElementById('invoiceSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('invoiceGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('invoiceTaxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';

            console.log('Invoice totals updated:', { subtotal, tax, total });
        }

        // Toggle Invoice Tax
        function toggleInvoiceTax() {
            updateInvoiceTotals();
        }

        // Create Invoice from Saved Quote
        async function generateInvoice() {
            // Ensure we have current invoice context
            if (!currentInvoiceData || !currentInvoiceData.bookingId) {
                showNotification('No booking selected. Please open the invoice from a saved quote.', 'error');
                console.error('generateInvoice called without currentInvoiceData or bookingId', currentInvoiceData);
                return;
            }

            // Validate form
            const requiredFields = ['invoiceClientName', 'invoiceClientPhone', 'invoiceClientAddress', 'invoiceClientEmail', 'invoiceDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Upload any temporary photos before saving the invoice
            try {
                await uploadInvoiceTemporaryPhotos();
            } catch (error) {
                console.error('Error uploading photos:', error);
                showNotification('Error uploading photos. Please try again.', 'error');
                return;
            }

            // Collect service items
            const serviceItems = [];
            const serviceItemElements = document.querySelectorAll('#invoiceServiceItems .service-item');
            console.log('Found service item elements:', serviceItemElements.length);
            
            serviceItemElements.forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value;
                const quantity = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                const total = quantity * price;

                console.log(`Service item ${index + 1}:`, { description, quantity, price, total });

                if (description && quantity > 0 && price > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('No service items found', 'error');
                return;
            }

            // Save invoice to database with current totals
            saveInvoice(serviceItems);
        }

        // Save Invoice to Database
        async function saveInvoice(serviceItems) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            // Calculate current totals from service items (allowing for modifications)
            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;
            
            console.log('Using current calculated totals:', { subtotal, tax, total });

            // Guard against missing booking context
            if (!currentInvoiceData || !currentInvoiceData.bookingId) {
                showNotification('Cannot save invoice: missing booking context. Please reopen from a saved quote.', 'error');
                console.error('saveInvoice called without currentInvoiceData or bookingId', currentInvoiceData);
                return;
            }

            const invoiceData = {
                quote_id: currentInvoiceData.quoteId,
                booking_id: currentInvoiceData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                invoice_date: invoiceDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            console.log('Saving invoice with data:', invoiceData);

            try {
                let response;
                let result;
                
                if (currentInvoiceData.invoiceId) {
                    // Update existing invoice
                    console.log('Updating existing invoice:', currentInvoiceData.invoiceId);
                    response = await fetch(`/api/invoices/${currentInvoiceData.invoiceId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        showNotification('Invoice updated successfully!', 'success');
                    }
                } else {
                    // Create new invoice
                    console.log('Creating new invoice');
                    response = await fetch('/api/invoices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        showNotification('Invoice saved successfully!', 'success');
                        
                        // Store the invoice ID for later use
                        window.currentInvoiceData.invoiceId = result.invoice_id;
                    }
                }

                if (response.ok) {
                    // Generate invoice preview
                    generateInvoicePreview(serviceItems, currentInvoiceData.invoiceId || result.invoice_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save invoice', 'error');
                }
            } catch (error) {
                console.error('Error saving invoice:', error);
                showNotification('Network error saving invoice', 'error');
            }
        }

        // Complete Booking with Invoice
        async function completeBookingWithInvoice() {
            try {
                const response = await fetch(`/api/bookings/${currentInvoiceData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showNotification('Booking completed successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to complete booking', 'error');
                }
            } catch (error) {
                console.error('Error completing booking:', error);
                showNotification('Network error completing booking', 'error');
            }
        }

        // Generate Invoice Preview
        function generateInvoicePreview(serviceItems, invoiceId = null) {
            console.log('ðŸŽ¯ generateInvoicePreview called with:', { serviceItems, invoiceId });
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            // Use current calculated totals (allowing for modifications)
            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;
            
            console.log('Invoice preview using current calculated totals:', { subtotal, tax, total });

            const invoiceNumber = invoiceId || generateInvoiceNumber();
            const formattedDate = new Date(invoiceDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const invoiceHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <p><i class="fas fa-map-marker-alt"></i> 1932 9a Ave NE, Calgary, Alberta</p>
                                    <p><i class="fas fa-phone"></i> (250) 551-1021</p>
                                    <p><i class="fas fa-envelope"></i> stellartmanagement@outlook.com</p>
                                </div>
                            </div>
                        </div>
                        <div class="quote-details">
                            <h2 class="quote-title">INVOICE</h2>
                            <p class="quote-number">#${invoiceNumber}</p>
                            <p class="quote-date">${formattedDate}</p>
                        </div>
                    </div>

                    <!-- Client Information Section -->
                    <div class="client-info-section">
                        <div class="client-info-column">
                            <h3>Client Information</h3>
                            <div class="info-line"></div>
                            <div class="info-content">
                                <p><strong>Name:</strong> ${clientName}</p>
                                <p><strong>Phone:</strong> ${clientPhone || 'N/A'}</p>
                                <p><strong>Email:</strong> ${clientEmail || 'N/A'}</p>
                                <p><strong>Address:</strong> ${clientAddress || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="bill-to-column">
                            <h3>Bill To</h3>
                            <div class="info-line"></div>
                            <div class="info-content">
                                <p><strong>Name:</strong> ${clientName}</p>
                                <p><strong>Phone:</strong> ${clientPhone || 'N/A'}</p>
                                <p><strong>Email:</strong> ${clientEmail || 'N/A'}</p>
                                <p><strong>Address:</strong> ${clientAddress || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <div class="services-section">
                        <h3>Services</h3>
                        <div class="info-line"></div>
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviceItems.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>$${item.price.toFixed(2)}</td>
                                        <td>$${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                        ${taxEnabled ? `
                            <div class="total-row">
                                <span>Tax (5%):</span>
                                <span>$${tax.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="total-line"></div>
                        <div class="total-row grand-total">
                            <span>Total:</span>
                            <span>$${total.toFixed(2)}</span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3>Payment Terms</h3>
                        <div class="info-line"></div>
                        <div class="terms-content">
                            <p>Payment is due upon receipt of this invoice. We accept check, and e-transfer. Please include the invoice number with your payment.</p>
                        </div>
                    </div>
                </div>
            `;

            console.log('ðŸŽ¯ Setting invoice preview content...');
            const invoicePreviewContent = document.getElementById('invoicePreviewContent');
            console.log('ðŸŽ¯ Invoice preview content element found:', !!invoicePreviewContent);
            if (invoicePreviewContent) {
                invoicePreviewContent.innerHTML = invoiceHTML;
                // Ensure the preview content is visible
                invoicePreviewContent.style.display = 'block';
                invoicePreviewContent.style.visibility = 'visible';
                invoicePreviewContent.style.opacity = '1';
                console.log('ðŸŽ¯ Invoice preview content set successfully');
            } else {
                console.error('ðŸŽ¯ invoicePreviewContent element not found!');
            }
            closeModal('invoiceModal');
            // Add a small delay to ensure the close operation completes and content is rendered
            setTimeout(() => {
                console.log('ðŸŽ¯ Attempting to open invoicePreviewModal...');
                createNewPreviewModal('invoice', invoiceHTML);
            }, 200);
        }

        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `INV-${year}${month}${day}-${random}`;
        }
        // Print Invoice
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            const invoiceContent = document.getElementById('invoicePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Invoice as PDF
        function downloadInvoicePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printInvoice();
        }

        // Download Invoice (for quick billing compatibility)
        function downloadInvoice() {
            const invoiceContent = document.getElementById('invoicePreviewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Trigger download
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Quick Billing Print Functions
        function printQuickQuote(content) {
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body class="print-export">
                    ${content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for resources to load before printing
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        function printQuickInvoice(content) {
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    ${getUniversalDocumentStyles()}
                </head>
                <body class="print-export">
                    ${content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for resources to load before printing
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        // Quick Billing Download Functions
        function downloadQuickQuotePDF(content) {
            const ensureHtml2Pdf = () => new Promise((resolve, reject) => {
                if (window.html2pdf) return resolve();
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load PDF library'));
                document.head.appendChild(s);
            });

            ensureHtml2Pdf().then(() => {
                // Create container with proper dimensions and background
                const container = document.createElement('div');
                container.style.cssText = 'position: fixed; left: 0; top: 0; width: 800px; background: white; padding: 20px; visibility: hidden; z-index: -1;';
                
                // Create content wrapper with print-export class
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'print-export';
                contentWrapper.innerHTML = content;
                container.appendChild(contentWrapper);
                document.body.appendChild(container);

                // Inject styles temporarily
                const styleElement = document.createElement('style');
                styleElement.id = 'temp-pdf-styles';
                styleElement.textContent = getUniversalDocumentStyles().replace(/<style>|<\/style>/g, '');
                document.head.appendChild(styleElement);

                // Wait for images and fonts to load
                const waitForResources = () => {
                    const images = container.querySelectorAll('img');
                    const imagePromises = Array.from(images).map(img => {
                        return new Promise(resolve => {
                            if (img.complete) {
                                resolve();
                            } else {
                                img.onload = () => resolve();
                                img.onerror = () => resolve(); // Continue even if image fails
                                setTimeout(() => resolve(), 5000);
                            }
                        });
                    });
                    
                    // Wait for fonts to load
                    const fontPromise = document.fonts ? document.fonts.ready : Promise.resolve();
                    
                    return Promise.all([...imagePromises, fontPromise]);
                };

                waitForResources().then(() => {
                    // Add small delay to ensure DOM is fully rendered
                    setTimeout(() => {
                        const opts = {
                            margin: [10, 10, 10, 10],
                            filename: 'Quote.pdf',
                            html2canvas: { 
                                scale: 3,
                                useCORS: true,
                                allowTaint: true,
                                imageTimeout: 15000,
                                logging: false,
                                letterRendering: true,
                                windowWidth: 1200,
                                windowHeight: 1600
                            },
                            jsPDF: { 
                                unit: 'pt', 
                                format: 'letter', 
                                orientation: 'portrait',
                                compress: true
                            },
                            pagebreak: { mode: 'avoid-all' }
                        };

                        window.html2pdf().from(contentWrapper).set(opts).save().then(() => {
                            // Cleanup
                            container.remove();
                            styleElement.remove();
                        }).catch((e) => {
                            console.error('PDF generation failed:', e);
                            container.remove();
                            styleElement.remove();
                            showNotification('Failed to generate PDF. Please try again.', 'error');
                        });
                    }, 250); // 250ms delay for DOM rendering
                });
            }).catch(() => {
                showNotification('PDF library failed to load. Please check your connection.', 'error');
            });
        }

        function downloadQuickInvoicePDF(content) {
            const ensureHtml2Pdf = () => new Promise((resolve, reject) => {
                if (window.html2pdf) return resolve();
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load PDF library'));
                document.head.appendChild(s);
            });

            ensureHtml2Pdf().then(() => {
                // Create container with proper dimensions and background
                const container = document.createElement('div');
                container.style.cssText = 'position: fixed; left: 0; top: 0; width: 800px; background: white; padding: 20px; visibility: hidden; z-index: -1;';
                
                // Create content wrapper with print-export class
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'print-export';
                contentWrapper.innerHTML = content;
                container.appendChild(contentWrapper);
                document.body.appendChild(container);

                // Inject styles temporarily
                const styleElement = document.createElement('style');
                styleElement.id = 'temp-pdf-styles';
                styleElement.textContent = getUniversalDocumentStyles().replace(/<style>|<\/style>/g, '');
                document.head.appendChild(styleElement);

                // Wait for images and fonts to load
                const waitForResources = () => {
                    const images = container.querySelectorAll('img');
                    const imagePromises = Array.from(images).map(img => {
                        return new Promise(resolve => {
                            if (img.complete) {
                                resolve();
                            } else {
                                img.onload = () => resolve();
                                img.onerror = () => resolve(); // Continue even if image fails
                                setTimeout(() => resolve(), 5000);
                            }
                        });
                    });
                    
                    // Wait for fonts to load
                    const fontPromise = document.fonts ? document.fonts.ready : Promise.resolve();
                    
                    return Promise.all([...imagePromises, fontPromise]);
                };

                waitForResources().then(() => {
                    // Add small delay to ensure DOM is fully rendered
                    setTimeout(() => {
                        const opts = {
                            margin: [10, 10, 10, 10],
                            filename: 'Invoice.pdf',
                            html2canvas: { 
                                scale: 3,
                                useCORS: true,
                                allowTaint: true,
                                imageTimeout: 15000,
                                logging: false,
                                letterRendering: true,
                                windowWidth: 1200,
                                windowHeight: 1600
                            },
                            jsPDF: { 
                                unit: 'pt', 
                                format: 'letter', 
                                orientation: 'portrait',
                                compress: true
                            },
                            pagebreak: { mode: 'avoid-all' }
                        };

                        window.html2pdf().from(contentWrapper).set(opts).save().then(() => {
                            // Cleanup
                            container.remove();
                            styleElement.remove();
                        }).catch((e) => {
                            console.error('PDF generation failed:', e);
                            container.remove();
                            styleElement.remove();
                            showNotification('Failed to generate PDF. Please try again.', 'error');
                        });
                    }, 250); // 250ms delay for DOM rendering
                });
            }).catch(() => {
                showNotification('PDF library failed to load. Please check your connection.', 'error');
            });
        }

        // Send Invoice Email
        async function sendInvoiceEmail(event) {
            if (!currentInvoiceData || !currentInvoiceData.invoiceId) {
                showNotification('No invoice data available to send email', 'error');
                return;
            }

            try {
                // Show loading state - use more reliable button selection
                let sendButton = event.target;
                if (!sendButton || !sendButton.tagName || sendButton.tagName !== 'BUTTON') {
                    // Fallback: find the button by its onclick attribute
                    sendButton = document.querySelector('button[onclick*="sendInvoiceEmail"]');
                    console.log('Fallback button selection:', sendButton);
                }
                
                if (!sendButton) {
                    console.error('Could not find send button');
                    showNotification('Error: Could not find send button', 'error');
                    return;
                }
                
                const originalText = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                const response = await fetch(`/api/invoices/${currentInvoiceData.invoiceId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Invoice email sent successfully, result:', result);
                    showNotification('Invoice email sent successfully!', 'success');
                    
                    // Close the invoice modal after a short delay to ensure notification is visible
                    console.log('Attempting to close invoice modal after successful email send');
                    setTimeout(() => {
                        forceCloseModal('invoiceModal');
                    }, 500);
                    
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send invoice email', 'error');
                }
            } catch (error) {
                console.error('Error sending invoice email:', error);
                showNotification('Network error sending invoice email', 'error');
            } finally {
                // Restore button state
                console.log('Restoring button state, sendButton:', sendButton);
                if (sendButton) {
                    console.log('Restoring button to:', originalText);
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                    console.log('Button state restored');
                } else {
                    console.error('No sendButton found in finally block');
                }
            }
        }

        // Customer Management Functions - REMOVED

        // Render customer details
        function renderCustomerDetails(data) {
            const { customer, bookings, quotes, invoices, totalBreakdown } = data;
            
            document.getElementById('customerDetailsTitle').textContent = `Customer Details - ${customer.name}`;
            
            const content = `
                <div class="customer-details-grid">
                    <div class="customer-info-section">
                        <h4><i class="fas fa-user"></i> Customer Information</h4>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${customer.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${customer.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${customer.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${customer.address || 'Not provided'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Customer ID:</span>
                            <span class="info-value">${customer.customer_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${new Date(customer.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Bookings:</span>
                            <span class="info-value">${customer.total_bookings || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Spent:</span>
                            <span class="info-value">$${(customer.total_spent || 0).toFixed(2)}</span>
                            <button class="action-btn info" onclick="recalculateCustomerTotal('${customer.customer_id}')" style="margin-left: 10px; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                <i class="fas fa-calculator"></i> Recalculate
                            </button>
                        </div>

                        ${customer.notes ? `
                            <div class="info-row">
                                <span class="info-label">Notes:</span>
                                <span class="info-value">${customer.notes}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="customer-history-section">
                        <div class="history-tabs">
                            <div class="history-tab active" onclick="switchHistoryTab('bookings', {bookings, quotes, invoices})">Bookings (${bookings.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('quotes', {bookings, quotes, invoices})">Quotes (${quotes.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('invoices', {bookings, quotes, invoices})">Invoices (${invoices.length})</div>
                        </div>
                        <div class="history-content" id="historyContent">
                            ${renderEnhancedHistoryTab('bookings', bookings, quotes, invoices)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = content;
        }

        // Switch history tab
        function switchHistoryTab(tab, data) {
            // Update active tab
            document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get data based on tab
            let items = [];
            if (tab === 'bookings') items = data.bookings || [];
            else if (tab === 'quotes') items = data.quotes || [];
            else if (tab === 'invoices') items = data.invoices || [];
            
            if (tab === 'bookings') {
                document.getElementById('historyContent').innerHTML = renderEnhancedHistoryTab(tab, data.bookings || [], data.quotes || [], data.invoices || []);
            } else {
                document.getElementById('historyContent').innerHTML = renderHistoryTab(tab, items);
            }
        }

        // Render enhanced history tab content for bookings with related invoices and quotes
        function renderEnhancedHistoryTab(tab, bookings, quotes, invoices) {
            if (bookings.length === 0) {
                return '<div class="empty-state">No bookings found</div>';
            }

            return bookings.map(booking => {
                // Find related quotes and invoices for this booking
                const relatedQuotes = quotes.filter(q => q.booking_id === booking.booking_id);
                const relatedInvoices = invoices.filter(i => i.booking_id === booking.booking_id);
                
                return `
                    <div class="enhanced-history-item">
                        <div class="booking-header">
                            <h5><i class="fas fa-calendar-check"></i> ${booking.service} - ${booking.status}</h5>
                            <div class="booking-meta">
                                <span class="booking-date"><i class="fas fa-calendar"></i> ${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()} at ${booking.time}</span>
                                <span class="booking-id">
                                    <a href="booking-status.html?booking=${booking.booking_id}" target="_blank" class="clickable-booking-id" title="Click to view booking status page">
                                        <i class="fas fa-hashtag"></i> ${booking.booking_id}
                                    </a>
                                </span>
                            </div>
                        </div>
                        
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="detail-label">Customer:</span>
                                <span class="detail-value">${booking.name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${booking.notes || 'No notes'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Booking Date:</span>
                                <span class="detail-value">${(() => {
                                    const [year, month, day] = booking.date.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    return date.toLocaleDateString();
                                })()}</span>
                            </div>
                        </div>
                        
                        ${relatedQuotes.length > 0 || relatedInvoices.length > 0 ? `
                            <div class="related-documents">
                                ${relatedQuotes.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-file-invoice-dollar"></i> Related Quotes (${relatedQuotes.length})</h6>
                                        <div class="document-list">
                                            ${relatedQuotes.map(quote => {
                                                const serviceItems = JSON.parse(quote.service_items);
                                                return `
                                                    <div class="document-item quote-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Quote ${quote.quote_id}</span>
                                                            <span class="document-status ${quote.status}">${quote.status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${quote.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(quote.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${relatedInvoices.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-receipt"></i> Related Invoices (${relatedInvoices.length})</h6>
                                        <div class="document-list">
                                            ${relatedInvoices.map(invoice => {
                                                const serviceItems = JSON.parse(invoice.service_items);
                                                return `
                                                    <div class="document-item invoice-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Invoice ${invoice.invoice_id}</span>
                                                            <span class="document-status ${invoice.payment_status}">${invoice.payment_status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${invoice.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(invoice.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="no-documents">
                                <i class="fas fa-info-circle"></i> No related quotes or invoices found for this booking.
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Render history tab content
        function renderHistoryTab(tab, items) {
            if (items.length === 0) {
                return '<div class="empty-state">No items found</div>';
            }

            return items.map(item => {
                if (tab === 'bookings') {
                    return `
                        <div class="history-item">
                            <h5>${item.service} - ${item.status}</h5>
                            <p><strong>Date:</strong> ${new Date(item.date).toLocaleDateString()} at ${item.time}</p>
                            <p><strong>Booking ID:</strong> ${item.booking_id}</p>
                            <p class="date">Booked for: ${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'quotes') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Quote ${item.quote_id} - ${item.status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'invoices') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Invoice ${item.invoice_id} - ${item.payment_status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }
            }).join('');
        }

        // Edit customer
        function editCustomer(customerId) {
            currentCustomerId = customerId;
            const customer = allCustomers.find(c => c.customer_id === customerId);
            
            if (customer) {
                document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                openModal('customerModal');
            }
        }

        // Save customer
        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name || !email || !phone) {
                showNotification('Name, email, and phone are required', 'error');
                return;
            }

            try {
                const url = currentCustomerId ? `/api/customers/${currentCustomerId}` : '/api/customers';
                const method = currentCustomerId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone, address, notes })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save customer', 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showNotification('Network error saving customer', 'error');
            }
        }

        // Delete customer
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    
                    // Check if customer has associated data and offer force delete
                    if (error.hasData) {
                        const forceDelete = confirm(
                            `This customer has associated data:\n` +
                            `- ${error.counts.booking_count} bookings\n` +
                            `- ${error.counts.quote_count} quotes\n` +
                            `- ${error.counts.invoice_count} invoices\n\n` +
                            `Do you want to force delete this customer and ALL associated data? This action cannot be undone.`
                        );
                        
                        if (forceDelete) {
                            try {
                                const forceResponse = await fetch(`/api/customers/${customerId}?force=true`, {
                                    method: 'DELETE',
                                    headers: getAuthHeaders()
                                });
                                
                                if (forceResponse.ok) {
                                    const forceResult = await forceResponse.json();
                                    showNotification(forceResult.message, 'success');
                                    loadCustomers();
                                } else {
                                    const forceError = await forceResponse.json();
                                    showNotification(forceError.error || 'Failed to force delete customer', 'error');
                                }
                            } catch (forceError) {
                                console.error('Error force deleting customer:', forceError);
                                showNotification('Network error force deleting customer', 'error');
                            }
                        }
                    } else {
                        showNotification(error.error || 'Failed to delete customer', 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showNotification('Network error deleting customer', 'error');
            }
        }

        // Migrate existing customers
        async function migrateCustomers() {
            if (!confirm('This will migrate existing bookings to create customer profiles. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/customers/migrate', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Migration completed: ${result.processed} customers processed, ${result.errors} errors`, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to migrate customers', 'error');
                }
            } catch (error) {
                console.error('Error migrating customers:', error);
                showNotification('Network error migrating customers', 'error');
            }
        }

        // Close customer modal
        function closeCustomerModal() {
            closeModal('customerModal');
            currentCustomerId = null;
        }

        // Close customer details modal
        function closeCustomerDetailsModal() {
            closeModal('customerDetailsModal');
        }

        // Image Modal Functions
        function showImageModal(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imagePath;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        // Customer Message Modal Functions
        function showCustomerMessageModal(bookingId, customerName, customerEmail) {
            // Populate the modal with customer information
            document.getElementById('messageCustomerName').textContent = customerName;
            document.getElementById('messageCustomerEmail').textContent = customerEmail;
            document.getElementById('messageBookingId').textContent = bookingId;
            
            // Clear previous message content
            document.getElementById('messageContent').value = '';
            
            // Open the modal
            openModal('customerMessageModal');
        }

        function closeCustomerMessageModal() {
            closeModal('customerMessageModal');
        }
        async function sendCustomerMessage() {
            const customerName = document.getElementById('messageCustomerName').textContent;
            const customerEmail = document.getElementById('messageCustomerEmail').textContent;
            const bookingId = document.getElementById('messageBookingId').textContent;
            const subject = document.getElementById('messageSubject').value;
            const messageContent = document.getElementById('messageContent').value;

            if (!messageContent.trim()) {
                showNotification('Please enter a message', 'error');
                return;
            }

            // Get the send button and store original text before any operations
            const sendButton = document.querySelector('#customerMessageModal .btn-primary');
            if (!sendButton) {
                showNotification('Error: Send button not found', 'error');
                return;
            }
            const originalText = sendButton.innerHTML;

            try {
                // Show loading state
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;

                const response = await fetch('/api/bookings/send-customer-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        customerName: customerName,
                        customerEmail: customerEmail,
                        subject: subject,
                        message: messageContent
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Message sent successfully!', 'success');
                    closeCustomerMessageModal();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send message: ${error.message}`, 'error');
                }
            } catch (error) {
                console.error('Error sending customer message:', error);
                let errorMessage = 'Failed to send message. Please try again.';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Reset button state
                if (sendButton) {
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                }
            }
        }

        // Smooth filter tab click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('sidebar-item') || e.target.closest('.sidebar-item')) {
                const sidebarItem = e.target.classList.contains('sidebar-item') ? e.target : e.target.closest('.sidebar-item');
                const filter = sidebarItem.getAttribute('data-filter');
                
                // Prevent multiple rapid clicks
                if (sidebarItem.classList.contains('loading')) return;
                
                // Add loading state to clicked sidebar item
                sidebarItem.classList.add('loading');
                
                // Update active sidebar item
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                    item.classList.remove('loading');
                });
                sidebarItem.classList.add('active');
                
                // Update current filter
                currentFilter = filter;
                
                // Update section title smoothly
                const sectionTitle = document.getElementById('sectionTitle');
                let newTitle = '';
                if (filter === 'all') newTitle = 'Active Bookings';
                else if (filter === 'pending') newTitle = 'Pending Bookings';
                else if (filter === 'all-bookings') newTitle = 'All Bookings';
                else if (filter === 'calendar') newTitle = 'Calendar View';
                else if (filter === 'quick-quote') newTitle = 'Quick Quote Generator';
                else if (filter === 'customers') newTitle = 'Customer Management';
                
                // Smooth title transition
                sectionTitle.style.opacity = '0';
                sectionTitle.style.transform = 'translateY(-5px)';
                
                // Hide all views smoothly first
                const views = ['activeBookingsGrid', 'calendarView', 'quickQuoteView'];
                views.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    view.classList.add('view-hidden');
                });
                
                // Wait for fade out, then show new view
                setTimeout(() => {
                    // Update title
                    sectionTitle.textContent = newTitle;
                    sectionTitle.style.opacity = '1';
                    sectionTitle.style.transform = 'translateY(0)';
                    
                    // Hide all views
                    views.forEach(viewId => {
                        const view = document.getElementById(viewId);
                        view.style.display = 'none';
                        view.classList.remove('view-hidden');
                    });
                    
                                    // Show appropriate view
                let targetView;
                if (filter === 'calendar') {
                    targetView = document.getElementById('calendarView');
                    targetView.style.display = 'block';
                    if (!window.adminCalendar.blockedDates.length) window.adminCalendar.loadBlockedDates();
                    
                    // Debug: Check mobile detection
                    console.log('Calendar view opened - Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 768);
                    window.adminCalendar.renderCalendar(allBookings);
                } else if (filter === 'quick-quote') {
                    targetView = document.getElementById('quickQuoteView');
                    targetView.style.display = 'block';
                } else {
                    targetView = document.getElementById('activeBookingsGrid');
                    targetView.style.display = 'grid';
                    currentFilter = filter;
                    renderActiveBookings();
                }
                    
                    // Trigger smooth entrance animation
                    requestAnimationFrame(() => {
                        targetView.style.opacity = '0';
                        targetView.style.transform = 'translateY(10px)';
                        requestAnimationFrame(() => {
                            targetView.style.opacity = '1';
                            targetView.style.transform = 'translateY(0)';
                        });
                    });
                    
                    // Remove loading state
                    e.target.classList.remove('loading');
                }, 250);
            }
        });

        // Show Email Options Modal
        function showEmailOptions(title, emailContent, customerEmail) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="email-options">
                            <div class="option-section">
                                <h3>ðŸ“§ Send via Email Client</h3>
                                <p>This will open your default email client with the quote content pre-filled.</p>
                                <button class="btn-primary" onclick="sendViaEmailClient('${customerEmail}', 'Quote - ${currentQuoteData.quoteId}', '${emailContent.html.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Open Email Client
                                </button>
                            </div>
                            
                            <div class="option-section">
                                <h3>ðŸ“‹ Copy to Clipboard</h3>
                                <p>Copy the email content to paste into your email client manually.</p>
                                <button class="btn-secondary" onclick="copyEmailContent('${emailContent.html.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Copy HTML Content
                                </button>
                                <button class="btn-secondary" onclick="copyEmailContent('${emailContent.text.replace(/'/g, "\\'")}', '${emailContent.text.replace(/'/g, "\\'")}')">
                                     Copy Text Content
                                </button>
                            </div>
                            
                            <div class="option-section">
                                <h3>ðŸ‘€ Preview Email</h3>
                                <p>See how the email will look to your customers.</p>
                                <button class="btn-info" onclick="previewEmail('${emailContent.html.replace(/'/g, "\\'")}')">
                                    ðŸ‘€ Preview Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Send via Email Client
        function sendViaEmailClient(to, subject, htmlBody, textBody) {
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textBody)}`;
            window.open(mailtoLink);
            
            // Close the modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            showNotification('Email client opened! The quote content is pre-filled.', 'success');
        }

        // Copy Email Content
        function copyEmailContent(content, type) {
            navigator.clipboard.writeText(content).then(() => {
                showNotification(`${type} content copied to clipboard!`, 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification(`${type} content copied to clipboard!`, 'success');
            });
        }

        // Preview Email
        function previewEmail(htmlContent) {
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(htmlContent);
            previewWindow.document.close();
        }

        // Image verification functions removed - now using improved storage system
        
        // Confirm site visit and change status to quote-ready
        async function confirmSiteVisit(bookingId) {
            try {


                
                // Update booking from pending status directly to quote-ready
                const newStatus = 'quote-ready';
                
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                console.log('ðŸ“Š Response status:', response.status);
                console.log('ðŸ“Š Response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.json();
    
                    showNotification('Site visit confirmed. Status changed to Quote Ready.', 'success');
                    
                    // Auto-switch to the quote-ready tab
                    autoSwitchToNextTab('quote-ready');
                    
                    loadBookings();
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Failed to confirm site visit. Status:', response.status);
                    console.error('âŒ Error response:', errorText);
                    
                    let errorMessage = 'Failed to confirm site visit';
                    if (response.status === 401) {
                        errorMessage = 'Authentication failed. Please log in again.';
                    } else if (response.status === 403) {
                        errorMessage = 'Access denied. You may not have permission to perform this action.';
                    } else if (response.status === 404) {
                        errorMessage = 'Booking not found. Please refresh and try again.';
                    } else if (response.status === 500) {
                        errorMessage = 'Server error. Please try again later.';
                    }
                    
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('âŒ Network error confirming site visit:', error);
                showNotification(`Network error: ${error.message}`, 'error');
            }
        }

        // Revert booking status to a previous state with intelligent reversion logic
        async function revertBookingStatus(bookingId, newStatus) {
            try {
                // Get current booking to check current status
                const currentBooking = allBookings.find(b => b.booking_id === bookingId);
                if (!currentBooking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                const currentStatus = currentBooking.status;
                let targetStatus = newStatus;

                // Intelligent status reversion logic
                if (currentStatus === 'completed' && newStatus !== 'completed') {
                    // When reverting from completed, go back to invoice-sent (the status before completion)
                    targetStatus = 'invoice-sent';
                }

                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: targetStatus })
                });

                if (response.ok) {
                    const statusMessage = currentStatus === 'completed' && newStatus !== 'completed' 
                        ? `Booking reverted from completed to ${targetStatus} successfully` 
                        : `Booking status reverted to ${targetStatus} successfully`;
                    showNotification(statusMessage, 'success');
                    
                    // Auto-switch to the appropriate tab for the new status
                    autoSwitchToNextTab(targetStatus);
                    
                    loadBookings(); // Reload to update the display
                    
                    // Explicitly refresh calendar if it's currently visible
                    if (currentFilter === 'calendar') {
                        window.adminCalendar.renderCalendar(allBookings);
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to revert booking status', 'error');
                }
            } catch (error) {
                console.error('Error reverting booking status:', error);
                showNotification('Network error reverting booking status', 'error');
            }
        }

        // Send Quote to Customer
        async function sendQuoteToCustomer(bookingId) {
            try {
                // First check if there's an existing quote for this booking
                let quoteData = null;
                try {
                    const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`, {
                        headers: getAuthHeaders()
                    });
                    if (quoteResponse.ok) {
                        const quotes = await quoteResponse.json();
                        if (quotes.length > 0) {
                            quoteData = quotes[0]; // Use the most recent quote

                        }
                    }
                } catch (error) {
                    console.error('Error checking for existing quotes:', error);
                }

                // If we have quote data, update the booking with the quote information
                if (quoteData) {
                    try {
                        // Calculate total from quote service items
                        let totalAmount = 0;
                        if (quoteData.service_items) {
                            const serviceItems = typeof quoteData.service_items === 'string' 
                                ? JSON.parse(quoteData.service_items) 
                                : quoteData.service_items;
                            
                            serviceItems.forEach(item => {
                                totalAmount += (item.quantity || 0) * (item.price || 0);
                            });
                        }

                        // Update booking with quote information
                        const updateResponse = await fetch(`/api/bookings/${bookingId}/status`, {
                            method: 'PATCH',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({
                                estimated_cost: totalAmount.toFixed(2),
                                work_description: quoteData.work_description || 'Tree service as requested'
                            })
                        });

                        if (!updateResponse.ok) {
                            console.error('Failed to update booking with quote data');
                        }
                    } catch (error) {
                        console.error('Error updating booking with quote data:', error);
                    }
                }

                // Now send the quote email
                const response = await fetch(`/api/bookings/${bookingId}/send-quote`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Quote sent to customer successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send quote to customer', 'error');
                }
            } catch (error) {
                console.error('Error sending quote to customer:', error);
                showNotification('Network error sending quote to customer', 'error');
            }
        }

        // Mark Invoice as Paid
        async function markInvoicePaid(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/mark-paid`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Invoice marked as paid successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to mark invoice as paid', 'error');
                }
            } catch (error) {
                console.error('Error marking invoice as paid:', error);
                showNotification('Network error marking invoice as paid', 'error');
            }
        }





        // Auto-switch to next logical tab based on status update
        function autoSwitchToNextTab(newStatus) {
            let targetFilter = null;
            
            // Map status to the next logical tab
            switch (newStatus) {
                case 'quote-ready':
                    targetFilter = 'quote-ready';
                    break;
                case 'quote-sent':
                    targetFilter = 'quote-sent';
                    break;
                case 'quote-accepted':
                    targetFilter = 'quote-accepted';
                    break;
                case 'pending-booking':
                    targetFilter = 'pending-booking';
                    break;
                case 'invoice-ready':
                    targetFilter = 'invoice-ready';
                    break;
                case 'invoice-sent':
                    targetFilter = 'invoice-sent';
                    break;
                case 'completed':
                    targetFilter = 'completed';
                    break;
                default:
                    return; // Don't switch for other statuses
            }
            
            // Find the corresponding sidebar item and trigger its click
            const sidebarItem = document.querySelector(`.sidebar-item[data-filter="${targetFilter}"]`);
            if (sidebarItem) {
                // Remove active class from all sidebar items
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                
                // Add active class to the target sidebar item
                sidebarItem.classList.add('active');
                
                // Update current filter
                currentFilter = targetFilter;
                
                // Update section title
                updateSectionTitle();
                
                // Show bookings grid (not calendar)
                document.getElementById('activeBookingsGrid').style.display = 'grid';
                document.getElementById('calendarView').style.display = 'none';
                
                // Render filtered bookings
                renderActiveBookings();
                
                // Scroll to bookings section smoothly
                const activeBookingsSection = document.querySelector('.active-bookings-section');
                if (activeBookingsSection) {
                    activeBookingsSection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }

        // ... existing code ...

        // Booking Restrictions Functions
        let customDatePickerCurrentMonth = new Date();
        let selectedCustomDates = [];

        function handleAllowedDaysChange() {
            const allowedDays = document.getElementById('allowedDays').value;
            const customDatesSection = document.getElementById('customDatesSection');
            
            if (allowedDays === 'custom') {
                customDatesSection.style.display = 'block';
            } else {
                customDatesSection.style.display = 'none';
                selectedCustomDates = [];
                updateCustomDatesList();
            }
        }

        function handleJobDurationChange() {
            const jobDuration = document.getElementById('jobDurationDays').value;
            console.log('Job duration changed to:', jobDuration, 'days');
        }

        function openCustomDatePicker() {
            selectedCustomDates = [];
            renderCustomDatePicker();
            openModal('customDatePickerModal');
        }

        function renderCustomDatePicker() {
            const container = document.getElementById('customDatePicker');
            const monthDisplay = document.getElementById('customDateMonth');
            
            const year = customDatePickerCurrentMonth.getFullYear();
            const month = customDatePickerCurrentMonth.getMonth();
            
            monthDisplay.textContent = customDatePickerCurrentMonth.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            container.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'date-picker-day';
                
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (currentDate < new Date()) {
                    dayElement.classList.add('disabled');
                } else {
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    if (isWeekend) {
                        dayElement.classList.add('weekend');
                    }
                    
                    dayElement.onclick = () => toggleCustomDate(currentDate);
                }
                
                dayElement.textContent = currentDate.getDate();
                container.appendChild(dayElement);
            }
            
            updateSelectedDatesCount();
        }

        function toggleCustomDate(date) {
            const dateString = date.toISOString().split('T')[0];
            const index = selectedCustomDates.findIndex(d => d.date === dateString);
            
            if (index === -1) {
                selectedCustomDates.push({
                    date: dateString,
                    isWeekend: date.getDay() === 0 || date.getDay() === 6
                });
            } else {
                selectedCustomDates.splice(index, 1);
            }
            
            updateSelectedDatesCount();
            renderCustomDatePicker();
        }

        function updateSelectedDatesCount() {
            const countElement = document.getElementById('selectedDatesCount');
            countElement.textContent = selectedCustomDates.length;
        }

        function changeCustomDateMonth(direction) {
            customDatePickerCurrentMonth.setMonth(customDatePickerCurrentMonth.getMonth() + direction);
            renderCustomDatePicker();
        }

        function applyCustomDates() {
            updateCustomDatesList();
            closeModal('customDatePickerModal');
        }

        function updateCustomDatesList() {
            const container = document.getElementById('customDatesList');
            
            if (selectedCustomDates.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-style: italic;">No custom dates selected</p>';
                return;
            }
            
            container.innerHTML = selectedCustomDates.map(dateObj => `
                <div class="custom-date-item">
                    <div class="date-info">
                        <span class="date-badge">${dateObj.isWeekend ? 'Weekend' : 'Weekday'}</span>
                        <span>${new Date(dateObj.date).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</span>
                    </div>
                    <button type="button" class="remove-date-btn" onclick="removeCustomDate('${dateObj.date}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCustomDate(dateString) {
            selectedCustomDates = selectedCustomDates.filter(d => d.date !== dateString);
            updateCustomDatesList();
        }

        // Initialize booking restrictions when loading existing quote
        function loadBookingRestrictions(restrictions) {
            if (!restrictions) return;
            
            const allowedDaysSelect = document.getElementById('allowedDays');
            const jobDurationInput = document.getElementById('jobDurationDays');
            
            if (allowedDaysSelect) {
                allowedDaysSelect.value = restrictions.allowed_days || 'weekends';
                handleAllowedDaysChange();
            }
            
            if (jobDurationInput) {
                jobDurationInput.value = restrictions.job_duration_days || 1;
            }
            
            if (restrictions.custom_dates && restrictions.custom_dates.length > 0) {
                selectedCustomDates = restrictions.custom_dates.map(dateStr => ({
                    date: dateStr,
                    isWeekend: new Date(dateStr).getDay() === 0 || new Date(dateStr).getDay() === 6
                }));
                updateCustomDatesList();
            }
        }

    </script>

    <!-- Site Visit Modal -->
    <div id="siteVisitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-check"></i> Complete Site Visit Assessment</h3>
                <button class="modal-close" onclick="closeModal('siteVisitModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="siteVisitForm">
                    <div class="form-group">
                        <label for="workDescription">Work Description</label>
                        <textarea id="workDescription" name="workDescription" rows="4" placeholder="Describe the work to be performed based on your site assessment..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="estimatedCost">Estimated Cost ($)</label>
                        <input type="number" id="estimatedCost" name="estimatedCost" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="siteVisitNotes">Site Visit Notes</label>
                        <textarea id="siteVisitNotes" name="siteVisitNotes" rows="3" placeholder="Additional notes from your site visit..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="recommendedDate">Recommended Date</label>
                        <input type="date" id="recommendedDate" name="recommendedDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recommendedTime">Recommended Time</label>
                        <select id="recommendedTime" name="recommendedTime" required>
                            <option value="">Select time</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:30">6:30 PM</option>
                            <option value="19:30">7:30 PM</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('siteVisitModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="completeSiteVisit()">Complete Assessment</button>
            </div>
        </div>
    </div>
    <!-- Quote Generation Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote</h3>
                <button class="modal-close" onclick="closeModal('quoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <input type="text" id="quoteClientName" placeholder="Full Name" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="quoteClientPhone" placeholder="Phone Number" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="quoteClientAddress" placeholder="Address" required>
                            </div>
                            <div class="form-group">
                                <input type="email" id="quoteClientEmail" placeholder="Email" required>
                            </div>
                            <div class="form-group">
                                <input type="date" id="quoteDate" placeholder="Quote Date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                                    </div>
                                    <div class="item-controls">
                                        <div class="item-quantity">
                                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                                        </div>
                                        <div class="item-price">
                                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                                        </div>
                                        <div class="item-total">
                                            <span class="item-total-amount">$0.00</span>
                                        </div>
                                        <div class="item-actions">
                                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="item-photos-section">
                                    <div class="photo-upload-area" onclick="triggerPhotoUpload(this)">
                                        <div class="photo-upload-content">
                                            <i class="fas fa-file-image"></i>
                                            <span class="photo-upload-text">Photos: Add Photo</span>
                                        </div>
                                    </div>
                                    <div class="photos-container">
                                        <!-- Photos will be displayed here -->
                                    </div>
                                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this)">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="taxToggle" onchange="toggleTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="taxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="grandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Restrictions Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-calendar-alt"></i> Booking Restrictions</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="allowedDays">Allowed Booking Days:</label>
                                <select id="allowedDays" onchange="handleAllowedDaysChange()">
                                    <option value="weekends">Weekends Only (All Day)</option>
                                    <option value="weekdays">Weekdays Only (5:30 PM, 6:30 PM, 7:30 PM)</option>
                                    <option value="both">Both Weekends & Weekdays</option>
                                    <option value="custom">Custom Dates</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="jobDurationDays">Job Duration (Days):</label>
                                <input type="number" id="jobDurationDays" value="1" min="1" max="7" onchange="handleJobDurationChange()">
                                <small>Customer must book this many consecutive days</small>
                            </div>
                        </div>
                        
                        <!-- Custom Dates Section (hidden by default) -->
                        <div id="customDatesSection" style="display: none;">
                            <div class="custom-dates-header">
                                <h5>Custom Available Dates</h5>
                                <button type="button" class="btn-secondary" onclick="openCustomDatePicker()">
                                    <i class="fas fa-calendar-plus"></i> Add Custom Dates
                                </button>
                            </div>
                            <div id="customDatesList" class="custom-dates-list">
                                <!-- Custom dates will be displayed here -->
                            </div>
                        </div>
                        
                        <!-- Booking Restrictions Info -->
                       
                    </div>

                    <!-- Quote Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuote()">
                            <i class="fas fa-save"></i> Save Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Quote Modal -->
    <div id="quickQuoteModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bolt"></i> Quick Quote</h3>
                <button class="modal-close" onclick="closeModal('quickQuoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <input type="text" id="quickQuoteClientName" placeholder="Full Name *" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="quickQuoteClientPhone" placeholder="Phone Number (optional)">
                            </div>
                            <div class="form-group">
                                <input type="text" id="quickQuoteClientAddress" placeholder="Address (optional)">
                            </div>
                            <div class="form-group">
                                <input type="email" id="quickQuoteClientEmail" placeholder="Email (optional)">
                            </div>
                            <div class="form-group">
                                <input type="date" id="quickQuoteDate" placeholder="Quote Date" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="quickQuoteServiceItems" class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                                    </div>
                                    <div class="item-controls">
                                        <div class="item-quantity">
                                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                                        </div>
                                        <div class="item-price">
                                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                                        </div>
                                    </div>
                                    <div class="item-footer">
                                        <div class="item-total">
                                            <span class="item-total-amount">$0.00</span>
                                        </div>
                                        <div class="item-actions">
                                            <button type="button" class="remove-item-btn" onclick="removeQuickQuoteServiceItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="item-photos-section">
                                    <div class="photo-upload-area" onclick="triggerQuickQuotePhotoUpload(this)">
                                        <div class="photo-upload-content">
                                            <i class="fas fa-file-image"></i>
                                            <span class="photo-upload-text">Photos: Add Photo</span>
                                        </div>
                                    </div>
                                    <div class="photos-container">
                                        <!-- Photos will be displayed here -->
                                    </div>
                                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickQuotePhotoUpload(this)">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addQuickQuoteServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="quickQuoteTaxToggle" onchange="toggleQuickQuoteTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="quickQuoteSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="quickQuoteTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="quickQuoteTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="quickQuoteGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Quote Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quickQuoteModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuickQuote()">
                            <i class="fas fa-eye"></i> Generate Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Invoice Modal -->
    <div id="quickInvoiceModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bolt"></i> Quick Invoice</h3>
                <button class="modal-close" onclick="closeModal('quickInvoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <input type="text" id="quickInvoiceClientName" placeholder="Full Name *" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="quickInvoiceClientPhone" placeholder="Phone Number (optional)">
                            </div>
                            <div class="form-group">
                                <input type="text" id="quickInvoiceClientAddress" placeholder="Address (optional)">
                            </div>
                            <div class="form-group">
                                <input type="email" id="quickInvoiceClientEmail" placeholder="Email (optional)">
                            </div>
                            <div class="form-group">
                                <input type="date" id="quickInvoiceDate" placeholder="Invoice Date" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="quickInvoiceServiceItems" class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service or item description" value="">
                                    </div>
                                    <div class="item-controls">
                                        <div class="item-quantity">
                                            <input type="number" class="item-qty-input" value="1" min="1" placeholder="Qty">
                                        </div>
                                        <div class="item-price">
                                            <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="Price">
                                        </div>
                                    </div>
                                    <div class="item-footer">
                                        <div class="item-total">
                                            <span class="item-total-amount">$0.00</span>
                                        </div>
                                        <div class="item-actions">
                                            <button type="button" class="remove-item-btn" onclick="removeQuickInvoiceServiceItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="item-photos-section">
                                    <div class="photo-upload-area" onclick="triggerQuickInvoicePhotoUpload(this)">
                                        <div class="photo-upload-content">
                                            <i class="fas fa-file-image"></i>
                                            <span class="photo-upload-text">Photos: Add Photo</span>
                                        </div>
                                    </div>
                                    <div class="photos-container">
                                        <!-- Photos will be displayed here -->
                                    </div>
                                    <input type="file" class="photo-upload-input" accept="image/*" multiple style="display: none;" onchange="handleQuickInvoicePhotoUpload(this)">
                                </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addQuickInvoiceServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="quickInvoiceTaxToggle" onchange="toggleQuickInvoiceTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="quickInvoiceSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="quickInvoiceTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="quickInvoiceTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="quickInvoiceGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Invoice Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quickInvoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuickInvoice()">
                            <i class="fas fa-eye"></i> Generate Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Quick Actions -->
        <div class="mobile-quick-actions">
            <button class="quick-action-btn refresh-action" onclick="manualRefreshBookings()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Quote Preview Modal -->
    <div id="quotePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Quote Saved Successfully</h3>
                <button class="modal-close" onclick="closeModal('quotePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="quotePreviewContent" class="quote-preview">
                    <!-- Quote content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('quotePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printQuote()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadQuote()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                        <button class="action-btn confirm">
                            <i class="fas fa-paper-plane"></i> Send Quote
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Generation Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="invoiceClientName">Full Name</label>
                                <input type="text" id="invoiceClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientPhone">Phone Number</label>
                                <input type="tel" id="invoiceClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientAddress">Address</label>
                                <input type="text" id="invoiceClientAddress" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientEmail">Email</label>
                                <input type="email" id="invoiceClientEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="invoiceServiceItems" class="service-items-container">
                            <!-- Service items will be populated from quote -->
                        </div>
                        <div class="add-item-container">
                            <button type="button" class="add-item-btn" onclick="addInvoiceServiceItem()">
                                <i class="fas fa-plus"></i> Add Service Item
                            </button>
                        </div>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="invoiceTaxToggle" onchange="toggleInvoiceTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="invoiceTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="invoiceTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="invoiceGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateInvoice()">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Quick Actions -->
        <div class="mobile-quick-actions">
            <button class="quick-action-btn refresh-action" onclick="manualRefreshBookings()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Invoice Created Successfully</h3>
                <button class="modal-close" onclick="closeModal('invoicePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent" class="quote-preview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('invoicePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadInvoice()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                                            <button type="button" class="btn-info" onclick="sendInvoiceEmail(event)">
                            <i class="fas fa-envelope"></i> Send Email
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content photo-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-image"></i> Photo View</h3>
                <button class="modal-close" onclick="closeModal('photoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="photo-display">
                    <img id="modalPhoto" src="" alt="Service item photo" style="max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Image verification functions removed - now using improved storage system
    </script>
    <style>
        /* Image verification styles removed - using improved storage system */
        
        /* Service Item Photo Styles */
        .item-photos-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .photo-upload-area {
            background: rgba(249, 115, 22, 0.1);
            border: 2px dashed #c2410c;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .photo-upload-area:hover {
            background: rgba(249, 115, 22, 0.2);
            border-color: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
        }
        
        .photo-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #c2410c;
        }
        
        .photo-upload-content i {
            font-size: 24px;
            color: #c2410c;
        }
        
        .photo-upload-text {
            font-weight: 600;
            font-size: 14px;
            color: #c2410c;
        }
        
        .photos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            min-height: 40px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .photo-item img:hover {
            transform: scale(1.05);
        }
        
        .delete-photo-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .delete-photo-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        
        .no-photos {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
            text-align: center;
            grid-column: 1 / -1;
            padding: 10px;
        }

        /* Temporary photo styling */
        .temp-photo {
            position: relative;
        }
        
        .temp-photo-label {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(255, 193, 7, 0.9);
            color: #856404;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .temp-photo img {
            opacity: 0.8;
            border: 2px dashed #ffc107;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .photos-container {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .photo-item img {
                height: 60px;
            }
            
            .photo-upload-area {
                padding: 15px;
            }
            
            .photo-upload-content i {
                font-size: 20px;
            }
            
            .photo-upload-text {
                font-size: 12px;
            }
        }

        /* Photo Modal Styles */
        .photo-modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .photo-display {
            text-align: center;
            padding: 20px;
        }
        
        .photo-display img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Custom Date Picker Styles */
        .custom-date-picker-modal .modal-content {
            max-width: 600px;
        }

        .custom-date-picker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-picker-nav {
            display: flex;
            gap: 10px;
        }

        .date-picker-nav button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .date-picker-nav button:hover {
            background: #1a1a1a;
        }

        .date-picker-nav button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .date-picker-month {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .date-picker-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .date-picker-weekday {
            text-align: center;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 12px;
            padding: 8px 0;
        }

        .date-picker-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
        }

        .date-picker-day:hover:not(.disabled) {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .date-picker-day.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .date-picker-day.disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        .date-picker-day.other-month {
            color: #ccc;
        }

        .date-picker-day.weekend {
            background: rgba(140, 198, 63, 0.1);
            border-color: var(--accent-color);
        }

        .date-picker-day.weekend.selected {
            background: var(--accent-color);
            color: white;
        }

        .custom-dates-list {
            margin-top: 15px;
        }

        .custom-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .custom-date-item .date-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-date-item .date-badge {
            background: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .custom-date-item .remove-date-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .custom-date-item .remove-date-btn:hover {
            background: #c82333;
        }

        .restrictions-info {
            margin-top: 20px;
        }

        .info-box {
            display: flex;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
        }

        .info-box i {
            color: var(--info-color);
            font-size: 18px;
            margin-top: 2px;
        }

        .info-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--secondary-color);
        }

        .info-content strong {
            color: var(--primary-color);
        }

        /* Sidebar Layout Styles */
        .main-layout-with-sidebar {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Mobile sidebar - hidden on desktop */
        .mobile-sidebar {
            display: none;
        }

        /* Desktop sidebar - visible on desktop, hidden on mobile */
        .desktop-sidebar {
            display: block;
            width: 250px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
            overflow: hidden;
            flex-shrink: 0;
            height: fit-content;
            order: 2; /* Position on the right */
        }

        .active-bookings-section {
            flex: 1;
            min-width: 0;
        }

        .admin-sidebar {
            width: 250px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
            overflow: hidden;
            flex-shrink: 0;
            height: fit-content;
            order: 2; /* Position on the right */
        }

        .sidebar-header {
            padding: 0.8rem 0.8rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }

        .sidebar-section {
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.8rem;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-section-header:hover {
            background: #e9ecef;
        }

        .section-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
        }

        .section-chevron {
            color: #6c757d;
            transition: transform 0.2s ease;
            font-size: 0.8rem;
        }

        .sidebar-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }

        .sidebar-section-content.expanded {
            max-height: 500px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .sidebar-item:hover {
            background: #f8f9fa;
            border-left-color: #8cc63f;
        }

        .sidebar-item.active {
            background: #e8f5e8;
            border-left-color: #8cc63f;
            color: #2c5530;
        }

        .sidebar-item i {
            width: 20px;
            margin-right: 0.75rem;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .sidebar-item.active i {
            color: #8cc63f;
        }

        .item-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .item-count {
            background: #8cc63f;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            line-height: 1;
        }

        .sidebar-item.active .item-count {
            background: #2c5530;
        }

        /* Loading state for sidebar items */
        .sidebar-item.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .sidebar-item.loading i {
            animation: spin 1s linear infinite;
        }

        .main-content-area {
            flex: 1;
            min-width: 0;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 1024px) {
            .bookings-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .main-layout-with-sidebar {
                flex-direction: column;
                gap: 1rem;
            }

            /* Mobile sidebar positioning */
            .mobile-sidebar {
                display: block;
                width: 100%;
                margin-bottom: 1rem;
                order: 1;
            }

            /* Hide desktop sidebar on mobile */
            .desktop-sidebar {
                display: none;
            }

            .bookings-container {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .bookings-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .main-layout-with-sidebar {
                flex-direction: column;
                gap: 1rem;
            }

            /* Mobile sidebar positioning */
            .mobile-sidebar {
                display: block;
                width: 100%;
                margin-bottom: 1rem;
                order: 1;
            }

            /* Hide desktop sidebar on mobile */
            .desktop-sidebar {
                display: none;
            }

            .bookings-container {
                order: 2;
            }

            .sidebar-section-header {
                padding: 0.75rem 1rem;
            }

            .section-title {
                font-size: 0.85rem;
            }

            .sidebar-item {
                padding: 0.625rem 1rem;
            }

            .item-text {
                font-size: 0.8rem;
            }

            .sidebar-item i {
                width: 18px;
                margin-right: 0.625rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .bookings-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .main-layout-with-sidebar {
                flex-direction: column;
                gap: 1rem;
            }

            /* Mobile sidebar positioning */
            .mobile-sidebar {
                display: block;
                width: 100%;
                margin-bottom: 1rem;
                order: 1;
            }

            /* Hide desktop sidebar on mobile */
            .desktop-sidebar {
                display: none;
            }

            .bookings-container {
                order: 2;
            }

            .sidebar-section-header {
                padding: 0.625rem 0.875rem;
            }

            .section-title {
                font-size: 0.8rem;
            }

            .sidebar-item {
                padding: 0.5rem 0.875rem;
            }

            .item-text {
                font-size: 0.75rem;
            }

            .sidebar-item i {
                width: 16px;
                margin-right: 0.5rem;
                font-size: 0.8rem;
            }
        }

    </style>

    <!-- Custom Date Picker Modal -->
    <div id="customDatePickerModal" class="modal custom-date-picker-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Select Custom Available Dates</h3>
                <button class="modal-close" onclick="closeModal('customDatePickerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-picker-header">
                    <div class="date-picker-nav">
                        <button onclick="changeCustomDateMonth(-1)" id="prevCustomMonth">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="changeCustomDateMonth(1)" id="nextCustomMonth">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="date-picker-month" id="customDateMonth">January 2025</div>
                </div>
                
                <div class="date-picker-weekdays">
                    <div class="date-picker-weekday">Sun</div>
                    <div class="date-picker-weekday">Mon</div>
                    <div class="date-picker-weekday">Tue</div>
                    <div class="date-picker-weekday">Wed</div>
                    <div class="date-picker-weekday">Thu</div>
                    <div class="date-picker-weekday">Fri</div>
                    <div class="date-picker-weekday">Sat</div>
                </div>
                
                <div class="custom-date-picker" id="customDatePicker">
                    <!-- Calendar will be populated here -->
                </div>
                
                <div class="custom-dates-summary">
                    <p><strong>Selected Dates:</strong> <span id="selectedDatesCount">0</span></p>
                    <p><small>Weekends are all day, weekdays are 5:30 PM, 6:30 PM, 7:30 PM only</small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('customDatePickerModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="applyCustomDates()">Apply Selected Dates</button>
            </div>
        </div>
    </div>
    <script>
        // Make the detailed booking details popup globally accessible
        window.showDetailedBookingDetailsPopup = showDetailedBookingDetailsPopup;
        
        // Keep the original function name for backward compatibility
        window.showBookingDetailsPopup = showDetailedBookingDetailsPopup;
        
        // Make the enhanced openModal function globally accessible
        window.openModal = openModal;
        
        // Test function to manually open preview modals
        function testPreviewModals() {
            console.log('ðŸ§ª Testing preview modals...');
            
            // Test quote preview modal
            console.log('ðŸ§ª Testing quote preview modal...');
            const quoteContent = document.getElementById('quotePreviewContent');
            if (quoteContent) {
                quoteContent.innerHTML = '<div style="padding: 20px; text-align: center;"><h3>Test Quote Preview</h3><p>This is a test quote preview modal.</p></div>';
            }
            showQuotePreviewModal();
            
            // Test invoice preview modal after a delay
            setTimeout(() => {
                console.log('ðŸ§ª Testing invoice preview modal...');
                const invoiceContent = document.getElementById('invoicePreviewContent');
                if (invoiceContent) {
                    invoiceContent.innerHTML = '<div style="padding: 20px; text-align: center;"><h3>Test Invoice Preview</h3><p>This is a test invoice preview modal.</p></div>';
                }
                showInvoicePreviewModal();
            }, 2000);
        }
        
        // Make test function globally accessible
        window.testPreviewModals = testPreviewModals;
        
        // Simple functions to show preview modals
        function showQuotePreviewModal() {
            console.log('ðŸŽ¯ showQuotePreviewModal called');
            const modal = document.getElementById('quotePreviewModal');
            if (modal) {
                // Force the modal to be visible
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.4)';
                
                // Ensure the modal content is visible
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.display = 'flex';
                    modalContent.style.flexDirection = 'column';
                    modalContent.style.visibility = 'visible';
                    modalContent.style.opacity = '1';
                    modalContent.style.background = 'white';
                    modalContent.style.borderRadius = '8px';
                    modalContent.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.3)';
                    modalContent.style.maxHeight = '90vh';
                    modalContent.style.overflowY = 'auto';
                    modalContent.style.width = '90%';
                    modalContent.style.maxWidth = '800px';
                    modalContent.style.minWidth = '400px';
                    modalContent.style.margin = 'auto';
                    modalContent.style.padding = '0';
                }
                
                // Ensure the preview content is visible
                const previewContent = document.getElementById('quotePreviewContent');
                if (previewContent) {
                    previewContent.style.display = 'block';
                    previewContent.style.visibility = 'visible';
                    previewContent.style.opacity = '1';
                    previewContent.style.background = 'white';
                    previewContent.style.padding = '1.5rem';
                    previewContent.style.borderRadius = '8px';
                    previewContent.style.border = '1px solid #e1e8ed';
                    previewContent.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    previewContent.style.marginBottom = '1rem';
                }
                
                document.body.classList.add('modal-open');
                console.log('ðŸŽ¯ Quote preview modal should now be visible');
            } else {
                console.error('ðŸŽ¯ quotePreviewModal not found!');
            }
        }
        
        function showInvoicePreviewModal() {
            console.log('ðŸŽ¯ showInvoicePreviewModal called');
            const modal = document.getElementById('invoicePreviewModal');
            if (modal) {
                // Force the modal to be visible
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.4)';
                
                // Ensure the modal content is visible
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.display = 'flex';
                    modalContent.style.flexDirection = 'column';
                    modalContent.style.visibility = 'visible';
                    modalContent.style.opacity = '1';
                    modalContent.style.background = 'white';
                    modalContent.style.borderRadius = '8px';
                    modalContent.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.3)';
                    modalContent.style.maxHeight = '90vh';
                    modalContent.style.overflowY = 'auto';
                    modalContent.style.width = '90%';
                    modalContent.style.maxWidth = '800px';
                    modalContent.style.minWidth = '400px';
                    modalContent.style.margin = 'auto';
                    modalContent.style.padding = '0';
                }
                
                // Ensure the preview content is visible
                const previewContent = document.getElementById('invoicePreviewContent');
                if (previewContent) {
                    previewContent.style.display = 'block';
                    previewContent.style.visibility = 'visible';
                    previewContent.style.opacity = '1';
                    previewContent.style.background = 'white';
                    previewContent.style.padding = '1.5rem';
                    previewContent.style.borderRadius = '8px';
                    previewContent.style.border = '1px solid #e1e8ed';
                    previewContent.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    previewContent.style.marginBottom = '1rem';
                }
                
                document.body.classList.add('modal-open');
                console.log('ðŸŽ¯ Invoice preview modal should now be visible');
            } else {
                console.error('ðŸŽ¯ invoicePreviewModal not found!');
            }
        }
        
        // Make the functions globally accessible
        window.showQuotePreviewModal = showQuotePreviewModal;
        window.showInvoicePreviewModal = showInvoicePreviewModal;
        
        // Ultra-simple test function
        function testSimpleModal() {
            console.log('ðŸ§ª Testing ultra-simple modal...');
            const modal = document.getElementById('invoicePreviewModal');
            if (modal) {
                // Remove all classes and styles first
                modal.className = '';
                modal.style.cssText = '';
                
                // Set the most basic possible styles
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.backgroundColor = 'red'; // Make it obvious
                modal.style.zIndex = '99999';
                modal.style.display = 'block';
                
                console.log('ðŸ§ª Modal should now be a red screen covering everything');
                
                // Set some content
                const content = document.getElementById('invoicePreviewContent');
                if (content) {
                    content.innerHTML = '<h1 style="color: white; text-align: center; margin-top: 50vh;">TEST MODAL IS WORKING!</h1>';
                    content.style.cssText = '';
                    content.style.color = 'white';
                    content.style.fontSize = '24px';
                    content.style.textAlign = 'center';
                    content.style.marginTop = '50vh';
                }
            }
        }
        
        window.testSimpleModal = testSimpleModal;
        
        // Create a completely new modal dynamically
        function createNewPreviewModal(type, content) {
            console.log('ðŸ§ª Creating new preview modal for type:', type);
            
            // Remove any existing dynamic modal
            const existingModal = document.getElementById('dynamicPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create new modal element
            const modal = document.createElement('div');
            modal.id = 'dynamicPreviewModal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                z-index: 99999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white !important;
                border-radius: 8px !important;
                padding: 2rem !important;
                max-width: 800px !important;
                width: 90% !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            `;
            
            // Create header
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 1rem !important;
                padding-bottom: 1rem !important;
                border-bottom: 1px solid #e1e8ed !important;
            `;
            
            const title = document.createElement('h3');
            title.textContent = type === 'quote' ? 'Quote Saved Successfully' : 'Invoice Created Successfully';
            title.style.cssText = 'margin: 0 !important; color: #333 !important;';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                background: none !important;
                border: none !important;
                font-size: 24px !important;
                cursor: pointer !important;
                color: #666 !important;
                padding: 0 !important;
                width: 30px !important;
                height: 30px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            closeBtn.onclick = () => modal.remove();
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            
            // Create content area
            const contentArea = document.createElement('div');
            contentArea.innerHTML = content;
            contentArea.style.cssText = 'margin-bottom: 1rem !important;';
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.style.cssText = `
                display: flex !important;
                gap: 1rem !important;
                justify-content: center !important;
                flex-wrap: wrap !important;
            `;
            
            const doneBtn = document.createElement('button');
            doneBtn.textContent = 'Done';
            doneBtn.style.cssText = `
                background: #6c757d !important;
                color: white !important;
                border: none !important;
                padding: 0.75rem 1.5rem !important;
                border-radius: 4px !important;
                cursor: pointer !important;
            `;
            doneBtn.onclick = () => modal.remove();
            
            const printBtn = document.createElement('button');
            printBtn.textContent = 'Print';
            printBtn.style.cssText = `
                background: #007bff !important;
                color: white !important;
                border: none !important;
                padding: 0.75rem 1.5rem !important;
                border-radius: 4px !important;
                cursor: pointer !important;
            `;
            printBtn.onclick = () => {
                if (type === 'quote') {
                    printQuickQuote(content);
                } else {
                    printQuickInvoice(content);
                }
            };
            
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download PDF';
            downloadBtn.style.cssText = `
                background: #28a745 !important;
                color: white !important;
                border: none !important;
                padding: 0.75rem 1.5rem !important;
                border-radius: 4px !important;
                cursor: pointer !important;
            `;
            downloadBtn.onclick = () => {
                if (type === 'quote') {
                    downloadQuickQuotePDF(content);
                } else {
                    downloadQuickInvoicePDF(content);
                }
            };
            
            actions.appendChild(doneBtn);
            actions.appendChild(printBtn);
            actions.appendChild(downloadBtn);
            
            // Assemble modal
            modalContent.appendChild(header);
            modalContent.appendChild(contentArea);
            modalContent.appendChild(actions);
            modal.appendChild(modalContent);
            
            // Add to page
            document.body.appendChild(modal);
            
            console.log('ðŸ§ª New dynamic modal created and added to page');
        }
        
        window.createNewPreviewModal = createNewPreviewModal;
        
        // Make renderActiveBookings globally accessible for archive functionality
        window.renderActiveBookings = renderActiveBookings;
        
        // Make updateStatistics globally accessible for archive functionality
        window.updateStatistics = updateStatistics;
        
        // Make autoSwitchToNextTab globally accessible for archive functionality
        window.autoSwitchToNextTab = autoSwitchToNextTab;
        
        // Make currentFilter globally accessible for archive functionality
        window.currentFilter = currentFilter;
        
        // Make updateSectionTitle globally accessible for archive functionality
        window.updateSectionTitle = updateSectionTitle;
        
        
    </script>
</body>
</html> 