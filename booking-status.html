<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Status - Stellar Tree Management</title>
    <link rel="icon" type="image/x-icon" href="images/logo.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Booking Status Page Styles */
        :root {
            --primary-color: #2a2a2a;
            --accent-color: #8cc63f;
            --secondary-color: #5a5a5a;
            --bg-color: #f8f9fa;
            --text-color: #2a2a2a;
            --light-gray: #f8fafc;
            --border-color: #e5e7eb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, var(--bg-color) 0%, #ffffff 100%);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .booking-status-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .booking-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .booking-header p {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .status-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .booking-id {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-badge.confirmed {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .status-badge.pending-site-visit {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-badge.quote-ready {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, 0.3);
        }

        .status-badge.completed {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, 0.3);
        }

        .status-badge.invoice-ready {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, 0.3);
        }

        .status-badge.invoice-sent {
            background: rgba(108, 117, 125, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        .status-badge.pending-booking {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-badge.cancelled {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .invoice-details {
            background: rgba(23, 162, 184, 0.05);
            border: 2px solid rgba(23, 162, 184, 0.2);
            border-radius: 16px;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .invoice-sent-details {
            background: rgba(108, 117, 125, 0.05);
            border: 2px solid rgba(108, 117, 125, 0.2);
            border-radius: 16px;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .invoice-actions {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(23, 162, 184, 0.1);
        }

        .job-completion-notice {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .job-completion-notice h3 {
            margin: 0 0 0.75rem 0;
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .job-completion-notice p {
            margin: 0;
            font-size: 1.1rem;
            opacity: 0.95;
            line-height: 1.5;
        }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Booking Restrictions Styles */
        .booking-restrictions-info {
            margin: 2rem 0;
        }

        .info-box {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--accent-color);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(140, 198, 63, 0.1);
        }

        .info-box i {
            color: var(--accent-color);
            font-size: 24px;
            margin-top: 5px;
        }

        .info-content h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .info-content p {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            line-height: 1.6;
        }

        .restrictions-detail {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid var(--accent-color);
        }

        .restrictions-detail strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .restrictions-detail .highlight {
            color: var(--accent-color);
            font-weight: 600;
        }

        .detail-item {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent-color);
        }

        .detail-item h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .detail-item p {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary-color);
            margin: 0;
        }

        .timeline {
            margin: 2rem 0;
            position: relative;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 3rem;
            bottom: -1.5rem;
            width: 1px;
            background: var(--border-color);
            transform: translateX(-50%);
        }

        .timeline-dot {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .timeline-dot:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .timeline-dot.pending {
            background: var(--warning-color);
        }

        .timeline-dot.confirmed {
            background: var(--success-color);
        }

        .timeline-dot.site-visit {
            background: #ffc107;
        }

        .timeline-dot.quote-ready {
            background: #17a2b8;
        }

        .timeline-dot.completed {
            background: var(--info-color);
        }

        .timeline-dot.pending-booking {
            background: var(--warning-color);
        }

        .timeline-dot.cancelled {
            background: var(--danger-color);
        }

        .timeline-dot.invoice-ready {
            background: #17a2b8;
        }

        .timeline-dot.invoice-sent {
            background: #6c757d;
        }

        .timeline-dot.quote-sent {
            background: #17a2b8;
        }

        .timeline-dot.quote-accepted {
            background: #28a745;
        }

        .timeline-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 0 0.5rem 0;
        }

        .timeline-content p {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin: 0;
        }

        .timeline-content {
            transition: all 0.3s ease;
        }

        .timeline-item:hover .timeline-content {
            transform: translateX(5px);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 48px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: #7ab32e;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .contact-info {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }

        .contact-info h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .contact-info p {
            font-size: 1rem;
            color: var(--secondary-color);
            margin: 0.5rem 0;
        }

        .invoice-details {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid var(--accent-color);
        }

        .invoice-details h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .invoice-info {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }

        .invoice-info p {
            font-size: 1rem;
            color: var(--secondary-color);
            margin: 0.75rem 0;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .invoice-info p:last-child {
            border-bottom: none;
        }

        .invoice-info strong {
            color: var(--primary-color);
        }

        .contact-info a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }

        .contact-info a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--primary-color);
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: var(--danger-color);
        }

        .invoice-actions p {
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .quote-details {
            text-align: center;
            padding: 2rem;
            background: var(--light-gray);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .quote-preview-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .quote-preview-container h3 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        .quote-preview-container h3 i {
            color: var(--accent-color);
            margin-right: 0.5rem;
        }

        .quote-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 12px;
            background: var(--light-gray);
            transition: all 0.3s ease;
            user-select: none;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: #7ab32f;
            transform: scale(1.05);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn i {
            transition: transform 0.3s ease;
        }

        .refresh-btn.refreshing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }



        /* Message Notifications */
        .message-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .message-notification.success {
            background: var(--success-color);
            color: white;
        }

        .message-notification.error {
            background: var(--danger-color);
            color: white;
        }

        .message-notification .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .message-notification .notification-content i {
            font-size: 1.2rem;
        }

        .quote-preview-header:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .quote-preview-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .toggle-icon {
            font-size: 1.2rem;
            color: var(--accent-color);
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .quote-preview-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .quote-preview-content.expanded {
            max-height: 2000px;
        }

        .quote-preview-header::after {
            content: 'Click to expand';
            font-size: 0.8rem;
            color: var(--secondary-color);
            font-weight: 400;
            opacity: 0.7;
        }

        .quote-preview-header.expanded::after {
            content: 'Click to collapse';
        }

        .quote-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Professional Quote Document Styling - Exact Match to Admin Panel */
        .quote-document {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            font-size: 12px;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .quote-header {
            background: white;
            color: #333;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #8cc63f;
        }

        .company-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .company-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 4px;
        }

        .company-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 10px 0;
            letter-spacing: 0.3px;
        }

        .company-contact {
            margin-top: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 11px;
            color: #666;
        }

        .contact-item i {
            width: 12px;
            color: #8cc63f;
            text-align: center;
        }

        .document-info {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .document-type {
            font-size: 22px;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 8px;
            letter-spacing: 1.2px;
        }

        .document-number {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
        }

        .document-date {
            font-size: 12px;
            color: #666;
        }

        .client-billing-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 24px;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin: 24px;
        }

        .section-heading {
            font-size: 15px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: #2c3e50;
            border-bottom: 2px solid #8cc63f;
            padding-bottom: 6px;
        }

        .data-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
            min-height: 16px;
        }

        .data-row .label {
            font-weight: 600;
            min-width: 70px;
            color: #555;
            font-size: 11px;
            flex-shrink: 0;
        }

        .data-row .value {
            flex: 1;
            color: #333;
            font-size: 11px;
            word-wrap: break-word;
        }

        .services-section {
            padding: 24px;
        }

        .services-table {
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            display: grid;
            grid-template-columns: 40px 1fr 60px 90px 90px;
            background: #2c3e50;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        .header-item {
            padding: 12px 10px;
            text-align: left;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-item:last-child {
            border-right: none;
        }

        .table-body {
            background: white;
        }

        .table-row {
            display: grid;
            grid-template-columns: 40px 1fr 60px 90px 90px;
            border-bottom: 1px solid #e1e8ed;
            font-size: 11px;
            min-height: 40px;
        }

        .table-row:nth-child(even) {
            background: #f8f9fa;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-cell {
            padding: 12px 10px;
            display: flex;
            align-items: center;
            border-right: 1px solid #e1e8ed;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell.description {
            font-weight: 500;
        }

        .table-cell.quantity {
            justify-content: center;
        }

        .table-cell.price, .table-cell.total {
            justify-content: flex-end;
            font-weight: 600;
        }

        .totals-section {
            padding: 0 24px 24px;
            display: flex;
            justify-content: flex-end;
        }

        .totals-container {
            width: 240px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            align-items: center;
            min-height: 20px;
        }

        .total-row.grand-total {
            border-top: 2px solid #8cc63f;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 15px;
            font-weight: 700;
            color: #2c3e50;
        }

        .total-label {
            font-weight: 600;
        }

        .total-value {
            font-weight: 600;
        }

        .terms-section {
            padding: 24px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
        }

        .terms-content p {
            margin: 0;
            font-size: 10px;
            color: #666;
            line-height: 1.3;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .booking-status-container {
                padding: 1rem;
            }

            .booking-header h1 {
                font-size: 2rem;
            }

            .booking-header p {
                font-size: 1rem;
            }

            .status-card {
                padding: 1.5rem;
                border-radius: 16px;
            }

            .status-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .booking-details {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .detail-item {
                padding: 1rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 1rem 1.5rem;
            }

            .timeline-item {
                margin-bottom: 1rem;
            }

            .timeline-dot {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1rem;
                margin-right: 1rem;
            }

            .timeline-content h4 {
                font-size: 1rem;
            }

            .timeline-content p {
                font-size: 0.85rem;
            }

            /* Quote Preview Mobile Styles */
            .quote-preview-container {
                padding: 1rem;
                margin: 1rem 0;
            }

            .quote-document {
                font-size: 10px;
                max-width: 100%;
                margin: 0;
            }

            .quote-header {
                padding: 16px;
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .company-brand {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .company-logo {
                width: 40px;
                height: 40px;
            }

            .company-name {
                font-size: 18px;
            }

            .company-contact {
                margin-top: 8px;
            }

            .contact-item {
                font-size: 10px;
                margin-bottom: 4px;
            }

            .document-info {
                text-align: left;
                align-items: flex-start;
            }

            .document-type {
                font-size: 20px;
            }

            .document-number {
                font-size: 14px;
            }

            .document-date {
                font-size: 11px;
            }

            .client-billing-section {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
                margin: 16px;
            }

            .section-heading {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .data-row {
                margin-bottom: 6px;
                min-height: 14px;
            }

            .data-row .label {
                min-width: 60px;
                font-size: 10px;
            }

            .data-row .value {
                font-size: 10px;
            }

            .services-section {
                padding: 16px;
            }

            .services-table {
                margin-top: 8px;
            }

            .table-header,
            .table-row {
                grid-template-columns: 35px 1fr 50px 70px 70px;
                min-width: 400px;
            }

            .header-item,
            .table-cell {
                padding: 8px 6px;
                font-size: 10px;
            }

            .totals-section {
                padding: 0 16px 16px;
            }

            .totals-container {
                width: 200px;
                padding: 12px;
            }

            .total-row {
                margin-bottom: 6px;
                font-size: 11px;
                min-height: 18px;
            }

            .total-row.grand-total {
                font-size: 14px;
                padding-top: 8px;
                margin-top: 8px;
            }

            .terms-section {
                padding: 16px;
            }

            .terms-content p {
                font-size: 9px;
            }

            .quote-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .quote-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .booking-header h1 {
                font-size: 1.8rem;
            }

            .status-card {
                padding: 1rem;
            }

            .detail-item {
                padding: 0.75rem;
            }

            .detail-item h3 {
                font-size: 0.8rem;
            }

            .detail-item p {
                font-size: 1rem;
            }

            .timeline-dot {
                width: 2rem;
                height: 2rem;
                font-size: 0.9rem;
                margin-right: 0.75rem;
            }

            .timeline-content h4 {
                font-size: 0.9rem;
            }

            .timeline-content p {
                font-size: 0.8rem;
            }
        }


    </style>
</head>
<body>
    <div class="booking-status-container">
        <div class="booking-header">
            <h1>Booking Status</h1>
            <p>Track your service request with Stellar Tree Management</p>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading booking details...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <p>Booking not found or access denied.</p>
        </div>

        <div id="booking-content" style="display: none;">
            <div class="status-card">
                <div class="status-header">
                    <div class="booking-id" id="booking-id"></div>
                    <div class="status-badge" id="status-badge"></div>
                </div>

                <div class="booking-details">
                    <div class="detail-item">
                        <h3>Service</h3>
                        <p id="service"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Date</h3>
                        <p id="date"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Time</h3>
                        <p id="time"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Customer</h3>
                        <p id="customer"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Phone</h3>
                        <p id="phone"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Email</h3>
                        <p id="email"></p>
                    </div>
                    <div class="detail-item">
                        <h3>Address</h3>
                        <p id="address"></p>
                    </div>
                </div>

                <div class="timeline">
                    <h3>Booking Timeline</h3>
                    <div class="timeline-item">
                        <div class="timeline-dot pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Request Received</h4>
                            <p>Your service request has been received and is being reviewed.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="site-visit-timeline" style="display: none;">
                        <div class="timeline-dot site-visit">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Site Visit Scheduled</h4>
                            <p>Our team will conduct an on-site assessment to provide an accurate estimate.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="quote-ready-timeline" style="display: none;">
                        <div class="timeline-dot quote-ready">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Quote Ready</h4>
                            <p>Your detailed quote has been prepared based on the site visit assessment.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="quote-sent-timeline" style="display: none;">
                        <div class="timeline-dot quote-sent">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Quote Sent</h4>
                            <p>Your detailed quote has been sent. Please review and accept if you're satisfied.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="quote-accepted-timeline" style="display: none;">
                        <div class="timeline-dot quote-accepted">
                            <i class="fas fa-thumbs-up"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Quote Accepted</h4>
                            <p>Thank you for accepting our quote! You're now being redirected to schedule your job.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="confirmed-timeline" style="display: none;">
                        <div class="timeline-dot confirmed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Request Booking</h4>
                            <p>Your estimate has been confirmed. Please confirm your booking below.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="pending-booking-timeline" style="display: none;">
                        <div class="timeline-dot pending-booking">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Job Scheduled</h4>
                            <p>Your job has been scheduled and is being reviewed by our team.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="completed-timeline" style="display: none;">
                        <div class="timeline-dot completed">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Work Completed</h4>
                            <p>Your tree service work has been completed successfully.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="invoice-ready-timeline" style="display: none;">
                        <div class="timeline-dot invoice-ready">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Invoice Ready</h4>
                            <p>Your job is complete and ready for invoicing.</p>
                        </div>
                    </div>
                    <div class="timeline-item" id="invoice-sent-timeline" style="display: none;">
                        <div class="timeline-dot invoice-sent">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Invoice Sent</h4>
                            <p>Your invoice has been sent and is awaiting payment.</p>
                        </div>
                    </div>
                </div>

                <!-- Quote Preview Section -->
                <div id="quote-preview-section" style="display: none;">
                    <div class="quote-preview-container">
                        <div class="quote-preview-header" onclick="toggleQuotePreview()">
                            <h3><i class="fas fa-file-invoice-dollar"></i> Quote Preview</h3>
                            <i class="fas fa-chevron-down toggle-icon" id="quote-toggle-icon"></i>
                        </div>
                        <div class="quote-preview-content" id="quote-preview-content">
                            <div class="quote-document">
                                <!-- Header Section -->
                                <div class="quote-header">
                                    <div class="company-brand">
                                        <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                                        <div>
                                            <h1 class="company-name">Stellar Tree Management</h1>
                                            <div class="company-contact">
                                                <div class="contact-item">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                    <span>1932 9a Ave NE, Calgary, Alberta</span>
                                                </div>
                                                <div class="contact-item">
                                                    <i class="fas fa-phone"></i>
                                                    <span>(250) 551-1021</span>
                                                </div>
                                                <div class="contact-item">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>stellartmanagement@outlook.com</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-type">QUOTE</div>
                                        <div class="document-number">#<span id="quote-number"></span></div>
                                        <div class="document-date"><span id="quote-date"></span></div>
                                    </div>
                                </div>

                                <!-- Client & Bill To Section -->
                                <div class="client-billing-section">
                                    <div>
                                        <h3 class="section-heading">Client Information</h3>
                                        <div class="data-row">
                                            <span class="label">Name:</span>
                                            <span class="value" id="quote-client-name"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Phone:</span>
                                            <span class="value" id="quote-client-phone"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Email:</span>
                                            <span class="value" id="quote-client-email"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Address:</span>
                                            <span class="value" id="quote-client-address"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="section-heading">Bill To</h3>
                                        <div class="data-row">
                                            <span class="label">Name:</span>
                                            <span class="value" id="quote-bill-name"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Address:</span>
                                            <span class="value" id="quote-bill-address"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Services Table -->
                                <div class="services-section">
                                    <h3 class="section-heading">Services</h3>
                                    <div class="services-table">
                                        <div class="table-header">
                                            <div class="header-item">#</div>
                                            <div class="header-item description">Description</div>
                                            <div class="header-item quantity">Qty</div>
                                            <div class="header-item price">Unit Price</div>
                                            <div class="header-item total">Total</div>
                                        </div>
                                        <div class="table-body" id="quote-services-body">
                                            <!-- Services will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Totals Section -->
                                <div class="totals-section">
                                    <div class="totals-container">
                                        <div class="total-row">
                                            <span class="total-label">Subtotal:</span>
                                            <span class="total-value" id="quote-subtotal"></span>
                                        </div>
                                        <div class="total-row" id="quote-tax-row" style="display: none;">
                                            <span class="total-label">Tax (5%):</span>
                                            <span class="total-value" id="quote-tax"></span>
                                        </div>
                                        <div class="total-row grand-total">
                                            <span class="total-label">Total:</span>
                                            <span class="total-value" id="quote-total"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Terms Section -->
                                <div class="terms-section">
                                    <h3 class="section-heading">Terms & Conditions</h3>
                                    <div class="terms-content">
                                        <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept cash, check, and major credit cards.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="quote-actions">
                                <button class="btn btn-primary" onclick="downloadQuote()">
                                    <i class="fas fa-download"></i> Download Quote
                                </button>
                                <button class="btn btn-secondary" onclick="printQuote()">
                                    <i class="fas fa-print"></i> Print Quote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Preview Section -->
                <div id="invoice-preview-section" style="display: none;">
                    <div class="quote-preview-container">
                        <div class="quote-preview-header">
                            <div class="header-left" onclick="toggleInvoicePreview()">
                                <h3><i class="fas fa-file-invoice"></i> Invoice Preview</h3>
                                <i class="fas fa-chevron-down toggle-icon" id="invoice-toggle-icon"></i>
                            </div>
                            <div class="header-right">
                                <button class="refresh-btn" onclick="refreshInvoicePreview(window.currentBookingData?.booking_id)" title="Refresh Invoice">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="quote-preview-content" id="invoice-preview-content">
                            <div class="quote-document">
                                <!-- Header Section -->
                                <div class="quote-header">
                                    <div class="company-brand">
                                        <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                                        <div>
                                            <h1 class="company-name">Stellar Tree Management</h1>
                                            <div class="company-contact">
                                                <div class="contact-item">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                    <span>1932 9a Ave NE, Calgary, Alberta</span>
                                                </div>
                                                <div class="contact-item">
                                                    <i class="fas fa-phone"></i>
                                                    <span>(250) 551-1021</span>
                                                </div>
                                                <div class="contact-item">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>stellartmanagement@outlook.com</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-type">INVOICE</div>
                                        <div class="document-number">#<span id="invoice-number"></span></div>
                                        <div class="document-date"><span id="invoice-date"></span></div>
                                    </div>
                                </div>

                                <!-- Client & Bill To Section -->
                                <div class="client-billing-section">
                                    <div>
                                        <h3 class="section-heading">Client Information</h3>
                                        <div class="data-row">
                                            <span class="label">Name:</span>
                                            <span class="value" id="invoice-client-name"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Phone:</span>
                                            <span class="value" id="invoice-client-phone"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Email:</span>
                                            <span class="value" id="invoice-client-email"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Address:</span>
                                            <span class="value" id="invoice-client-address"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="section-heading">Bill To</h3>
                                        <div class="data-row">
                                            <span class="label">Name:</span>
                                            <span class="value" id="invoice-bill-name"></span>
                                        </div>
                                        <div class="data-row">
                                            <span class="label">Address:</span>
                                            <span class="value" id="invoice-bill-address"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Services Table -->
                                <div class="services-section">
                                    <h3 class="section-heading">Services</h3>
                                    <div class="services-table">
                                        <div class="table-header">
                                            <div class="header-item">#</div>
                                            <div class="header-item description">Description</div>
                                            <div class="header-item quantity">Qty</div>
                                            <div class="header-item price">Unit Price</div>
                                            <div class="header-item total">Total</div>
                                        </div>
                                        <div class="table-body" id="invoice-services-body">
                                            <!-- Services will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Totals Section -->
                                <div class="totals-section">
                                    <div class="totals-container">
                                        <div class="total-row">
                                            <span class="total-label">Subtotal:</span>
                                            <span class="total-value" id="invoice-subtotal"></span>
                                        </div>
                                        <div class="total-row" id="invoice-tax-row" style="display: none;">
                                            <span class="total-label">Tax (5%):</span>
                                            <span class="total-value" id="invoice-tax"></span>
                                        </div>
                                        <div class="total-row grand-total">
                                            <span class="total-label">Total:</span>
                                            <span class="total-value" id="invoice-total"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Terms Section -->
                                <div class="terms-section">
                                    <div class="terms-content">
                                        <p><strong>Payment Terms:</strong> Payment is due within 30 days of invoice date.</p>
                                        <p><strong>Payment Methods:</strong> We accept credit cards, bank transfers, and cash payments.</p>
                                        <p><strong>Contact:</strong> For payment arrangements or questions, please contact us at stellartmanagement@outlook.com</p>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="quote-actions">
                                    <button class="btn btn-primary" onclick="downloadInvoice()">
                                        <i class="fas fa-download"></i> Download Invoice
                                    </button>
                                    <button class="btn btn-secondary" onclick="printInvoice()">
                                        <i class="fas fa-print"></i> Print Invoice
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" id="action-buttons">
                    <!-- Action buttons will be populated by JavaScript -->
                </div>
            </div>

            <div class="contact-info">
                <h3>Need Help?</h3>
                <p>If you have any questions about your booking, please contact us:</p>
                <p><i class="fas fa-phone"></i> <a href="tel:+2505511021">+1 (234) 567-890</a></p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:stellartmanagement@outlook.com">stellartmanagement@outlook.com</a></p>
            </div>
            
            <!-- Debug section for testing -->

        </div>
    </div>

    <script>
        // Get booking ID from URL
        function getBookingIdFromUrl() {
            const path = window.location.pathname;
            
            // Handle both /booking-status/:id and /:id patterns
            if (path.startsWith('/booking-status/')) {
                return path.split('/').pop();
            } else if (path !== '/' && path !== '/index.html') {
                // Extract booking ID from path like /ST-ABC123
                const segments = path.split('/').filter(segment => segment.length > 0);
                if (segments.length > 0) {
                    const potentialId = segments[segments.length - 1];
                    // Check if it looks like a booking ID
                    if (potentialId.startsWith('ST-') || /^[A-Z0-9-]+$/.test(potentialId)) {
                        return potentialId;
                    }
                }
            }
            
            // Try to get from query parameters as fallback
            const urlParams = new URLSearchParams(window.location.search);
            const queryParamId = urlParams.get('id');
            if (queryParamId) {
                return queryParamId;
            }
            
            // Try to get from 'booking' parameter (for quote emails)
            const bookingParamId = urlParams.get('booking');
            if (bookingParamId) {
                return bookingParamId;
            }
            
            // Try to get from localStorage as final fallback (for local file navigation)
            const localStorageId = localStorage.getItem('currentBookingId');
            if (localStorageId) {
                return localStorageId;
            }
            
            return null;
        }

        // Load booking details
        async function loadBookingDetails() {
            const bookingId = getBookingIdFromUrl();
            
            console.log('Extracted booking ID:', bookingId);
            console.log('Current URL:', window.location.href);
            console.log('Current pathname:', window.location.pathname);
            
            if (!bookingId) {
                showError('No booking ID provided. Please check the URL and try again.');
                return;
            }

            try {
                console.log('Fetching booking details for ID:', bookingId);
                const response = await fetch(`/api/bookings/${bookingId}`);
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Booking not found. Please check the booking ID and try again.');
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                const booking = await response.json();
                console.log('Booking data received:', booking);
                displayBookingDetails(booking);
            } catch (error) {
                console.error('Error loading booking:', error);
                showError(error.message || 'Failed to load booking details. Please try again later.');
            }
        }

        // Display booking details
        function displayBookingDetails(booking) {
            console.log('📋 Displaying booking details:', booking);
            console.log('🎯 Current status:', booking.status);
            
            // Store current booking data globally for other functions to access
            window.currentBookingData = booking;
            
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('booking-content').style.display = 'block';

            // Populate booking details
            document.getElementById('booking-id').textContent = booking.booking_id;
            document.getElementById('service').textContent = booking.service;
            document.getElementById('date').textContent = new Date(booking.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('time').textContent = booking.time;
            document.getElementById('customer').textContent = booking.name;
            document.getElementById('phone').textContent = booking.phone || 'N/A';
            document.getElementById('email').textContent = booking.email || 'N/A';
            document.getElementById('address').textContent = booking.address || 'N/A';

            // Update status badge
            const statusBadge = document.getElementById('status-badge');
            let displayStatus = booking.status;
            
            // For customer view, treat 'completed' as 'invoice-ready'
            if (booking.status === 'completed') {
                displayStatus = 'invoice-ready';
            }
            
            statusBadge.textContent = displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1).replace('-', ' ');
            statusBadge.className = `status-badge ${displayStatus}`;
            console.log('🏷️ Status badge updated:', statusBadge.textContent, statusBadge.className);
            console.log('🔍 Original status:', booking.status, 'Display status:', displayStatus);

            // Update timeline based on status
            console.log('🔄 Calling updateTimeline with status:', booking.status);
            updateTimeline(displayStatus);

            // Update action buttons
            updateActionButtons(booking);
            
            // Show appropriate preview sections
            showQuotePreview();
            showInvoicePreview();
            
            console.log('✅ Booking details display complete');
            console.log('🔍 Final status check - Status:', booking.status, 'Type:', typeof booking.status);
            console.log('🔍 Status comparison tests:');
            console.log('  - invoice-ready ===', booking.status === 'invoice-ready');
            console.log('  - invoice-sent ===', booking.status === 'invoice-sent');
            console.log('  - completed ===', booking.status === 'completed');
        }

        // Update timeline based on booking status
        function updateTimeline(status) {
            console.log('🔄 Updating timeline for status:', status);
            
            const confirmedTimeline = document.getElementById('confirmed-timeline');
            const pendingBookingTimeline = document.getElementById('pending-booking-timeline');
            const completedTimeline = document.getElementById('completed-timeline');
            const siteVisitTimeline = document.getElementById('site-visit-timeline');
            const invoiceReadyTimeline = document.getElementById('invoice-ready-timeline');
            const invoiceSentTimeline = document.getElementById('invoice-sent-timeline');
            const quoteSentTimeline = document.getElementById('quote-sent-timeline');
            const quoteAcceptedTimeline = document.getElementById('quote-accepted-timeline');
            const quoteReadyTimeline = document.getElementById('quote-ready-timeline');

            // Reset all timeline items to hidden first
            [confirmedTimeline, pendingBookingTimeline, completedTimeline, siteVisitTimeline, 
             invoiceReadyTimeline, invoiceSentTimeline, quoteSentTimeline, quoteAcceptedTimeline, quoteReadyTimeline]
                .forEach(item => item.style.display = 'none');

            console.log('📋 Timeline items reset to hidden');

            // Show timeline items based on status progression
            if (status === 'pending-site-visit' || status === 'quote-ready' || status === 'quote-sent' || 
                status === 'quote-accepted' || status === 'confirmed' || status === 'pending-booking' || 
                status === 'completed' || status === 'invoice-ready' || status === 'invoice-sent') {
                siteVisitTimeline.style.display = 'flex';
                console.log('✅ Site Visit timeline shown');
            }

            if (status === 'quote-ready' || status === 'quote-sent' || status === 'quote-accepted' || 
                status === 'confirmed' || status === 'pending-booking' || status === 'completed' || 
                status === 'invoice-ready' || status === 'invoice-sent') {
                quoteReadyTimeline.style.display = 'flex';
                console.log('✅ Quote Ready timeline shown');
            }

            if (status === 'quote-sent' || status === 'quote-accepted' || status === 'confirmed' || 
                status === 'pending-booking' || status === 'completed' || status === 'invoice-ready' || 
                status === 'invoice-sent') {
                quoteSentTimeline.style.display = 'flex';
                console.log('✅ Quote Sent timeline shown');
            }

            if (status === 'quote-accepted' || status === 'confirmed' || status === 'pending-booking' || 
                status === 'completed' || status === 'invoice-ready' || status === 'invoice-sent') {
                quoteAcceptedTimeline.style.display = 'flex';
                console.log('✅ Quote Accepted timeline shown');
            }

            if (status === 'confirmed' || status === 'pending-booking' || status === 'completed' || 
                status === 'invoice-ready' || status === 'invoice-sent') {
                confirmedTimeline.style.display = 'flex';
                console.log('✅ Confirmed timeline shown');
            }

            if (status === 'pending-booking' || status === 'completed' || status === 'invoice-ready' || 
                status === 'invoice-sent') {
                pendingBookingTimeline.style.display = 'flex';
                console.log('✅ Pending Booking timeline shown');
            }

            if (status === 'completed' || status === 'invoice-ready' || status === 'invoice-sent') {
                completedTimeline.style.display = 'flex';
                console.log('✅ Completed timeline shown');
            }

            if (status === 'completed' || status === 'invoice-ready' || status === 'invoice-sent') {
                invoiceReadyTimeline.style.display = 'flex';
                console.log('✅ Invoice Ready timeline shown (including completed status)');
            }
            
            console.log('🔍 Timeline status checks:');
            console.log('  - completedTimeline display:', completedTimeline.style.display);
            console.log('  - invoiceReadyTimeline display:', invoiceReadyTimeline.style.display);

            if (status === 'invoice-sent') {
                invoiceSentTimeline.style.display = 'flex';
                console.log('✅ Invoice Sent timeline shown');
            }

            console.log('🎯 Timeline update complete for status:', status);
        }

        // Update action buttons based on booking status
        function updateActionButtons(booking) {
            const actionButtons = document.getElementById('action-buttons');
            let buttons = '';
            
            console.log('🔍 updateActionButtons called with status:', booking.status);
            console.log('🔍 Status type:', typeof booking.status);
            console.log('🔍 Status length:', booking.status ? booking.status.length : 'undefined');

            if (booking.status === 'pending') {
                buttons = `
                    <p>Your service request is being reviewed. We'll contact you soon!</p>
                `;
            } else if (booking.status === 'pending-site-visit') {
                buttons = `
                    <p>Your service request has been approved for a site visit. Our team will contact you to schedule the assessment.</p>
                `;
            } else if (booking.status === 'quote-ready') {
                buttons = `
                    <p>Your quote is ready! Our team will review and send it to you shortly.</p>
                `;
            } else if (booking.status === 'quote-sent') {
                buttons = `
                    <div class="quote-details">
                        <h3>📋 Your Quote is Ready!</h3>
                        <p style="text-align: center; margin-bottom: 2rem; color: var(--secondary-color);">
                            Please review the detailed quote information below. If you're satisfied with the service and pricing, click "Accept Quote and Schedule Job" to proceed.
                        </p>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="acceptQuote('${booking.booking_id}')">
                                <i class="fas fa-thumbs-up"></i> Accept Quote and Schedule Job
                            </button>
                            <button class="btn btn-secondary" onclick="contactUs()">
                                <i class="fas fa-phone"></i> Contact Us
                            </button>
                        </div>
                    </div>
                `;
                
                // Automatically fetch and show quote preview
                setTimeout(() => fetchQuoteDetails(booking.booking_id), 500);
            } else if (booking.status === 'quote-accepted') {
                buttons = `
                    <div class="quote-accepted-details">
                        <h3>✅ Quote Accepted!</h3>
                        <p style="text-align: center; margin-bottom: 2rem; color: var(--secondary-color);">
                            Thank you for accepting our quote! You should now be redirected to the job scheduling page. 
                            If you're not redirected automatically, click the button below to schedule your job.
                        </p>
                        
                        <!-- Booking Restrictions Info -->
                        <div id="booking-restrictions-info" class="booking-restrictions-info" style="display: none;">
                            <div class="info-box">
                                <i class="fas fa-calendar-alt"></i>
                                <div class="info-content">
                                    <h4>📅 Job Scheduling Information</h4>
                                    <div id="restrictions-content">
                                        <!-- Booking restrictions will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <a href="schedule-job.html?booking_id=${booking.booking_id}" class="btn btn-primary">
                                <i class="fas fa-calendar"></i> Schedule My Job
                            </a>
                            <button class="btn btn-secondary" onclick="contactUs()">
                                <i class="fas fa-phone"></i> Contact Us
                            </button>
                        </div>
                    </div>
                `;
                
                // Show quote preview for accepted quotes as well
                setTimeout(() => fetchQuoteDetails(booking.booking_id), 500);
                
                // Load and display booking restrictions
                setTimeout(() => loadBookingRestrictions(booking.booking_id), 1000);
            } else if (booking.status === 'confirmed') {
                buttons = `
                    <button class="btn btn-primary" onclick="confirmBooking('${booking.booking_id}')">
                        <i class="fas fa-check"></i> Confirm Booking
                    </button>
                    <button class="btn btn-secondary" onclick="contactUs()">
                        <i class="fas fa-phone"></i> Contact Us
                    </button>
                `;
            } else if (booking.status === 'pending-booking') {
                buttons = `
                    <p>Your job has been scheduled and is being reviewed by our team. We'll contact you soon!</p>
                `;
            } else if (booking.status === 'completed') {
                console.log('🔍 Status condition: completed - treating as invoice-ready for customer view');
                // Clear quote preview for completed jobs (treat as invoice-ready)
                clearQuotePreview();
                
                buttons = `
                    <div class="job-completion-notice">
                        <h3>🎉 Job Completed Successfully!</h3>
                        <p>Your tree service work has been finished. Thank you for choosing Stellar Tree Management!</p>
                    </div>
                   
                `;
                
                // Show invoice preview for completed status (treat as invoice-ready)
                console.log('🔍 Triggering invoice preview for completed status, booking data:', booking);
                console.log('🔍 Key fields for invoice:', {
                    name: booking.name,
                    estimated_cost: booking.estimated_cost,
                    work_description: booking.work_description,
                    status: booking.status
                });
                setTimeout(() => loadInvoicePreview(booking.booking_id), 500);
            } else if (booking.status === 'invoice-ready') {
                console.log('🔍 Status condition: invoice-ready');
                // Clear quote preview for invoice stages
                clearQuotePreview();
                
                buttons = `
                    <div class="job-completion-notice">
                        <h3>🎉 Job Completed Successfully!</h3>
                        <p>Your tree service work has been finished. Thank you for choosing Stellar Tree Management!</p>
                    </div>
                   
                `;
                
                // Show invoice preview for invoice-ready status
                console.log('🔍 Triggering invoice preview for invoice-ready status, booking data:', booking);
                console.log('🔍 Key fields for invoice:', {
                    name: booking.name,
                    estimated_cost: booking.estimated_cost,
                    work_description: booking.work_description,
                    status: booking.status
                });
                setTimeout(() => loadInvoicePreview(booking.booking_id), 500);
            } else if (booking.status === 'invoice-sent') {
                console.log('🔍 Status condition: invoice-sent');
                // Clear quote preview for invoice stages
                clearQuotePreview();
                
                buttons = `
                    <div class="job-completion-notice">
                        <h3>🎉 Job Completed Successfully!</h3>
                        <p>Your tree service work has been finished. Thank you for choosing Stellar Tree Management!</p>
                    </div>
                    
                `;
                
                // Show invoice preview for invoice-sent status
                console.log('🔍 Triggering invoice preview for invoice-sent status, booking data:', booking);
                console.log('🔍 Key fields for invoice:', {
                    name: booking.name,
                    estimated_cost: booking.estimated_cost,
                    work_description: booking.work_description,
                    status: booking.status
                });
                setTimeout(() => loadInvoicePreview(booking.booking_id), 500);
            } else if (booking.status === 'cancelled') {
                buttons = `
                    <p>This booking has been cancelled. Please contact us if you have any questions.</p>
                `;
            }

            actionButtons.innerHTML = buttons;
        }

        // Confirm booking
        async function confirmBooking(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showSuccess('Booking request submitted successfully! Our team will review and confirm your booking.');
                    // Reload booking details to update status
                    setTimeout(() => loadBookingDetails(), 1000);
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to submit booking request');
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showError('Network error confirming booking');
            }
        }

        // Accept quote and redirect to scheduling
        async function acceptQuote(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/accept-quote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showSuccess('Quote accepted successfully! Redirecting to job scheduling...');
                    // Redirect to scheduling page after a short delay
                    setTimeout(() => {
                        window.location.href = `schedule-job.html?booking_id=${bookingId}`;
                    }, 1500);
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to accept quote');
                }
            } catch (error) {
                console.error('Error accepting quote:', error);
                showError('Network error accepting quote');
            }
        }

        // Contact us
        function contactUs() {
            window.location.href = 'mailto:stellartmanagement@outlook.com?subject=Booking%20Inquiry';
        }

        // Show success message
        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = `
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p>${message}</p>
            `;
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Test API connection
        async function testBookingAPI() {
            const bookingId = getBookingIdFromUrl();
            if (!bookingId) {
                alert('No booking ID available to test');
                return;
            }
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}`);
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ API Test Successful!\n\nStatus: ${response.status}\nBooking ID: ${result.booking_id}\nService: ${result.service}`);
                } else {
                    alert(`❌ API Test Failed!\n\nStatus: ${response.status}\nError: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`❌ API Test Failed!\n\nError: ${error.message}`);
            }
        }

        // View Invoice function
        async function viewInvoice(bookingId) {
            try {
                // Redirect to admin panel to view invoice
                // This is because the invoice viewing requires admin privileges
                window.location.href = `/admin.html?booking=${bookingId}&action=view-invoice`;
            } catch (error) {
                console.error('Error viewing invoice:', error);
                showError('Failed to view invoice. Please contact us for assistance.');
            }
        }

        // Fetch and display quote details
        async function fetchQuoteDetails(bookingId) {
            // Check if we have a current booking and if it's in an invoice stage
            const currentBooking = window.currentBookingData;
            if (currentBooking && (currentBooking.status === 'invoice-ready' || currentBooking.status === 'invoice-sent')) {
                console.log('✅ Skipping quote fetch for invoice stage - job completed, no quote needed');
                return;
            }
            
            try {
                console.log('🔍 Fetching quote details for booking:', bookingId);
                const response = await fetch(`/api/bookings/${bookingId}/quote`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch quote: ${response.status}`);
                }

                const quoteData = await response.json();
                console.log('📋 Quote data received:', quoteData);
                
                // Store quote data globally for invoice preview to use
                window.currentQuoteData = quoteData;
                console.log('💾 Quote data stored globally for invoice preview');
                
                populateQuotePreview(quoteData);
                showQuotePreview();
            } catch (error) {
                console.error('Error fetching quote details:', error);
                // If quote API is not available, create a mock quote from booking data
                createMockQuoteFromBooking();
            }
        }

        // Populate quote preview with data
        function populateQuotePreview(quoteData) {
            console.log('📋 Populating quote preview with data:', quoteData);
            
            // Populate quote header
            document.getElementById('quote-number').textContent = quoteData.quote_number || 'QT-' + Date.now();
            document.getElementById('quote-date').textContent = new Date(quoteData.quote_date || Date.now()).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Populate client information
            document.getElementById('quote-client-name').textContent = quoteData.client_name || 'N/A';
            document.getElementById('quote-client-phone').textContent = quoteData.client_phone || 'N/A';
            document.getElementById('quote-client-email').textContent = quoteData.client_email || 'N/A';
            document.getElementById('quote-client-address').textContent = quoteData.client_address || 'N/A';

            // Populate bill to information
            document.getElementById('quote-bill-name').textContent = quoteData.bill_name || quoteData.client_name || 'N/A';
            document.getElementById('quote-bill-address').textContent = quoteData.bill_address || quoteData.client_address || 'N/A';

            // Populate services
            const servicesBody = document.getElementById('quote-services-body');
            servicesBody.innerHTML = '';
            
            if (quoteData.services && quoteData.services.length > 0) {
                console.log('📋 Loading services:', quoteData.services);
                quoteData.services.forEach((service, index) => {
                    const serviceRow = document.createElement('div');
                    serviceRow.className = 'table-row';
                    serviceRow.innerHTML = `
                        <div class="table-cell">${index + 1}</div>
                        <div class="table-cell description">${service.description || 'Service'}</div>
                        <div class="table-cell quantity">${service.quantity || 1}</div>
                        <div class="table-cell price">$${(service.unit_price || 0).toFixed(2)}</div>
                        <div class="table-cell total">$${(service.total || 0).toFixed(2)}</div>
                    `;
                    servicesBody.appendChild(serviceRow);
                });
            } else {
                // Fallback to basic service info
                console.log('📋 No services found, using fallback');
                const serviceRow = document.createElement('div');
                serviceRow.className = 'table-row';
                serviceRow.innerHTML = `
                    <div class="table-cell">1</div>
                    <div class="table-cell description">Tree Service</div>
                    <div class="table-cell quantity">1</div>
                    <div class="table-cell price">$${(quoteData.estimated_cost || 0).toFixed(2)}</div>
                    <div class="table-cell total">$${(quoteData.estimated_cost || 0).toFixed(2)}</div>
                `;
                servicesBody.appendChild(serviceRow);
            }

            // Populate summary
            const subtotal = quoteData.subtotal || quoteData.estimated_cost || 0;
            const total = quoteData.total || quoteData.estimated_cost || 0;
            const tax = quoteData.tax || 0;
            const taxEnabled = quoteData.tax_enabled;
            
            document.getElementById('quote-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('quote-total').textContent = `$${total.toFixed(2)}`;
            
            // Handle tax row
            const taxRow = document.getElementById('quote-tax-row');
            const taxValue = document.getElementById('quote-tax');
            if (taxEnabled && tax > 0) {
                taxRow.style.display = 'flex';
                taxValue.textContent = `$${tax.toFixed(2)}`;
            } else {
                taxRow.style.display = 'none';
            }
            
            console.log('✅ Quote preview populated successfully');
        }

        // Create mock quote from booking data (fallback)
        function createMockQuoteFromBooking() {
            console.log('📝 Creating mock quote from booking data');
            const bookingId = getBookingIdFromUrl();
            
            // Get booking details from the page
            const service = document.getElementById('service').textContent;
            const customer = document.getElementById('customer').textContent;
            const phone = document.getElementById('phone').textContent;
            const address = document.getElementById('address').textContent;
            const email = document.getElementById('email').textContent;
            
            // Create mock quote data
            const mockQuote = {
                quote_number: 'QT-' + Date.now(),
                quote_date: new Date(),
                client_name: customer,
                client_phone: phone,
                client_email: email || 'N/A',
                client_address: address,
                bill_name: customer,
                bill_address: address,
                services: [
                    {
                        description: service,
                        quantity: 1,
                        unit_price: 0,
                        total: 0
                    }
                ],
                estimated_cost: 0,
                subtotal: 0,
                total: 0
            };
            
            console.log('📝 Mock quote created:', mockQuote);
            populateQuotePreview(mockQuote);
            showQuotePreview();
        }

        // Show quote preview section
        function showQuotePreview() {
            // Check if we have a current booking and if it's in an invoice stage
            const currentBooking = window.currentBookingData; // We'll need to store this globally
            if (currentBooking && (currentBooking.status === 'completed' || currentBooking.status === 'invoice-ready' || currentBooking.status === 'invoice-sent')) {
                // Hide quote preview for invoice stages - job is done, no quote needed
                document.getElementById('quote-preview-section').style.display = 'none';
                console.log('✅ Quote preview hidden for invoice stage - job completed');
                return;
            }
            
            // Clear invoice preview when showing quote preview
            clearInvoicePreview();
            
            document.getElementById('quote-preview-section').style.display = 'block';
            // Ensure quote preview starts collapsed
            const content = document.getElementById('quote-preview-content');
            const icon = document.getElementById('quote-toggle-icon');
            const header = document.querySelector('.quote-preview-header');
            content.classList.remove('expanded');
            icon.classList.remove('rotated');
            header.classList.remove('expanded');
            console.log('✅ Quote preview section shown (collapsed by default)');
        }

        // Show invoice preview section
        function showInvoicePreview() {
            const currentBooking = window.currentBookingData;
            if (currentBooking && (currentBooking.status === 'completed' || currentBooking.status === 'invoice-ready' || currentBooking.status === 'invoice-sent')) {
                // Clear quote preview when showing invoice preview
                clearQuotePreview();
                
                // Load and show invoice preview
                loadInvoicePreview(currentBooking.booking_id);
                console.log('✅ Invoice preview shown for invoice stage (including completed status)');
            } else {
                // Hide invoice preview for non-invoice stages
                document.getElementById('invoice-preview-section').style.display = 'none';
                console.log('✅ Invoice preview hidden for non-invoice stage');
            }
        }

        // Clear quote preview section
        function clearQuotePreview() {
            document.getElementById('quote-preview-section').style.display = 'none';
            console.log('✅ Quote preview section cleared');
        }
        
        // Clear invoice preview section
        function clearInvoicePreview() {
            document.getElementById('invoice-preview-section').style.display = 'none';
            console.log('✅ Invoice preview section cleared');
        }

        // Toggle quote preview content
        function toggleQuotePreview() {
            const content = document.getElementById('quote-preview-content');
            const icon = document.getElementById('quote-toggle-icon');
            const header = document.querySelector('.quote-preview-header');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
                header.classList.remove('expanded');
                console.log('📋 Quote preview collapsed');
            } else {
                content.classList.add('expanded');
                icon.classList.add('rotated');
                header.classList.add('expanded');
                console.log('📋 Quote preview expanded');
            }
        }

        // Download quote as PDF
        function downloadQuote() {
            try {
                console.log('📥 Downloading quote...');
                // Create a new window with the quote content for printing
                const quoteWindow = window.open('', '_blank');
                const quoteContent = document.querySelector('.quote-document').innerHTML;
                
                quoteWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Quote - Stellar Tree Management</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 20px; 
                                background: white; 
                                font-size: 12px;
                                line-height: 1.4;
                                color: #333;
                            }
                            
                            .quote-document { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                line-height: 1.4; 
                                color: #333; 
                                font-size: 12px; 
                                max-width: 800px; 
                                margin: 0 auto; 
                                background: white; 
                                border-radius: 8px; 
                                overflow: hidden; 
                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .quote-header { 
                                background: white; 
                                color: #333; 
                                padding: 24px; 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: flex-start; 
                                border-bottom: 3px solid #8cc63f; 
                            }
                            
                            .company-brand { 
                                display: flex; 
                                align-items: center; 
                                gap: 16px; 
                            }
                            
                            .company-logo { 
                                width: 48px; 
                                height: 48px; 
                                object-fit: contain; 
                                border-radius: 4px; 
                            }
                            
                            .company-name { 
                                font-size: 20px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                                margin: 0 0 10px 0; 
                                letter-spacing: 0.3px; 
                            }
                            
                            .company-contact { 
                                margin-top: 10px; 
                            }
                            
                            .contact-item { 
                                display: flex; 
                                align-items: center; 
                                gap: 8px; 
                                margin-bottom: 5px; 
                                font-size: 11px; 
                                color: #666; 
                            }
                            
                            .contact-item i { 
                                width: 12px; 
                                color: #8cc63f; 
                                text-align: center; 
                            }
                            
                            .document-info { 
                                text-align: right; 
                                display: flex; 
                                flex-direction: column; 
                                align-items: flex-end; 
                            }
                            
                            .document-type { 
                                font-size: 22px; 
                                font-weight: 800; 
                                color: #2c3e50; 
                                margin-bottom: 8px; 
                                letter-spacing: 1.2px; 
                            }
                            
                            .document-number { 
                                font-size: 15px; 
                                font-weight: 600; 
                                margin-bottom: 6px; 
                                color: #555; 
                            }
                            
                            .document-date { 
                                font-size: 12px; 
                                color: #666; 
                            }
                            
                            .client-billing-section { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 24px; 
                                padding: 24px; 
                                background: #f8f9fa; 
                                border: 1px solid #e1e8ed; 
                                border-radius: 8px; 
                                margin: 24px; 
                            }
                            
                            .section-heading { 
                                font-size: 15px; 
                                font-weight: 600; 
                                margin: 0 0 12px 0; 
                                color: #2c3e50; 
                                border-bottom: 2px solid #8cc63f; 
                                padding-bottom: 6px; 
                            }
                            
                            .data-row { 
                                display: flex; 
                                margin-bottom: 8px; 
                                align-items: flex-start; 
                                min-height: 16px; 
                            }
                            
                            .data-row .label { 
                                font-weight: 600; 
                                min-width: 70px; 
                                color: #555; 
                                font-size: 11px; 
                                flex-shrink: 0; 
                            }
                            
                            .data-row .value { 
                                flex: 1; 
                                color: #333; 
                                font-size: 11px; 
                                word-wrap: break-word; 
                            }
                            
                            .services-section { 
                                padding: 24px; 
                            }
                            
                            .services-table { 
                                border: 1px solid #e1e8ed; 
                                border-radius: 8px; 
                                overflow: hidden; 
                                margin-top: 12px; 
                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .table-header { 
                                display: grid; 
                                grid-template-columns: 40px 1fr 60px 90px 90px; 
                                background: #2c3e50; 
                                color: white; 
                                font-weight: 600; 
                                font-size: 11px; 
                            }
                            
                            .header-item { 
                                padding: 12px 10px; 
                                text-align: left; 
                                border-right: 1px solid rgba(255, 255, 255, 0.1); 
                            }
                            
                            .header-item:last-child { 
                                border-right: none; 
                            }
                            
                            .table-body { 
                                background: white; 
                            }
                            
                            .table-row { 
                                display: grid; 
                                grid-template-columns: 40px 1fr 60px 90px 90px; 
                                border-bottom: 1px solid #e1e8ed; 
                                font-size: 11px; 
                                min-height: 40px; 
                            }
                            
                            .table-row:nth-child(even) { 
                                background: #f8f9fa; 
                            }
                            
                            .table-row:last-child { 
                                border-bottom: none; 
                            }
                            
                            .table-cell { 
                                padding: 12px 10px; 
                                display: flex; 
                                align-items: center; 
                                border-right: 1px solid #e1e8ed; 
                            }
                            
                            .table-cell:last-child { 
                                border-right: none; 
                            }
                            
                            .table-cell.description { 
                                font-weight: 500; 
                            }
                            
                            .table-cell.quantity { 
                                justify-content: center; 
                            }
                            
                            .table-cell.price, .table-cell.total { 
                                justify-content: flex-end; 
                                font-weight: 600; 
                            }
                            
                            .totals-section { 
                                padding: 0 24px 24px; 
                                display: flex; 
                                justify-content: flex-end; 
                            }
                            
                            .totals-container { 
                                width: 240px; 
                                background: #f8f9fa; 
                                border-radius: 8px; 
                                padding: 16px; 
                                border: 1px solid #e1e8ed; 
                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .total-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                                font-size: 12px; 
                                align-items: center; 
                                min-height: 20px; 
                            }
                            
                            .total-row.grand-total { 
                                border-top: 2px solid #8cc63f; 
                                padding-top: 10px; 
                                margin-top: 10px; 
                                font-size: 15px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                            }
                            
                            .total-label { 
                                font-weight: 600; 
                            }
                            
                            .total-value { 
                                font-weight: 600; 
                            }
                            
                            .terms-section { 
                                padding: 24px; 
                                background: #f8f9fa; 
                                border-top: 1px solid #e1e8ed; 
                            }
                            
                            .terms-content p { 
                                margin: 0; 
                                font-size: 10px; 
                                color: #666; 
                                line-height: 1.3; 
                            }
                            
                            @media print { 
                                body { margin: 0; } 
                            }
                        </style>
                    </head>
                    <body>
                        ${quoteContent}
                    </body>
                    </html>
                `);
                
                quoteWindow.document.close();
                quoteWindow.print();
                
                showSuccess('Quote download initiated!');
            } catch (error) {
                console.error('Error downloading quote:', error);
                showError('Failed to download quote. Please try again.');
            }
        }

        // Print quote
        function printQuote() {
            try {
                console.log('🖨️ Printing quote...');
                const printContent = document.querySelector('#invoice-preview-section .quote-document').innerHTML;
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Quote - Stellar Tree Management</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 20px; 
                                background: white; 
                                font-size: 12px;
                                line-height: 1.4;
                                color: #333;
                            }
                            
                            .quote-document { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                line-height: 1.4; 
                                color: #333; 
                                font-size: 12px; 
                                max-width: 800px; 
                                margin: 0 auto; 
                                background: white; 
                                border-radius: 8px; 
                                overflow: hidden; 
                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .quote-header { 
                                background: white; 
                                color: #333; 
                                padding: 24px; 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: flex-start; 
                                border-bottom: 3px solid #8cc63f; 
                            }
                            
                            .company-brand { 
                                display: flex; 
                                align-items: center; 
                                gap: 16px; 
                            }
                            
                            .company-logo { 
                                width: 48px; 
                                height: 48px; 
                                object-fit: contain; 
                                border-radius: 4px; 
                            }
                            
                            .company-name { 
                                font-size: 20px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                                margin: 0 0 10px 0; 
                                letter-spacing: 0.3px; 
                            }
                            
                            .company-contact { 
                                margin-top: 10px; 
                            }
                            
                            .contact-item { 
                                display: flex; 
                                align-items: center; 
                                gap: 8px; 
                                margin-bottom: 5px; 
                                font-size: 11px; 
                                color: #666; 
                            }
                            
                            .contact-item i { 
                                width: 12px; 
                                color: #8cc63f; 
                                text-align: center; 
                            }
                            
                            .document-info { 
                                text-align: right; 
                                display: flex; 
                                flex-direction: column; 
                                align-items: flex-end; 
                            }
                            
                            .document-type { 
                                font-size: 22px; 
                                font-weight: 800; 
                                color: #2c3e50; 
                                margin-bottom: 8px; 
                                letter-spacing: 1.2px; 
                            }
                            
                            .document-number { 
                                font-size: 15px; 
                                font-weight: 600; 
                                margin-bottom: 6px; 
                                color: #555; 
                            }
                            
                            .document-date { 
                                font-size: 12px; 
                                color: #666; 
                            }
                            
                            .client-billing-section { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 24px; 
                                padding: 24px; 
                                background: #f8f9fa; 
                                border: 1px solid #e1e8ed; 
                                border-radius: 8px; 
                                margin: 24px; 
                            }
                            
                            .section-heading { 
                                font-size: 15px; 
                                font-weight: 600; 
                                margin: 0 0 12px 0; 
                                color: #2c3e50; 
                                border-bottom: 2px solid #8cc63f; 
                                padding-bottom: 6px; 
                            }
                            
                            .data-row { 
                                display: flex; 
                                margin-bottom: 8px; 
                                align-items: flex-start; 
                                min-height: 16px; 
                            }
                            
                            .data-row .label { 
                                font-weight: 600; 
                                min-width: 70px; 
                                color: #555; 
                                font-size: 11px; 
                                flex-shrink: 0; 
                            }
                            
                            .data-row .value { 
                                flex: 1; 
                                color: #333; 
                                font-size: 11px; 
                                word-wrap: break-word; 
                            }
                            
                            .services-section { 
                                padding: 24px; 
                            }
                            
                            .services-table { 
                                border: 1px solid #e1e8ed; 
                                border-radius: 8px; 
                                overflow: hidden; 
                                margin-top: 12px; 
                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .table-header { 
                                display: grid; 
                                grid-template-columns: 40px 1fr 60px 90px 90px; 
                                background: #2c3e50; 
                                color: white; 
                                font-weight: 600; 
                                font-size: 12px; 
                            }
                            
                            .header-item { 
                                padding: 12px 10px; 
                                text-align: left; 
                                border-right: 1px solid rgba(255, 255, 255, 0.1); 
                            }
                            
                            .header-item:last-child { 
                                border-right: none; 
                            }
                            
                            .table-body { 
                                background: white; 
                            }
                            
                            .table-row { 
                                display: grid; 
                                grid-template-columns: 40px 1fr 60px 90px 90px; 
                                border-bottom: 1px solid #e1e8ed; 
                                font-size: 11px; 
                                min-height: 40px; 
                            }
                            
                            .table-row:nth-child(even) { 
                                background: #f8f9fa; 
                            }
                            
                            .table-row:last-child { 
                                border-bottom: none; 
                            }
                            
                            .table-cell { 
                                padding: 12px 10px; 
                                display: flex; 
                                align-items: center; 
                                border-right: 1px solid #e1e8ed; 
                            }
                            
                            .table-cell:last-child { 
                                border-right: none; 
                            }
                            
                            .table-cell.description { 
                                font-weight: 500; 
                            }
                            
                            .table-cell.quantity { 
                                justify-content: center; 
                            }
                            
                            .table-cell.price, .table-cell.total { 
                                justify-content: flex-end; 
                                font-weight: 600; 
                            }
                            
                            .totals-section { 
                                padding: 0 24px 24px; 
                                display: flex; 
                                justify-content: flex-end; 
                            }
                            
                            .totals-container { 
                                width: 240px; 
                                background: #f8f9fa; 
                                border-radius: 8px; 
                                padding: 16px; 
                                border: 1px solid #e1e8ed; 
                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .total-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                                font-size: 12px; 
                                align-items: center; 
                                min-height: 20px; 
                            }
                            
                            .total-row.grand-total { 
                                border-top: 2px solid #8cc63f; 
                                padding-top: 10px; 
                                margin-top: 10px; 
                                font-size: 15px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                            }
                            
                            .total-label { 
                                font-weight: 600; 
                            }
                            
                            .total-value { 
                                font-weight: 600; 
                            }
                            
                            .terms-section { 
                                padding: 24px; 
                                background: #f8f9fa; 
                                border-top: 1px solid #e1e8ed; 
                            }
                            
                            .terms-content p { 
                                margin: 0; 
                                font-size: 10px; 
                                color: #666; 
                                line-height: 1.3; 
                            }
                            
                            @media print { 
                                body { margin: 0; }
                                .quote-actions { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                
                showSuccess('Quote print dialog opened!');
            } catch (error) {
                console.error('Error printing quote:', error);
                showError('Failed to print quote. Please try again.');
            }
        }

        // Load booking details when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Booking Status Page Loaded');
            console.log('📍 Current URL:', window.location.href);
            console.log('📍 Current Pathname:', window.location.pathname);
            
            // Initialize preview sections to be hidden by default
            document.getElementById('quote-preview-section').style.display = 'none';
            document.getElementById('invoice-preview-section').style.display = 'none';
            
            loadBookingDetails();
            

        });

        // Utility function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }

        // Invoice Preview Functions
        function toggleInvoicePreview() {
            const content = document.getElementById('invoice-preview-content');
            const icon = document.getElementById('invoice-toggle-icon');
            const header = document.querySelector('#invoice-preview-section .quote-preview-header');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
                header.classList.remove('expanded');
                console.log('📋 Invoice preview collapsed');
            } else {
                content.classList.add('expanded');
                icon.classList.add('rotated');
                header.classList.add('expanded');
                console.log('📋 Invoice preview expanded');
            }
        }









        // Show success message
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'message-notification success';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // Show error message
        function showErrorMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'message-notification error';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        }



        // Refresh invoice data and update preview
        async function refreshInvoicePreview(bookingId) {
            if (!bookingId) {
                console.log('❌ No booking ID provided for refresh');
                return;
            }
            
            console.log('🔄 Refreshing invoice preview for booking:', bookingId);
            
            // Show refresh button in refreshing state
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.add('refreshing');
                refreshBtn.disabled = true;
            }
            
            try {
                // First try to refresh quote data if available
                if (window.currentQuoteData) {
                    console.log('🔄 Refreshing quote data for invoice...');
                    await fetchQuoteDetails(bookingId);
                }
                
                // Then refresh invoice preview
                await loadInvoicePreview(bookingId);
                console.log('✅ Invoice preview refreshed successfully');
                
                // Show success message for manual refresh
                showSuccessMessage('Invoice refreshed successfully!');
            } catch (error) {
                console.error('❌ Error refreshing invoice preview:', error);
                showErrorMessage('Failed to refresh invoice. Please try again.');
            } finally {
                // Remove refreshing state
                if (refreshBtn) {
                    refreshBtn.classList.remove('refreshing');
                    refreshBtn.disabled = false;
                }
            }
        }

        // Load invoice data and populate preview
        async function loadInvoicePreview(bookingId) {
            try {
                console.log('📋 Loading invoice for booking:', bookingId);
                
                // First, try to fetch the actual invoice data from the database
                try {
                    console.log('📋 Attempting to fetch invoice from database...');
                    const response = await fetch(`/api/invoices/booking/${bookingId}`);
                    
                    if (response.ok) {
                        const invoices = await response.json();
                        console.log('📋 Fetched invoices from database:', invoices);
                        
                        if (invoices && invoices.length > 0) {
                            // Use the most recent invoice
                            const latestInvoice = invoices[0];
                            console.log('📋 Using latest invoice from database:', latestInvoice);
                            
                            // Populate invoice preview with actual database data
                            populateInvoicePreview(latestInvoice);
                            document.getElementById('invoice-preview-section').style.display = 'block';
                            
                            // Ensure it starts collapsed
                            const content = document.getElementById('invoice-preview-content');
                            const icon = document.getElementById('invoice-toggle-icon');
                            const header = document.querySelector('#invoice-preview-section .quote-preview-header');
                            if (content) content.classList.remove('expanded');
                            if (icon) icon.classList.remove('rotated');
                            if (header) header.classList.remove('expanded');
                            
                            console.log('✅ Invoice preview populated from database data');
                            return;
                        } else {
                            console.log('📋 No invoices found in database for this booking');
                        }
                    } else {
                        console.log('📋 Failed to fetch invoices from database:', response.status);
                    }
                } catch (dbError) {
                    console.log('📋 Database fetch failed, falling back to other methods:', dbError);
                }
                
                // For completed jobs, create invoice preview from current booking data
                const currentBooking = window.currentBookingData;
                if (currentBooking && (currentBooking.status === 'completed' || currentBooking.status === 'invoice-ready' || currentBooking.status === 'invoice-sent')) {
                    console.log('📋 Creating invoice preview from booking data');
                    await createInvoiceFromQuote(bookingId);
                    return;
                }
                
                console.log('ℹ️ Not in invoice stage - no invoice preview needed');
            } catch (error) {
                console.error('Error loading invoice:', error);
                console.log('📋 Using fallback invoice preview due to error');
                createInvoiceFromBookingData(bookingId);
            }
        }

        // Populate invoice preview with data
        function populateInvoicePreview(invoice) {
            console.log('📋 Populating invoice preview:', invoice);
            
            // Set invoice details
            document.getElementById('invoice-number').textContent = invoice.invoice_id;
            document.getElementById('invoice-date').textContent = formatDate(invoice.invoice_date);
            document.getElementById('invoice-client-name').textContent = invoice.client_name;
            document.getElementById('invoice-client-phone').textContent = invoice.client_phone;
            document.getElementById('invoice-client-email').textContent = invoice.client_email;
            document.getElementById('invoice-client-address').textContent = invoice.client_address;
            document.getElementById('invoice-bill-name').textContent = invoice.client_name;
            document.getElementById('invoice-bill-address').textContent = invoice.client_address;
            
            // Set totals
            document.getElementById('invoice-subtotal').textContent = `$${parseFloat(invoice.subtotal).toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `$${parseFloat(invoice.total_amount).toFixed(2)}`;
            
            // Handle tax
            const taxRow = document.getElementById('invoice-tax-row');
            if (invoice.tax_enabled && parseFloat(invoice.tax_amount) > 0) {
                document.getElementById('invoice-tax').textContent = `$${parseFloat(invoice.tax_amount).toFixed(2)}`;
                taxRow.style.display = 'flex';
            } else {
                taxRow.style.display = 'none';
            }
            
            // Populate service items
            const servicesBody = document.getElementById('invoice-services-body');
            servicesBody.innerHTML = '';
            
            console.log('📋 Invoice data for service items:', invoice);
            console.log('📋 Service items array:', invoice.service_items);
            console.log('📋 Services array (alternative):', invoice.services);
            
            // Try multiple possible service item structures
            let serviceItems = invoice.service_items || invoice.services || [];
            
            if (serviceItems && serviceItems.length > 0) {
                console.log('📋 Found service items:', serviceItems);
                serviceItems.forEach((item, index) => {
                    console.log('📋 Processing service item:', item);
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    
                    // Handle different service item structures
                    const description = item.description || item.service_description || 'Service';
                    const quantity = item.quantity || item.qty || 1;
                    const price = item.price || item.unit_price || item.unitPrice || 0;
                    const total = item.total || item.line_total || item.lineTotal || (price * quantity);
                    
                    row.innerHTML = `
                        <div class="table-cell">${index + 1}</div>
                        <div class="table-cell description">${description}</div>
                        <div class="table-cell quantity">${quantity}</div>
                        <div class="table-cell price">$${parseFloat(price).toFixed(2)}</div>
                        <div class="table-cell total">$${parseFloat(total).toFixed(2)}</div>
                    `;
                    servicesBody.appendChild(row);
                });
            } else {
                // Fallback to basic service info
                console.log('📋 No services found, using fallback');
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = `
                    <div class="table-cell">1</div>
                    <div class="table-cell description">Tree Service</div>
                    <div class="table-cell quantity">1</div>
                    <div class="table-cell price">$${(invoice.total_amount || 0).toFixed(2)}</div>
                    <div class="table-cell total">$${(invoice.total_amount || 0).toFixed(2)}</div>
                `;
                servicesBody.appendChild(row);
            }
        }

        // Create invoice preview from quote data
        async function createInvoiceFromQuote(bookingId) {
            try {
                console.log('📋 Creating invoice from quote data for booking:', bookingId);
                
                // First try to use stored quote data if available
                console.log('🔍 Available data sources for invoice:');
                console.log('  - window.currentQuoteData:', window.currentQuoteData);
                console.log('  - window.currentBookingData:', window.currentBookingData);
                
                if (window.currentQuoteData) {
                    console.log('📋 Using stored quote data for invoice:', window.currentQuoteData);
                    
                    const quoteData = window.currentQuoteData;
                    const invoiceData = {
                        invoice_id: `INV-${bookingId}`,
                        invoice_date: new Date().toISOString(),
                        client_name: quoteData.client_name || quoteData.name || 'N/A',
                        client_phone: quoteData.client_phone || quoteData.phone || 'N/A',
                        client_email: quoteData.client_email || quoteData.email || 'N/A',
                        client_address: quoteData.client_address || quoteData.address || 'N/A',
                        subtotal: quoteData.subtotal || quoteData.estimated_cost || 0,
                        total_amount: quoteData.total || quoteData.estimated_cost || 0,
                        tax_amount: quoteData.tax || 0,
                        tax_enabled: quoteData.tax_enabled || false,
                        service_items: quoteData.services || [],
                        services: quoteData.services || []
                    };
                    
                    console.log('📋 Created invoice data from quote:', invoiceData);
                    
                    // Populate invoice preview with converted data
                    populateInvoicePreview(invoiceData);
                    document.getElementById('invoice-preview-section').style.display = 'block';
                    
                    // Ensure it starts collapsed
                    const content = document.getElementById('invoice-preview-content');
                    const icon = document.getElementById('invoice-toggle-icon');
                    const header = document.querySelector('#invoice-preview-section .quote-preview-header');
                    content.classList.remove('expanded');
                    icon.classList.remove('rotated');
                    header.classList.remove('expanded');
                    
                    console.log('✅ Invoice preview created from quote data');
                    return;
                }
                
                // Try to extract quote data from displayed quote preview
                const extractedQuoteData = extractQuoteDataFromDisplay();
                if (extractedQuoteData) {
                    console.log('📋 Using extracted quote data from display:', extractedQuoteData);
                    
                    const invoiceData = {
                        invoice_id: `INV-${bookingId}`,
                        invoice_date: new Date().toISOString(),
                        client_name: extractedQuoteData.client_name || 'N/A',
                        client_phone: extractedQuoteData.client_phone || 'N/A',
                        client_email: extractedQuoteData.client_email || 'N/A',
                        client_address: extractedQuoteData.client_address || 'N/A',
                        subtotal: extractedQuoteData.subtotal || 0,
                        total_amount: extractedQuoteData.total || 0,
                        tax_amount: extractedQuoteData.tax || 0,
                        tax_enabled: extractedQuoteData.tax_enabled || false,
                        service_items: extractedQuoteData.services || [],
                        services: extractedQuoteData.services || []
                    };
                    
                    console.log('📋 Created invoice data from extracted quote:', invoiceData);
                    
                    // Populate invoice preview with converted data
                    populateInvoicePreview(invoiceData);
                    document.getElementById('invoice-preview-section').style.display = 'block';
                    
                    // Ensure it starts collapsed
                    const content = document.getElementById('invoice-preview-content');
                    const icon = document.getElementById('invoice-toggle-icon');
                    const header = document.querySelector('#invoice-preview-section .quote-preview-header');
                    content.classList.remove('expanded');
                    icon.classList.remove('rotated');
                    header.classList.remove('expanded');
                    
                    console.log('✅ Invoice preview created from extracted quote data');
                    return;
                }
                
                // Fallback to current booking data if no quote data available
                const currentBooking = window.currentBookingData;
                if (!currentBooking) {
                    console.log('❌ No current booking data available');
                    createInvoiceFromBookingData(bookingId);
                    return;
                }
                
                console.log('📋 Using current booking data for invoice (fallback):', currentBooking);
                
                // Create invoice data from current booking
                const invoiceData = {
                    invoice_id: `INV-${bookingId}`,
                    invoice_date: new Date().toISOString(),
                    client_name: currentBooking.name || 'N/A',
                    client_phone: currentBooking.phone || 'N/A',
                    client_email: currentBooking.email || 'N/A',
                    client_address: currentBooking.address || 'N/A',
                    subtotal: currentBooking.estimated_cost || 0,
                    total_amount: currentBooking.estimated_cost || 0,
                    tax_amount: 0,
                    tax_enabled: false,
                    service_items: [],
                    services: [{
                        description: currentBooking.work_description || 'Tree Service',
                        quantity: 1,
                        unit_price: currentBooking.estimated_cost || 0,
                        total: currentBooking.estimated_cost || 0
                    }]
                };
                
                console.log('📋 Created invoice data from booking (fallback):', invoiceData);
                
                // Populate invoice preview with converted data
                populateInvoicePreview(invoiceData);
                document.getElementById('invoice-preview-section').style.display = 'block';
                
                // Ensure it starts collapsed
                const content = document.getElementById('invoice-preview-content');
                const icon = document.getElementById('invoice-toggle-icon');
                const header = document.querySelector('#invoice-preview-section .quote-preview-header');
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
                header.classList.remove('expanded');
                
                console.log('✅ Invoice preview created from booking data (fallback)');
            } catch (error) {
                console.error('Error creating invoice from quote:', error);
                console.log('📋 Using booking data fallback due to error');
                createInvoiceFromBookingData(bookingId);
            }
        }

        // Extract quote data from the displayed quote preview
        function extractQuoteDataFromDisplay() {
            try {
                console.log('🔍 Attempting to extract quote data from displayed quote preview...');
                
                // Check if quote preview section is visible
                const quoteSection = document.getElementById('quote-preview-section');
                if (!quoteSection || quoteSection.style.display === 'none') {
                    console.log('❌ Quote preview section not visible');
                    return null;
                }
                
                // Extract client information
                const clientName = document.getElementById('quote-client-name')?.textContent || 'N/A';
                const clientPhone = document.getElementById('quote-client-phone')?.textContent || 'N/A';
                const clientEmail = document.getElementById('quote-client-email')?.textContent || 'N/A';
                const clientAddress = document.getElementById('quote-client-address')?.textContent || 'N/A';
                
                // Extract totals
                const subtotal = document.getElementById('quote-subtotal')?.textContent?.replace('$', '') || '0';
                const total = document.getElementById('quote-total')?.textContent?.replace('$', '') || '0';
                
                // Extract services from the displayed table
                const services = [];
                const serviceRows = document.querySelectorAll('#quote-services-body .table-row');
                
                if (serviceRows.length > 0) {
                    console.log('📋 Found service rows:', serviceRows.length);
                    serviceRows.forEach((row, index) => {
                        const cells = row.querySelectorAll('.table-cell');
                        if (cells.length >= 5) {
                            const service = {
                                description: cells[1]?.textContent || 'Service',
                                quantity: parseFloat(cells[2]?.textContent) || 1,
                                unit_price: parseFloat(cells[3]?.textContent?.replace('$', '')) || 0,
                                total: parseFloat(cells[4]?.textContent?.replace('$', '')) || 0
                            };
                            services.push(service);
                            console.log('📋 Extracted service:', service);
                        }
                    });
                }
                
                if (services.length === 0) {
                    console.log('❌ No services found in quote preview');
                    return null;
                }
                
                const quoteData = {
                    client_name: clientName,
                    client_phone: clientPhone,
                    client_email: clientEmail,
                    client_address: clientAddress,
                    subtotal: parseFloat(subtotal),
                    total: parseFloat(total),
                    tax: 0,
                    tax_enabled: false,
                    services: services
                };
                
                console.log('✅ Successfully extracted quote data:', quoteData);
                return quoteData;
                
            } catch (error) {
                console.error('❌ Error extracting quote data from display:', error);
                return null;
            }
        }

        // Create invoice preview from current booking data
        function createInvoiceFromBookingData(bookingId) {
            console.log('📋 Creating invoice from booking data for booking:', bookingId);
            
            // Get current booking data
            const currentBooking = window.currentBookingData;
            if (!currentBooking) {
                console.log('❌ No current booking data available');
                showFallbackInvoicePreview(bookingId);
                return;
            }
            
            console.log('📋 Using booking data for invoice:', currentBooking);
            
            // Create invoice data from booking
            const invoiceData = {
                invoice_id: `INV-${bookingId}`,
                invoice_date: new Date().toISOString(),
                client_name: currentBooking.name || 'N/A',
                client_phone: currentBooking.phone || 'N/A',
                client_email: currentBooking.email || 'N/A',
                client_address: currentBooking.address || 'N/A',
                subtotal: currentBooking.estimated_cost || 0,
                total_amount: currentBooking.estimated_cost || 0,
                tax_amount: 0,
                tax_enabled: false,
                service_items: [],
                services: [{
                    description: currentBooking.work_description || 'Tree Service',
                    quantity: 1,
                    unit_price: currentBooking.estimated_cost || 0,
                    total: currentBooking.estimated_cost || 0
                }]
            };
            
            console.log('📋 Created invoice data from booking:', invoiceData);
            
            // Populate invoice preview
            populateInvoicePreview(invoiceData);
            document.getElementById('invoice-preview-section').style.display = 'block';
            
            // Ensure it starts collapsed
            const content = document.getElementById('invoice-preview-content');
            const icon = document.getElementById('invoice-toggle-icon');
            const header = document.querySelector('#invoice-preview-section .quote-preview-header');
            content.classList.remove('expanded');
            icon.classList.remove('rotated');
            header.classList.remove('expanded');
            
            console.log('✅ Invoice preview created from booking data');
        }

        // Show fallback invoice preview for completed jobs without invoices
        function showFallbackInvoicePreview(bookingId) {
            console.log('📋 Showing fallback invoice preview for booking:', bookingId);
            
            // Get current booking data
            const currentBooking = window.currentBookingData;
            if (!currentBooking) {
                console.log('❌ No current booking data available');
                return;
            }
            
            // Populate fallback invoice data
            document.getElementById('invoice-number').textContent = `INV-${currentBooking.booking_id}`;
            document.getElementById('invoice-date').textContent = formatDate(new Date());
            document.getElementById('invoice-client-name').textContent = currentBooking.name || 'N/A';
            document.getElementById('invoice-client-phone').textContent = currentBooking.phone || 'N/A';
            document.getElementById('invoice-client-email').textContent = currentBooking.email || 'N/A';
            document.getElementById('invoice-client-address').textContent = currentBooking.address || 'N/A';
            document.getElementById('invoice-bill-name').textContent = currentBooking.name || 'N/A';
            document.getElementById('invoice-bill-address').textContent = currentBooking.address || 'N/A';
            
            // Set totals (use estimated cost if available)
            const totalAmount = currentBooking.estimated_cost || 0;
            document.getElementById('invoice-subtotal').textContent = `$${parseFloat(totalAmount).toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `$${parseFloat(totalAmount).toFixed(2)}`;
            
            // Hide tax row for fallback
            const taxRow = document.getElementById('invoice-tax-row');
            taxRow.style.display = 'none';
            
            // Populate service items with fallback data
            const servicesBody = document.getElementById('invoice-services-body');
            servicesBody.innerHTML = '';
            
            const row = document.createElement('div');
            row.className = 'table-row';
            row.innerHTML = `
                <div class="table-cell">1</div>
                <div class="table-cell description">${currentBooking.work_description || 'Tree Service'}</div>
                <div class="table-cell quantity">1</div>
                <div class="table-cell price">$${parseFloat(totalAmount).toFixed(2)}</div>
                <div class="table-cell total">$${parseFloat(totalAmount).toFixed(2)}</div>
            `;
            servicesBody.appendChild(row);
            
            // Show the invoice preview section
            document.getElementById('invoice-preview-section').style.display = 'block';
            
            // Ensure it starts collapsed
            const content = document.getElementById('invoice-preview-content');
            const icon = document.getElementById('invoice-toggle-icon');
            const header = document.querySelector('#invoice-preview-section .quote-preview-header');
            content.classList.remove('expanded');
            icon.classList.remove('rotated');
            header.classList.remove('expanded');
            
            console.log('✅ Fallback invoice preview shown');
        }

        // Download invoice
        function downloadInvoice() {
            try {
                console.log('📥 Downloading invoice...');
                
                // Get the current invoice data
                const currentBooking = window.currentBookingData;
                if (!currentBooking) {
                    showError('No booking data available for download');
                    return;
                }
                
                // Get the exact invoice content from the preview
                const invoiceContent = document.querySelector('#invoice-preview-section .quote-document').innerHTML;
                
                // Create a new window with the invoice content
                const invoiceWindow = window.open('', '_blank');
                const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice - Stellar Tree Management</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: white; 
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }
        
        .quote-document { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            line-height: 1.4; 
            color: #333; 
            font-size: 12px; 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
        }
        
        .quote-header { 
            background: white; 
            color: #333; 
            padding: 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            border-bottom: 3px solid #e83e8c; 
        }
        
        .company-brand { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
        }
        
        .company-logo { 
            width: 48px; 
            height: 48px; 
            object-fit: contain; 
            border-radius: 4px; 
        }
        
        .company-name { 
            font-size: 20px; 
            font-weight: 700; 
            color: #2c3e50; 
            margin: 0 0 10px 0; 
            letter-spacing: 0.3px; 
        }
        
        .company-contact { 
            margin-top: 10px; 
        }
        
        .contact-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 4px; 
            font-size: 11px; 
            color: #666; 
        }
        
        .document-info { 
            text-align: right; 
        }
        
        .document-type { 
            font-size: 18px; 
            font-weight: 700; 
            color: #e83e8c; 
            margin-bottom: 8px; 
        }
        
        .document-number { 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 4px; 
        }
        
        .document-date { 
            font-size: 14px; 
            color: #666; 
        }
        
        .client-billing-section { 
            padding: 24px; 
            display: flex; 
            justify-content: space-between; 
            gap: 40px; 
        }
        
        .section-heading { 
            margin: 0 0 12px 0; 
            font-size: 14px; 
            font-weight: 600; 
            color: #2c3e50; 
        }
        
        .data-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: 12px; 
        }
        
        .label { 
            font-weight: 600; 
            color: #666; 
            min-width: 60px; 
        }
        
        .value { 
            color: #333; 
            font-weight: 500; 
        }
        
        .services-section { 
            padding: 0 24px; 
        }
        
        .services-table { 
            border: 1px solid #e1e8ed; 
            border-radius: 8px; 
            overflow: hidden; 
        }
        
        .table-header { 
            background: #8cc63f; 
            color: white; 
            display: flex; 
            font-weight: 600; 
            font-size: 12px; 
        }
        
        .header-item { 
            padding: 12px 8px; 
            flex: 1; 
            text-align: center; 
        }
        
        .header-item:first-child { 
            text-align: center; 
            flex: 0.5; 
        }
        
        .header-item.description { 
            text-align: left; 
            flex: 2; 
        }
        
        .header-item.quantity { 
            text-align: center; 
            flex: 0.5; 
        }
        
        .header-item.price { 
            text-align: center; 
            flex: 1; 
        }
        
        .header-item.total { 
            text-align: center; 
            flex: 1; 
        }
        
        .table-row { 
            display: flex; 
            border-bottom: 1px solid #e1e8ed; 
            font-size: 12px; 
        }
        
        .table-row:last-child { 
            border-bottom: none; 
        }
        
        .table-cell { 
            padding: 12px 8px; 
            flex: 1; 
            display: flex; 
            align-items: center; 
            border-right: 1px solid #e1e8ed; 
        }
        
        .table-cell:last-child { 
            border-right: none; 
        }
        
        .table-cell:first-child { 
            flex: 0.5; 
            justify-content: center; 
        }
        
        .table-cell.description { 
            flex: 2; 
            justify-content: flex-start; 
            font-weight: 500; 
        }
        
        .table-cell.quantity { 
            flex: 0.5; 
            justify-content: center; 
        }
        
        .table-cell.price { 
            flex: 1; 
            justify-content: center; 
        }
        
        .table-cell.total { 
            flex: 1; 
            justify-content: center; 
            font-weight: 600; 
        }
        
        .totals-section { 
            padding: 0 24px 24px; 
            display: flex; 
            justify-content: flex-end; 
        }
        
        .totals-container { 
            width: 240px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 16px; 
            border: 1px solid #e1e8ed; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
        }
        
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: 12px; 
            align-items: center; 
            min-height: 20px; 
        }
        
        .total-row.grand-total { 
            border-top: 2px solid #8cc63f; 
            padding-top: 10px; 
            margin-top: 10px; 
            font-size: 15px; 
            font-weight: 700; 
            color: #2c3e50; 
        }
        
        .total-label { 
            font-weight: 600; 
        }
        
        .total-value { 
            font-weight: 600; 
        }
        
        .terms-section { 
            padding: 24px; 
            background: #f8f9fa; 
            border-top: 1px solid #e1e8ed; 
        }
        
        .terms-content p { 
            margin: 0; 
            font-size: 10px; 
            color: #666; 
            line-height: 1.3; 
        }
        
        @media print { 
            body { margin: 0; }
            .quote-actions { display: none; }
        }
    </style>
</head>
<body>
    <div class="quote-document">
        ${invoiceContent}
    </div>
</body>
</html>`;
                
                invoiceWindow.document.write(htmlContent);
                invoiceWindow.document.close();
                
                // Wait for content to load, then show success message
                setTimeout(() => {
                    invoiceWindow.focus();
                    showSuccess('Invoice downloaded! You can now print or save as PDF from the new window.');
                }, 500);
                
            } catch (error) {
                console.error('Error downloading invoice:', error);
                showError('Failed to download invoice. Please try again.');
            }
        }

        // Print invoice
        function printInvoice() {
            try {
                console.log('🖨️ Printing invoice...');
                
                // Get the current invoice data
                const currentBooking = window.currentBookingData;
                if (!currentBooking) {
                    showError('No booking data available for printing');
                    return;
                }
                
                // Get the exact invoice content from the preview
                const printContent = document.querySelector('#invoice-preview-section .quote-document').innerHTML;
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice - Stellar Tree Management</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 20px; 
                                background: white; 
                                font-size: 12px;
                                line-height: 1.4;
                                color: #333;
                            }
                            
                            .quote-document { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                line-height: 1.4; 
                                color: #333; 
                                font-size: 12px; 
                                max-width: 800px; 
                                margin: 0 auto; 
                                background: white; 
                                border-radius: 8px; 
                                overflow: hidden; 
                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .quote-header { 
                                background: white; 
                                color: #333; 
                                padding: 24px; 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: flex-start; 
                                border-bottom: 3px solid #8cc63f; 
                            }
                            
                            .company-name { 
                                font-size: 20px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                                margin: 0 0 10px 0; 
                                letter-spacing: 0.3px; 
                            }
                            
                            .document-type { 
                                font-size: 18px; 
                                font-weight: 700; 
                                color: #e83e8c; 
                                text-align: right; 
                                margin-bottom: 8px; 
                            }
                            
                            .document-number { 
                                font-size: 14px; 
                                color: #666; 
                                margin-bottom: 4px; 
                            }
                            
                            .document-date { 
                                font-size: 14px; 
                                color: #666; 
                            }
                            
                            .client-info { 
                                padding: 24px; 
                                display: flex; 
                                justify-content: space-between; 
                                gap: 40px; 
                            }
                            
                            .info-section h4 { 
                                margin: 0 0 12px 0; 
                                font-size: 14px; 
                                font-weight: 600; 
                                color: #2c3e50; 
                            }
                            
                            .info-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                                font-size: 12px; 
                            }
                            
                            .label { 
                                font-weight: 600; 
                                color: #666; 
                                min-width: 60px; 
                            }
                            
                            .value { 
                                color: #333; 
                                font-weight: 500; 
                            }
                            
                            .services-table { 
                                margin: 0 24px; 
                                border: 1px solid #e1e8ed; 
                                border-radius: 8px; 
                                overflow: hidden; 
                            }
                            
                            .table-header { 
                                background: #8cc63f; 
                                color: white; 
                                display: flex; 
                                font-weight: 600; 
                                font-size: 12px; 
                            }
                            
                            .header-cell { 
                                padding: 12px 8px; 
                                flex: 1; 
                                text-align: center; 
                            }
                            
                            .header-cell:first-child { 
                                text-align: left; 
                                padding-left: 16px; 
                            }
                            
                            .header-cell:last-child { 
                                text-align: right; 
                                padding-right: 16px; 
                            }
                            
                            .table-row { 
                                display: flex; 
                                border-bottom: 1px solid #e1e8ed; 
                                font-size: 12px; 
                            }
                            
                            .table-row:last-child { 
                                border-bottom: none; 
                            }
                            
                            .table-cell { 
                                padding: 12px 8px; 
                                flex: 1; 
                                display: flex; 
                                align-items: center; 
                                border-right: 1px solid #e1e8ed; 
                            }
                            
                            .table-cell:last-child { 
                                border-right: none; 
                            }
                            
                            .table-cell.description { 
                                justify-content: flex-start; 
                                font-weight: 500; 
                            }
                            
                            .table-cell.quantity { 
                                justify-content: center; 
                            }
                            
                            .table-cell.price, .table-cell.total { 
                                justify-content: flex-end; 
                                font-weight: 600; 
                            }
                            
                            .totals-section { 
                                padding: 0 24px 24px; 
                                display: flex; 
                                justify-content: flex-end; 
                            }
                            
                            .totals-container { 
                                width: 240px; 
                                background: #f8f9fa; 
                                border-radius: 8px; 
                                padding: 16px; 
                                border: 1px solid #e1e8ed; 
                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
                            }
                            
                            .total-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                                font-size: 12px; 
                                align-items: center; 
                                min-height: 20px; 
                            }
                            
                            .total-row.grand-total { 
                                border-top: 2px solid #8cc63f; 
                                padding-top: 10px; 
                                margin-top: 10px; 
                                font-size: 15px; 
                                font-weight: 700; 
                                color: #2c3e50; 
                            }
                            
                            .total-label { 
                                font-weight: 600; 
                            }
                            
                            .total-value { 
                                font-weight: 600; 
                            }
                            
                            @media print { 
                                body { margin: 0; }
                                .quote-actions { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                
                showSuccess('Invoice print dialog opened!');
            } catch (error) {
                console.error('Error printing invoice:', error);
                showError('Failed to print invoice. Please try again.');
            }
        }

        // Load and display booking restrictions for a quote
        async function loadBookingRestrictions(bookingId) {
            try {
                // First get the quote for this booking
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`);
                if (!quoteResponse.ok) {
                    console.log('No quote found for booking:', bookingId);
                    return;
                }
                
                const quotes = await quoteResponse.json();
                if (quotes.length === 0) {
                    console.log('No quotes found for booking:', bookingId);
                    return;
                }
                
                const latestQuote = quotes[0];
                const restrictions = latestQuote.booking_restrictions;
                
                if (!restrictions) {
                    console.log('No booking restrictions found for quote');
                    return;
                }
                
                // Display the restrictions
                displayBookingRestrictions(restrictions);
                
            } catch (error) {
                console.error('Error loading booking restrictions:', error);
            }
        }

        // Display booking restrictions information
        function displayBookingRestrictions(restrictions) {
            const restrictionsInfo = document.getElementById('booking-restrictions-info');
            const restrictionsContent = document.getElementById('restrictions-content');
            
            if (!restrictionsInfo || !restrictionsContent) {
                console.log('Restrictions display elements not found');
                return;
            }
            
            let restrictionsHtml = '';
            
            // Job duration information
            restrictionsHtml += `
                <div class="restrictions-detail">
                    <strong>Job Duration:</strong> This job will take <span class="highlight">${restrictions.job_duration_days} day${restrictions.job_duration_days > 1 ? 's' : ''}</span> to complete.
                </div>
            `;
            
            // Allowed days information
            if (restrictions.allowed_days === 'weekends') {
                restrictionsHtml += `
                    <div class="restrictions-detail">
                        <strong>Available Days:</strong> You can only book on <span class="highlight">weekends (all day)</span>.
                    </div>
                `;
            } else if (restrictions.allowed_days === 'weekdays') {
                restrictionsHtml += `
                    <div class="restrictions-detail">
                        <strong>Available Days:</strong> You can only book on <span class="highlight">weekdays at 5:30 PM, 6:30 PM, or 7:30 PM</span>.
                    </div>
                `;
            } else if (restrictions.allowed_days === 'both') {
                restrictionsHtml += `
                    <div class="restrictions-detail">
                        <strong>Available Days:</strong> You can book on <span class="highlight">weekends (all day) and weekdays at 5:30 PM, 6:30 PM, or 7:30 PM</span>.
                    </div>
                `;
            } else if (restrictions.allowed_days === 'custom' && restrictions.custom_dates && restrictions.custom_dates.length > 0) {
                const customDatesList = restrictions.custom_dates.map(date => {
                    const dateObj = new Date(date);
                    const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                    const timeInfo = isWeekend ? 'all day' : '5:30 PM, 6:30 PM, or 7:30 PM';
                    return `${dateObj.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric' 
                    })} (${timeInfo})`;
                }).join(', ');
                
                restrictionsHtml += `
                    <div class="restrictions-detail">
                        <strong>Available Dates:</strong> You can only book on these specific dates: <span class="highlight">${customDatesList}</span>
                    </div>
                `;
            }
            
            // Additional information
            restrictionsHtml += `
                <div class="restrictions-detail">
                    <strong>Important:</strong> You must select <span class="highlight">${restrictions.job_duration_days} consecutive day${restrictions.job_duration_days > 1 ? 's' : ''}</span> when scheduling your job.
                </div>
            `;
            
            restrictionsContent.innerHTML = restrictionsHtml;
            restrictionsInfo.style.display = 'block';
        }

    </script>
</body>
</html> 